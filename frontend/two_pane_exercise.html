<!DOCTYPE html>
<html lang="ja" data-app="exercise-v2">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>過去問演習 事例I UIリニューアル</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css"
    />
    <style>
      :root {
        color-scheme: light dark;
        --color-bg: #eef2f8;
        --color-surface: #ffffff;
        --color-surface-alt: rgba(255, 255, 255, 0.85);
        --color-border: rgba(18, 38, 64, 0.12);
        --color-text: #132640;
        --color-text-muted: rgba(19, 38, 64, 0.65);
        --color-primary: #325bff;
        --color-primary-strong: #2443c7;
        --color-accent: #f28f3b;
        --color-danger: #de5b5b;
        --color-success: #2c9f6b;
        --shadow-layer: 0 18px 45px rgba(17, 34, 64, 0.08);
        --radius-card: 18px;
        --radius-pill: 999px;
        --transition: 200ms ease;
        font-size: 16px;
      }

      @media (prefers-color-scheme: dark) {
        :root {
          --color-bg: #0f172a;
          --color-surface: rgba(15, 23, 42, 0.92);
          --color-surface-alt: rgba(30, 41, 59, 0.7);
          --color-border: rgba(148, 163, 184, 0.18);
          --color-text: #e2e8f0;
          --color-text-muted: rgba(226, 232, 240, 0.72);
          --shadow-layer: 0 24px 60px rgba(2, 6, 23, 0.75);
        }
      }

      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "Noto Sans JP", system-ui, -apple-system, "Segoe UI", sans-serif;
        color: var(--color-text);
        background: linear-gradient(180deg, #f4f7ff 0%, var(--color-bg) 40%, var(--color-bg) 100%);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      header {
        position: sticky;
        top: 0;
        z-index: 40;
        backdrop-filter: blur(12px);
        background: color-mix(in srgb, var(--color-surface) 75%, transparent);
        border-bottom: 1px solid var(--color-border);
        padding: 14px clamp(18px, 2vw, 32px);
        display: flex;
        gap: 18px;
        align-items: center;
        flex-wrap: wrap;
      }

      header h1 {
        margin: 0;
        font-family: "M PLUS Rounded 1c", "Noto Sans JP", sans-serif;
        font-size: clamp(1.2rem, 1.1rem + 0.6vw, 1.7rem);
        letter-spacing: 0.01em;
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      header h1 span {
        font-size: 0.85rem;
        color: var(--color-text-muted);
        font-weight: 500;
      }

      .toolbar {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-left: auto;
        flex-wrap: wrap;
      }

      .toolbar__timer {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 6px 14px;
        border-radius: var(--radius-pill);
        border: 1px solid var(--color-border);
        background: var(--color-surface-alt);
        font-family: "M PLUS Rounded 1c", "Noto Sans JP", sans-serif;
        font-weight: 600;
      }

      .toolbar__timer[data-warning="true"] {
        border-color: rgba(242, 143, 59, 0.45);
        color: var(--color-accent);
      }

      button {
        font: inherit;
        cursor: pointer;
        border: none;
        background: none;
      }

      .button {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        padding: 10px 18px;
        border-radius: var(--radius-pill);
        background: var(--color-surface);
        border: 1px solid var(--color-border);
        color: inherit;
        font-weight: 600;
        transition: transform var(--transition), box-shadow var(--transition),
          border-color var(--transition);
      }

      .button:hover,
      .button:focus-visible {
        outline: none;
        transform: translateY(-1px);
        border-color: var(--color-primary);
        box-shadow: 0 12px 28px rgba(17, 34, 64, 0.12);
      }

      .button--primary {
        background: var(--color-primary);
        color: #ffffff;
        border-color: transparent;
      }

      .button--ghost {
        background: transparent;
      }

      main {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: clamp(24px, 3vw, 40px);
        padding: clamp(18px, 2.4vw, 32px);
      }

      .layout {
        display: grid;
        gap: clamp(18px, 2.5vw, 32px);
        grid-template-columns: minmax(320px, 1fr) minmax(360px, 1.15fr);
        align-items: start;
      }

      .card {
        background: var(--color-surface);
        border-radius: var(--radius-card);
        padding: clamp(18px, 2.4vw, 24px);
        box-shadow: var(--shadow-layer);
        border: 1px solid var(--color-border);
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .card h2,
      .card h3 {
        margin: 0;
        font-family: "M PLUS Rounded 1c", "Noto Sans JP", sans-serif;
      }

      .scenario-header {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .scenario-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
        font-size: 0.85rem;
        color: var(--color-text-muted);
      }

      .scenario-search {
        position: relative;
      }

      .scenario-search input {
        width: 100%;
        border-radius: var(--radius-pill);
        padding: 10px 44px 10px 16px;
        border: 1px solid var(--color-border);
        background: var(--color-surface-alt);
        font-size: 0.95rem;
        transition: border-color var(--transition), box-shadow var(--transition);
      }

      .scenario-search input:focus-visible {
        outline: none;
        border-color: var(--color-primary);
        box-shadow: 0 0 0 3px color-mix(in srgb, var(--color-primary) 30%, transparent);
      }

      .scenario-search i {
        position: absolute;
        right: 16px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--color-text-muted);
        font-size: 1.1rem;
      }

      .scenario-body {
        font-size: 0.98rem;
        line-height: 1.9;
        letter-spacing: 0.02em;
        white-space: pre-line;
      }

      .scenario-body mark.highlight {
        padding: 2px 0;
        border-radius: 6px;
        background: rgba(50, 91, 255, 0.22);
      }

      .scenario-body mark[data-color="accent"] {
        background: rgba(242, 143, 59, 0.22);
      }

      .scenario-body mark[data-color="success"] {
        background: rgba(44, 159, 107, 0.22);
      }

      .scenario-body mark[data-color="purple"] {
        background: rgba(128, 90, 213, 0.24);
      }

      .highlight-palette {
        position: absolute;
        display: none;
        gap: 8px;
        padding: 10px 14px;
        border-radius: var(--radius-card);
        background: var(--color-surface);
        border: 1px solid var(--color-border);
        box-shadow: 0 16px 30px rgba(15, 23, 42, 0.15);
        z-index: 1000;
        align-items: center;
      }

      .highlight-swatch {
        width: 28px;
        height: 28px;
        border-radius: 10px;
        border: 2px solid transparent;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        transition: transform var(--transition), border-color var(--transition);
      }

      .highlight-swatch:hover,
      .highlight-swatch:focus-visible {
        outline: none;
        transform: translateY(-1px);
        border-color: rgba(0, 0, 0, 0.12);
      }

      .highlight-swatch[data-color="primary"] {
        background: rgba(50, 91, 255, 0.28);
      }

      .highlight-swatch[data-color="accent"] {
        background: rgba(242, 143, 59, 0.3);
      }

      .highlight-swatch[data-color="success"] {
        background: rgba(44, 159, 107, 0.3);
      }

      .highlight-swatch[data-color="purple"] {
        background: rgba(128, 90, 213, 0.3);
      }

      .highlight-remove {
        width: 34px;
        height: 34px;
        border-radius: 50%;
        background: rgba(0, 0, 0, 0.04);
        color: var(--color-text-muted);
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }

      .highlight-remove:hover,
      .highlight-remove:focus-visible {
        outline: none;
        color: var(--color-danger);
        background: rgba(222, 91, 91, 0.12);
      }

      .auto-save-status {
        font-size: 0.82rem;
        color: var(--color-text-muted);
      }

      .auto-save-status[data-visible="true"] {
        color: var(--color-success);
        font-weight: 600;
      }

      .text-muted {
        color: var(--color-text-muted);
        font-size: 0.9rem;
      }

      .pane-tabs {
        display: flex;
        gap: 8px;
        border-bottom: 1px solid var(--color-border);
        padding-bottom: 6px;
      }

      .pane-tab {
        border-radius: var(--radius-pill);
        padding: 8px 18px;
        font-size: 0.92rem;
        font-weight: 600;
        background: transparent;
        color: var(--color-text-muted);
        border: 1px solid transparent;
        transition: background var(--transition), color var(--transition);
      }

      .pane-tab[aria-selected="true"] {
        background: rgba(50, 91, 255, 0.16);
        color: var(--color-primary-strong);
        border-color: rgba(50, 91, 255, 0.32);
      }

      .pane-panel {
        display: none;
        flex-direction: column;
        gap: 18px;
      }

      .pane-panel[aria-hidden="false"] {
        display: flex;
      }

      .question-list {
        display: grid;
        gap: 12px;
      }

      .question-item {
        border: 1px solid var(--color-border);
        border-radius: var(--radius-card);
        background: var(--color-surface-alt);
        padding: 14px;
        display: grid;
        gap: 6px;
        transition: border-color var(--transition), box-shadow var(--transition);
      }

      .question-item[aria-selected="true"] {
        border-color: rgba(50, 91, 255, 0.4);
        box-shadow: 0 12px 26px rgba(50, 91, 255, 0.16);
      }

      .question-item button {
        justify-self: start;
      }

      .question-item__meta {
        font-size: 0.78rem;
        color: var(--color-text-muted);
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .answer-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        align-items: center;
        font-size: 0.88rem;
        color: var(--color-text-muted);
      }

      .answer-meta strong {
        color: var(--color-text);
      }

      .answer-toggle {
        display: inline-flex;
        border: 1px solid var(--color-border);
        border-radius: var(--radius-pill);
        background: var(--color-surface-alt);
        overflow: hidden;
      }

      .answer-toggle button {
        padding: 8px 18px;
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--color-text-muted);
        background: transparent;
        border: none;
        transition: background var(--transition), color var(--transition);
      }

      .answer-toggle button[aria-pressed="true"] {
        background: var(--color-primary);
        color: #ffffff;
      }

      .answer-editor,
      .answer-model {
        display: none;
        flex-direction: column;
        gap: 14px;
      }

      .answer-editor[data-visible="true"],
      .answer-model[data-visible="true"] {
        display: flex;
      }

      textarea {
        width: 100%;
        min-height: 200px;
        border-radius: 16px;
        border: 1px solid var(--color-border);
        padding: 14px;
        font-size: 0.95rem;
        line-height: 1.7;
        resize: vertical;
        background: var(--color-surface-alt);
      }

      textarea:focus-visible {
        outline: none;
        border-color: var(--color-primary);
        box-shadow: 0 0 0 3px color-mix(in srgb, var(--color-primary) 35%, transparent);
      }

      .progress-track {
        width: 100%;
        height: 10px;
        border-radius: var(--radius-pill);
        background: rgba(15, 23, 42, 0.08);
        overflow: hidden;
      }

      .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, var(--color-primary) 0%, #8aa6ff 100%);
        width: 0%;
        transition: width 180ms ease;
      }

      .progress-bar[data-state="warning"] {
        background: linear-gradient(90deg, var(--color-accent) 0%, #ffd4a8 100%);
      }

      .progress-bar[data-state="danger"] {
        background: linear-gradient(90deg, var(--color-danger) 0%, #f6b1b1 100%);
      }

      .keyword-list {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 10px;
      }

      .keyword-chip {
        border-radius: var(--radius-pill);
        padding: 6px 12px;
        font-size: 0.82rem;
        font-weight: 600;
        background: rgba(15, 23, 42, 0.06);
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      .keyword-chip[data-hit="true"] {
        background: rgba(44, 159, 107, 0.16);
        color: var(--color-success);
      }

      .model-points {
        padding-left: 1.1rem;
        margin: 0;
        display: grid;
        gap: 6px;
        font-size: 0.92rem;
      }

      .guide-list {
        padding-left: 1.1rem;
        display: grid;
        gap: 10px;
      }

      .steps {
        display: grid;
        gap: 16px;
      }

      .step-item {
        border-radius: var(--radius-card);
        border: 1px solid var(--color-border);
        background: var(--color-surface-alt);
        padding: 16px 18px;
        display: flex;
        gap: 14px;
      }

      .step-number {
        width: 40px;
        height: 40px;
        border-radius: 12px;
        background: rgba(50, 91, 255, 0.2);
        color: var(--color-primary-strong);
        font-weight: 700;
        font-family: "M PLUS Rounded 1c", "Noto Sans JP", sans-serif;
        display: grid;
        place-items: center;
      }

      .tools-grid {
        display: grid;
        gap: 18px;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      }

      .tool-card {
        background: var(--color-surface);
        border-radius: var(--radius-card);
        padding: 18px;
        box-shadow: var(--shadow-layer);
        border: 1px solid var(--color-border);
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .tool-card footer {
        margin-top: auto;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }

      .modal {
        position: fixed;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        padding: 24px;
        z-index: 2000;
      }

      .modal[data-open="true"] {
        display: flex;
      }

      .modal__overlay {
        position: absolute;
        inset: 0;
        background: rgba(15, 23, 42, 0.6);
        backdrop-filter: blur(4px);
      }

      .modal__content {
        position: relative;
        background: var(--color-surface);
        border-radius: var(--radius-card);
        padding: clamp(20px, 4vw, 32px);
        border: 1px solid var(--color-border);
        box-shadow: var(--shadow-layer);
        display: grid;
        gap: 18px;
        min-width: min(420px, 100%);
      }

      .modal__content h3 {
        margin: 0;
      }

      .modal__keywords {
        display: grid;
        gap: 10px;
      }

      .modal__keywords li {
        list-style: none;
        border-radius: var(--radius-pill);
        background: rgba(50, 91, 255, 0.14);
        padding: 8px 14px;
        font-weight: 600;
      }

      .modal__progress {
        display: grid;
        gap: 6px;
      }

      .modal-close {
        position: absolute;
        top: 12px;
        right: 12px;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: grid;
        place-items: center;
        background: rgba(15, 23, 42, 0.08);
      }

      .support-tools {
        display: flex;
        flex-direction: column;
        gap: 18px;
      }

      .support-tools details {
        border-radius: var(--radius-card);
        border: 1px solid var(--color-border);
        background: var(--color-surface);
        padding: 16px 18px;
      }

      .support-tools summary {
        cursor: pointer;
        font-weight: 600;
      }

      .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
      }

      @media (max-width: 1080px) {
        .layout {
          grid-template-columns: 1fr;
        }

        header {
          position: relative;
        }

        .toolbar {
          margin-left: 0;
        }
      }

      @media (max-width: 720px) {
        main {
          padding: 16px;
        }

        .card {
          padding: 16px;
        }

        textarea {
          min-height: 160px;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <h1>
        過去問演習 | 事例I
        <span>与件文と設問を1画面で俯瞰しながら回答できます</span>
      </h1>
      <div class="toolbar">
        <div class="toolbar__timer" data-timer-display data-warning="false">
          <i class="bx bx-time-five"></i>
          <span data-timer-text>80:00</span>
        </div>
        <button class="button button--primary" data-timer-start>
          <i class="bx bx-play-circle"></i>
          タイマー開始
        </button>
        <button class="button button--ghost">
          <i class="bx bx-cog"></i>
          設定
        </button>
      </div>
    </header>
    <main>
      <section class="layout">
        <article class="card" id="scenario">
          <div class="scenario-header">
            <h2>与件文</h2>
            <div class="scenario-meta">
              <span><i class="bx bx-book-open"></i> 第1問〜第3問対象</span>
              <span data-auto-save class="auto-save-status">自動保存待機中…</span>
            </div>
            <div class="scenario-search">
              <label class="sr-only" for="scenario-search">与件文内検索</label>
              <input
                type="search"
                id="scenario-search"
                placeholder="キーワードで与件文を検索"
                autocomplete="off"
              />
              <i class="bx bx-search"></i>
            </div>
          </div>
          <div class="scenario-body" id="scenario-body"></div>
        </article>
        <aside class="card" id="workspace">
          <nav class="pane-tabs" role="tablist" aria-label="演習タブ">
            <button class="pane-tab" role="tab" aria-selected="true" data-pane-target="list">
              設問リスト
            </button>
            <button class="pane-tab" role="tab" aria-selected="false" data-pane-target="answer">
              回答
            </button>
            <button class="pane-tab" role="tab" aria-selected="false" data-pane-target="guide">
              採点ガイド
            </button>
          </nav>
          <div class="pane-panel" data-pane="list" aria-hidden="false">
            <h2>回答ナビゲーション</h2>
            <p class="text-muted">
              設問を選択すると右上のタブ「回答」で入力・模範解答を確認できます。
            </p>
            <div class="question-list" data-question-list></div>
          </div>
          <div class="pane-panel" data-pane="answer" aria-hidden="true">
            <header>
              <h2 data-answer-title>設問を選択してください</h2>
              <div class="answer-meta" data-answer-meta hidden>
                <span>制限文字数：<strong data-limit>0</strong>字</span>
                <span>残り：<strong data-remaining>0</strong>字</span>
                <span>要点被覆率：<strong data-coverage>0%</strong></span>
              </div>
            </header>
            <div class="answer-toggle" role="tablist" aria-label="回答モード">
              <button type="button" role="tab" aria-pressed="true" data-answer-view="editor">
                回答入力
              </button>
              <button type="button" role="tab" aria-pressed="false" data-answer-view="model">
                模範解答
              </button>
            </div>
            <section class="answer-editor" data-visible="true" data-editor>
              <label for="answer-input" class="sr-only">回答入力欄</label>
              <textarea id="answer-input" placeholder="ここに解答を入力してください"></textarea>
              <div class="progress-track">
                <div class="progress-bar" data-progress-bar></div>
              </div>
              <div class="keyword-list" data-keyword-list></div>
            </section>
            <section class="answer-model" data-model>
              <div>
                <h3>模範解答</h3>
                <p data-model-answer>設問を選択すると模範解答を表示します。</p>
              </div>
              <div>
                <h3>模範解答のポイント</h3>
                <ul class="model-points" data-model-points></ul>
              </div>
            </section>
          </div>
          <div class="pane-panel" data-pane="guide" aria-hidden="true">
            <h2>採点ガイド</h2>
            <p>
              各設問の評価観点と採点指針をまとめています。回答作成後にセルフチェックを行いましょう。
            </p>
            <ol class="guide-list" data-guide-list></ol>
          </div>
        </aside>
      </section>

      <section class="card">
        <h2>使い方ステップ</h2>
        <div class="steps">
          <article class="step-item">
            <div class="step-number">1</div>
            <div>
              <h3>与件文を読み込み、ハイライトで整理</h3>
              <p>
                気になる箇所を選択すると色パレットが自動表示されます。色をクリックするだけでハイライトされ、内容は自動保存されます。
              </p>
            </div>
          </article>
          <article class="step-item">
            <div class="step-number">2</div>
            <div>
              <h3>設問リストから回答対象を選択</h3>
              <p>
                右ペインの「設問リスト」タブで回答する設問を選択し、「回答」タブで記述します。残文字数と要点被覆率がリアルタイムに更新されます。
              </p>
            </div>
          </article>
          <article class="step-item">
            <div class="step-number">3</div>
            <div>
              <h3>模範解答と採点ガイドで最終確認</h3>
              <p>
                回答と重要ワードのマッチ状況を確認し、採点ガイドの観点をチェックすることで抜け漏れを防ぎます。
              </p>
            </div>
          </article>
        </div>
      </section>

      <section class="card">
        <h2>補助ツール</h2>
        <div class="tools-grid">
          <article class="tool-card">
            <h3>リトリーバル・プラクティス</h3>
            <p>
              ハイライトから抽出した重要キーワードで即時確認。カードを表示して想起できたかチェックしましょう。
            </p>
            <footer>
              <button class="button button--primary" data-flashcard-open>
                カードを表示
              </button>
              <div class="progress-track" aria-label="リトリーバル進捗">
                <div class="progress-bar" data-flashcard-progress></div>
              </div>
            </footer>
          </article>
          <article class="tool-card">
            <h3>MECEスキャナ</h3>
            <p>
              回答文の構成を分析し、漏れやダブりを検知します。今後の機能拡張に備えたプレースホルダーです。
            </p>
            <footer>
              <button class="button button--ghost" disabled>
                準備中
              </button>
            </footer>
          </article>
        </div>
        <div class="support-tools">
          <details>
            <summary>要点チェックリスト</summary>
            <p>
              設問ごとの重要ワードは回答入力欄の下に表示され、入力内容に応じて自動で達成状況が更新されます。
            </p>
          </details>
          <details>
            <summary>タイマーの使い方</summary>
            <p>
              「タイマー開始」を押すと確認ダイアログが表示されます。承認すると80分カウントダウンが開始され、停止しても与件文は常時閲覧可能です。
            </p>
          </details>
        </div>
      </section>
    </main>

    <div class="highlight-palette" data-highlight-palette>
      <button type="button" class="highlight-swatch" data-color="primary" aria-label="青系ハイライト"></button>
      <button type="button" class="highlight-swatch" data-color="accent" aria-label="オレンジ系ハイライト"></button>
      <button type="button" class="highlight-swatch" data-color="success" aria-label="グリーン系ハイライト"></button>
      <button type="button" class="highlight-swatch" data-color="purple" aria-label="パープル系ハイライト"></button>
      <button type="button" class="highlight-remove" data-highlight-remove aria-label="ハイライトを解除">
        <i class="bx bx-trash"></i>
      </button>
    </div>

    <div class="modal" data-flashcard-modal aria-hidden="true">
      <div class="modal__overlay" data-flashcard-close></div>
      <div class="modal__content" role="dialog" aria-modal="true" aria-labelledby="flashcard-title">
        <button class="modal-close" type="button" data-flashcard-close aria-label="閉じる">
          <i class="bx bx-x"></i>
        </button>
        <h3 id="flashcard-title">キーワードカード</h3>
        <p>キーワードを声に出して想起し、思い出せたらチェックしましょう。</p>
        <ul class="modal__keywords" data-flashcard-keywords></ul>
        <div class="modal__progress">
          <div class="progress-track">
            <div class="progress-bar" data-flashcard-progress-modal></div>
          </div>
          <span data-flashcard-progress-label>0 / 0</span>
        </div>
        <div style="display: flex; gap: 12px; justify-content: flex-end">
          <button class="button button--ghost" type="button" data-flashcard-close>
            閉じる
          </button>
          <button class="button button--primary" type="button" data-flashcard-next>
            次のカードへ
          </button>
        </div>
      </div>
    </div>
    <script>
      const scenarioBody = document.getElementById('scenario-body');
      const scenarioSearchInput = document.getElementById('scenario-search');
      const autoSaveStatus = document.querySelector('[data-auto-save]');
      const highlightPalette = document.querySelector('[data-highlight-palette]');
      const highlightRemoveButton = document.querySelector('[data-highlight-remove]');
      const paneTabs = document.querySelectorAll('.pane-tab');
      const panePanels = document.querySelectorAll('.pane-panel');
      const questionListEl = document.querySelector('[data-question-list]');
      const answerTitle = document.querySelector('[data-answer-title]');
      const answerMeta = document.querySelector('[data-answer-meta]');
      const limitEl = document.querySelector('[data-limit]');
      const remainingEl = document.querySelector('[data-remaining]');
      const coverageEl = document.querySelector('[data-coverage]');
      const answerTextarea = document.getElementById('answer-input');
      const keywordList = document.querySelector('[data-keyword-list]');
      const progressBar = document.querySelector('[data-progress-bar]');
      const answerViewButtons = document.querySelectorAll('[data-answer-view]');
      const answerEditor = document.querySelector('[data-editor]');
      const answerModel = document.querySelector('[data-model]');
      const modelAnswerEl = document.querySelector('[data-model-answer]');
      const modelPointsEl = document.querySelector('[data-model-points]');
      const guideList = document.querySelector('[data-guide-list]');
      const flashcardButton = document.querySelector('[data-flashcard-open]');
      const flashcardModal = document.querySelector('[data-flashcard-modal]');
      const flashcardCloseButtons = document.querySelectorAll('[data-flashcard-close]');
      const flashcardNextButton = document.querySelector('[data-flashcard-next]');
      const flashcardKeywordsList = document.querySelector('[data-flashcard-keywords]');
      const flashcardProgress = document.querySelector('[data-flashcard-progress]');
      const flashcardProgressModal = document.querySelector('[data-flashcard-progress-modal]');
      const flashcardProgressLabel = document.querySelector('[data-flashcard-progress-label]');
      const timerDisplay = document.querySelector('[data-timer-display]');
      const timerText = document.querySelector('[data-timer-text]');
      const timerStartButton = document.querySelector('[data-timer-start]');

      const defaultScenario = `A社は地域密着でBtoB製品を製造する老舗企業であり、直近の市場環境は競合のデジタル投資が活発化している。\n主要顧客である自動車部品メーカー向けに高品質な部材を提供し、信頼と長期契約を獲得してきた。\nしかし、需要変動の影響で稼働率が低下し、若手人材の定着と新規顧客開拓が課題となっている。\n営業はベテランに依存し、ノウハウが暗黙知化している。生産ではDX投資が遅れ、品質データの活用が十分でない。\n今後は既存顧客との関係を維持しながら、得意な品質保証力と設計提案力を活かし新市場へ展開することが期待される。`;

      const questions = [
        {
          id: 'q1',
          title: '第1問（設問1）',
          prompt:
            'A社がこれまで築いてきた強みを整理し、今後の戦略にどのように活かすべきか120字以内で述べよ。',
          limit: 120,
          keywords: ['信頼', '品質保証', '設計提案力', '長期契約'],
          modelAnswer:
            '主要顧客と築いた信頼を背景に、高品質な品質保証力と設計提案力を活かし、既存顧客の深耕と関連市場への展開を同時に図る。',
          modelPoints: ['強みの明示', '活用の方向性', '既存と新規の両立'],
          guide:
            '強みの特定と活用方針が明確であるか、競争優位を維持・拡大する視点が含まれているかを確認する。',
        },
        {
          id: 'q2',
          title: '第2問',
          prompt:
            '若手人材の定着に向けた取り組みを、組織活性化とスキル継承の観点から160字以内で提案せよ。',
          limit: 160,
          keywords: ['育成', '暗黙知', 'キャリア', '活性化'],
          modelAnswer:
            'ベテランの暗黙知を形式知化するOJTと研修体系を整備し、キャリアパスと評価制度を明確化。プロジェクト活動を通じて組織活性化と定着を図る。',
          modelPoints: ['暗黙知の形式知化', 'キャリアパス設計', '活性化施策'],
          guide:
            '人材施策が継続的かつ実効性のある仕組みになっているか、若手視点のメリットが示されているかを確認する。',
        },
        {
          id: 'q3',
          title: '第3問',
          prompt: 'DX投資の遅れを解消するための生産革新策を200字以内で述べよ。',
          limit: 200,
          keywords: ['データ活用', 'DX', '生産性', '品質'],
          modelAnswer:
            '品質データをクラウドで一元管理し、工程ごとの異常検知を自動化。IoTセンサーで稼働状況を把握し、ボトルネックの改善と品質向上を同時に図る。',
          modelPoints: ['データ基盤', '自動化', '改善サイクル'],
          guide:
            'データ活用と現場改善が連動しているか、導入効果が生産性と品質の両面で語られているかを確認する。',
        },
      ];

      const answerStorageKey = 'case-study-answers';
      const scenarioStorageKey = 'case-study-scenario';
      const flashcards = [
        ['信頼関係', '品質保証', '設計提案力'],
        ['暗黙知の形式知化', '若手育成', 'キャリアパス'],
        ['DX投資', '品質データ活用', '稼働率向上'],
      ];

      let activeQuestionId = null;
      let highlightRange = null;
      let activeHighlight = null;
      let timerRemaining = 80 * 60;
      let timerInterval = null;
      let flashcardIndex = 0;

      const storedScenario = localStorage.getItem(scenarioStorageKey);
      scenarioBody.innerHTML = storedScenario || defaultScenario.replace(/\n/g, '<br />');

      const storedAnswers = JSON.parse(localStorage.getItem(answerStorageKey) || '{}');
      const updateAutoSaveStatus = (text) => {
        if (!autoSaveStatus) return;
        autoSaveStatus.dataset.visible = 'true';
        autoSaveStatus.textContent = text || '自動保存済み';
        setTimeout(() => {
          autoSaveStatus.dataset.visible = 'false';
          autoSaveStatus.textContent = '自動保存待機中…';
        }, 2500);
      };

      const snapshotScenarioHTML = () => {
        const clone = scenarioBody.cloneNode(true);
        clone.querySelectorAll('mark[data-search]').forEach((mark) => {
          const textNode = document.createTextNode(mark.textContent);
          mark.replaceWith(textNode);
        });
        return clone.innerHTML;
      };

      const saveScenario = () => {
        localStorage.setItem(scenarioStorageKey, snapshotScenarioHTML());
        updateAutoSaveStatus();
      };

      const buildQuestionList = () => {
        questionListEl.innerHTML = '';
        questions.forEach((question) => {
          const answerText = storedAnswers[question.id]?.text || '';
          const item = document.createElement('div');
          item.className = 'question-item';
          item.dataset.questionId = question.id;
          if (question.id === activeQuestionId) {
            item.setAttribute('aria-selected', 'true');
          }
          const title = document.createElement('h3');
          title.textContent = question.title;
          const prompt = document.createElement('p');
          prompt.textContent = question.prompt;
          const meta = document.createElement('div');
          meta.className = 'question-item__meta';
          meta.textContent = `入力済み: ${answerText.length} / ${question.limit}字`;
          const button = document.createElement('button');
          button.className = 'button button--ghost';
          button.type = 'button';
          button.textContent = '回答タブで開く';
          button.addEventListener('click', () => selectQuestion(question.id));
          item.append(title, prompt, meta, button);
          item.addEventListener('click', (event) => {
            if (event.target.tagName.toLowerCase() === 'button') return;
            selectQuestion(question.id);
          });
          questionListEl.appendChild(item);
        });
      };

      const activatePane = (tab) => {
        const target = tab.dataset.paneTarget;
        paneTabs.forEach((btn) => {
          const selected = btn === tab;
          btn.setAttribute('aria-selected', selected);
        });
        panePanels.forEach((panel) => {
          const hidden = panel.dataset.pane !== target;
          panel.setAttribute('aria-hidden', hidden);
        });
      };

      paneTabs.forEach((tab) => {
        tab.addEventListener('click', () => activatePane(tab));
      });

      const renderGuide = () => {
        guideList.innerHTML = '';
        questions.forEach((question) => {
          const li = document.createElement('li');
          li.textContent = question.guide;
          guideList.appendChild(li);
        });
      };

      const renderKeywords = (question, answerText) => {
        keywordList.innerHTML = '';
        const normalized = answerText.replace(/\s+/g, '').toLowerCase();
        let hitCount = 0;
        question.keywords.forEach((word) => {
          const normalizedWord = word.replace(/\s+/g, '').toLowerCase();
          const hit = normalized.includes(normalizedWord);
          if (hit) hitCount += 1;
          const chip = document.createElement('span');
          chip.className = 'keyword-chip';
          chip.dataset.hit = hit;
          chip.innerHTML = `<i class="bx ${hit ? 'bx-check-circle' : 'bx-radio-circle'}"></i>${word}`;
          keywordList.appendChild(chip);
        });
        const coverage = question.keywords.length
          ? Math.round((hitCount / question.keywords.length) * 100)
          : 100;
        coverageEl.textContent = `${coverage}%`;
        progressBar.style.width = `${Math.min(coverage, 100)}%`;
        if (coverage < 40) {
          progressBar.dataset.state = 'danger';
        } else if (coverage < 60) {
          progressBar.dataset.state = 'warning';
        } else {
          progressBar.dataset.state = 'normal';
        }
      };

      const updateAnswerView = () => {
        const question = questions.find((q) => q.id === activeQuestionId);
        if (!question) {
          answerTitle.textContent = '設問を選択してください';
          answerMeta.hidden = true;
          answerTextarea.value = '';
          keywordList.innerHTML = '';
          progressBar.style.width = '0%';
          progressBar.dataset.state = 'normal';
          coverageEl.textContent = '0%';
          modelAnswerEl.textContent = '設問を選択すると模範解答を表示します。';
          modelPointsEl.innerHTML = '';
          return;
        }
        const stored = storedAnswers[question.id] || { text: '' };
        answerTitle.textContent = question.prompt;
        answerMeta.hidden = false;
        limitEl.textContent = question.limit;
        answerTextarea.value = stored.text;
        const remaining = question.limit - stored.text.length;
        remainingEl.textContent = remaining;
        renderKeywords(question, stored.text);
        modelAnswerEl.textContent = question.modelAnswer;
        modelPointsEl.innerHTML = '';
        question.modelPoints.forEach((point) => {
          const li = document.createElement('li');
          li.textContent = point;
          modelPointsEl.appendChild(li);
        });
        buildQuestionList();
      };
      const selectQuestion = (questionId) => {
        activeQuestionId = questionId;
        const answerTab = Array.from(paneTabs).find((tab) => tab.dataset.paneTarget === 'answer');
        if (answerTab) {
          activatePane(answerTab);
        }
        updateAnswerView();
      };

      const persistAnswers = () => {
        localStorage.setItem(answerStorageKey, JSON.stringify(storedAnswers));
      };

      answerTextarea.addEventListener('input', () => {
        const question = questions.find((q) => q.id === activeQuestionId);
        if (!question) return;
        const text = answerTextarea.value.slice(0, question.limit);
        if (text !== answerTextarea.value) {
          answerTextarea.value = text;
        }
        storedAnswers[question.id] = { text };
        persistAnswers();
        const remaining = question.limit - text.length;
        remainingEl.textContent = remaining;
        renderKeywords(question, text);
        buildQuestionList();
      });

      answerViewButtons.forEach((button) => {
        button.addEventListener('click', () => {
          answerViewButtons.forEach((btn) => btn.setAttribute('aria-pressed', btn === button));
          const view = button.dataset.answerView;
          const showEditor = view === 'editor';
          answerEditor.dataset.visible = showEditor;
          answerModel.dataset.visible = !showEditor;
        });
      });

      const highlightSelection = (color) => {
        const selection = window.getSelection();
        if (!selection || selection.rangeCount === 0) return;
        const range = selection.getRangeAt(0);
        if (!scenarioBody.contains(range.commonAncestorContainer) || range.collapsed) return;
        const text = range.toString();
        const mark = document.createElement('mark');
        mark.className = 'highlight';
        mark.dataset.color = color;
        mark.textContent = text;
        range.deleteContents();
        range.insertNode(mark);
        selection.removeAllRanges();
        activeHighlight = mark;
        saveScenario();
        hidePalette();
      };

      const hidePalette = () => {
        highlightPalette.style.display = 'none';
        highlightRange = null;
      };

      const showPalette = (rect) => {
        highlightPalette.style.display = 'inline-flex';
        const paletteRect = highlightPalette.getBoundingClientRect();
        const top = Math.max(window.scrollY + 12, rect.top + window.scrollY - paletteRect.height - 12);
        const left = Math.min(
          window.scrollX + window.innerWidth - paletteRect.width - 12,
          Math.max(12, rect.left + window.scrollX)
        );
        highlightPalette.style.top = `${top}px`;
        highlightPalette.style.left = `${left}px`;
      };

      const handleSelectionChange = () => {
        const selection = window.getSelection();
        if (!selection || selection.rangeCount === 0) {
          hidePalette();
          return;
        }
        const range = selection.getRangeAt(0);
        if (!scenarioBody.contains(range.commonAncestorContainer) || range.collapsed) {
          hidePalette();
          return;
        }
        highlightRange = range.cloneRange();
        const rect = range.getBoundingClientRect();
        showPalette(rect);
      };

      scenarioBody.addEventListener('mouseup', handleSelectionChange);
      scenarioBody.addEventListener('keyup', handleSelectionChange);

      scenarioBody.addEventListener('click', (event) => {
        const mark = event.target.closest('mark');
        if (mark) {
          activeHighlight = mark;
          const range = document.createRange();
          range.selectNodeContents(mark);
          const selection = window.getSelection();
          selection.removeAllRanges();
          selection.addRange(range);
          highlightRange = range.cloneRange();
          const rect = mark.getBoundingClientRect();
          showPalette(rect);
        }
      });

      highlightPalette.querySelectorAll('.highlight-swatch').forEach((button) => {
        button.addEventListener('click', () => {
          if (activeHighlight) {
            activeHighlight.dataset.color = button.dataset.color;
            saveScenario();
            hidePalette();
            return;
          }
          if (highlightRange) {
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(highlightRange);
          }
          highlightSelection(button.dataset.color);
        });
      });

      highlightRemoveButton.addEventListener('click', () => {
        if (activeHighlight) {
          const textNode = document.createTextNode(activeHighlight.textContent);
          activeHighlight.replaceWith(textNode);
          activeHighlight = null;
          saveScenario();
        }
        hidePalette();
      });

      document.addEventListener('mousedown', (event) => {
        if (!highlightPalette.contains(event.target) && !scenarioBody.contains(event.target)) {
          hidePalette();
        }
      });
      scenarioSearchInput.addEventListener('input', () => {
        const query = scenarioSearchInput.value.trim();
        const marks = scenarioBody.querySelectorAll('mark[data-search]');
        marks.forEach((mark) => {
          const textNode = document.createTextNode(mark.textContent);
          mark.replaceWith(textNode);
        });
        if (!query) {
          return;
        }
        const regex = new RegExp(query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
        scenarioBody.innerHTML = scenarioBody.innerHTML.replace(/<mark data-search="true">(.*?)<\/mark>/g, '$1');
        scenarioBody.innerHTML = scenarioBody.innerHTML.replace(regex, (match) => {
          return `<mark data-search="true">${match}</mark>`;
        });
        const first = scenarioBody.querySelector('mark[data-search]');
        if (first) {
          first.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      });

      const openFlashcardModal = () => {
        flashcardModal.dataset.open = 'true';
        flashcardModal.setAttribute('aria-hidden', 'false');
        renderFlashcard();
      };

      const closeFlashcardModal = () => {
        flashcardModal.dataset.open = 'false';
        flashcardModal.setAttribute('aria-hidden', 'true');
      };

      const renderFlashcard = () => {
        const keywords = flashcards[flashcardIndex % flashcards.length];
        flashcardKeywordsList.innerHTML = '';
        keywords.forEach((word) => {
          const li = document.createElement('li');
          li.textContent = word;
          flashcardKeywordsList.appendChild(li);
        });
        const progressValue = ((flashcardIndex % flashcards.length) + 1) / flashcards.length;
        flashcardProgress.style.width = `${progressValue * 100}%`;
        flashcardProgressModal.style.width = `${progressValue * 100}%`;
        flashcardProgressLabel.textContent = `${(flashcardIndex % flashcards.length) + 1} / ${flashcards.length}`;
      };

      flashcardButton.addEventListener('click', openFlashcardModal);
      flashcardCloseButtons.forEach((button) => button.addEventListener('click', closeFlashcardModal));
      flashcardNextButton.addEventListener('click', () => {
        flashcardIndex = (flashcardIndex + 1) % flashcards.length;
        renderFlashcard();
      });

      const updateTimerDisplay = () => {
        const minutes = Math.floor(timerRemaining / 60)
          .toString()
          .padStart(2, '0');
        const seconds = (timerRemaining % 60).toString().padStart(2, '0');
        timerText.textContent = `${minutes}:${seconds}`;
        timerDisplay.dataset.warning = timerRemaining <= 10 * 60;
        if (timerRemaining <= 0 && timerInterval) {
          clearInterval(timerInterval);
          timerInterval = null;
        }
      };

      timerStartButton.addEventListener('click', () => {
        if (timerInterval) return;
        const confirmed = window.confirm('タイマーを開始しますか？');
        if (!confirmed) return;
        timerRemaining = 80 * 60;
        updateTimerDisplay();
        timerInterval = setInterval(() => {
          timerRemaining -= 1;
          updateTimerDisplay();
          if (timerRemaining <= 0) {
            clearInterval(timerInterval);
            timerInterval = null;
            alert('80分が経過しました。採点ガイドで最終確認しましょう。');
          }
        }, 1000);
      });

      const initialize = () => {
        buildQuestionList();
        renderGuide();
        updateAnswerView();
        flashcardProgress.style.width = '0%';
        flashcardProgressModal.style.width = '0%';
        flashcardProgressLabel.textContent = `0 / ${flashcards.length}`;
      };

      initialize();
    </script>
  </body>
</html>
