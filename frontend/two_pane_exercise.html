<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>診断士二次 演習UIプロトタイプ</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@700&family=Noto+Sans+JP:wght@400;500;700&family=Noto+Sans+Mono:wght@500&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css"
    />
    <style>
      body[data-app="exercise"] {
        /* カラーと余白のカスタムプロパティ */
        --color-bg: #f6f8fb;
        --color-surface: #ffffff;
        --color-text: #1f2a3d;
        --color-text-strong: #0f1b2d;
        --color-border: rgba(31, 42, 61, 0.12);
        --color-chip-bg: rgba(47, 90, 168, 0.12);
        --color-chip-active: #2f5aa8;
        --color-chip-active-text: #ffffff;
        --color-warning: #c0504d;
        --color-text-muted: #667185;
        --color-layer-subtle: #eef2fb;
        --color-layer-soft: #e3e9f7;
        --color-focus-ring: rgba(47, 90, 168, 0.45);
        --radius-card: 16px;
        --spacing-xl: 40px;
        --spacing-lg: 32px;
        --spacing-md: 16px;
        --spacing-sm: 12px;
        --spacing-xs: 8px;
        --transition-duration: 200ms;
        --font-heading-xl: clamp(1.9rem, 1.6rem + 0.5vw, 2.2rem);
        --font-heading-lg: clamp(1.45rem, 1.3rem + 0.3vw, 1.6rem);
        --font-heading-md: clamp(1.2rem, 1.12rem + 0.2vw, 1.32rem);
        --content-max-width: min(720px, 100%);
        --icon-size-sm: 1rem;
        --icon-size-md: 1.25rem;
        font-size: 16px;
      }

      @media (prefers-color-scheme: dark) {
        body[data-app="exercise"] {
          --color-bg: #0f1727;
          --color-surface: rgba(18, 26, 44, 0.92);
          --color-text: #e5ecf8;
          --color-text-strong: #f6f8ff;
          --color-border: rgba(229, 236, 248, 0.16);
          --color-chip-bg: rgba(94, 130, 207, 0.18);
          --color-chip-active: #6f9bf5;
          --color-chip-active-text: #0f1727;
          --color-warning: #f87171;
          --color-text-muted: rgba(229, 236, 248, 0.75);
          --color-layer-subtle: rgba(94, 130, 207, 0.18);
          --color-layer-soft: rgba(121, 157, 228, 0.22);
          --color-focus-ring: rgba(111, 155, 245, 0.55);
        }
      }

      body[data-app="exercise"] *,
      body[data-app="exercise"] *::before,
      body[data-app="exercise"] *::after {
        box-sizing: border-box;
      }

      body[data-app="exercise"] {
        margin: 0;
        font-family: "Noto Sans JP", system-ui, -apple-system, BlinkMacSystemFont,
          "Segoe UI", sans-serif;
        background-color: var(--color-bg);
        color: var(--color-text);
        line-height: 1.6;
        text-rendering: optimizeLegibility;
      }

      body[data-app="exercise"] h1,
      body[data-app="exercise"] .heading-xl {
        font-size: var(--font-heading-xl);
        font-weight: 700;
        line-height: 1.28;
        letter-spacing: 0.01em;
        margin: 0 0 var(--spacing-sm);
        font-family: "M PLUS Rounded 1c", "Noto Sans JP", sans-serif;
        color: var(--color-text-strong);
      }

      body[data-app="exercise"] h2,
      body[data-app="exercise"] .heading-lg {
        font-size: var(--font-heading-lg);
        font-weight: 700;
        line-height: 1.3;
        margin: 0 0 var(--spacing-sm);
        font-family: "M PLUS Rounded 1c", "Noto Sans JP", sans-serif;
        color: var(--color-text-strong);
      }

      body[data-app="exercise"] h3,
      body[data-app="exercise"] .heading-md {
        font-size: var(--font-heading-md);
        font-weight: 700;
        line-height: 1.35;
        margin: 0 0 var(--spacing-xs);
        font-family: "M PLUS Rounded 1c", "Noto Sans JP", sans-serif;
        color: var(--color-text-strong);
      }

      body[data-app="exercise"] p {
        margin: 0 0 var(--spacing-sm);
      }

      body[data-app="exercise"] p,
      body[data-app="exercise"] li,
      body[data-app="exercise"] dd {
        font-size: 0.95rem;
        line-height: 1.75;
      }

      body[data-app="exercise"] small,
      body[data-app="exercise"] .text-muted {
        font-size: 0.85rem;
        line-height: 1.6;
      }

      body[data-app="exercise"] .text-muted {
        color: var(--color-text-muted);
      }

      body[data-app="exercise"] a {
        color: inherit;
      }

      body[data-app="exercise"] .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
      }

      body[data-app="exercise"] a:focus-visible,
      body[data-app="exercise"] button:focus-visible,
      body[data-app="exercise"] textarea:focus-visible,
      body[data-app="exercise"] [role="button"]:focus-visible {
        outline: none;
        box-shadow: 0 0 0 3px var(--color-focus-ring);
        border-radius: 8px;
      }

      body[data-app="exercise"] .ui-button {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: var(--spacing-xs);
        padding: 10px 16px;
        border-radius: 999px;
        border: 1px solid var(--color-border);
        background-color: var(--color-surface);
        color: var(--color-text-strong);
        font-size: 0.95rem;
        font-weight: 600;
        letter-spacing: 0.01em;
        cursor: pointer;
        line-height: 1.35;
        transition: background-color var(--transition-duration) ease,
          color var(--transition-duration) ease,
          border-color var(--transition-duration) ease,
          box-shadow var(--transition-duration) ease,
          transform var(--transition-duration) ease;
      }

      body[data-app="exercise"] .icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: var(--icon-size-md);
        line-height: 1;
      }

      body[data-app="exercise"] .icon--sm {
        font-size: var(--icon-size-sm);
      }

      body[data-app="exercise"] .ui-button:focus-visible {
        border-radius: 999px;
      }

      body[data-app="exercise"] .ui-button:hover {
        border-color: var(--color-chip-active);
      }

      body[data-app="exercise"] .ui-button--lg {
        padding: 12px 20px;
        font-size: 1rem;
      }

      body[data-app="exercise"] .ui-button--primary {
        background-color: var(--color-chip-active);
        border-color: var(--color-chip-active);
        color: var(--color-chip-active-text);
        font-weight: 700;
      }

      body[data-app="exercise"] .ui-button--primary:hover,
      body[data-app="exercise"] .ui-button--primary:focus-visible {
        box-shadow: 0 0 0 3px var(--color-focus-ring);
        transform: translateY(-1px);
      }

      body[data-app="exercise"] .ui-button--subtle {
        justify-content: flex-start;
        padding: var(--spacing-xs) var(--spacing-sm);
        background-color: var(--color-layer-subtle);
        border-color: transparent;
        color: var(--color-text);
        font-size: 0.92rem;
      }

      body[data-app="exercise"] .ui-button--subtle:hover,
      body[data-app="exercise"] .ui-button--subtle:focus-visible {
        background-color: color-mix(
          in srgb,
          var(--color-chip-active) 18%,
          var(--color-layer-subtle)
        );
        border-color: transparent;
        color: var(--color-text-strong);
      }

      body[data-app="exercise"] .app-shell {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        gap: var(--spacing-lg);
      }

      body[data-app="exercise"] .app-header {
        position: sticky;
        top: 0;
        z-index: 10;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: var(--spacing-md);
        padding: 16px var(--spacing-lg);
        background-color: color-mix(
          in srgb,
          var(--color-bg) 85%,
          var(--color-surface)
        );
        border-bottom: 1px solid color-mix(
          in srgb,
          var(--color-border) 70%,
          transparent
        );
        backdrop-filter: blur(16px);
      }

      body[data-app="exercise"] .app-header__group {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
      }

      body[data-app="exercise"] .app-header__quicknav {
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
        margin-left: auto;
      }

      body[data-app="exercise"] .app-header__anchor {
        appearance: none;
        border: none;
        background: transparent;
        color: var(--color-text-muted);
        font-weight: 600;
        font-size: 0.92rem;
        padding: var(--spacing-xs) var(--spacing-sm);
        border-radius: 999px;
        cursor: pointer;
        position: relative;
        transition: background-color var(--transition-duration) ease,
          color var(--transition-duration) ease;
      }

      body[data-app="exercise"] .app-header__anchor::after {
        content: "";
        position: absolute;
        inset-inline: var(--spacing-xs);
        bottom: calc(var(--spacing-xs) * -0.5);
        height: 2px;
        background-color: transparent;
        border-radius: 999px;
        transition: background-color var(--transition-duration) ease,
          transform var(--transition-duration) ease;
        transform: scaleX(0);
        transform-origin: center;
      }

      body[data-app="exercise"] .app-header__anchor:hover,
      body[data-app="exercise"] .app-header__anchor:focus-visible {
        color: var(--color-text-strong);
        background-color: color-mix(
          in srgb,
          var(--color-chip-bg) 70%,
          transparent
        );
      }

      body[data-app="exercise"] .app-header__anchor:focus-visible {
        outline: none;
        box-shadow: 0 0 0 3px var(--color-focus-ring);
      }

      body[data-app="exercise"] .app-header__anchor[data-active="true"] {
        color: var(--color-chip-active);
      }

      body[data-app="exercise"] .app-header__anchor[data-active="true"]::after {
        background-color: var(--color-chip-active);
        transform: scaleX(1);
      }

      body[data-app="exercise"] .app-header__title {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      body[data-app="exercise"] .app-header__title h1 {
        margin: 0;
        font-size: 1.25rem;
        font-weight: 700;
      }

      body[data-app="exercise"] .app-header__title span {
        font-size: 0.85rem;
        color: var(--color-text-muted);
      }

      body[data-app="exercise"] .app-header__button {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: var(--spacing-xs);
        padding: 10px 14px;
        border-radius: 999px;
        border: 1px solid var(--color-border);
        background-color: var(--color-surface);
        color: var(--color-text-strong);
        font-weight: 600;
        cursor: pointer;
        transition: border-color var(--transition-duration) ease,
          box-shadow var(--transition-duration) ease;
      }

      body[data-app="exercise"] .app-header__button:hover,
      body[data-app="exercise"] .app-header__button:focus-visible {
        border-color: var(--color-chip-active);
        box-shadow: 0 0 0 3px var(--color-focus-ring);
      }

      body[data-app="exercise"] .app-header__icon {
        font-size: var(--icon-size-md);
        color: currentColor;
      }

      body[data-app="exercise"] .app-progress {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        padding: 0 var(--spacing-lg);
      }

      body[data-app="exercise"] .progress-indicator {
        flex: 1;
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        padding: var(--spacing-sm) var(--spacing-md);
        border-radius: 14px;
        border: none;
        background-color: var(--color-layer-subtle);
        box-shadow: 0 8px 20px rgba(15, 23, 39, 0.08);
      }

      body[data-app="exercise"] .progress-indicator__bar {
        position: relative;
        flex: 1;
        height: 8px;
        border-radius: 999px;
        background-color: var(--color-layer-soft);
        overflow: hidden;
      }

      body[data-app="exercise"] .progress-indicator__bar span {
        display: block;
        height: 100%;
        width: 45%;
        border-radius: inherit;
        background: linear-gradient(
          90deg,
          var(--color-chip-active) 0%,
          color-mix(in srgb, var(--color-chip-active) 80%, transparent) 100%
        );
      }

      body[data-app="exercise"] .progress-indicator__meta {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        font-size: 0.9rem;
      }

      body[data-app="exercise"] .progress-indicator__spinner {
        width: 20px;
        height: 20px;
        border-radius: 999px;
        border: 2px solid color-mix(
          in srgb,
          var(--color-chip-active) 30%,
          transparent
        );
        border-top-color: var(--color-chip-active);
        animation: exercise-spinner 1s linear infinite;
      }

      body[data-app="exercise"] .layout {
        display: flex;
        align-items: flex-start;
        gap: var(--spacing-xl);
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 var(--spacing-lg) calc(var(--spacing-xl) + var(--spacing-lg));
        width: 100%;
      }

      body[data-app="exercise"] .context-pane {
        position: sticky;
        top: var(--spacing-lg);
        max-height: calc(100vh - var(--spacing-lg) * 2);
        overflow-y: auto;
        flex: 0 0 380px;
        padding: var(--spacing-lg) var(--spacing-md);
        border: none;
        border-radius: var(--radius-card);
        background-color: var(--color-layer-soft);
        box-shadow: 0 18px 36px rgba(15, 23, 39, 0.1);
      }

      @media (prefers-color-scheme: dark) {
        body[data-app="exercise"] .context-pane {
          background-color: var(--color-surface);
        }
      }

      body[data-app="exercise"] .context-pane__header {
        margin-bottom: var(--spacing-md);
      }

      body[data-app="exercise"] .context-pane__miniheader {
        display: flex;
        flex-wrap: wrap;
        gap: var(--spacing-xs);
        align-items: center;
        font-size: 0.9rem;
        color: var(--color-text-muted);
      }

      body[data-app="exercise"] .context-pane__miniheader strong {
        color: var(--color-text);
      }

      body[data-app="exercise"] .context-pane__meta {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: var(--spacing-xs) var(--spacing-sm);
        font-size: 0.88rem;
        color: var(--color-text-muted);
        font-family: "Noto Sans Mono", "Noto Sans JP", monospace;
      }

      body[data-app="exercise"] .context-pane__meta dt {
        font-weight: 600;
        letter-spacing: 0.02em;
      }

      body[data-app="exercise"] .context-pane__body {
        font-size: 1rem;
        white-space: pre-line;
      }

      body[data-app="exercise"] .exercise {
        flex: 1 1 auto;
        display: flex;
        flex-direction: column;
        gap: var(--spacing-lg);
        min-width: 0;
      }

      body[data-app="exercise"] .exercise__controls {
        display: grid;
        gap: var(--spacing-md);
        width: var(--content-max-width);
        margin: 0 auto;
      }

      body[data-app="exercise"] .control-card {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-sm);
        padding: var(--spacing-md);
        border-radius: var(--radius-card);
        border: none;
        background-color: var(--color-layer-subtle);
        box-shadow: 0 10px 24px rgba(15, 23, 39, 0.06);
      }

      body[data-app="exercise"] .search-field {
        position: relative;
        display: flex;
        align-items: center;
      }

      body[data-app="exercise"] .search-field input {
        width: 100%;
        padding: 12px 16px 12px 42px;
        border-radius: 12px;
        border: 1px solid var(--color-border);
        background-color: var(--color-bg);
        font-size: 0.95rem;
      }

      body[data-app="exercise"] .search-field__icon {
        position: absolute;
        left: 14px;
        color: var(--color-text-muted);
      }

      body[data-app="exercise"] .search-field__icon .bx {
        color: var(--color-text-muted);
      }

      body[data-app="exercise"] .filter-chips {
        display: flex;
        flex-wrap: wrap;
        gap: var(--spacing-xs);
      }

      body[data-app="exercise"] .filter-chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 8px 12px;
        border-radius: 999px;
        border: 1px solid var(--color-border);
        background-color: var(--color-chip-bg);
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        transition: border-color var(--transition-duration) ease,
          background-color var(--transition-duration) ease;
      }

      body[data-app="exercise"] .filter-chip .icon {
        color: inherit;
      }

      body[data-app="exercise"] .filter-chip[data-active="true"] {
        background-color: var(--color-chip-active);
        border-color: var(--color-chip-active);
        color: var(--color-chip-active-text);
      }

      body[data-app="exercise"] .question-index {
        display: grid;
        gap: var(--spacing-xs);
        padding-left: 1.25rem;
        margin: 0;
        color: var(--color-text);
      }

      body[data-app="exercise"] .question-index a {
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
        padding: 6px 0;
        color: inherit;
        font-weight: 600;
      }

      body[data-app="exercise"] .reference-card {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-xs);
        padding: var(--spacing-md);
        border-radius: var(--radius-card);
        border: 1px solid var(--color-border);
        background-color: var(--color-bg);
        color: var(--color-text);
      }

      body[data-app="exercise"] .reference-card__body {
        font-size: 0.92rem;
        color: var(--color-text-muted);
      }

      body[data-app="exercise"] .strategy-card-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: var(--spacing-sm);
        margin-top: var(--spacing-sm);
      }

      body[data-app="exercise"] .strategy-card {
        position: relative;
        border: none;
        border-radius: 12px;
        padding: var(--spacing-sm) var(--spacing-md);
        text-align: left;
        font-weight: 600;
        font-size: 0.95rem;
        background: color-mix(in srgb, var(--color-chip-bg) 80%, transparent);
        color: var(--color-text-strong);
        cursor: pointer;
        transition: transform var(--transition-duration) ease,
          box-shadow var(--transition-duration) ease,
          background-color var(--transition-duration) ease;
      }

      body[data-app="exercise"] .strategy-card:hover,
      body[data-app="exercise"] .strategy-card:focus-visible {
        transform: translateY(-2px);
        box-shadow: 0 12px 20px rgba(27, 35, 55, 0.12);
        background: color-mix(in srgb, var(--color-chip-active) 18%, var(--color-bg));
        color: var(--color-text-strong);
      }

      body[data-app="exercise"] .strategy-card[aria-pressed="true"] {
        background: color-mix(in srgb, var(--color-chip-active) 24%, var(--color-bg));
        color: var(--color-chip-active-text);
        box-shadow: 0 16px 24px rgba(27, 35, 55, 0.18);
      }

      body[data-app="exercise"] .strategy-card:focus-visible {
        outline: none;
        box-shadow: 0 0 0 3px var(--color-focus-ring),
          0 12px 20px rgba(27, 35, 55, 0.12);
      }

      body[data-app="exercise"] .strategy-card[data-tooltip]:hover::after,
      body[data-app="exercise"] .strategy-card[data-tooltip]:focus-visible::after {
        content: attr(data-tooltip);
        position: absolute;
        inset-inline-start: 16px;
        inset-block-end: calc(100% + var(--spacing-xs));
        padding: 6px 10px;
        border-radius: 8px;
        background: var(--color-text-strong);
        color: var(--color-chip-active-text);
        font-size: 0.8rem;
        white-space: nowrap;
        box-shadow: 0 8px 20px rgba(27, 35, 55, 0.16);
        z-index: 3;
      }

      body[data-app="exercise"] .strategy-card__preview {
        margin-top: var(--spacing-xs);
        padding: var(--spacing-xs) var(--spacing-sm);
        border-radius: 10px;
        background: var(--color-layer-subtle);
        color: var(--color-text);
        font-size: 0.85rem;
        line-height: 1.6;
      }

      body[data-app="exercise"] .strategy-card__preview[hidden] {
        display: none;
      }

      body[data-app="exercise"] .exercise__tabs {
        position: sticky;
        top: var(--spacing-lg);
        z-index: 5;
        display: flex;
        gap: var(--spacing-sm);
        padding: var(--spacing-sm) var(--spacing-md);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-card);
        background-color: var(--color-bg);
        background: linear-gradient(
          180deg,
          var(--color-bg) 0%,
          color-mix(in srgb, var(--color-bg) 60%, transparent)
        );
        overflow-x: auto;
        scroll-snap-type: x mandatory;
        scrollbar-width: thin;
        width: var(--content-max-width);
        margin-inline: auto;
      }

      body[data-app="exercise"] .exercise__tabs::-webkit-scrollbar {
        height: 6px;
      }

      body[data-app="exercise"] .exercise__tabs::-webkit-scrollbar-thumb {
        background-color: rgba(27, 35, 55, 0.25);
        border-radius: 999px;
      }

      body[data-app="exercise"] .exercise-tab {
        display: inline-flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 2px;
        min-width: 168px;
        padding: 10px 14px;
        border-radius: 14px;
        border: 1px solid transparent;
        background-color: var(--color-chip-bg);
        color: var(--color-text);
        font-size: 0.95rem;
        font-weight: 600;
        letter-spacing: 0.01em;
        cursor: pointer;
        transition: background-color var(--transition-duration) ease,
          color var(--transition-duration) ease,
          border-color var(--transition-duration) ease,
          box-shadow var(--transition-duration) ease;
        scroll-snap-align: start;
      }

      body[data-app="exercise"] .exercise-tab__label {
        font-family: "Noto Sans Mono", "Noto Sans JP", monospace;
        font-size: 0.78rem;
        text-transform: uppercase;
        color: var(--color-text-muted);
      }

      body[data-app="exercise"] .exercise-tab__title {
        font-family: "M PLUS Rounded 1c", "Noto Sans JP", sans-serif;
        font-weight: 700;
        color: var(--color-text-strong);
      }

      body[data-app="exercise"] .exercise-tab:hover,
      body[data-app="exercise"] .exercise-tab:focus-visible {
        border-color: var(--color-chip-active);
        box-shadow: 0 0 0 3px var(--color-focus-ring);
      }

      body[data-app="exercise"] .exercise-tab[aria-selected="true"] {
        background-color: var(--color-chip-active);
        color: var(--color-chip-active-text);
      }

      body[data-app="exercise"] .exercise-tab[aria-selected="true"] .exercise-tab__label,
      body[data-app="exercise"] .exercise-tab[aria-selected="true"] .exercise-tab__title {
        color: var(--color-chip-active-text);
      }

      body[data-app="exercise"] .exercise__questions {
        display: grid;
        gap: var(--spacing-xl);
        justify-items: center;
        padding-block: var(--spacing-sm) var(--spacing-xl);
      }

      @keyframes exercise-spinner {
        to {
          transform: rotate(360deg);
        }
      }

      body[data-app="exercise"] .question-card {
        position: relative;
        width: var(--content-max-width);
        padding: calc(var(--spacing-lg) + var(--spacing-sm));
        border-radius: var(--radius-card);
        border: 1px solid var(--color-border);
        background-color: var(--color-surface);
        box-shadow: 0 12px 32px rgba(15, 23, 39, 0.08);
        transition: box-shadow var(--transition-duration) ease,
          transform var(--transition-duration) ease;
      }

      body[data-app="exercise"] .question-card:hover,
      body[data-app="exercise"] .question-card:focus-within {
        box-shadow: 0 16px 36px rgba(15, 23, 39, 0.14);
        transform: translateY(-2px);
      }

      body[data-app="exercise"] .question-card__header {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: var(--spacing-sm);
        margin-bottom: var(--spacing-md);
      }

      body[data-app="exercise"] .question-card__badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
        border-radius: 12px;
        background-color: var(--color-chip-active);
        color: var(--color-chip-active-text);
        font-weight: 700;
        font-family: "Noto Sans Mono", "Noto Sans JP", monospace;
      }

      body[data-app="exercise"] .question-card__title {
        font-size: 1.15rem;
        font-weight: 700;
        margin: 0;
        font-family: "M PLUS Rounded 1c", "Noto Sans JP", sans-serif;
        color: var(--color-text-strong);
      }

      body[data-app="exercise"] .question-card__meta {
        margin-left: auto;
        display: flex;
        gap: var(--spacing-sm);
        font-size: 0.9rem;
        color: var(--color-text-muted);
        font-family: "Noto Sans Mono", "Noto Sans JP", monospace;
      }

      body[data-app="exercise"] .question-card__body {
        margin-bottom: var(--spacing-md);
      }

      body[data-app="exercise"] .question-card__input {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-xs);
      }

      body[data-app="exercise"] .question-card__tools {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: var(--spacing-xs);
      }

      body[data-app="exercise"] .question-card__textarea {
        width: 100%;
        min-height: 160px;
        padding: var(--spacing-sm);
        border-radius: 12px;
        border: 1px solid var(--color-border);
        background-color: var(--color-surface);
        color: inherit;
        font-size: 1rem;
        resize: vertical;
        transition: border-color var(--transition-duration) ease,
          box-shadow var(--transition-duration) ease;
      }

      @media (prefers-color-scheme: dark) {
        body[data-app="exercise"] .question-card__textarea {
          background-color: var(--color-surface);
          border-color: var(--color-border);
        }
      }

      body[data-app="exercise"] .question-card__textarea:focus {
        border-color: var(--color-chip-active);
      }

      body[data-app="exercise"] .char-counter {
        align-self: flex-end;
        margin-left: auto;
        font-size: 0.85rem;
        color: var(--color-text-muted);
        font-family: "Noto Sans Mono", "Noto Sans JP", monospace;
      }

      body[data-app="exercise"] .char-counter--limit {
        color: var(--color-warning);
        font-weight: 600;
      }

      body[data-app="exercise"] .support-block {
        border-top: 1px solid color-mix(
          in srgb,
          var(--color-border) 70%,
          transparent
        );
        padding-top: var(--spacing-sm);
        margin-top: var(--spacing-md);
        font-size: 0.9rem;
      }

      body[data-app="exercise"] .support-block__toggle {
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-color: transparent;
        color: var(--color-text);
        gap: var(--spacing-sm);
      }

      body[data-app="exercise"] .support-block__toggle:hover,
      body[data-app="exercise"] .support-block__toggle:focus-visible {
        color: var(--color-text-strong);
      }

      body[data-app="exercise"] .support-block__toggle[aria-expanded="true"] {
        background-color: color-mix(
          in srgb,
          var(--color-chip-active) 18%,
          var(--color-layer-subtle)
        );
        border-color: transparent;
        color: var(--color-text-strong);
      }

      body[data-app="exercise"] .support-block__content {
        margin-top: var(--spacing-xs);
        padding: var(--spacing-xs) var(--spacing-sm);
        border-radius: 8px;
        background-color: var(--color-layer-subtle);
        color: var(--color-text-muted);
      }

      body[data-app="exercise"] .support-block__content[hidden] {
        display: none;
      }

      @media (prefers-color-scheme: dark) {
        body[data-app="exercise"] .support-block__content {
          background-color: color-mix(
            in srgb,
            var(--color-chip-bg) 55%,
            transparent
          );
        }
      }

      body[data-app="exercise"] .support-block__label {
        font-weight: 600;
        letter-spacing: 0.01em;
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
      }

      body[data-app="exercise"] .support-block__chevron {
        flex-shrink: 0;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 999px;
        font-size: var(--icon-size-sm);
        transition: transform var(--transition-duration) ease,
          color var(--transition-duration) ease;
      }

      body[data-app="exercise"]
        .support-block__toggle[aria-expanded="true"]
        .support-block__chevron {
        color: var(--color-chip-active);
        transform: rotate(180deg);
      }

      body[data-app="exercise"] .support-block__icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 28px;
        height: 28px;
        border-radius: 10px;
        background-color: color-mix(
          in srgb,
          var(--color-chip-bg) 55%,
          transparent
        );
        color: var(--color-chip-active);
        font-size: var(--icon-size-sm);
        transition: background-color var(--transition-duration) ease,
          color var(--transition-duration) ease;
      }

      body[data-app="exercise"] .support-block__toggle:hover .support-block__icon,
      body[data-app="exercise"] .support-block__toggle:focus-visible .support-block__icon,
      body[data-app="exercise"] .support-block__toggle[aria-expanded="true"]
        .support-block__icon {
        background-color: var(--color-chip-active);
        color: var(--color-chip-active-text);
      }

      @media (prefers-color-scheme: dark) {
        body[data-app="exercise"] .support-block__icon {
          background-color: rgba(111, 155, 245, 0.28);
          color: var(--color-chip-active-text);
        }
      }

      body[data-app="exercise"] .analysis-info {
        margin-top: var(--spacing-xs);
        padding: var(--spacing-xs) var(--spacing-sm);
        border-radius: 8px;
        background: var(--color-layer-subtle);
        font-size: 0.85rem;
        color: var(--color-text);
      }

      body[data-app="exercise"] .analysis-info[hidden] {
        display: none;
      }

      body[data-app="exercise"] .analysis-info__trigger {
        border: none;
        background: transparent;
        color: var(--color-text-muted);
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        transition: background-color var(--transition-duration) ease,
          color var(--transition-duration) ease;
      }

      body[data-app="exercise"] .analysis-info__trigger:hover,
      body[data-app="exercise"] .analysis-info__trigger:focus-visible,
      body[data-app="exercise"] .analysis-info__trigger[aria-expanded="true"] {
        color: var(--color-chip-active);
        background-color: color-mix(
          in srgb,
          var(--color-chip-bg) 60%,
          transparent
        );
      }

      body[data-app="exercise"] .analysis-info__icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: var(--icon-size-md);
        line-height: 1;
      }

      body[data-app="exercise"] .analysis-info__meta {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: var(--spacing-xs);
        margin-top: var(--spacing-xs);
      }

      body[data-app="exercise"] .analysis-info__meta a {
        color: var(--color-chip-active);
        font-weight: 600;
        font-size: 0.82rem;
      }

      body[data-app="exercise"] .analysis-info__meta a:hover,
      body[data-app="exercise"] .analysis-info__meta a:focus-visible {
        text-decoration: underline;
      }

      body[data-app="exercise"] .text-highlight {
        background: var(--color-layer-subtle);
        padding-inline: 2px;
        border-radius: 4px;
      }

      body[data-app="exercise"] .shortcut-launcher {
        border: none;
        background: transparent;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: var(--color-text-muted);
        cursor: pointer;
        border-radius: 50%;
        width: 36px;
        height: 36px;
        transition: background-color var(--transition-duration) ease,
          color var(--transition-duration) ease;
      }

      body[data-app="exercise"] .shortcut-launcher:hover,
      body[data-app="exercise"] .shortcut-launcher:focus-visible {
        color: var(--color-chip-active);
        background-color: color-mix(
          in srgb,
          var(--color-chip-bg) 55%,
          transparent
        );
      }

      body[data-app="exercise"] .shortcut-panel {
        position: fixed;
        inset: 0;
        display: grid;
        place-items: center;
        background: rgba(17, 24, 39, 0.45);
        backdrop-filter: blur(4px);
        z-index: 50;
      }

      body[data-app="exercise"] .shortcut-panel[hidden] {
        display: none;
      }

      body[data-app="exercise"] .shortcut-panel__dialog {
        background: var(--color-surface);
        color: var(--color-text);
        border-radius: 20px;
        padding: var(--spacing-lg);
        width: min(480px, 92vw);
        box-shadow: 0 24px 60px rgba(27, 35, 55, 0.25);
      }

      body[data-app="exercise"] .shortcut-panel__header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: var(--spacing-md);
      }

      body[data-app="exercise"] .shortcut-panel__list {
        display: grid;
        gap: var(--spacing-sm);
        font-size: 0.95rem;
      }

      body[data-app="exercise"] .shortcut-panel__item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: var(--spacing-sm);
        padding: var(--spacing-xs) var(--spacing-sm);
        border-radius: 12px;
        background: color-mix(in srgb, var(--color-chip-bg) 75%, transparent);
      }

      body[data-app="exercise"] .shortcut-panel__keys {
        font-family: "Noto Sans Mono", "Noto Sans JP", monospace;
        font-size: 0.85rem;
        display: inline-flex;
        gap: 6px;
      }

      body[data-app="exercise"] .shortcut-panel__keys span {
        padding: 4px 8px;
        border-radius: 6px;
        background: color-mix(in srgb, var(--color-chip-active) 12%, var(--color-bg));
        border: 1px solid color-mix(in srgb, var(--color-chip-active) 35%, transparent);
      }

      body[data-app="exercise"] .shortcut-panel__close {
        border: none;
        background: transparent;
        color: var(--color-text-muted);
        cursor: pointer;
        font-size: 1.2rem;
        line-height: 1;
        border-radius: 50%;
        width: 32px;
        height: 32px;
      }

      body[data-app="exercise"] .shortcut-panel__close:hover,
      body[data-app="exercise"] .shortcut-panel__close:focus-visible {
        color: var(--color-chip-active);
        background-color: color-mix(
          in srgb,
          var(--color-chip-bg) 50%,
          transparent
        );
      }

      body[data-app="exercise"] .retrieval-preview {
        margin-top: var(--spacing-lg);
        padding: var(--spacing-md);
        border-radius: var(--radius-card);
        background: var(--color-layer-soft);
        display: grid;
        gap: var(--spacing-sm);
      }

      body[data-app="exercise"] .retrieval-preview__header {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-xs);
      }

      body[data-app="exercise"] .retrieval-modal {
        position: fixed;
        inset: 0;
        display: grid;
        place-items: center;
        z-index: 60;
      }

      body[data-app="exercise"] .retrieval-modal[hidden] {
        display: none;
      }

      body[data-app="exercise"] .retrieval-modal__backdrop {
        position: absolute;
        inset: 0;
        background: rgba(10, 15, 28, 0.58);
        backdrop-filter: blur(4px);
      }

      body[data-app="exercise"] .retrieval-modal__dialog {
        position: relative;
        z-index: 1;
        width: min(560px, 92vw);
        border-radius: 20px;
        background: var(--color-surface);
        color: var(--color-text);
        padding: var(--spacing-lg);
        box-shadow: 0 24px 60px rgba(27, 35, 55, 0.3);
        display: grid;
        gap: var(--spacing-md);
      }

      body[data-app="exercise"] .retrieval-modal__header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: var(--spacing-sm);
      }

      body[data-app="exercise"] .retrieval-modal__body {
        min-height: 160px;
      }

      body[data-app="exercise"] .retrieval-card {
        display: grid;
        gap: var(--spacing-xs);
        background: var(--color-layer-subtle);
        border-radius: var(--radius-card);
        padding: var(--spacing-md);
        line-height: 1.65;
      }

      body[data-app="exercise"] .retrieval-card[hidden] {
        display: none;
      }

      body[data-app="exercise"] .retrieval-card__tag {
        font-size: 0.82rem;
        font-weight: 600;
        color: var(--color-chip-active);
      }

      body[data-app="exercise"] .retrieval-modal__controls {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: var(--spacing-sm);
      }

      body[data-app="exercise"] .retrieval-progress {
        display: flex;
        flex-direction: column;
        gap: 4px;
        font-size: 0.85rem;
        color: var(--color-text-muted);
        flex: 1;
      }

      body[data-app="exercise"] .retrieval-progress__bar {
        position: relative;
        height: 6px;
        border-radius: 999px;
        background: color-mix(in srgb, var(--color-chip-bg) 50%, transparent);
        overflow: hidden;
      }

      body[data-app="exercise"] .retrieval-progress__bar span {
        position: absolute;
        inset: 0;
        border-radius: inherit;
        background: var(--color-chip-active);
        transform-origin: left center;
        transform: scaleX(0);
        transition: transform var(--transition-duration) ease;
      }

      body[data-app="exercise"] .retrieval-modal__close {
        border: none;
        background: transparent;
        color: var(--color-text-muted);
        cursor: pointer;
        border-radius: 50%;
        width: 32px;
        height: 32px;
      }

      body[data-app="exercise"] .retrieval-modal__close:hover,
      body[data-app="exercise"] .retrieval-modal__close:focus-visible {
        color: var(--color-chip-active);
        background-color: color-mix(
          in srgb,
          var(--color-chip-bg) 50%,
          transparent
        );
      }

      body[data-app="exercise"] .question-card--active::after {
        content: "";
        position: absolute;
        inset: 0;
        border-radius: inherit;
        border: 2px solid var(--color-chip-active);
        pointer-events: none;
        animation: activePulse 2s ease;
      }

      @keyframes activePulse {
        0% {
          opacity: 1;
        }
        100% {
          opacity: 0;
        }
      }

      body[data-app="exercise"] .exercise__footer {
        position: sticky;
        bottom: 0;
        z-index: 10;
        margin-top: auto;
        background-color: var(--color-bg);
        background: linear-gradient(
          180deg,
          color-mix(in srgb, var(--color-bg) 90%, transparent) 0%,
          var(--color-bg) 55%,
          var(--color-bg) 100%
        );
        border-top: 1px solid var(--color-border);
        padding: var(--spacing-md) var(--spacing-md) calc(var(--spacing-md) + 4px);
        display: flex;
        justify-content: flex-end;
      }

      body[data-app="exercise"] .cta-button {
        gap: var(--spacing-xs);
      }

      body[data-app="exercise"] .cta-button__verb {
        font-family: "M PLUS Rounded 1c", "Noto Sans JP", sans-serif;
      }

      body[data-app="exercise"] .cta-button__object {
        font-family: "Noto Sans JP", sans-serif;
        font-weight: 600;
      }

      @media (max-width: 1024px) {
        body[data-app="exercise"] .context-pane {
          flex-basis: 320px;
        }
      }

      @media (max-width: 768px) {
        body[data-app="exercise"] .layout {
          flex-direction: column;
          gap: var(--spacing-lg);
        }

        body[data-app="exercise"] .context-pane {
          position: relative;
          top: auto;
          max-height: none;
          width: 100%;
          flex: 1 1 auto;
          order: 2;
        }

        body[data-app="exercise"] .exercise {
          order: 1;
          gap: var(--spacing-lg);
        }

        body[data-app="exercise"] .exercise__tabs {
          position: sticky;
          top: 0;
        }

        body[data-app="exercise"] .app-progress {
          flex-direction: column;
          align-items: stretch;
          padding: 0 var(--spacing-md);
        }

        body[data-app="exercise"] .progress-indicator {
          flex-direction: column;
          align-items: flex-start;
          gap: var(--spacing-sm);
        }

        body[data-app="exercise"] .progress-indicator__meta {
          width: 100%;
          justify-content: space-between;
        }
      }

      @media (max-width: 960px) {
        body[data-app="exercise"] .app-header {
          flex-wrap: wrap;
          justify-content: center;
          gap: var(--spacing-sm);
        }

        body[data-app="exercise"] .app-header__group:last-of-type {
          order: 2;
        }

        body[data-app="exercise"] .app-header__quicknav {
          order: 3;
          width: 100%;
          justify-content: center;
          flex-wrap: wrap;
          padding-top: var(--spacing-xs);
        }
      }

      @media (max-width: 600px) {
        body[data-app="exercise"] .layout {
          padding: var(--spacing-md);
        }

        body[data-app="exercise"] .context-pane__miniheader {
          position: sticky;
          top: 0;
          z-index: 10;
          display: flex;
          flex-wrap: wrap;
          gap: var(--spacing-xs);
          align-items: center;
          padding: var(--spacing-xs) 0;
          background-color: var(--color-bg);
        }

        body[data-app="exercise"] .context-pane__miniheader a {
          color: var(--color-chip-active);
          font-size: 0.85rem;
          text-decoration: underline;
        }
      }
    </style>
  </head>
  <body data-app="exercise">
    <div class="app-shell">
      <header class="app-header" role="banner">
        <div class="app-header__group">
          <button
            class="app-header__button"
            type="button"
            aria-label="演習一覧に戻る"
          >
            <span class="icon app-header__icon" aria-hidden="true">
              <i class="bx bx-left-arrow-alt"></i>
            </span>
            戻る
          </button>
          <div class="app-header__title">
            <h1>診断士二次 演習ハブ</h1>
            <span>事例I / 令和6年度</span>
          </div>
        </div>
        <div class="app-header__group" role="navigation" aria-label="主要操作">
          <button class="app-header__button" type="button">
            <span class="icon app-header__icon" aria-hidden="true">
              <i class="bx bx-search"></i>
            </span>
            検索
          </button>
          <button class="app-header__button" type="button">
            <span class="icon app-header__icon" aria-hidden="true">
              <i class="bx bx-filter"></i>
            </span>
            フィルタ
          </button>
          <button
            class="shortcut-launcher"
            type="button"
            aria-label="キーボードショートカットを表示"
            data-shortcut-open
          >
            <span class="icon" aria-hidden="true">
              <i class="bx bx-keyboard"></i>
            </span>
          </button>
        </div>
        <nav
          class="app-header__quicknav"
          aria-label="セクションへのショートカット"
        >
          <button class="app-header__anchor" type="button" data-target="section-overview">
            設問概要
          </button>
          <button class="app-header__anchor" type="button" data-target="section-scenario">
            与件文
          </button>
          <button class="app-header__anchor" type="button" data-target="section-retrieval">
            リトリーバル
          </button>
          <button class="app-header__anchor" type="button" data-target="section-answer">
            解答
          </button>
        </nav>
      </header>
      <section class="app-progress" aria-label="進捗状況">
        <div class="progress-indicator" role="status">
          <div class="progress-indicator__spinner" aria-hidden="true"></div>
          <div class="progress-indicator__bar" aria-hidden="true">
            <span></span>
          </div>
          <div class="progress-indicator__meta">
            <span>問題を読み込み中</span>
            <span aria-label="残り時間 約32分">
              ⏱️ <time datetime="PT32M">32分</time>
            </span>
          </div>
          <span class="sr-only">問題を読み込み中です</span>
        </div>
      </section>
      <div class="layout">
        <aside
          id="section-scenario"
          class="context-pane"
          role="region"
          aria-labelledby="context-heading"
        >
        <header class="context-pane__header">
          <div class="context-pane__miniheader">
            <strong>事例I 令和6年</strong>
            <a class="text-muted" href="#question-1">設問一覧へジャンプ</a>
          </div>
          <h1 id="context-heading">B製造業 与件文</h1>
          <dl class="context-pane__meta">
            <dt>業種</dt>
            <dd>精密機器製造</dd>
            <dt>従業員</dt>
            <dd>220名</dd>
            <dt>売上規模</dt>
            <dd>58億円</dd>
            <dt>キーワード</dt>
            <dd>技能伝承 / 開発連携</dd>
          </dl>
        </header>
        <div class="context-pane__body">
          <!-- 与件文を常時参照できるよう縦スクロール可能に配置 -->
          A社は創業40年の精密機器メーカーである。創業者の引退を契機に、
          2代目社長は設計部門のDX化と熟練技術者の技能伝承を最優先テーマ
          と定めた。設計BOMと生産BOMが分断されており、製品立ち上げ時の
          手戻りが多発している。また、顧客ニーズの高度化に伴い、多品種小
          ロットかつ短納期での開発対応が求められている。

          現状、設計段階での顧客折衝は営業部門が単独で担っており、設計の
          観点が十分に反映されていない。生産部門ではベテラン技能者の高齢
          化が進み、暗黙知の形式知化が急務となっている。社長は部門横断で
          の情報共有と意思決定スピードの改善を目指し、試験的にデジタル・
          コラボレーション基盤を導入した。

          今後は、設計段階からの顧客共創、外部パートナーとの連携強化、そ
          れに伴う評価制度の再設計が検討課題である。
        </div>
      </aside>

      <main class="exercise" role="main" aria-labelledby="exercise-heading">
        <h2 id="exercise-heading" class="sr-only">演習と設問</h2>
        <section
          id="section-overview"
          class="exercise__controls"
          aria-label="問題の検索と整理"
        >
          <div class="control-card" role="group" aria-labelledby="search-heading">
            <h3 id="search-heading" class="heading-md">問題検索</h3>
            <label class="sr-only" for="problem-search">問題文やキーワードを検索</label>
            <div class="search-field">
              <input
                id="problem-search"
                type="search"
                name="problem-search"
                placeholder="キーワードや設問番号で検索"
              />
              <span class="icon icon--sm search-field__icon" aria-hidden="true">
                <i class="bx bx-search"></i>
              </span>
            </div>
          </div>
          <div class="control-card" role="group" aria-labelledby="filter-heading">
            <h3 id="filter-heading" class="heading-md">検索フィルタ</h3>
            <div class="filter-chips" role="list">
              <button class="filter-chip" type="button" role="listitem" data-active="true">
                <span class="icon icon--sm" aria-hidden="true">
                  <i class="bx bx-check"></i>
                </span>
                未回答
              </button>
              <button class="filter-chip" type="button" role="listitem">
                <span class="icon icon--sm" aria-hidden="true">
                  <i class="bx bx-check"></i>
                </span>
                解答済み
              </button>
              <button class="filter-chip" type="button" role="listitem">
                <span class="icon icon--sm" aria-hidden="true">
                  <i class="bx bx-check"></i>
                </span>
                要復習
              </button>
              <button class="filter-chip" type="button" role="listitem">
                <span class="icon icon--sm" aria-hidden="true">
                  <i class="bx bx-check"></i>
                </span>
                解説あり
              </button>
            </div>
          </div>
          <div class="control-card" role="group" aria-labelledby="index-heading">
            <h3 id="index-heading" class="heading-md">問題一覧</h3>
            <ol class="question-index">
              <li><a href="#question-1">Q1 経営課題の整理</a></li>
              <li><a href="#question-2">Q2 顧客共創の提案</a></li>
              <li><a href="#question-3">Q3 技能伝承の仕組み</a></li>
              <li><a href="#question-4">Q4 評価制度の再設計</a></li>
            </ol>
          </div>
          <div class="reference-card" role="complementary" aria-labelledby="reference-heading">
            <h3 id="reference-heading" class="heading-md">解説メモ</h3>
            <div class="reference-card__body">
              与件文から導かれるポイントをメモとして整理しています。設問に
              迷ったら、キーワードと因果関係の視点を確認しましょう。
            </div>
          </div>
          <div class="control-card" role="group" aria-labelledby="expression-heading">
            <h3 id="expression-heading" class="heading-md">表現カード</h3>
            <p class="text-muted">
              クリックすると回答作成のヒントが表示されます。キーボードの
              Tabで移動し、Enterで決定できます。
            </p>
            <div class="strategy-card-grid">
              <button
                type="button"
                class="strategy-card"
                data-tooltip="2センテンス構成を意識した短文テンプレート"
                data-strategy="expression"
              >
                30字×2の表現
              </button>
              <button
                type="button"
                class="strategy-card"
                data-tooltip="原因→施策→効果のフレームを提示"
                data-strategy="structure"
              >
                構造の言葉
              </button>
              <button
                type="button"
                class="strategy-card"
                data-tooltip="強み×機会の切り口でアイデアを整理"
                data-strategy="swot"
              >
                強み活用カード
              </button>
              <button
                type="button"
                class="strategy-card"
                data-tooltip="一次知識を再確認して具体例を引き出す"
                data-strategy="knowledge"
              >
                定石・知識集
              </button>
            </div>
            <div class="strategy-card__preview" data-strategy-detail hidden></div>
            <div class="sr-only" aria-live="polite" data-strategy-live></div>
          </div>
        </section>
        <section
          id="section-retrieval"
          class="retrieval-preview"
          aria-labelledby="retrieval-heading"
        >
          <div class="retrieval-preview__header">
            <h3 id="retrieval-heading" class="heading-md">リトリーバル</h3>
            <p class="text-muted">
              過去演習で蓄積した知識カードを一枚ずつ確認できます。関連する
              インサイトを復習してから回答を組み立てましょう。
            </p>
          </div>
          <button
            type="button"
            class="ui-button ui-button--primary"
            data-retrieval-open
            aria-haspopup="dialog"
          >
            カードを開く
          </button>
        </section>
        <nav
          class="exercise__tabs"
          role="tablist"
          aria-label="設問タブ"
          data-wheel-scroll="true"
        >
          <!-- ホイールでも操作できる設問タブ -->
          <button
            id="tab-question-1"
            class="exercise-tab"
            type="button"
            role="tab"
            aria-selected="true"
            aria-controls="question-1"
            tabindex="0"
            data-target="question-1"
          >
            <span class="exercise-tab__label">Q1</span>
            <span class="exercise-tab__title">経営課題の整理</span>
          </button>
          <button
            id="tab-question-2"
            class="exercise-tab"
            type="button"
            role="tab"
            aria-selected="false"
            aria-controls="question-2"
            tabindex="-1"
            data-target="question-2"
          >
            <span class="exercise-tab__label">Q2</span>
            <span class="exercise-tab__title">顧客共創の提案</span>
          </button>
          <button
            id="tab-question-3"
            class="exercise-tab"
            type="button"
            role="tab"
            aria-selected="false"
            aria-controls="question-3"
            tabindex="-1"
            data-target="question-3"
          >
            <span class="exercise-tab__label">Q3</span>
            <span class="exercise-tab__title">技能伝承の仕組み</span>
          </button>
          <button
            id="tab-question-4"
            class="exercise-tab"
            type="button"
            role="tab"
            aria-selected="false"
            aria-controls="question-4"
            tabindex="-1"
            data-target="question-4"
          >
            <span class="exercise-tab__label">Q4</span>
            <span class="exercise-tab__title">評価制度の再設計</span>
          </button>
        </nav>
        <section
          id="section-answer"
          class="exercise__questions"
          aria-live="polite"
        >
          <article
            id="question-1"
            class="question-card"
            role="region"
            aria-labelledby="question-1-title"
            data-max-length="120"
          >
            <header class="question-card__header">
              <span class="question-card__badge">1</span>
              <h3 id="question-1-title" class="question-card__title">
                経営課題の整理
              </h3>
              <div class="question-card__meta">
                <span>配点 20点</span>
                <span>120字以内</span>
              </div>
            </header>
            <div class="question-card__body">
              A社が直面している主要な経営課題を、設計・生産・人材の観点
              から整理し、優先度の高い順に二点述べよ。
            </div>
            <div class="question-card__input">
              <label class="sr-only" for="answer-1">設問1回答欄</label>
              <textarea
                id="answer-1"
                class="question-card__textarea"
                maxlength="300"
                aria-describedby="counter-1"
                data-max-length="120"
              ></textarea>
              <div class="question-card__tools">
                <div id="counter-1" class="char-counter" aria-live="polite">
                  0 / 120 字
                </div>
                <button
                  class="analysis-info__trigger"
                  type="button"
                  aria-expanded="false"
                  aria-controls="analysis-info-1"
                  data-info-target="analysis-info-1"
                >
                  <span class="analysis-info__icon" aria-hidden="true">
                    <i class="bx bx-info-circle"></i>
                  </span>
                  <span class="sr-only">分析ツールの説明を開く</span>
                </button>
              </div>
              <div id="analysis-info-1" class="analysis-info" hidden>
                <p>
                  残り字数のカウンターと構造ラベルを合わせて確認し、要素の
                  抜け漏れをチェックしましょう。配点が高い設問では段落構成を
                  メモしてから記入するのがおすすめです。
                </p>
                <div class="analysis-info__meta">
                  <span>構造メモ機能の基本操作</span>
                  <a
                    href="https://videos.example.jp/tool-demo"
                    target="_blank"
                    rel="noreferrer"
                  >
                    使い方動画を見る
                  </a>
                </div>
              </div>
            </div>
            <div class="support-block">
              <button
                class="support-block__toggle ui-button ui-button--subtle"
                type="button"
                aria-expanded="false"
                aria-controls="support-1"
                data-support-id="support-1"
              >
                <span class="icon icon--sm support-block__icon" aria-hidden="true">
                  <i class="bx bx-bulb"></i>
                </span>
                <span class="support-block__label">活用する 思考補助</span>
                <span class="icon icon--sm support-block__chevron" aria-hidden="true">
                  <i class="bx bx-chevron-down"></i>
                </span>
              </button>
              <div id="support-1" class="support-block__content" hidden>
                設計部門のDX化、BOM連携、技能伝承、人材評価の整合性など、
                与件文から直接引用できる語を起点に因果で整理する。
              </div>
            </div>
          </article>

          <article
            id="question-2"
            class="question-card"
            role="region"
            aria-labelledby="question-2-title"
            data-max-length="160"
          >
            <header class="question-card__header">
              <span class="question-card__badge">2</span>
              <h3 id="question-2-title" class="question-card__title">
                顧客共創の提案
              </h3>
              <div class="question-card__meta">
                <span>配点 30点</span>
                <span>160字以内</span>
              </div>
            </header>
            <div class="question-card__body">
              A社が顧客との共同開発を推進するための施策を、営業・設計・
              生産の連携の仕組みとして提案せよ。
            </div>
            <div class="question-card__input">
              <label class="sr-only" for="answer-2">設問2回答欄</label>
              <textarea
                id="answer-2"
                class="question-card__textarea"
                maxlength="400"
                aria-describedby="counter-2"
                data-max-length="160"
              ></textarea>
              <div class="question-card__tools">
                <div id="counter-2" class="char-counter" aria-live="polite">
                  0 / 160 字
                </div>
                <button
                  class="analysis-info__trigger"
                  type="button"
                  aria-expanded="false"
                  aria-controls="analysis-info-2"
                  data-info-target="analysis-info-2"
                >
                  <span class="analysis-info__icon" aria-hidden="true">
                    <i class="bx bx-info-circle"></i>
                  </span>
                  <span class="sr-only">分析ツールの説明を開く</span>
                </button>
              </div>
              <div id="analysis-info-2" class="analysis-info" hidden>
                <p>
                  共創提案では、顧客の期待価値と自社資源のマトリクスを用い
                  ると構造的に整理できます。フレームを選ぶと、要素の順序を
                  自動で提案します。
                </p>
                <div class="analysis-info__meta">
                  <span>提案骨子テンプレート</span>
                  <a
                    href="https://videos.example.jp/template-demo"
                    target="_blank"
                    rel="noreferrer"
                  >
                    使い方動画を見る
                  </a>
                </div>
              </div>
            </div>
            <div class="support-block">
              <button
                class="support-block__toggle ui-button ui-button--subtle"
                type="button"
                aria-expanded="false"
                aria-controls="support-2"
                data-support-id="support-2"
              >
                <span class="icon icon--sm support-block__icon" aria-hidden="true">
                  <i class="bx bx-bulb"></i>
                </span>
                <span class="support-block__label">確認する 注意事項</span>
                <span class="icon icon--sm support-block__chevron" aria-hidden="true">
                  <i class="bx bx-chevron-down"></i>
                </span>
              </button>
              <div id="support-2" class="support-block__content" hidden>
                顧客接点の情報共有タイミング、設計部門の早期参画、試作段
                階でのフィードバックループを盛り込む。
              </div>
            </div>
          </article>

          <article
            id="question-3"
            class="question-card"
            role="region"
            aria-labelledby="question-3-title"
            data-max-length="160"
          >
            <header class="question-card__header">
              <span class="question-card__badge">3</span>
              <h3 id="question-3-title" class="question-card__title">
                技能伝承の仕組み
              </h3>
              <div class="question-card__meta">
                <span>配点 25点</span>
                <span>160字以内</span>
              </div>
            </header>
            <div class="question-card__body">
              熟練技能の形式知化と継承を加速するための施策を、教育体系と
              デジタル活用の両面から述べよ。
            </div>
            <div class="question-card__input">
              <label class="sr-only" for="answer-3">設問3回答欄</label>
              <textarea
                id="answer-3"
                class="question-card__textarea"
                maxlength="400"
                aria-describedby="counter-3"
                data-max-length="160"
              ></textarea>
              <div class="question-card__tools">
                <div id="counter-3" class="char-counter" aria-live="polite">
                  0 / 160 字
                </div>
                <button
                  class="analysis-info__trigger"
                  type="button"
                  aria-expanded="false"
                  aria-controls="analysis-info-3"
                  data-info-target="analysis-info-3"
                >
                  <span class="analysis-info__icon" aria-hidden="true">
                    <i class="bx bx-info-circle"></i>
                  </span>
                  <span class="sr-only">分析ツールの説明を開く</span>
                </button>
              </div>
              <div id="analysis-info-3" class="analysis-info" hidden>
                <p>
                  技能伝承の設問では、プロセス分解チャートを使うとフェーズ
                  ごとの課題と施策を紐づけやすくなります。チャートに入力する
                  と、回答骨子が自動整形されます。
                </p>
                <div class="analysis-info__meta">
                  <span>プロセス分解チャート</span>
                  <a
                    href="https://videos.example.jp/chart-demo"
                    target="_blank"
                    rel="noreferrer"
                  >
                    使い方動画を見る
                  </a>
                </div>
              </div>
            </div>
            <div class="support-block">
              <button
                class="support-block__toggle ui-button ui-button--subtle"
                type="button"
                aria-expanded="false"
                aria-controls="support-3"
                data-support-id="support-3"
              >
                <span class="icon icon--sm support-block__icon" aria-hidden="true">
                  <i class="bx bx-bulb"></i>
                </span>
                <span class="support-block__label">参照する Tips</span>
                <span class="icon icon--sm support-block__chevron" aria-hidden="true">
                  <i class="bx bx-chevron-down"></i>
                </span>
              </button>
              <div id="support-3" class="support-block__content" hidden>
                指導員制度、ペアワーク、動画記録、工程別のナレッジカード
                など複数手段を組み合わせ、習熟度指標を定義する。
              </div>
            </div>
          </article>

          <article
            id="question-4"
            class="question-card"
            role="region"
            aria-labelledby="question-4-title"
            data-max-length="200"
          >
            <header class="question-card__header">
              <span class="question-card__badge">4</span>
              <h3 id="question-4-title" class="question-card__title">
                評価制度の再設計
              </h3>
              <div class="question-card__meta">
                <span>配点 25点</span>
                <span>200字以内</span>
              </div>
            </header>
            <div class="question-card__body">
              DX推進と技能伝承を両立させる評価制度・報酬制度の改善策を、
              期待する行動指標を含めて述べよ。
            </div>
            <div class="question-card__input">
              <label class="sr-only" for="answer-4">設問4回答欄</label>
              <textarea
                id="answer-4"
                class="question-card__textarea"
                maxlength="500"
                aria-describedby="counter-4"
                data-max-length="200"
              ></textarea>
              <div class="question-card__tools">
                <div id="counter-4" class="char-counter" aria-live="polite">
                  0 / 200 字
                </div>
                <button
                  class="analysis-info__trigger"
                  type="button"
                  aria-expanded="false"
                  aria-controls="analysis-info-4"
                  data-info-target="analysis-info-4"
                >
                  <span class="analysis-info__icon" aria-hidden="true">
                    <i class="bx bx-info-circle"></i>
                  </span>
                  <span class="sr-only">分析ツールの説明を開く</span>
                </button>
              </div>
              <div id="analysis-info-4" class="analysis-info" hidden>
                <p>
                  評価制度の設問では、成果指標と行動指標を二軸で整理し、重
                  要キーワードをハイライトしておくと記述がぶれません。軸を選
                  ぶと、テンプレートが展開されます。
                </p>
                <div class="analysis-info__meta">
                  <span>評価指標デザイン</span>
                  <a
                    href="https://videos.example.jp/eval-demo"
                    target="_blank"
                    rel="noreferrer"
                  >
                    使い方動画を見る
                  </a>
                </div>
              </div>
            </div>
            <div class="support-block">
              <button
                class="support-block__toggle ui-button ui-button--subtle"
                type="button"
                aria-expanded="false"
                aria-controls="support-4"
                data-support-id="support-4"
              >
                <span class="icon icon--sm support-block__icon" aria-hidden="true">
                  <i class="bx bx-bulb"></i>
                </span>
                <span class="support-block__label">確認する ゴール像</span>
                <span class="icon icon--sm support-block__chevron" aria-hidden="true">
                  <i class="bx bx-chevron-down"></i>
                </span>
              </button>
              <div id="support-4" class="support-block__content" hidden>
                DXで創出した知見の共有や後進育成を評価指標に組み込み、成
                果とプロセスを両面評価する基準づくりを意識する。
              </div>
            </div>
          </article>
        </section>
        <footer class="exercise__footer">
          <button
            type="button"
            class="cta-button ui-button ui-button--primary ui-button--lg"
            id="next-question-button"
            data-target="question-2"
            aria-label="次の設問へ進む"
          >
            <span class="cta-button__verb">進む</span>
            <span class="cta-button__object">次の設問へ</span>
          </button>
        </footer>
      </main>
    </div>
    </div>

    <div
      class="retrieval-modal"
      role="dialog"
      aria-modal="true"
      aria-labelledby="retrieval-modal-heading"
      hidden
      data-retrieval-modal
    >
      <div class="retrieval-modal__backdrop" data-retrieval-close></div>
      <div class="retrieval-modal__dialog">
        <header class="retrieval-modal__header">
          <h3 id="retrieval-modal-heading" class="heading-md">リトリーバルカード</h3>
          <button
            type="button"
            class="retrieval-modal__close"
            aria-label="リトリーバルを閉じる"
            data-retrieval-close
          >
            ✕
          </button>
        </header>
        <div class="retrieval-modal__body">
          <article class="retrieval-card" data-retrieval-card data-index="0">
            <span class="retrieval-card__tag">顧客共創</span>
            <h4 class="heading-md">共創設計レビュー</h4>
            <p>
              開発初期から設計と営業が参加する共創レビューを設定し、顧客の
              真因をBOMに反映。議事録をクラウド共有してトレーサビリティを
              確保する。
            </p>
          </article>
          <article class="retrieval-card" data-retrieval-card data-index="1" hidden>
            <span class="retrieval-card__tag">技能伝承</span>
            <h4 class="heading-md">動画×メンター制度</h4>
            <p>
              熟練者の作業を動画で記録し、技能のツボを字幕で補足。週次でメ
              ンターが振り返り面談を実施し、チェックリストで習熟度を可視化。
            </p>
          </article>
          <article class="retrieval-card" data-retrieval-card data-index="2" hidden>
            <span class="retrieval-card__tag">評価制度</span>
            <h4 class="heading-md">知識共有インセンティブ</h4>
            <p>
              DX基盤に登録したナレッジ件数と活用率を評価指標に組み込み、共
              有ポイントが昇格面談で参照される仕組みを構築する。
            </p>
          </article>
          <article class="retrieval-card" data-retrieval-card data-index="3" hidden>
            <span class="retrieval-card__tag">生産連携</span>
            <h4 class="heading-md">段取りシミュレーション</h4>
            <p>
              設計段階で段取り替えシミュレーションを実施し、タクトタイムを
              共有。結果をもとに製造部門が前倒しで治具準備を行う。
            </p>
          </article>
          <article class="retrieval-card" data-retrieval-card data-index="4" hidden>
            <span class="retrieval-card__tag">組織開発</span>
            <h4 class="heading-md">DXアンバサダー制度</h4>
            <p>
              若手をDXアンバサダーに任命し、部門横断で改善アイデアを月次報
              告。成功事例は社内ラジオで共有し、行動指標に紐づける。
            </p>
          </article>
        </div>
        <footer class="retrieval-modal__controls">
          <button
            type="button"
            class="ui-button"
            data-retrieval-prev
            aria-label="前のカードへ"
          >
            前へ
          </button>
          <div class="retrieval-progress">
            <span aria-live="polite" data-retrieval-count>1 / 5</span>
            <div class="retrieval-progress__bar">
              <span data-retrieval-progress></span>
            </div>
          </div>
          <button
            type="button"
            class="ui-button ui-button--primary"
            data-retrieval-next
            aria-label="次のカードへ"
          >
            次へ
          </button>
        </footer>
      </div>
    </div>

    <div
      class="shortcut-panel"
      role="dialog"
      aria-modal="true"
      aria-labelledby="shortcut-panel-heading"
      hidden
      data-shortcut-panel
    >
      <div class="shortcut-panel__dialog">
        <div class="shortcut-panel__header">
          <h3 id="shortcut-panel-heading" class="heading-md">ショートカット一覧</h3>
          <button
            type="button"
            class="shortcut-panel__close"
            aria-label="ショートカット一覧を閉じる"
            data-shortcut-close
          >
            ✕
          </button>
        </div>
        <p class="text-muted">
          キーボード操作でマーカーや支援ツールを呼び出せます。アクセシビ
          リティ向上のため、全ての操作はフォーカス移動と組み合わせて利用
          できます。
        </p>
        <div class="shortcut-panel__list">
          <div class="shortcut-panel__item">
            <span>選択テキストにハイライト</span>
            <span class="shortcut-panel__keys">
              <span>Alt</span><span>Shift</span><span>H</span>
            </span>
          </div>
          <div class="shortcut-panel__item">
            <span>ハイライトを解除</span>
            <span class="shortcut-panel__keys">
              <span>Alt</span><span>Shift</span><span>R</span>
            </span>
          </div>
          <div class="shortcut-panel__item">
            <span>リトリーバルカードを開く</span>
            <span class="shortcut-panel__keys">
              <span>Alt</span><span>Shift</span><span>O</span>
            </span>
          </div>
          <div class="shortcut-panel__item">
            <span>ショートカット一覧を開く</span>
            <span class="shortcut-panel__keys">
              <span>Alt</span><span>Shift</span><span>K</span>
            </span>
          </div>
        </div>
      </div>
    </div>

    <script>
      (() => {
        const initializeExerciseApp = (appRoot) => {
          if (!appRoot) {
            return;
          }

          const previousController = appRoot.__exerciseCleanupController;
          if (previousController) {
            previousController.abort();
          }

          const cleanupController = new AbortController();
          const { signal } = cleanupController;
          appRoot.__exerciseCleanupController = cleanupController;

          signal.addEventListener(
            'abort',
            () => {
              if (appRoot.__exerciseCleanupController === cleanupController) {
                delete appRoot.__exerciseCleanupController;
              }
            },
            { once: true }
          );

          const escapeSelector = (value) =>
            typeof value === 'string'
              ? value.replace(/([!"#$%&'()*+,./:;<=>?@[\\\]^`{|}~])/g, '\\$1')
              : '';

          const headerAnchors = Array.from(
            appRoot.querySelectorAll('.app-header__anchor')
          );
          const anchorEntries = headerAnchors
            .map((button) => {
              const targetId = button.dataset.target;
              if (!targetId) return null;
              const target = appRoot.querySelector(
                `#${escapeSelector(targetId)}`
              );
              return target ? { button, target, targetId } : null;
            })
            .filter(Boolean);

          const setActiveAnchor = (targetId) => {
            headerAnchors.forEach((button) => {
              const isActive = button.dataset.target === targetId;
              button.dataset.active = String(isActive);
            });
          };

          const scrollToSection = (targetId) => {
            const entry = anchorEntries.find(
              (item) => item.targetId === targetId
            );
            if (!entry) return;
            entry.target.scrollIntoView({ behavior: 'smooth', block: 'start' });
            setActiveAnchor(targetId);
          };

          headerAnchors.forEach((button) => {
            button.dataset.active = 'false';
            button.addEventListener(
              'click',
              () => {
                if (button.dataset.target) {
                  scrollToSection(button.dataset.target);
                }
              },
              { signal }
            );
          });

          if (anchorEntries.length) {
            setActiveAnchor(anchorEntries[0].targetId);
          }

          if (anchorEntries.length && 'IntersectionObserver' in window) {
            const anchorObserver = new IntersectionObserver(
              (entries) => {
                const visibleEntry = entries
                  .filter((entry) => entry.isIntersecting)
                  .sort((a, b) => b.intersectionRatio - a.intersectionRatio)[0];
                if (!visibleEntry) {
                  return;
                }
                const id = visibleEntry.target.getAttribute('id');
                if (id) {
                  setActiveAnchor(id);
                }
              },
              {
                rootMargin: '-45% 0px -45% 0px',
                threshold: 0.2,
              }
            );

            anchorEntries.forEach((entry) => anchorObserver.observe(entry.target));
            signal.addEventListener(
              'abort',
              () => anchorObserver.disconnect(),
              { once: true }
            );
          }

          const strategyCards = Array.from(
            appRoot.querySelectorAll('.strategy-card')
          );
          const strategyDetail = appRoot.querySelector('[data-strategy-detail]');
          const strategyLiveRegion = appRoot.querySelector('[data-strategy-live]');
          const strategyMessages = {
            expression:
              '導入→結論の2センテンス構成で、課題と対応策を30字ずつ書き出すと要点がぶれません。',
            structure:
              '因果→施策→効果の順で骨子を並べ、接続語を揃えると読みやすさが向上します。',
            swot:
              '強み×機会の掛け合わせでアイデアを発想し、リスクは弱み×脅威として整理しましょう。',
            knowledge:
              '一次知識の定石を再確認し、設問のキーワードと紐づく要素をチェックリスト化します。',
          };

          const showStrategyDetail = (key) => {
            if (!strategyDetail) return;
            const message = key ? strategyMessages[key] : '';
            if (message) {
              strategyDetail.textContent = message;
              strategyDetail.hidden = false;
              if (strategyLiveRegion) {
                strategyLiveRegion.textContent = `${message} を参照できます。`;
              }
            } else {
              strategyDetail.hidden = true;
              if (strategyLiveRegion) {
                strategyLiveRegion.textContent = '';
              }
            }
          };

          if (strategyCards.length) {
            strategyCards.forEach((card) => {
              card.setAttribute('aria-pressed', 'false');
              card.addEventListener(
                'click',
                () => {
                  strategyCards.forEach((other) =>
                    other.setAttribute('aria-pressed', 'false')
                  );
                  card.setAttribute('aria-pressed', 'true');
                  showStrategyDetail(card.dataset.strategy);
                },
                { signal }
              );
            });
          }

          const infoButtons = Array.from(
            appRoot.querySelectorAll('.analysis-info__trigger')
          );
          infoButtons.forEach((button) => {
            const targetId = button.dataset.infoTarget;
            const infoPanel = targetId
              ? appRoot.querySelector(`#${escapeSelector(targetId)}`)
              : null;
            if (!infoPanel) {
              return;
            }
            button.addEventListener(
              'click',
              () => {
                const expanded = button.getAttribute('aria-expanded') === 'true';
                const nextState = !expanded;
                button.setAttribute('aria-expanded', String(nextState));
                infoPanel.hidden = !nextState;
                if (nextState) {
                  infoPanel.scrollIntoView({
                    behavior: 'smooth',
                    block: 'nearest',
                  });
                }
              },
              { signal }
            );
          });

          const retrievalModal = appRoot.querySelector('[data-retrieval-modal]');
          const retrievalOpeners = Array.from(
            appRoot.querySelectorAll('[data-retrieval-open]')
          );
          const retrievalCards = Array.from(
            retrievalModal?.querySelectorAll('[data-retrieval-card]') || []
          );
          const retrievalCount = retrievalModal?.querySelector(
            '[data-retrieval-count]'
          );
          const retrievalProgress = retrievalModal?.querySelector(
            '[data-retrieval-progress]'
          );
          const retrievalPrev = retrievalModal?.querySelector('[data-retrieval-prev]');
          const retrievalNext = retrievalModal?.querySelector('[data-retrieval-next]');
          const retrievalClosers = Array.from(
            retrievalModal?.querySelectorAll('[data-retrieval-close]') || []
          );
          let retrievalIndex = 0;
          let retrievalPreviousFocus = null;

          const updateRetrievalView = () => {
            if (!retrievalCards.length) return;
            retrievalCards.forEach((card, index) => {
              card.hidden = index !== retrievalIndex;
            });
            const total = retrievalCards.length;
            if (retrievalCount) {
              retrievalCount.textContent = `${retrievalIndex + 1} / ${total}`;
            }
            if (retrievalProgress) {
              const progressRatio = (retrievalIndex + 1) / total;
              retrievalProgress.style.transform = `scaleX(${progressRatio})`;
            }
            if (retrievalPrev) {
              retrievalPrev.disabled = retrievalIndex === 0;
            }
            if (retrievalNext) {
              retrievalNext.disabled = retrievalIndex === retrievalCards.length - 1;
            }
          };

          const openRetrieval = () => {
            if (!retrievalModal || !retrievalModal.hidden) {
              return false;
            }
            retrievalPreviousFocus =
              document.activeElement instanceof HTMLElement
                ? document.activeElement
                : null;
            retrievalModal.hidden = false;
            updateRetrievalView();
            const focusTarget =
              retrievalModal.querySelector('[data-retrieval-close]') ||
              retrievalModal;
            if (focusTarget && focusTarget.focus) {
              focusTarget.focus();
            }
            return true;
          };

          const closeRetrieval = () => {
            if (!retrievalModal || retrievalModal.hidden) {
              return false;
            }
            retrievalModal.hidden = true;
            if (retrievalPreviousFocus?.focus) {
              retrievalPreviousFocus.focus();
            }
            return true;
          };

          if (retrievalOpeners.length) {
            retrievalOpeners.forEach((button) => {
              button.addEventListener('click', openRetrieval, { signal });
            });
          }

          if (retrievalPrev && retrievalNext) {
            retrievalPrev.addEventListener(
              'click',
              () => {
                retrievalIndex = Math.max(0, retrievalIndex - 1);
                updateRetrievalView();
              },
              { signal }
            );
            retrievalNext.addEventListener(
              'click',
              () => {
                retrievalIndex = Math.min(
                  retrievalCards.length - 1,
                  retrievalIndex + 1
                );
                updateRetrievalView();
              },
              { signal }
            );
          }

          if (retrievalClosers.length) {
            retrievalClosers.forEach((closer) => {
              closer.addEventListener('click', closeRetrieval, { signal });
            });
          }

          if (retrievalModal) {
            retrievalModal.addEventListener(
              'click',
              (event) => {
                if (event.target === retrievalModal) {
                  closeRetrieval();
                }
              },
              { signal }
            );
          }

          const shortcutPanel = appRoot.querySelector('[data-shortcut-panel]');
          const shortcutOpeners = Array.from(
            appRoot.querySelectorAll('[data-shortcut-open]')
          );
          const shortcutClosers = Array.from(
            shortcutPanel?.querySelectorAll('[data-shortcut-close]') || []
          );
          let shortcutPreviousFocus = null;

          const openShortcutPanel = () => {
            if (!shortcutPanel || !shortcutPanel.hidden) {
              return false;
            }
            shortcutPreviousFocus =
              document.activeElement instanceof HTMLElement
                ? document.activeElement
                : null;
            shortcutPanel.hidden = false;
            const focusTarget =
              shortcutPanel.querySelector('[data-shortcut-close]') || shortcutPanel;
            focusTarget?.focus?.();
            return true;
          };

          const closeShortcutPanel = () => {
            if (!shortcutPanel || shortcutPanel.hidden) {
              return false;
            }
            shortcutPanel.hidden = true;
            if (shortcutPreviousFocus?.focus) {
              shortcutPreviousFocus.focus();
            }
            return true;
          };

          shortcutOpeners.forEach((button) => {
            button.addEventListener('click', openShortcutPanel, { signal });
          });

          shortcutClosers.forEach((button) => {
            button.addEventListener('click', closeShortcutPanel, { signal });
          });

          if (shortcutPanel) {
            shortcutPanel.addEventListener(
              'click',
              (event) => {
                if (event.target === shortcutPanel) {
                  closeShortcutPanel();
                }
              },
              { signal }
            );
          }

          const unwrapMark = (mark) => {
            if (!mark || !mark.parentNode) return;
            const parent = mark.parentNode;
            while (mark.firstChild) {
              parent.insertBefore(mark.firstChild, mark);
            }
            parent.removeChild(mark);
          };

          const highlightSelection = () => {
            const selection = window.getSelection();
            if (!selection || selection.rangeCount === 0) {
              return false;
            }
            const range = selection.getRangeAt(0);
            if (range.collapsed) {
              return false;
            }
            if (!appRoot.contains(range.commonAncestorContainer)) {
              return false;
            }
            const wrapper = document.createElement('mark');
            wrapper.className = 'text-highlight';
            try {
              const contents = range.extractContents();
              wrapper.appendChild(contents);
              range.insertNode(wrapper);
              selection.removeAllRanges();
              const newRange = document.createRange();
              newRange.selectNode(wrapper);
              selection.addRange(newRange);
              return true;
            } catch (error) {
              return false;
            }
          };

          const removeHighlight = () => {
            const selection = window.getSelection();
            if (!selection || selection.rangeCount === 0) {
              return false;
            }
            const range = selection.getRangeAt(0);
            if (!appRoot.contains(range.commonAncestorContainer)) {
              return false;
            }
            let removed = false;
            if (range.collapsed) {
              const node =
                selection.anchorNode instanceof Element
                  ? selection.anchorNode
                  : selection.anchorNode?.parentElement;
              const mark = node?.closest?.('mark.text-highlight');
              if (mark) {
                unwrapMark(mark);
                removed = true;
              }
            } else {
              const marks = Array.from(
                appRoot.querySelectorAll('mark.text-highlight')
              );
              marks.forEach((mark) => {
                try {
                  if (range.intersectsNode(mark)) {
                    unwrapMark(mark);
                    removed = true;
                  }
                } catch (error) {
                  // ignore intersections that throw for detached nodes
                }
              });
            }
            return removed;
          };

          document.addEventListener(
            'keydown',
            (event) => {
              if (event.defaultPrevented) {
                return;
              }
              const key = event.key?.toLowerCase?.();
              const isModifierCombo =
                event.altKey && event.shiftKey && !event.ctrlKey && !event.metaKey;

              if (isModifierCombo && key === 'h') {
                if (highlightSelection()) {
                  event.preventDefault();
                }
              } else if (isModifierCombo && key === 'r') {
                if (removeHighlight()) {
                  event.preventDefault();
                }
              } else if (isModifierCombo && key === 'o') {
                if (openRetrieval()) {
                  event.preventDefault();
                }
              } else if (isModifierCombo && key === 'k') {
                if (openShortcutPanel()) {
                  event.preventDefault();
                }
              } else if (event.key === 'Escape') {
                const closedModal = closeRetrieval();
                const closedShortcuts = closeShortcutPanel();
                if (closedModal || closedShortcuts) {
                  event.preventDefault();
                }
              }
            },
            { signal }
          );

          // 現在の設問位置とタブ／CTAの同期、スムーススクロール、ハイライト
          const tabButtons = Array.from(
            appRoot.querySelectorAll('.exercise-tab')
          );
          const tabList = appRoot.querySelector('.exercise__tabs');
          const nextButton = appRoot.querySelector('#next-question-button');
          const questionCards = Array.from(
            appRoot.querySelectorAll('.question-card')
          );
          const answerTextareas = appRoot.querySelectorAll(
            '.question-card__textarea'
          );

          const activateCard = (card) => {
            questionCards.forEach((c) =>
              c.classList.remove('question-card--active')
            );
            if (!card) return;
            card.classList.add('question-card--active');
            if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
              card.classList.remove('question-card--active');
            } else {
              setTimeout(() => {
                card.classList.remove('question-card--active');
              }, 2000);
            }
          };

          const updateTabs = (activeId) => {
            tabButtons.forEach((button) => {
              const isActive = button.dataset.target === activeId;
              button.setAttribute('aria-selected', String(isActive));
              button.setAttribute('tabindex', isActive ? '0' : '-1');
            });
          };

          const updateFooterCta = (activeId) => {
            if (!nextButton) return;
            const currentIndex = questionCards.findIndex(
              (card) => card.id === activeId
            );
            if (currentIndex === -1) {
              return;
            }

            const verb = nextButton.querySelector('.cta-button__verb');
            const object = nextButton.querySelector('.cta-button__object');
            const isLast = currentIndex === questionCards.length - 1;
            const nextIndex = isLast ? 0 : currentIndex + 1;
            nextButton.dataset.target = questionCards[nextIndex].id;
            if (verb && object) {
              if (isLast) {
                verb.textContent = '見直す';
                object.textContent = '1問目へ';
                nextButton.setAttribute('aria-label', '1問目へ戻る');
              } else {
                verb.textContent = '進む';
                object.textContent = '次の設問へ';
                nextButton.setAttribute('aria-label', '次の設問へ進む');
              }
            }
          };

          const scrollToQuestion = (targetId) => {
            const target = targetId
              ? appRoot.querySelector(`#${escapeSelector(targetId)}`)
              : null;
            if (!target) return;
            target.scrollIntoView({ behavior: 'smooth', block: 'start' });
            if (target.focus) {
              try {
                target.focus({ preventScroll: true });
              } catch (error) {
                target.focus();
              }
            }
            activateCard(target);
            updateTabs(targetId);
            updateFooterCta(targetId);
            setActiveAnchor('section-answer');
          };

          tabButtons.forEach((button, index) => {
            button.addEventListener(
              'click',
              () => {
                scrollToQuestion(button.dataset.target);
              },
              { signal }
            );

            button.addEventListener(
              'keydown',
              (event) => {
                const { key } = event;
                let nextIndex = index;
                if (key === 'ArrowRight' || key === 'ArrowDown') {
                  nextIndex = (index + 1) % tabButtons.length;
                } else if (key === 'ArrowLeft' || key === 'ArrowUp') {
                  nextIndex = (index - 1 + tabButtons.length) % tabButtons.length;
                } else if (key === 'Home') {
                  nextIndex = 0;
                } else if (key === 'End') {
                  nextIndex = tabButtons.length - 1;
                } else {
                  return;
                }
                event.preventDefault();
                const nextButtonEl = tabButtons[nextIndex];
                nextButtonEl.focus();
                scrollToQuestion(nextButtonEl.dataset.target);
              },
              { signal }
            );
          });

          if (tabList?.dataset.wheelScroll === 'true') {
            tabList.addEventListener(
              'wheel',
              (event) => {
                if (Math.abs(event.deltaY) <= Math.abs(event.deltaX)) {
                  return;
                }
                event.preventDefault();
                tabList.scrollBy({
                  left: event.deltaY,
                  behavior: 'smooth',
                });
              },
              { passive: false, signal }
            );
          }

          if (nextButton) {
            nextButton.addEventListener(
              'click',
              () => {
                const targetId = nextButton.dataset.target;
                if (targetId) {
                  scrollToQuestion(targetId);
                }
              },
              { signal }
            );
          }

          if (questionCards.length) {
            updateFooterCta(questionCards[0].id);
          }

          const observer = new IntersectionObserver(
            (entries) => {
              entries.forEach((entry) => {
                if (entry.isIntersecting) {
                  const id = entry.target.getAttribute('id');
                  updateTabs(id);
                  updateFooterCta(id);
                  activateCard(entry.target);
                  setActiveAnchor('section-answer');
                }
              });
            },
            {
              rootMargin: '-40% 0px -45% 0px',
              threshold: 0.1,
            }
          );

          signal.addEventListener(
            'abort',
            () => {
              observer.disconnect();
            },
            { once: true }
          );

          questionCards.forEach((card) => {
            card.setAttribute('tabindex', '-1');
            observer.observe(card);
          });

          // 字数カウンタ：上限超過時は警告色を適用
          const updateCounter = (textarea, counter) => {
            const max = Number(textarea.dataset.maxLength);
            const length = textarea.value.length;
            const remaining = `${length} / ${max} 字`;
            counter.textContent = remaining;
            counter.classList.toggle('char-counter--limit', length > max);
          };

          const answerStorageKey = 'exercise-answer-drafts-v1';
          let answerDrafts = {};

          try {
            answerDrafts = JSON.parse(
              localStorage.getItem(answerStorageKey) || '{}'
            );
          } catch (error) {
            answerDrafts = {};
          }

          const persistDrafts = () => {
            try {
              const hasDrafts = Object.keys(answerDrafts).length > 0;
              if (hasDrafts) {
                localStorage.setItem(
                  answerStorageKey,
                  JSON.stringify(answerDrafts)
                );
              } else {
                localStorage.removeItem(answerStorageKey);
              }
            } catch (error) {
              // ストレージ未対応環境では静かにフォールバック
            }
          };

          answerTextareas.forEach((textarea) => {
            const describedBy = textarea.getAttribute('aria-describedby');
            const counter = describedBy
              ? appRoot.querySelector(`#${escapeSelector(describedBy)}`)
              : null;
            const textareaId = textarea.id;
            const savedDraft =
              textareaId && answerDrafts[textareaId]
                ? answerDrafts[textareaId]
                : null;

            if (savedDraft && typeof savedDraft.value === 'string') {
              textarea.value = savedDraft.value;
            }

            if (counter) {
              updateCounter(textarea, counter);
            }

            let saveTimer;

            const saveDraft = () => {
              if (!textareaId) return;
              if (textarea.value === '') {
                delete answerDrafts[textareaId];
              } else {
                answerDrafts[textareaId] = {
                  value: textarea.value,
                  savedAt: new Date().toISOString(),
                };
              }
              persistDrafts();
            };

            const scheduleSave = () => {
              clearTimeout(saveTimer);
              saveTimer = window.setTimeout(saveDraft, 300);
            };

            textarea.addEventListener(
              'input',
              () => {
                if (counter) {
                  updateCounter(textarea, counter);
                }
                scheduleSave();
              },
              { signal }
            );

            textarea.addEventListener('blur', saveDraft, { signal });
            window.addEventListener('beforeunload', saveDraft, { signal });

            signal.addEventListener(
              'abort',
              () => {
                clearTimeout(saveTimer);
              },
              { once: true }
            );
          });

          // 折りたたみ補助情報：ローカルストレージで既読状態を保持
          const supportToggles = appRoot.querySelectorAll(
            '.support-block__toggle'
          );
          const storageKey = 'exercise-support-state-v1';
          let storedState = {};

          try {
            storedState = JSON.parse(localStorage.getItem(storageKey) || '{}');
          } catch (error) {
            storedState = {};
          }

          supportToggles.forEach((toggle) => {
            const supportId = toggle.dataset.supportId;
            const content = supportId
              ? appRoot.querySelector(`#${escapeSelector(supportId)}`)
              : null;
            if (!content) {
              return;
            }
            const isOpen = storedState[supportId];

            if (isOpen) {
              toggle.setAttribute('aria-expanded', 'true');
              content.hidden = false;
            }

            toggle.addEventListener(
              'click',
              () => {
                const expanded = toggle.getAttribute('aria-expanded') === 'true';
                toggle.setAttribute('aria-expanded', String(!expanded));
                content.hidden = expanded;
                storedState[supportId] = !expanded;
                try {
                  localStorage.setItem(storageKey, JSON.stringify(storedState));
                } catch (error) {
                  // ストレージ未対応環境では静かにフォールバック
                }
              },
              { signal }
            );
          });
        };

        const initializeAllRoots = () => {
          document
            .querySelectorAll('[data-app="exercise"]')
            .forEach((root) => initializeExerciseApp(root));
        };

        const scheduleInitialization = (() => {
          let rafId = null;
          return () => {
            if (typeof window === 'undefined') {
              initializeAllRoots();
              return;
            }

            if (rafId !== null) {
              window.cancelAnimationFrame(rafId);
            }

            rafId = window.requestAnimationFrame(() => {
              rafId = null;
              initializeAllRoots();
            });
          };
        })();

        if (document.readyState === 'loading') {
          document.addEventListener(
            'DOMContentLoaded',
            () => {
              scheduleInitialization();
            },
            { once: true }
          );
        } else {
          scheduleInitialization();
        }

        const registerSpaHooks = () => {
          const listeners = [
            [window, 'pageshow'],
            [window, 'popstate'],
            [window, 'hashchange'],
            [document, 'turbo:load'],
            [document, 'turbo:frame-load'],
            [document, 'astro:page-load'],
            [document, 'astro:after-swap'],
            [document, 'htmx:afterSettle'],
          ];

          listeners.forEach(([target, event]) => {
            if (target && target.addEventListener) {
              target.addEventListener(event, scheduleInitialization);
            }
          });

          if (
            window.navigation &&
            typeof window.navigation.addEventListener === 'function'
          ) {
            window.navigation.addEventListener('navigate', scheduleInitialization);
          }

          if (
            typeof history !== 'undefined' &&
            !history.__exerciseAppPatched
          ) {
            history.__exerciseAppPatched = true;
            ['pushState', 'replaceState'].forEach((method) => {
              const original = history[method];
              if (typeof original === 'function') {
                history[method] = function (...args) {
                  const result = original.apply(this, args);
                  scheduleInitialization();
                  return result;
                };
              }
            });
          }
        };

        registerSpaHooks();

        const observer = new MutationObserver((mutations) => {
          mutations.forEach((mutation) => {
            mutation.addedNodes.forEach((node) => {
              const targets = [];
              if (node instanceof Element && node.matches('[data-app="exercise"]')) {
                targets.push(node);
              }
              if (node instanceof Element || node instanceof DocumentFragment) {
                node.querySelectorAll?.('[data-app="exercise"]').forEach((element) => {
                  targets.push(element);
                });
              }
              targets.forEach((root) => initializeExerciseApp(root));
            });
          });
        });

        const observeTarget = document.body || document.documentElement;
        if (observeTarget) {
          observer.observe(observeTarget, { childList: true, subtree: true });
        }

        window.initializeExerciseApp = initializeExerciseApp;
        window.initializeAllExerciseApps = initializeAllRoots;
        window.refreshExerciseApp = scheduleInitialization;
      })();
    </script>
  </body>
</html>
