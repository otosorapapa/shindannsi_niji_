<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>診断士二次 模擬試験UI</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Roboto+Mono:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css"
    />
    <style>
      :root {
        --color-bg: #f4f7fb;
        --color-surface: #ffffff;
        --color-border: rgba(16, 33, 56, 0.08);
        --color-text: #1d2433;
        --color-muted: #6b7a99;
        --color-primary: #1f58ff;
        --color-primary-dark: #163eb8;
        --color-accent: #ff9c3f;
        --color-danger: #ef476f;
        --color-progress-bg: rgba(31, 88, 255, 0.1);
        --color-progress-good: #1f58ff;
        --color-progress-warning: #ffb347;
        --color-progress-danger: #ef476f;
        --color-tool-bg: #e5ecff;
        --radius-lg: 20px;
        --radius-md: 16px;
        --radius-sm: 12px;
        --spacing-xl: 32px;
        --spacing-lg: 24px;
        --spacing-md: 16px;
        --spacing-sm: 12px;
        --spacing-xs: 8px;
        --top-bar-height: 64px;
        font-size: 16px;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "Noto Sans JP", system-ui, -apple-system, BlinkMacSystemFont,
          "Segoe UI", sans-serif;
        background: var(--color-bg);
        color: var(--color-text);
        line-height: 1.6;
        min-height: 100vh;
      }

      a {
        color: inherit;
      }

      .text-muted {
        color: var(--color-muted);
      }

      .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
      }

      .app-shell {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }

      .top-bar {
        position: sticky;
        top: 0;
        z-index: 20;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: var(--spacing-md);
        padding: 0 var(--spacing-lg);
        height: var(--top-bar-height);
        background: rgba(255, 255, 255, 0.92);
        backdrop-filter: blur(20px);
        border-bottom: 1px solid var(--color-border);
      }

      .top-bar__left {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        min-width: 0;
      }

      .top-bar__title {
        display: flex;
        flex-direction: column;
        gap: 2px;
        font-weight: 600;
      }

      .top-bar__title span {
        font-size: 0.8rem;
        color: var(--color-muted);
      }

      .top-bar__timer {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        border-radius: 999px;
        background: var(--color-progress-bg);
        font-family: "Roboto Mono", "Noto Sans JP", monospace;
        font-weight: 600;
        color: var(--color-primary-dark);
        transition: background 200ms ease, color 200ms ease;
      }

      .top-bar__timer[data-warning="true"] {
        background: rgba(255, 179, 71, 0.15);
        color: #c16a00;
      }

      .top-bar__timer[data-danger="true"] {
        background: rgba(239, 71, 111, 0.18);
        color: var(--color-danger);
      }

      .top-bar__actions {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
      }

      .icon-button {
        appearance: none;
        border: none;
        border-radius: 999px;
        background: var(--color-surface);
        border: 1px solid transparent;
        width: 40px;
        height: 40px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: var(--color-muted);
        cursor: pointer;
        transition: background 150ms ease, border-color 150ms ease,
          color 150ms ease;
      }

      .icon-button:hover,
      .icon-button:focus-visible {
        outline: none;
        border-color: var(--color-primary);
        color: var(--color-primary);
        background: color-mix(in srgb, var(--color-primary) 10%, #fff 90%);
      }

      .notice-panel {
        position: absolute;
        top: calc(var(--top-bar-height) + 8px);
        left: 50%;
        transform: translateX(-50%);
        width: min(780px, calc(100% - 32px));
        padding: var(--spacing-md);
        border-radius: var(--radius-md);
        background: var(--color-surface);
        border: 1px solid var(--color-border);
        box-shadow: 0 18px 40px rgba(12, 23, 42, 0.12);
        display: none;
        z-index: 30;
      }

      .notice-panel[aria-hidden="false"] {
        display: block;
      }

      .notice-panel__title {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: var(--spacing-sm);
        font-weight: 700;
      }

      .workspace {
        display: grid;
        grid-template-columns: minmax(320px, 1fr) minmax(0, 2.2fr) auto;
        gap: var(--spacing-md);
        flex: 1;
        padding: var(--spacing-md) var(--spacing-lg) var(--spacing-xl);
        transition: grid-template-columns 240ms ease;
      }

      body[data-hide-context="true"] .workspace {
        grid-template-columns: 0 minmax(0, 1fr) auto;
      }

      body[data-hide-context="true"] .scenario-pane {
        opacity: 0;
        pointer-events: none;
      }

      .scenario-pane {
        position: relative;
        background: var(--color-surface);
        border-radius: var(--radius-lg);
        padding: var(--spacing-lg);
        border: 1px solid var(--color-border);
        box-shadow: 0 20px 45px rgba(15, 23, 42, 0.08);
        display: flex;
        flex-direction: column;
        gap: var(--spacing-md);
        max-height: calc(100vh - var(--top-bar-height) - var(--spacing-xl));
        overflow: hidden;
        transition: opacity 200ms ease;
      }

      .scenario-pane__body {
        overflow-y: auto;
        padding-right: 6px;
      }

      .scenario-pane__body p {
        margin: 0 0 var(--spacing-sm);
      }

      .scenario-pane__meta {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: var(--spacing-xs) var(--spacing-md);
        font-size: 0.85rem;
        color: var(--color-muted);
      }

      .main-pane {
        position: relative;
        background: transparent;
        display: flex;
        flex-direction: column;
        gap: var(--spacing-md);
      }

      .question-tabs {
        display: flex;
        gap: var(--spacing-xs);
        background: var(--color-surface);
        border-radius: var(--radius-lg);
        padding: var(--spacing-xs);
        border: 1px solid var(--color-border);
        box-shadow: 0 8px 24px rgba(15, 23, 42, 0.06);
        position: sticky;
        top: calc(var(--top-bar-height) + var(--spacing-md));
        z-index: 15;
      }

      .question-tab {
        flex: 1;
        border: none;
        border-radius: var(--radius-sm);
        background: transparent;
        padding: var(--spacing-sm) var(--spacing-md);
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--color-muted);
        cursor: pointer;
        transition: background 180ms ease, color 180ms ease;
      }

      .question-tab[aria-selected="true"] {
        background: color-mix(in srgb, var(--color-primary) 12%, #fff 88%);
        color: var(--color-primary-dark);
        box-shadow: 0 10px 22px rgba(31, 88, 255, 0.15);
      }

      .question-panels {
        position: relative;
        background: var(--color-surface);
        border-radius: var(--radius-lg);
        border: 1px solid var(--color-border);
        box-shadow: 0 24px 44px rgba(15, 23, 42, 0.08);
        overflow: hidden;
      }

      .question-panel {
        display: none;
        padding-bottom: var(--spacing-lg);
      }

      .question-panel[aria-hidden="false"] {
        display: block;
      }

      .question-header {
        padding: var(--spacing-lg) var(--spacing-lg) var(--spacing-sm);
        border-bottom: 1px solid color-mix(in srgb, var(--color-border) 70%, transparent);
      }

      .question-header__meta {
        display: flex;
        gap: var(--spacing-sm);
        flex-wrap: wrap;
        font-size: 0.85rem;
        color: var(--color-muted);
      }

      .answer-container {
        position: relative;
        display: grid;
        grid-template-columns: minmax(0, 1fr) minmax(220px, 0.38fr);
        gap: var(--spacing-md);
        padding: var(--spacing-lg);
      }

      .answer-editor {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-sm);
      }

      .answer-topbar {
        position: sticky;
        top: calc(var(--top-bar-height) + var(--spacing-md) + 56px);
        z-index: 10;
        display: flex;
        flex-direction: column;
        gap: var(--spacing-xs);
        background: var(--color-surface);
        padding-bottom: var(--spacing-sm);
      }

      .char-progress {
        height: 10px;
        border-radius: 999px;
        background: var(--color-progress-bg);
        overflow: hidden;
      }

      .char-progress__bar {
        height: 100%;
        width: 0;
        border-radius: inherit;
        transition: width 200ms ease, background 200ms ease;
      }

      .char-stats {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        font-size: 0.85rem;
        color: var(--color-muted);
      }

      .char-stats__item {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        background: color-mix(in srgb, var(--color-primary) 8%, #fff 92%);
        padding: 4px 10px;
        border-radius: 999px;
        font-weight: 600;
      }

      .char-stats__item i {
        font-size: 1rem;
      }

      textarea.answer-textarea {
        min-height: 220px;
        border-radius: var(--radius-md);
        border: 1px solid var(--color-border);
        padding: var(--spacing-md);
        resize: vertical;
        font-family: inherit;
        font-size: 0.95rem;
        line-height: 1.7;
        transition: border 150ms ease, box-shadow 150ms ease;
      }

      textarea.answer-textarea:focus {
        outline: none;
        border-color: var(--color-primary);
        box-shadow: 0 0 0 3px color-mix(in srgb, var(--color-primary) 30%, transparent);
      }

      .memo-area {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-sm);
        padding: var(--spacing-sm);
        background: color-mix(in srgb, var(--color-primary) 6%, #fff 94%);
        border-radius: var(--radius-md);
        border: 1px dashed color-mix(in srgb, var(--color-primary) 25%, transparent);
        min-height: 220px;
      }

      .memo-area textarea {
        flex: 1;
        border: none;
        background: transparent;
        font-size: 0.85rem;
        resize: vertical;
      }

      .insight-panel {
        position: sticky;
        top: calc(var(--top-bar-height) + var(--spacing-md));
        align-self: start;
        width: 320px;
        max-height: calc(100vh - var(--top-bar-height) - var(--spacing-xl));
        display: flex;
        flex-direction: column;
        gap: var(--spacing-sm);
        padding: var(--spacing-md);
        border-radius: var(--radius-lg);
        background: var(--color-surface);
        border: 1px solid var(--color-border);
        box-shadow: 0 18px 36px rgba(15, 23, 42, 0.08);
        transition: transform 200ms ease, opacity 200ms ease;
      }

      .insight-panel[data-hidden="true"] {
        opacity: 0;
        pointer-events: none;
        transform: translateX(40px);
      }

      .insight-panel__header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: 700;
      }

      .insight-panel__section {
        border-top: 1px solid color-mix(in srgb, var(--color-border) 70%, transparent);
        padding-top: var(--spacing-sm);
        font-size: 0.85rem;
      }

      .insight-panel__chips {
        display: flex;
        flex-wrap: wrap;
        gap: var(--spacing-xs);
      }

      .chip {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 10px;
        border-radius: 999px;
        background: color-mix(in srgb, var(--color-primary) 8%, #fff 92%);
        font-size: 0.8rem;
        color: var(--color-primary-dark);
        font-weight: 600;
      }

      .tools-sidebar {
        position: sticky;
        top: calc(var(--top-bar-height) + var(--spacing-md));
        align-self: start;
        display: flex;
        flex-direction: column;
        gap: var(--spacing-sm);
        background: var(--color-surface);
        border-radius: var(--radius-lg);
        padding: var(--spacing-sm);
        border: 1px solid var(--color-border);
        box-shadow: 0 14px 30px rgba(15, 23, 42, 0.1);
        transition: transform 200ms ease;
      }

      .tools-sidebar[data-collapsed="true"] {
        transform: translateX(120%);
      }

      .tools-sidebar__toggle {
        align-self: flex-end;
      }

      .tool-button {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 56px;
        height: 56px;
        border-radius: 16px;
        border: none;
        background: var(--color-tool-bg);
        color: var(--color-primary-dark);
        font-size: 1.4rem;
        cursor: pointer;
        position: relative;
        transition: transform 150ms ease, box-shadow 150ms ease;
      }

      .tool-button span {
        position: absolute;
        bottom: 4px;
        right: 6px;
        font-size: 0.65rem;
        font-weight: 700;
        color: #4c5ba4;
      }

      .tool-button:hover,
      .tool-button:focus-visible {
        outline: none;
        transform: translateY(-2px);
        box-shadow: 0 12px 22px rgba(31, 88, 255, 0.22);
      }

      dialog.tool-modal {
        border: none;
        border-radius: var(--radius-lg);
        padding: var(--spacing-lg);
        max-width: min(720px, calc(100vw - 48px));
        background: var(--color-surface);
        box-shadow: 0 24px 48px rgba(12, 23, 42, 0.28);
      }

      dialog.tool-modal::backdrop {
        background: rgba(8, 16, 32, 0.5);
      }

      .tool-modal__header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-sm);
        font-weight: 700;
      }

      .tool-modal__body {
        font-size: 0.9rem;
        color: var(--color-text);
        display: grid;
        gap: var(--spacing-sm);
      }

      .answer-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 var(--spacing-lg) var(--spacing-lg);
      }

      .primary-button {
        border: none;
        border-radius: 999px;
        background: linear-gradient(90deg, var(--color-primary), #4f7aff);
        color: #fff;
        padding: 12px 24px;
        font-size: 1rem;
        font-weight: 700;
        cursor: pointer;
        box-shadow: 0 20px 36px rgba(31, 88, 255, 0.24);
      }

      .primary-button:hover,
      .primary-button:focus-visible {
        outline: none;
        transform: translateY(-1px);
      }

      .dashboard-overlay {
        position: fixed;
        inset: 0;
        background: rgba(8, 16, 32, 0.65);
        display: none;
        align-items: center;
        justify-content: center;
        padding: var(--spacing-lg);
        z-index: 40;
      }

      .dashboard-overlay[aria-hidden="false"] {
        display: flex;
      }

      .dashboard {
        background: var(--color-surface);
        border-radius: var(--radius-lg);
        width: min(960px, 100%);
        max-height: calc(100vh - 96px);
        overflow: auto;
        padding: var(--spacing-lg);
        display: grid;
        gap: var(--spacing-lg);
      }

      .dashboard__header {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .dashboard__grid {
        display: grid;
        gap: var(--spacing-md);
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      }

      .dashboard-card {
        border: 1px solid var(--color-border);
        border-radius: var(--radius-md);
        padding: var(--spacing-md);
        display: grid;
        gap: var(--spacing-sm);
        background: color-mix(in srgb, var(--color-primary) 6%, #fff 94%);
      }

      .chart-bar {
        display: grid;
        gap: 6px;
      }

      .chart-bar__row {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .chart-bar__label {
        width: 120px;
        font-size: 0.8rem;
        color: var(--color-muted);
      }

      .chart-bar__track {
        flex: 1;
        height: 10px;
        border-radius: 999px;
        background: rgba(31, 88, 255, 0.08);
        overflow: hidden;
      }

      .chart-bar__value {
        height: 100%;
        border-radius: inherit;
        background: linear-gradient(90deg, var(--color-primary), #7fa4ff);
      }

      @media (max-width: 1280px) {
        .workspace {
          grid-template-columns: minmax(260px, 1fr) minmax(0, 2fr);
        }

        .insight-panel,
        .tools-sidebar {
          display: none;
        }
      }

      @media (max-width: 960px) {
        body[data-hide-context="true"] .workspace {
          grid-template-columns: minmax(0, 1fr);
        }

        .workspace {
          grid-template-columns: minmax(0, 1fr);
        }

        .answer-container {
          grid-template-columns: minmax(0, 1fr);
        }

        .memo-area {
          min-height: 140px;
        }
      }
    </style>
  </head>
  <body data-hide-context="false">
    <div class="app-shell">
      <header class="top-bar" role="banner">
        <div class="top-bar__left">
          <div class="top-bar__title">
            <strong>診断士二次 模擬試験</strong>
            <span>ショートカット: gで与件開閉 / Ctrl+↑↓で設問移動</span>
          </div>
          <div class="top-bar__timer" data-timer>
            <span class="icon" aria-hidden="true"><i class="bx bx-time"></i></span>
            <span data-timer-label>--:--</span>
          </div>
        </div>
        <div class="top-bar__actions">
          <button
            class="icon-button"
            type="button"
            aria-expanded="false"
            aria-controls="notice-panel"
            data-notice-toggle
            aria-label="注意書きを開く"
          >
            <i class="bx bx-info-circle"></i>
          </button>
          <button
            class="icon-button"
            type="button"
            aria-label="全画面で与件文を表示"
            data-toggle-context
          >
            <i class="bx bx-layout"></i>
          </button>
        </div>
        <div class="notice-panel" id="notice-panel" aria-hidden="true">
          <div class="notice-panel__title">
            <span class="icon" aria-hidden="true"><i class="bx bx-bulb"></i></span>
            模試の進め方
          </div>
          <ul>
            <li>与件文は <kbd>g</kbd> で開閉できます。重要箇所はメモ欄に要約しましょう。</li>
            <li>Ctrl + ↑ / ↓ で設問タブを切り替えられます。</li>
            <li>趣旨カード <kbd>h</kbd>、頻出フレーム <kbd>f</kbd>、模範解答比較 <kbd>m</kbd> で補助ツールを開きます。</li>
            <li>提出前に各設問の字数と要素カバー率を確認してください。</li>
          </ul>
        </div>
      </header>
      <div class="workspace">
        <aside class="scenario-pane" aria-label="与件文" data-scenario>
          <div>
            <h2 id="scenario-title"></h2>
            <div class="scenario-pane__meta" data-scenario-meta></div>
          </div>
          <div class="scenario-pane__body" data-scenario-body></div>
        </aside>
        <main class="main-pane" role="main">
          <nav class="question-tabs" role="tablist" data-question-tabs></nav>
          <section class="question-panels" data-question-panels></section>
          <div class="answer-actions">
            <div class="text-muted" data-answer-summary>全設問の入力状況を確認してください。</div>
            <button class="primary-button" type="button" data-submit>
              模試を提出
            </button>
          </div>
        </main>
        <aside
          class="insight-panel"
          aria-label="構造ラベルと名詞抽出"
          data-insight
        >
          <div class="insight-panel__header">
            <span>構造ラベル・名詞抽出</span>
            <button class="icon-button" type="button" data-insight-toggle aria-label="サイドパネルを閉じる">
              <i class="bx bx-hide"></i>
            </button>
          </div>
          <div class="insight-panel__section">
            <strong>構造ラベル</strong>
            <div class="insight-panel__chips" data-structure-chips></div>
          </div>
          <div class="insight-panel__section">
            <strong>名詞抽出</strong>
            <div class="insight-panel__chips" data-noun-chips></div>
          </div>
          <p class="text-muted" style="font-size: 0.75rem; margin: 0;">
            ショートカット: Ctrl+Shift+S で表示／非表示
          </p>
        </aside>
        <aside class="tools-sidebar" data-tools aria-label="補助ツール">
          <button class="icon-button tools-sidebar__toggle" type="button" data-tool-collapse aria-expanded="true">
            <i class="bx bx-chevron-right"></i>
          </button>
          <button class="tool-button" type="button" data-tool="mece" aria-haspopup="dialog" aria-controls="tool-mece">
            <i class="bx bx-git-branch"></i>
            <span>M</span>
          </button>
          <button class="tool-button" type="button" data-tool="intent" aria-haspopup="dialog" aria-controls="tool-intent">
            <i class="bx bx-target-lock"></i>
            <span>H</span>
          </button>
          <button class="tool-button" type="button" data-tool="frame" aria-haspopup="dialog" aria-controls="tool-frame">
            <i class="bx bx-shape-circle"></i>
            <span>F</span>
          </button>
          <button class="tool-button" type="button" data-tool="model" aria-haspopup="dialog" aria-controls="tool-model">
            <i class="bx bx-book-open"></i>
            <span>R</span>
          </button>
        </aside>
      </div>
    </div>

    <dialog class="tool-modal" id="tool-mece">
      <div class="tool-modal__header">
        <span>MECEスキャナ</span>
        <button class="icon-button" type="button" data-close-modal>
          <i class="bx bx-x"></i>
        </button>
      </div>
      <div class="tool-modal__body" data-tool-body="mece"></div>
    </dialog>

    <dialog class="tool-modal" id="tool-intent">
      <div class="tool-modal__header">
        <span>趣旨カード</span>
        <button class="icon-button" type="button" data-close-modal>
          <i class="bx bx-x"></i>
        </button>
      </div>
      <div class="tool-modal__body" data-tool-body="intent"></div>
    </dialog>

    <dialog class="tool-modal" id="tool-frame">
      <div class="tool-modal__header">
        <span>頻出フレーム</span>
        <button class="icon-button" type="button" data-close-modal>
          <i class="bx bx-x"></i>
        </button>
      </div>
      <div class="tool-modal__body" data-tool-body="frame"></div>
    </dialog>

    <dialog class="tool-modal" id="tool-model">
      <div class="tool-modal__header">
        <span>模範解答比較</span>
        <button class="icon-button" type="button" data-close-modal>
          <i class="bx bx-x"></i>
        </button>
      </div>
      <div class="tool-modal__body" data-tool-body="model"></div>
    </dialog>

    <div class="dashboard-overlay" aria-hidden="true" data-dashboard-overlay>
      <section class="dashboard" role="dialog" aria-modal="true" aria-labelledby="dashboard-title">
        <div class="dashboard__header">
          <div>
            <h2 id="dashboard-title">模試結果ダッシュボード</h2>
            <p class="text-muted" style="font-size: 0.85rem; margin: 4px 0 0;">
              設問ごとの得点・模範解答との比較、年度別・設問タイプ別の推移を可視化しました。
            </p>
          </div>
          <button class="icon-button" type="button" data-dashboard-close aria-label="ダッシュボードを閉じる">
            <i class="bx bx-x"></i>
          </button>
        </div>
        <div class="dashboard-card">
          <strong>設問別結果</strong>
          <div class="chart-bar" data-chart-questions></div>
        </div>
        <div class="dashboard-card">
          <strong>模範解答との比較</strong>
          <div class="chart-bar" data-chart-model></div>
        </div>
        <div class="dashboard-card">
          <strong>年度別正答率推移</strong>
          <div class="chart-bar" data-chart-year></div>
        </div>
        <div class="dashboard-card">
          <strong>設問タイプ別推移</strong>
          <div class="chart-bar" data-chart-type></div>
        </div>
      </section>
    </div>

    <script>
      const examData = {
        title: "診断士二次 模擬試験", 
        timeLimitMinutes: 80,
        scenario: {
          title: "B製造業 与件文",
          meta: [
            { label: "業種", value: "精密機器製造" },
            { label: "従業員", value: "220名" },
            { label: "売上", value: "58億円" },
            { label: "キーワード", value: "技能伝承 / DX / 共創" }
          ],
          body: [
            "A社は創業40年の精密機器メーカーであり、設計部門のDX化と熟練技術者の技能伝承を最優先テーマとして掲げている。",
            "設計BOMと生産BOMが分断されていることで、製品立ち上げ時に手戻りが多発し、顧客対応にも遅れが生じている。",
            "2代目社長は部門横断の情報共有を強化するため、デジタル・コラボレーション基盤を導入したが、現場での定着には課題が残る。",
            "設計段階での顧客共創、外部パートナーとの連携強化、評価制度の再設計が今後の重点検討領域となっている。"
          ]
        },
        questions: [
          {
            key: "q1",
            label: "Q1",
            title: "経営課題の整理",
            prompt: "A社が直面している主要な経営課題を設計・生産・人材の観点で整理し、優先度の高い二点を述べよ。",
            score: 20,
            limit: 120,
            keywords: ["設計BOM", "技能伝承", "情報共有"],
            structure: ["現状", "課題", "優先順位"],
            nouns: ["設計部門", "生産", "技能伝承", "情報共有"],
            modelScore: 84,
            history: [68, 72, 80, 86],
            typeHistory: {
              課題整理: [58, 64, 71, 80]
            }
          },
          {
            key: "q2",
            label: "Q2",
            title: "顧客共創の提案",
            prompt: "顧客共創を推進するために、営業と設計が連携して提案力を高める施策を述べよ。",
            score: 30,
            limit: 180,
            keywords: ["共創", "営業", "提案力"],
            structure: ["顧客接点", "連携", "効果"],
            nouns: ["顧客", "営業部門", "設計", "提案力"],
            modelScore: 76,
            history: [62, 66, 74, 79],
            typeHistory: {
              施策提案: [55, 61, 70, 77]
            }
          },
          {
            key: "q3",
            label: "Q3",
            title: "技能伝承の仕組み",
            prompt: "技能伝承の停滞を解消する仕組みと、評価制度の見直し案を述べよ。",
            score: 25,
            limit: 160,
            keywords: ["技能伝承", "評価制度", "OJT"],
            structure: ["背景", "施策", "評価"],
            nouns: ["技能伝承", "若手", "OJT", "評価制度"],
            modelScore: 90,
            history: [70, 76, 81, 88],
            typeHistory: {
              人材開発: [64, 70, 78, 85]
            }
          },
          {
            key: "q4",
            label: "Q4",
            title: "評価制度の再設計",
            prompt: "部門横断の成果創出を促す評価制度の再設計案を示せ。",
            score: 25,
            limit: 200,
            keywords: ["評価制度", "横断", "成果"],
            structure: ["評価指標", "協働", "成果"],
            nouns: ["評価制度", "部門横断", "成果指標"],
            modelScore: 82,
            history: [60, 68, 75, 82],
            typeHistory: {
              制度設計: [52, 61, 70, 78]
            }
          }
        ],
        tools: {
          mece: [
            "経営課題の漏れをチェック: 人・モノ・カネ・情報で整理",
            "顧客提供価値: 認知→購入→利用→関係維持のMECE",
            "業務プロセス: 企画→設計→製造→納品→アフター"
          ],
          intent: [
            "Q1: 経営課題の全体俯瞰と優先順位付け",
            "Q2: 顧客共創で営業と設計の橋渡し",
            "Q3: 技能継承と評価の仕組み化",
            "Q4: 組織横断の成果評価"
          ],
          frame: [
            "事例Iフレーム: 組織・人事マネジメント視点",
            "課題→原因→対応→効果 の構成テンプレート",
            "KPI設計: 先行指標と結果指標のセット"
          ],
          model: [
            "モデル回答は因果を明示し、数値と固有名詞で説得力を付与",
            "不足要素: 効果の定量表現、顧客ベネフィットの強調",
            "差分: あなたの回答は技能伝承の段取りが強み"
          ]
        }
      };

      const state = {
        startTime: Date.now(),
        activeQuestionIndex: 0,
        answers: new Map(),
        insightHidden: false,
        toolsCollapsed: false,
      };

      const scenarioTitle = document.getElementById("scenario-title");
      const scenarioMeta = document.querySelector("[data-scenario-meta]");
      const scenarioBody = document.querySelector("[data-scenario-body]");
      const questionTabs = document.querySelector("[data-question-tabs]");
      const questionPanels = document.querySelector("[data-question-panels]");
      const timer = document.querySelector("[data-timer]");
      const timerLabel = document.querySelector("[data-timer-label]");
      const noticePanel = document.getElementById("notice-panel");
      const answerSummary = document.querySelector("[data-answer-summary]");
      const structureChips = document.querySelector("[data-structure-chips]");
      const nounChips = document.querySelector("[data-noun-chips]");
      const insightPanel = document.querySelector("[data-insight]");
      const dashboardOverlay = document.querySelector("[data-dashboard-overlay]");

      function renderScenario() {
        scenarioTitle.textContent = examData.scenario.title;
        scenarioMeta.innerHTML = examData.scenario.meta
          .map(
            (item) =>
              `<span>${item.label}</span><strong>${item.value}</strong>`
          )
          .join("");
        scenarioBody.innerHTML = examData.scenario.body
          .map((paragraph) => `<p>${paragraph}</p>`)
          .join("");
      }

      function createTab(question, index) {
        const button = document.createElement("button");
        button.className = "question-tab";
        button.type = "button";
        button.role = "tab";
        button.id = `tab-${question.key}`;
        button.setAttribute("aria-controls", `panel-${question.key}`);
        button.setAttribute("aria-selected", index === 0 ? "true" : "false");
        button.dataset.index = index;
        button.tabIndex = index === 0 ? 0 : -1;
        button.innerHTML = `<div>${question.label}</div><small>${question.title}</small>`;
        button.addEventListener("click", () => activateQuestion(index));
        return button;
      }

      function createPanel(question, index) {
        const article = document.createElement("article");
        article.className = "question-panel";
        article.id = `panel-${question.key}`;
        article.setAttribute("role", "tabpanel");
        article.setAttribute("aria-labelledby", `tab-${question.key}`);
        article.setAttribute("aria-hidden", index === 0 ? "false" : "true");
        article.dataset.questionKey = question.key;
        article.innerHTML = `
          <div class="question-header">
            <h3 style="margin:0 0 var(--spacing-xs);">${question.title}</h3>
            <p>${question.prompt}</p>
            <div class="question-header__meta">
              <span>配点 ${question.score}点</span>
              <span>制限 ${question.limit}字</span>
            </div>
          </div>
          <div class="answer-container">
            <div class="answer-editor">
              <div class="answer-topbar">
                <div class="char-progress" aria-hidden="true">
                  <div class="char-progress__bar" data-progress-bar></div>
                </div>
                <div class="char-stats">
                  <div class="char-stats__item" data-remaining><i class="bx bx-edit"></i><span>残り ${question.limit}</span></div>
                  <div class="char-stats__item" data-coverage><i class="bx bx-shape-square"></i><span>カバー率 0%</span></div>
                  <div class="char-stats__item" data-zenkaku><i class="bx bx-text"></i><span>全角換算 0字</span></div>
                </div>
              </div>
              <label class="sr-only" for="answer-${question.key}">${question.title}の解答欄</label>
              <textarea
                id="answer-${question.key}"
                class="answer-textarea"
                data-answer
                data-question-key="${question.key}"
                data-limit="${question.limit}"
                placeholder="ここに解答を入力してください"
              ></textarea>
            </div>
            <div class="memo-area">
              <strong>骨子メモ</strong>
              <textarea placeholder="要素を整理しながら書き写しましょう"></textarea>
              <small style="color:var(--color-muted);">ハイライトとの対応付けに活用</small>
            </div>
          </div>
        `;
        const textarea = article.querySelector("[data-answer]");
        textarea.addEventListener("input", () => updateAnswerState(article, question));
        article.dataset.keywords = JSON.stringify(question.keywords);
        article.dataset.structure = JSON.stringify(question.structure);
        article.dataset.nouns = JSON.stringify(question.nouns);
        return article;
      }

      function updateInsight(question) {
        structureChips.innerHTML = question.structure
          .map((label) => `<span class="chip"><i class='bx bx-merge'></i>${label}</span>`)
          .join("");
        nounChips.innerHTML = question.nouns
          .map((noun) => `<span class="chip"><i class='bx bx-purchase-tag'></i>${noun}</span>`)
          .join("");
      }

      function activateQuestion(index) {
        const tabs = [...questionTabs.querySelectorAll(".question-tab")];
        const panels = [...questionPanels.querySelectorAll(".question-panel")];
        if (!tabs[index] || !panels[index]) return;
        tabs.forEach((tab, tabIndex) => {
          tab.setAttribute("aria-selected", tabIndex === index ? "true" : "false");
          tab.tabIndex = tabIndex === index ? 0 : -1;
        });
        panels.forEach((panel, panelIndex) => {
          panel.setAttribute("aria-hidden", panelIndex === index ? "false" : "true");
        });
        state.activeQuestionIndex = index;
        updateInsight(examData.questions[index]);
        panels[index].querySelector("textarea").focus({ preventScroll: false });
      }

      function computeCoverage(answer, keywords) {
        if (!keywords || keywords.length === 0) return 0;
        const normalized = answer.replace(/\s+/g, "");
        const matched = keywords.filter((keyword) => normalized.includes(keyword));
        return Math.round((matched.length / keywords.length) * 100);
      }

      function updateAnswerState(panel, question) {
        const textarea = panel.querySelector("[data-answer]");
        const remainingLabel = panel.querySelector("[data-remaining] span");
        const coverageLabel = panel.querySelector("[data-coverage] span");
        const zenkakuLabel = panel.querySelector("[data-zenkaku] span");
        const bar = panel.querySelector("[data-progress-bar]");
        const limit = Number(textarea.dataset.limit);
        const length = textarea.value.length;
        const remaining = Math.max(limit - length, 0);
        const coverage = computeCoverage(textarea.value, question.keywords);
        const zenkaku = Math.round(length * 1.0);
        const ratio = Math.min(length / limit, 1);
        remainingLabel.textContent = `残り ${remaining}`;
        coverageLabel.textContent = `カバー率 ${coverage}%`;
        zenkakuLabel.textContent = `全角換算 ${zenkaku}字`;
        bar.style.width = `${ratio * 100}%`;
        if (ratio < 0.7) {
          bar.style.background = `linear-gradient(90deg, var(--color-progress-good), #6f8bff)`;
        } else if (ratio < 0.95) {
          bar.style.background = `linear-gradient(90deg, var(--color-progress-warning), #ffd27f)`;
        } else {
          bar.style.background = `linear-gradient(90deg, var(--color-progress-danger), #ff99b2)`;
        }
        state.answers.set(question.key, {
          text: textarea.value,
          remaining,
          coverage,
          length,
        });
        renderAnswerSummary();
      }

      function renderAnswerSummary() {
        const entries = examData.questions.map((q) => state.answers.get(q.key));
        const completed = entries.filter((entry) => entry && entry.length > 0).length;
        const coverageAvg = entries.reduce((sum, entry) => sum + (entry?.coverage || 0), 0) / examData.questions.length;
        answerSummary.textContent = `入力済み ${completed}/${examData.questions.length}問 ・ 平均カバー率 ${Math.round(coverageAvg)}%`;
      }

      function toggleNotice() {
        const expanded = noticePanel.getAttribute("aria-hidden") === "false";
        noticePanel.setAttribute("aria-hidden", expanded ? "true" : "false");
        document.querySelector("[data-notice-toggle]").setAttribute("aria-expanded", expanded ? "false" : "true");
      }

      function toggleContextPane() {
        const hide = document.body.getAttribute("data-hide-context") === "true";
        document.body.setAttribute("data-hide-context", hide ? "false" : "true");
      }

      function updateTimer() {
        const now = Date.now();
        const elapsed = Math.floor((now - state.startTime) / 1000);
        const total = examData.timeLimitMinutes * 60;
        const remaining = Math.max(total - elapsed, 0);
        const minutes = String(Math.floor(remaining / 60)).padStart(2, "0");
        const seconds = String(remaining % 60).padStart(2, "0");
        timerLabel.textContent = `${minutes}:${seconds}`;
        const warning = remaining <= 5 * 60 && remaining > 120;
        const danger = remaining <= 120;
        if (warning) {
          timer.setAttribute("data-warning", "true");
        } else {
          timer.removeAttribute("data-warning");
        }
        if (danger) {
          timer.setAttribute("data-danger", "true");
        } else {
          timer.removeAttribute("data-danger");
        }
        if (remaining === 0) {
          clearInterval(timerInterval);
        }
      }

      function openToolModal(key) {
        const modal = document.getElementById(`tool-${key}`);
        if (!modal) return;
        const body = modal.querySelector(`[data-tool-body="${key}"]`);
        const items = examData.tools[key] || [];
        body.innerHTML = items.map((item) => `<div>・${item}</div>`).join("");
        if (typeof modal.showModal === "function") {
          modal.showModal();
        }
      }

      function closeModal(button) {
        const dialog = button.closest("dialog");
        if (dialog && dialog.open) dialog.close();
      }

      function toggleToolsSidebar() {
        state.toolsCollapsed = !state.toolsCollapsed;
        const sidebar = document.querySelector("[data-tools]");
        sidebar.dataset.collapsed = state.toolsCollapsed ? "true" : "false";
        sidebar.querySelector("[data-tool-collapse]").setAttribute("aria-expanded", state.toolsCollapsed ? "false" : "true");
      }

      function toggleInsightPanel(hide) {
        state.insightHidden = typeof hide === "boolean" ? hide : !state.insightHidden;
        insightPanel.dataset.hidden = state.insightHidden ? "true" : "false";
      }

      function goToQuestion(offset) {
        const nextIndex = Math.min(
          examData.questions.length - 1,
          Math.max(0, state.activeQuestionIndex + offset)
        );
        activateQuestion(nextIndex);
      }

      function buildDashboard() {
        const questionChart = document.querySelector("[data-chart-questions]");
        const modelChart = document.querySelector("[data-chart-model]");
        const yearChart = document.querySelector("[data-chart-year]");
        const typeChart = document.querySelector("[data-chart-type]");
        questionChart.innerHTML = examData.questions
          .map((q) => {
            const answer = state.answers.get(q.key);
            const score = answer ? Math.min(q.score, Math.round((answer.coverage / 100) * q.score)) : 0;
            return `<div class="chart-bar__row"><span class="chart-bar__label">${q.label}</span><div class="chart-bar__track"><div class="chart-bar__value" style="width:${(score / q.score) * 100}%"></div></div><span style="font-size:0.8rem;">${score}点</span></div>`;
          })
          .join("");
        modelChart.innerHTML = examData.questions
          .map((q) => {
            const answer = state.answers.get(q.key);
            const diff = answer ? Math.max(q.modelScore - answer.coverage, 0) : q.modelScore;
            return `<div class="chart-bar__row"><span class="chart-bar__label">${q.label}</span><div class="chart-bar__track"><div class="chart-bar__value" style="width:${Math.min(100, (answer?.coverage || 0))}%"></div></div><span style="font-size:0.8rem;">差分 ${diff}pt</span></div>`;
          })
          .join("");
        yearChart.innerHTML = examData.questions
          .map((q) => {
            const latest = q.history[q.history.length - 1];
            const base = q.history[0];
            return `<div class="chart-bar__row"><span class="chart-bar__label">${q.label}</span><div class="chart-bar__track"><div class="chart-bar__value" style="width:${latest}%"></div></div><span style="font-size:0.8rem;">${base}%→${latest}%</span></div>`;
          })
          .join("");
        typeChart.innerHTML = examData.questions
          .map((q) => {
            const [[type, values]] = Object.entries(q.typeHistory);
            const latest = values[values.length - 1];
            return `<div class="chart-bar__row"><span class="chart-bar__label">${type}</span><div class="chart-bar__track"><div class="chart-bar__value" style="width:${latest}%"></div></div><span style="font-size:0.8rem;">${latest}%</span></div>`;
          })
          .join("");
      }

      function openDashboard() {
        buildDashboard();
        dashboardOverlay.setAttribute("aria-hidden", "false");
      }

      function closeDashboard() {
        dashboardOverlay.setAttribute("aria-hidden", "true");
      }

      document.querySelector("[data-notice-toggle]").addEventListener("click", toggleNotice);
      document.querySelector("[data-toggle-context]").addEventListener("click", toggleContextPane);
      document.querySelector("[data-insight-toggle]").addEventListener("click", () => toggleInsightPanel(true));
      document.querySelector("[data-tool-collapse]").addEventListener("click", toggleToolsSidebar);
      document.querySelectorAll("[data-tool]").forEach((button) => {
        button.addEventListener("click", () => openToolModal(button.dataset.tool));
      });
      document.querySelectorAll("[data-close-modal]").forEach((button) => {
        button.addEventListener("click", () => closeModal(button));
      });
      document.querySelector("[data-submit]").addEventListener("click", openDashboard);
      document.querySelector("[data-dashboard-close]").addEventListener("click", closeDashboard);
      dashboardOverlay.addEventListener("click", (event) => {
        if (event.target === dashboardOverlay) closeDashboard();
      });

      document.addEventListener("keydown", (event) => {
        if (event.key === "g" && !event.metaKey && !event.ctrlKey && !event.altKey) {
          event.preventDefault();
          toggleContextPane();
        }
        if (event.ctrlKey && !event.shiftKey && !event.altKey && (event.key === "ArrowUp" || event.key === "ArrowDown")) {
          event.preventDefault();
          goToQuestion(event.key === "ArrowUp" ? -1 : 1);
        }
        if (event.key.toLowerCase() === "h" && !event.metaKey) {
          event.preventDefault();
          openToolModal("intent");
        }
        if (event.key.toLowerCase() === "f" && !event.metaKey) {
          event.preventDefault();
          openToolModal("frame");
        }
        if (event.key.toLowerCase() === "m" && !event.metaKey) {
          event.preventDefault();
          openToolModal("model");
        }
        if (event.ctrlKey && event.shiftKey && event.key.toLowerCase() === "s") {
          event.preventDefault();
          toggleInsightPanel();
        }
      });

      renderScenario();
      examData.questions.forEach((question, index) => {
        const tab = createTab(question, index);
        questionTabs.appendChild(tab);
        const panel = createPanel(question, index);
        questionPanels.appendChild(panel);
      });
      updateInsight(examData.questions[0]);
      renderAnswerSummary();
      const timerInterval = setInterval(updateTimer, 1000);
      updateTimer();
    </script>
  </body>
</html>
