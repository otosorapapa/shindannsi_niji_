<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>診断士二次 演習UIプロトタイプ</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@700&family=Noto+Sans+JP:wght@400;500;700&family=Noto+Sans+Mono:wght@500&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css"
    />
    <style>
      body[data-app="exercise"] {
        /* カラーと余白のカスタムプロパティ */
        --color-primary: #1f3a68;
        --color-primary-dark: #142a4d;
        --color-accent: #f28c2f;
        --color-accent-strong: #d9741f;
        --color-bg: #f4f7fb;
        --color-surface: #ffffff;
        --color-text: #1c273a;
        --color-text-strong: #122038;
        --color-border: rgba(18, 33, 56, 0.12);
        --color-chip-bg: color-mix(in srgb, var(--color-primary) 14%, #ffffff 86%);
        --color-chip-active: var(--color-primary);
        --color-chip-active-text: #ffffff;
        --color-warning: var(--color-accent-strong);
        --color-text-muted: color-mix(in srgb, var(--color-text) 62%, #7b879a 38%);
        --color-layer-subtle: color-mix(in srgb, var(--color-primary) 8%, #f8faff 92%);
        --color-layer-soft: color-mix(in srgb, var(--color-primary) 12%, #eef3fb 88%);
        --color-focus-ring: color-mix(in srgb, var(--color-primary) 45%, transparent);
        --color-cta: var(--color-accent);
        --color-cta-strong: var(--color-accent-strong);
        --color-cta-text: #ffffff;
        --radius-card: 16px;
        --spacing-xl: 40px;
        --spacing-lg: 32px;
        --spacing-md: 16px;
        --spacing-sm: 12px;
        --spacing-xs: 8px;
        --transition-duration: 200ms;
        --font-heading-xl: clamp(1.9rem, 1.6rem + 0.5vw, 2.2rem);
        --font-heading-lg: clamp(1.45rem, 1.3rem + 0.3vw, 1.6rem);
        --font-heading-md: clamp(1.2rem, 1.12rem + 0.2vw, 1.32rem);
        --content-max-width: min(720px, 100%);
        --icon-size-sm: 1rem;
        --icon-size-md: 1.25rem;
        --highlight-strength-base: var(--color-primary);
        --highlight-strength-contrast: color-mix(
          in srgb,
          var(--color-primary) 18%,
          #ffffff 82%
        );
        --highlight-weakness-base: var(--color-accent);
        --highlight-weakness-contrast: color-mix(
          in srgb,
          var(--color-accent) 18%,
          #ffffff 82%
        );
        --highlight-challenge-base: color-mix(
          in srgb,
          var(--color-primary) 70%,
          var(--color-accent) 30%
        );
        --highlight-challenge-contrast: color-mix(
          in srgb,
          var(--highlight-challenge-base) 16%,
          #ffffff 84%
        );
        --highlight-opportunity-base: color-mix(
          in srgb,
          var(--color-primary) 45%,
          #ffffff 55%
        );
        --highlight-opportunity-contrast: color-mix(
          in srgb,
          var(--highlight-opportunity-base) 18%,
          #ffffff 82%
        );
        --highlight-pattern-size: 16px;
        font-size: 16px;
      }

      @media (prefers-color-scheme: dark) {
        body[data-app="exercise"] {
          --color-bg: #101a2d;
          --color-surface: rgba(22, 33, 54, 0.94);
          --color-text: #e3eaf6;
          --color-text-strong: #f6f8ff;
          --color-border: rgba(228, 236, 247, 0.16);
          --color-chip-bg: color-mix(
            in srgb,
            var(--color-primary) 26%,
            transparent
          );
          --color-chip-active: color-mix(
            in srgb,
            var(--color-primary) 70%,
            #ffffff 30%
          );
          --color-chip-active-text: #0f1727;
          --color-warning: color-mix(
            in srgb,
            var(--color-accent) 70%,
            #ffffff 30%
          );
          --color-text-muted: rgba(227, 234, 246, 0.75);
          --color-layer-subtle: rgba(46, 77, 129, 0.22);
          --color-layer-soft: rgba(61, 97, 155, 0.26);
          --color-focus-ring: color-mix(
            in srgb,
            var(--color-primary) 65%,
            transparent
          );
          --color-cta: color-mix(
            in srgb,
            var(--color-accent) 75%,
            #ffffff 25%
          );
          --color-cta-strong: color-mix(
            in srgb,
            var(--color-accent-strong) 80%,
            #ffffff 20%
          );
          --color-cta-text: #0f1727;
          --highlight-strength-contrast: color-mix(
            in srgb,
            var(--color-primary) 40%,
            transparent
          );
          --highlight-weakness-contrast: color-mix(
            in srgb,
            var(--color-accent) 38%,
            transparent
          );
          --highlight-challenge-contrast: color-mix(
            in srgb,
            var(--highlight-challenge-base) 34%,
            transparent
          );
          --highlight-opportunity-contrast: color-mix(
            in srgb,
            var(--highlight-opportunity-base) 32%,
            transparent
          );
        }
      }

      body[data-app="exercise"] *,
      body[data-app="exercise"] *::before,
      body[data-app="exercise"] *::after {
        box-sizing: border-box;
      }

      body[data-app="exercise"] {
        margin: 0;
        font-family: "Noto Sans JP", system-ui, -apple-system, BlinkMacSystemFont,
          "Segoe UI", sans-serif;
        background-color: var(--color-bg);
        color: var(--color-text);
        line-height: 1.6;
        text-rendering: optimizeLegibility;
      }

      body[data-app="exercise"] h1,
      body[data-app="exercise"] .heading-xl {
        font-size: var(--font-heading-xl);
        font-weight: 700;
        line-height: 1.28;
        letter-spacing: 0.01em;
        margin: 0 0 var(--spacing-sm);
        font-family: "M PLUS Rounded 1c", "Noto Sans JP", sans-serif;
        color: var(--color-text-strong);
      }

      body[data-app="exercise"] h2,
      body[data-app="exercise"] .heading-lg {
        font-size: var(--font-heading-lg);
        font-weight: 700;
        line-height: 1.3;
        margin: 0 0 var(--spacing-sm);
        font-family: "M PLUS Rounded 1c", "Noto Sans JP", sans-serif;
        color: var(--color-text-strong);
      }

      body[data-app="exercise"] h3,
      body[data-app="exercise"] .heading-md {
        font-size: var(--font-heading-md);
        font-weight: 700;
        line-height: 1.35;
        margin: 0 0 var(--spacing-xs);
        font-family: "M PLUS Rounded 1c", "Noto Sans JP", sans-serif;
        color: var(--color-text-strong);
      }

      body[data-app="exercise"] p {
        margin: 0 0 var(--spacing-sm);
      }

      body[data-app="exercise"] p,
      body[data-app="exercise"] li,
      body[data-app="exercise"] dd {
        font-size: 0.95rem;
        line-height: 1.75;
      }

      body[data-app="exercise"] small,
      body[data-app="exercise"] .text-muted {
        font-size: 0.85rem;
        line-height: 1.6;
      }

      body[data-app="exercise"] .text-muted {
        color: var(--color-text-muted);
      }

      body[data-app="exercise"] a {
        color: inherit;
      }

      body[data-app="exercise"] .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
      }

      body[data-app="exercise"] a:focus-visible,
      body[data-app="exercise"] button:focus-visible,
      body[data-app="exercise"] textarea:focus-visible,
      body[data-app="exercise"] [role="button"]:focus-visible {
        outline: none;
        box-shadow: 0 0 0 3px var(--color-focus-ring);
        border-radius: 8px;
      }

      body[data-app="exercise"] .ui-button {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: var(--spacing-xs);
        padding: 10px 16px;
        border-radius: 999px;
        border: 1px solid var(--color-border);
        background-color: var(--color-surface);
        color: var(--color-text-strong);
        font-size: 0.95rem;
        font-weight: 600;
        letter-spacing: 0.01em;
        cursor: pointer;
        line-height: 1.35;
        transition: background-color var(--transition-duration) ease,
          color var(--transition-duration) ease,
          border-color var(--transition-duration) ease,
          box-shadow var(--transition-duration) ease,
          transform var(--transition-duration) ease;
      }

      body[data-app="exercise"] .ui-button[disabled] {
        cursor: not-allowed;
        opacity: 0.5;
        pointer-events: none;
      }

      body[data-app="exercise"] .ui-button--ghost {
        background-color: transparent;
        border-color: color-mix(in srgb, var(--color-border) 60%, transparent);
        color: var(--color-text);
      }

      body[data-app="exercise"] .ui-button--ghost:hover,
      body[data-app="exercise"] .ui-button--ghost:focus-visible {
        background-color: color-mix(
          in srgb,
          var(--color-chip-bg) 60%,
          transparent
        );
        border-color: var(--color-chip-active);
        color: var(--color-text-strong);
      }

      body[data-app="exercise"] .ui-button--icon {
        padding: 0;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: var(--color-surface);
        border: 1px solid var(--color-border);
        color: var(--color-text-muted);
      }

      body[data-app="exercise"] .ui-button--icon:hover,
      body[data-app="exercise"] .ui-button--icon:focus-visible {
        border-color: var(--color-chip-active);
        color: var(--color-chip-active);
        background-color: color-mix(
          in srgb,
          var(--color-chip-bg) 65%,
          transparent
        );
      }

      body[data-app="exercise"] .ui-button--sm {
        width: 32px;
        height: 32px;
      }

      body[data-app="exercise"] .ui-select {
        width: 100%;
        padding: 10px 36px 10px 12px;
        border-radius: 12px;
        border: 1px solid var(--color-border);
        background-color: var(--color-surface);
        color: var(--color-text);
        font-size: 0.92rem;
        line-height: 1.4;
        appearance: none;
        background-image: linear-gradient(45deg, transparent 50%, currentColor 50%),
          linear-gradient(135deg, currentColor 50%, transparent 50%);
        background-position: calc(100% - 24px) 16px, calc(100% - 18px) 16px;
        background-size: 6px 6px;
        background-repeat: no-repeat;
      }

      body[data-app="exercise"] .ui-select:focus-visible {
        outline: none;
        box-shadow: 0 0 0 3px var(--color-focus-ring);
        border-color: var(--color-chip-active);
      }

      body[data-app="exercise"] .icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: var(--icon-size-md);
        line-height: 1;
      }

      body[data-app="exercise"] .icon--sm {
        font-size: var(--icon-size-sm);
      }

      body[data-app="exercise"] .has-tooltip {
        position: relative;
      }

      body[data-app="exercise"] .has-tooltip::after {
        content: attr(data-tooltip);
        position: absolute;
        inset-block-end: calc(100% + 6px);
        inset-inline-start: 50%;
        transform: translate(-50%, 4px);
        padding: 6px 10px;
        border-radius: 8px;
        background-color: color-mix(
          in srgb,
          var(--color-primary-dark) 85%,
          rgba(19, 32, 54, 0.85) 15%
        );
        color: #ffffff;
        font-size: 0.78rem;
        white-space: nowrap;
        opacity: 0;
        pointer-events: none;
        transition: opacity var(--transition-duration) ease,
          transform var(--transition-duration) ease;
        box-shadow: 0 8px 16px rgba(19, 32, 54, 0.18);
        z-index: 5;
      }

      body[data-app="exercise"] .has-tooltip::before {
        content: "";
        position: absolute;
        inset-inline-start: 50%;
        inset-block-end: calc(100% + 2px);
        transform: translateX(-50%);
        border: 6px solid transparent;
        border-top-color: color-mix(
          in srgb,
          var(--color-primary-dark) 85%,
          rgba(19, 32, 54, 0.85) 15%
        );
        opacity: 0;
        transition: opacity var(--transition-duration) ease;
        z-index: 5;
      }

      body[data-app="exercise"] .has-tooltip:hover::after,
      body[data-app="exercise"] .has-tooltip:focus-visible::after,
      body[data-app="exercise"] .has-tooltip:hover::before,
      body[data-app="exercise"] .has-tooltip:focus-visible::before {
        opacity: 1;
        transform: translate(-50%, 0);
      }

      body[data-app="exercise"] .ui-button:focus-visible {
        border-radius: 999px;
      }

      body[data-app="exercise"] .ui-button:hover {
        border-color: var(--color-chip-active);
      }

      body[data-app="exercise"] .ui-button--lg {
        padding: 12px 20px;
        font-size: 1rem;
      }

      body[data-app="exercise"] .ui-button--primary {
        background-color: var(--color-cta);
        border-color: var(--color-cta);
        color: var(--color-cta-text);
        font-weight: 700;
      }

      body[data-app="exercise"] .ui-button--primary:hover,
      body[data-app="exercise"] .ui-button--primary:focus-visible {
        background-color: var(--color-cta-strong);
        border-color: var(--color-cta-strong);
        box-shadow: 0 0 0 3px color-mix(
            in srgb,
            var(--color-cta) 45%,
            transparent
          );
        transform: translateY(-1px);
      }

      body[data-app="exercise"] .ui-button--subtle {
        justify-content: flex-start;
        padding: var(--spacing-xs) var(--spacing-sm);
        background-color: var(--color-layer-subtle);
        border-color: transparent;
        color: var(--color-text);
        font-size: 0.92rem;
      }

      body[data-app="exercise"] .ui-button--subtle:hover,
      body[data-app="exercise"] .ui-button--subtle:focus-visible {
        background-color: color-mix(
          in srgb,
          var(--color-chip-active) 18%,
          var(--color-layer-subtle)
        );
        border-color: transparent;
        color: var(--color-text-strong);
      }

      body[data-app="exercise"] .app-shell {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        gap: var(--spacing-lg);
      }

      body[data-app="exercise"] .app-header {
        position: sticky;
        top: 0;
        z-index: 10;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: var(--spacing-md);
        padding: 16px var(--spacing-lg);
        background-color: color-mix(
          in srgb,
          var(--color-bg) 85%,
          var(--color-surface)
        );
        border-bottom: 1px solid color-mix(
          in srgb,
          var(--color-border) 70%,
          transparent
        );
        backdrop-filter: blur(16px);
      }

      body[data-app="exercise"] .app-header__group {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
      }

      body[data-app="exercise"] .app-header__quicknav {
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
        margin-left: auto;
      }

      body[data-app="exercise"] .app-header__anchor {
        position: relative;
        font-weight: 600;
        font-size: 0.92rem;
        color: var(--color-text-muted);
        background-color: transparent;
        transition: background-color var(--transition-duration) ease,
          color var(--transition-duration) ease;
      }

      body[data-app="exercise"] .app-header__anchor::after {
        content: "";
        position: absolute;
        inset-inline: var(--spacing-xs);
        bottom: calc(var(--spacing-xs) * -0.5);
        height: 2px;
        background-color: transparent;
        border-radius: 999px;
        transition: background-color var(--transition-duration) ease,
          transform var(--transition-duration) ease;
        transform: scaleX(0);
        transform-origin: center;
      }

      body[data-app="exercise"] .app-header__anchor:hover,
      body[data-app="exercise"] .app-header__anchor:focus-visible {
        color: var(--color-text-strong);
        background-color: color-mix(
          in srgb,
          var(--color-chip-bg) 70%,
          transparent
        );
      }

      body[data-app="exercise"] .app-header__anchor[data-active="true"] {
        color: var(--color-chip-active);
      }

      body[data-app="exercise"] .app-header__anchor[data-active="true"]::after {
        background-color: var(--color-chip-active);
        transform: scaleX(1);
      }

      body[data-app="exercise"] .app-header__title {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      body[data-app="exercise"] .app-header__title h1 {
        margin: 0;
        font-size: 1.25rem;
        font-weight: 700;
      }

      body[data-app="exercise"] .app-header__title span {
        font-size: 0.85rem;
        color: var(--color-text-muted);
      }

      body[data-app="exercise"] .app-header__selection {
        display: inline-flex;
        align-items: center;
        gap: var(--spacing-xs);
        padding: 6px 12px;
        border-radius: 999px;
        background-color: color-mix(
          in srgb,
          var(--color-chip-bg) 70%,
          transparent
        );
        color: var(--color-text-strong);
        font-size: 0.85rem;
        font-weight: 600;
        line-height: 1.4;
      }

      body[data-app="exercise"] .app-header__selection-item--strong {
        color: var(--color-chip-active);
      }

      body[data-app="exercise"] .app-header__selection-separator {
        display: inline-flex;
        align-items: center;
        color: var(--color-text-muted);
      }

      @media (max-width: 960px) {
        body[data-app="exercise"] .app-header__selection {
          flex-wrap: wrap;
          justify-content: center;
          width: 100%;
        }

        body[data-app="exercise"] .question-card__fields {
          grid-template-columns: 1fr;
        }
      }

      body[data-app="exercise"] .app-header__button {
        font-size: 0.92rem;
        color: var(--color-text-muted);
      }

      body[data-app="exercise"] .app-header__icon {
        font-size: var(--icon-size-md);
        color: currentColor;
      }

      body[data-app="exercise"] .app-header__controls {
        display: flex;
        gap: var(--spacing-sm);
        align-items: center;
        flex-wrap: wrap;
        margin-left: auto;
      }

      body[data-app="exercise"] .app-header__control {
        display: grid;
        gap: 4px;
        font-size: 0.75rem;
        color: var(--color-text-muted);
      }

      body[data-app="exercise"] .app-header__control span {
        font-weight: 600;
        letter-spacing: 0.02em;
      }

      body[data-app="exercise"] .app-header__control select {
        min-width: 120px;
        padding: 6px 32px 6px 12px;
        border-radius: 999px;
        border: 1px solid var(--color-border);
        background-color: var(--color-surface);
        color: var(--color-text);
        font-size: 0.85rem;
      }

      body[data-app="exercise"] .app-progress {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: var(--spacing-md);
        align-items: stretch;
        padding: var(--spacing-md) var(--spacing-lg);
      }

      body[data-app="exercise"] .progress-card {
        display: grid;
        gap: var(--spacing-xs);
        padding: var(--spacing-md);
        border-radius: var(--radius-card);
        background: color-mix(
          in srgb,
          var(--color-chip-bg) 55%,
          transparent
        );
        box-shadow: 0 12px 28px rgba(15, 23, 39, 0.08);
        min-height: 88px;
      }

      @media (prefers-color-scheme: dark) {
        body[data-app="exercise"] .progress-card {
          background: color-mix(
            in srgb,
            var(--color-chip-bg) 35%,
            var(--color-surface)
          );
        }
      }

      body[data-app="exercise"] .progress-card__header {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        gap: var(--spacing-xs);
        font-size: 0.85rem;
        font-weight: 600;
      }

      body[data-app="exercise"] .progress-card__title {
        color: var(--color-text-strong);
      }

      body[data-app="exercise"] .progress-card__meta {
        color: var(--color-text-muted);
        font-variant-numeric: tabular-nums;
      }

      body[data-app="exercise"] .progress-card__bar {
        position: relative;
        height: 6px;
        border-radius: 999px;
        overflow: hidden;
        background-color: color-mix(
          in srgb,
          var(--color-border) 60%,
          transparent
        );
      }

      body[data-app="exercise"] .progress-card__bar span {
        position: absolute;
        inset: 0;
        border-radius: inherit;
        background: linear-gradient(
          90deg,
          var(--color-chip-active) 0%,
          color-mix(in srgb, var(--color-chip-active) 70%, #fff) 100%
        );
        width: 0;
        transition: width 280ms ease;
      }

      body[data-app="exercise"] .progress-card--timer {
        background: color-mix(
          in srgb,
          var(--color-warning) 20%,
          var(--color-layer-subtle)
        );
      }

      body[data-app="exercise"] .section-tabs {
        display: flex;
        gap: var(--spacing-sm);
        padding: var(--spacing-sm) var(--spacing-lg) 0;
        overflow-x: auto;
        scroll-snap-type: x mandatory;
        scrollbar-width: thin;
      }

      body[data-app="exercise"] .section-tabs::-webkit-scrollbar {
        height: 6px;
      }

      body[data-app="exercise"] .section-tabs::-webkit-scrollbar-thumb {
        background-color: rgba(27, 35, 55, 0.25);
        border-radius: 999px;
      }

      body[data-app="exercise"] .section-tab {
        display: inline-flex;
        align-items: center;
        gap: var(--spacing-sm);
        padding: 12px 18px;
        min-width: 220px;
        border-radius: var(--radius-card);
        border: 1px solid var(--color-border);
        background: var(--color-surface);
        color: var(--color-text);
        cursor: pointer;
        transition: background-color var(--transition-duration) ease,
          border-color var(--transition-duration) ease,
          color var(--transition-duration) ease,
          box-shadow var(--transition-duration) ease;
        scroll-snap-align: start;
      }

      body[data-app="exercise"] .section-tab:focus-visible {
        outline: none;
        box-shadow: 0 0 0 3px var(--color-focus-ring);
        border-color: var(--color-chip-active);
      }

      body[data-app="exercise"] .section-tab:hover {
        border-color: var(--color-chip-active);
        color: var(--color-text-strong);
      }

      body[data-app="exercise"] .section-tab[aria-selected='true'] {
        background: var(--color-chip-active);
        border-color: var(--color-chip-active);
        color: var(--color-chip-active-text);
        box-shadow: 0 0 0 3px color-mix(
          in srgb,
          var(--color-chip-active) 30%,
          transparent
        );
      }

      body[data-app="exercise"] .section-tab__icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 36px;
        height: 36px;
        border-radius: 12px;
        background: color-mix(
          in srgb,
          var(--color-chip-bg) 70%,
          transparent
        );
        color: inherit;
        font-size: var(--icon-size-md);
      }

      body[data-app="exercise"] .section-tab[aria-selected='true'] .section-tab__icon {
        background: color-mix(in srgb, var(--color-chip-active) 25%, var(--color-bg));
        color: var(--color-chip-active-text);
      }

      body[data-app="exercise"] .section-tab__texts {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 2px;
      }

      body[data-app="exercise"] .section-tab__title {
        font-family: "M PLUS Rounded 1c", "Noto Sans JP", sans-serif;
        font-size: 0.98rem;
        font-weight: 700;
      }

      body[data-app="exercise"] .section-tab__description {
        font-size: 0.82rem;
        color: var(--color-text-muted);
      }

      body[data-app="exercise"] .section-tab[aria-selected='true']
        .section-tab__description {
        color: var(--color-chip-active-text);
      }

      body[data-app="exercise"] [data-panel-collapsed='true'] {
        display: none !important;
      }

      body[data-app="exercise"] .layout {
        --layout-left-width: clamp(320px, 38vw, 520px);
        --layout-resizer-width: 12px;
        display: flex;
        align-items: stretch;
        flex-wrap: nowrap;
        gap: var(--spacing-lg);
        max-width: 1280px;
        margin: 0 auto;
        padding: 0 var(--spacing-lg) calc(var(--spacing-xl) + var(--spacing-lg));
        width: 100%;
      }

      body[data-app="exercise"] .layout[data-resizing='true'] {
        cursor: col-resize;
        user-select: none;
      }

      body[data-app="exercise"] .layout__pane {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-xl);
        min-width: 0;
      }

      body[data-app="exercise"] .layout__pane--left {
        flex: 0 0 var(--layout-left-width);
        max-width: min(var(--layout-left-width), 60%);
      }

      body[data-app="exercise"] .layout__pane--right {
        flex: 1 1 0%;
        min-width: 0;
      }

      body[data-app="exercise"] .layout__resizer {
        position: relative;
        flex: 0 0 var(--layout-resizer-width);
        align-self: stretch;
        border-radius: 999px;
        background: color-mix(in srgb, var(--color-border) 45%, transparent);
        transition: background-color var(--transition-duration) ease,
          box-shadow var(--transition-duration) ease;
        cursor: col-resize;
      }

      body[data-app="exercise"] .layout__resizer::before {
        content: '';
        position: absolute;
        inset-block: 12px;
        inset-inline: 3px;
        border-radius: 999px;
        background: color-mix(in srgb, var(--color-border) 65%, transparent);
      }

      body[data-app="exercise"] .layout__resizer:hover,
      body[data-app="exercise"] .layout__resizer:focus-visible {
        background: color-mix(
          in srgb,
          var(--color-chip-active) 28%,
          var(--color-border) 72%
        );
        box-shadow: 0 0 0 3px var(--color-focus-ring);
      }

      body[data-app="exercise"] .context-pane {
        position: sticky;
        top: var(--spacing-lg);
        max-height: calc(100vh - var(--spacing-lg) * 2);
        overflow-y: auto;
        width: 100%;
        flex: 1 1 auto;
        align-self: flex-start;
        display: flex;
        flex-direction: column;
        gap: var(--spacing-md);
        padding: var(--spacing-lg) var(--spacing-md);
        background: none;
        box-shadow: none;
        min-height: 0;
      }

      body[data-app="exercise"] .context-pane__card { 
        background: var(--color-surface);
        border-radius: var(--radius-card);
        box-shadow: 0 14px 30px rgba(15, 23, 39, 0.08);
        padding: var(--spacing-md);
        display: grid;
        gap: var(--spacing-sm);
      }

      body[data-app="exercise"]
        .context-pane__card--scenario
        [data-accordion-body] {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-md);
      }

      @media (prefers-color-scheme: dark) {
        body[data-app="exercise"] .context-pane__card {
          background: rgba(18, 26, 44, 0.92);
          box-shadow: 0 20px 40px rgba(8, 13, 25, 0.55);
        }
        body[data-app="exercise"] .quick-nav {
          background: rgba(18, 26, 44, 0.92);
          box-shadow: 0 20px 40px rgba(8, 13, 25, 0.55);
        }
        body[data-app="exercise"] .quick-nav__link {
          background: rgba(17, 27, 45, 0.6);
          border-color: rgba(255, 255, 255, 0.08);
        }
        body[data-app="exercise"] .quick-nav__link[data-active='true'] {
          background: color-mix(in srgb, var(--color-chip-bg) 80%, transparent);
        }
      }

      body[data-app="exercise"] .context-pane__header {
        margin: 0;
        gap: var(--spacing-sm);
      }

      body[data-app="exercise"] .context-pane__miniheader {
        display: flex;
        flex-wrap: wrap;
        gap: var(--spacing-xs);
        align-items: center;
        font-size: 0.9rem;
        color: var(--color-text-muted);
      }

      body[data-app="exercise"] .context-pane__miniheader strong {
        color: var(--color-text);
      }

      body[data-app="exercise"] .context-pane__card-title {
        font-size: 1.05rem;
        font-weight: 700;
        margin: 0;
        color: var(--color-text-strong);
        letter-spacing: 0.01em;
      }

      body[data-app="exercise"] .context-pane__card-intro {
        font-size: 0.9rem;
        color: var(--color-text-muted);
        margin: 0;
      }

      body[data-app="exercise"] .context-pane__guide-list {
        list-style: none;
        margin: 0;
        padding: 0;
        display: grid;
        gap: var(--spacing-xs);
      }

      body[data-app="exercise"] .context-pane__guide-item {
        display: flex;
        align-items: flex-start;
        gap: var(--spacing-xs);
        font-size: 0.88rem;
        color: var(--color-text-muted);
      }

      body[data-app="exercise"] .context-pane__guide-icon {
        color: var(--color-chip-active);
        font-size: var(--icon-size-sm);
        line-height: 1;
        margin-top: 2px;
      }

      body[data-app="exercise"] .context-pane__meta {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: var(--spacing-xs) var(--spacing-sm);
        font-size: 0.88rem;
        color: var(--color-text-muted);
        font-family: "Noto Sans Mono", "Noto Sans JP", monospace;
      }

      body[data-app="exercise"] .context-pane__meta dt {
        font-weight: 600;
        letter-spacing: 0.02em;
      }

      body[data-app="exercise"] .context-pane__search {
        display: grid;
        gap: var(--spacing-xs);
      }

      body[data-app="exercise"] .context-pane__search-field {
        position: relative;
      }

      body[data-app="exercise"] .context-pane__search-field input {
        width: 100%;
        padding: 10px 40px 10px 12px;
        border-radius: 999px;
        border: 1px solid var(--color-border);
        background: var(--color-surface);
        font-size: 0.95rem;
        color: inherit;
      }

      body[data-app="exercise"] .context-pane__search-field input:focus {
        outline: none;
        border-color: var(--color-chip-active);
        box-shadow: 0 0 0 3px var(--color-focus-ring);
      }

      body[data-app="exercise"] .context-pane__search-icon {
        position: absolute;
        top: 50%;
        right: 12px;
        transform: translateY(-50%);
        color: var(--color-text-muted);
      }

      body[data-app="exercise"] .context-pane__search-controls {
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
        font-size: 0.85rem;
      }

      body[data-app="exercise"] .context-pane__search-nav {
        border-radius: 50%;
      }

      body[data-app="exercise"] .context-pane__search-nav[disabled] {
        cursor: not-allowed;
        opacity: 0.45;
        pointer-events: none;
      }

      body[data-app="exercise"] .context-pane__actions {
        margin-top: var(--spacing-sm);
        display: flex;
        flex-direction: column;
        gap: var(--spacing-md);
      }

      body[data-app="exercise"] .context-pane__jump {
        font-size: 0.9rem;
        gap: 6px;
        align-self: flex-start;
      }

      body[data-app="exercise"] .context-pane__body {
        font-size: 1rem;
        white-space: pre-line;
        background: color-mix(in srgb, var(--color-layer-subtle) 80%, transparent);
        padding: var(--spacing-sm) var(--spacing-md);
        border-radius: 12px;
        line-height: 1.75;
      }

      body[data-app="exercise"] .exercise {
        flex: 1 1 auto;
        display: flex;
        flex-direction: column;
        gap: var(--spacing-lg);
        min-width: 0;
      }

      body[data-app="exercise"] .quick-nav {
        position: sticky;
        top: var(--spacing-lg);
        width: 100%;
        align-self: flex-start;
        display: flex;
        flex-direction: column;
        gap: var(--spacing-md);
        background: var(--color-surface);
        border-radius: var(--radius-card);
        box-shadow: 0 14px 30px rgba(15, 23, 39, 0.08);
        padding: var(--spacing-md);
        max-height: calc(100vh - var(--spacing-lg) * 2);
        min-height: 0;
      }

      body[data-app="exercise"] .quick-nav__header {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-xs);
      }

      body[data-app="exercise"] .quick-nav__title {
        margin: 0;
        font-size: 1.02rem;
        font-weight: 700;
        color: var(--color-text-strong);
        font-family: "M PLUS Rounded 1c", "Noto Sans JP", sans-serif;
      }

      body[data-app="exercise"] .quick-nav__hint {
        font-size: 0.82rem;
        color: var(--color-text-muted);
        line-height: 1.5;
      }

      body[data-app="exercise"] .quick-nav__list {
        list-style: none;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        gap: var(--spacing-xs);
        flex: 1 1 auto;
        min-height: 0;
        overflow-y: auto;
        overscroll-behavior: contain;
      }

      body[data-app="exercise"] .quick-nav__item {
        display: block;
      }

      body[data-app="exercise"] .quick-nav__link {
        width: 100%;
        border: 1px solid color-mix(in srgb, var(--color-border) 70%, transparent);
        background: color-mix(in srgb, var(--color-layer-subtle) 45%, transparent);
        border-radius: 14px;
        padding: var(--spacing-sm) var(--spacing-sm);
        display: grid;
        grid-template-columns: auto 1fr auto;
        align-items: center;
        gap: var(--spacing-sm);
        color: inherit;
        text-align: left;
        font: inherit;
        cursor: pointer;
        transition: border-color var(--transition-duration) ease,
          box-shadow var(--transition-duration) ease,
          background-color var(--transition-duration) ease;
      }

      body[data-app="exercise"] .quick-nav__link:hover,
      body[data-app="exercise"] .quick-nav__link:focus-visible {
        border-color: var(--color-chip-active);
        background: color-mix(in srgb, var(--color-chip-bg) 65%, transparent);
        box-shadow: 0 10px 18px rgba(15, 23, 39, 0.08);
        outline: none;
      }

      body[data-app="exercise"] .quick-nav__link[data-active='true'] {
        border-color: var(--color-chip-active);
        background: color-mix(in srgb, var(--color-chip-bg) 80%, transparent);
      }

      body[data-app="exercise"] .quick-nav__link[data-status='answered'] {
        border-color: color-mix(in srgb, var(--color-primary) 55%, transparent);
      }

      body[data-app="exercise"] .quick-nav__link[data-status='review'] {
        border-color: color-mix(in srgb, var(--color-warning) 55%, transparent);
      }

      body[data-app="exercise"] .quick-nav__number {
        font-family: "Noto Sans Mono", "Noto Sans JP", monospace;
        font-weight: 700;
        font-size: 0.88rem;
        color: var(--color-chip-active);
      }

      body[data-app="exercise"] .quick-nav__texts {
        display: flex;
        flex-direction: column;
        gap: 2px;
        min-width: 0;
      }

      body[data-app="exercise"] .quick-nav__label {
        font-weight: 600;
        font-size: 0.92rem;
        color: var(--color-text-strong);
        white-space: nowrap;
        text-overflow: ellipsis;
        overflow: hidden;
      }

      body[data-app="exercise"] .quick-nav__status {
        font-size: 0.8rem;
        color: var(--color-text-muted);
      }

      body[data-app="exercise"] .quick-nav__indicator {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: color-mix(in srgb, var(--color-border) 70%, transparent);
      }

      body[data-app="exercise"] .quick-nav__indicator[data-status='answered'] {
        background: var(--color-primary);
      }

      body[data-app="exercise"] .quick-nav__indicator[data-status='review'] {
        background: var(--color-warning);
      }

      body[data-app="exercise"] .quick-nav__indicator[data-status='unanswered'] {
        background: color-mix(in srgb, var(--color-border) 70%, transparent);
      }

      body[data-app="exercise"] .quick-nav__empty {
        padding: var(--spacing-sm);
        border-radius: 12px;
        background: color-mix(in srgb, var(--color-layer-subtle) 65%, transparent);
        font-size: 0.88rem;
        color: var(--color-text-muted);
      }

      body[data-app="exercise"] .accordion-toggle {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        border: none;
        background: transparent;
        color: var(--color-text-muted);
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        padding: 6px 12px;
        border-radius: 999px;
        transition: color var(--transition-duration) ease,
          background-color var(--transition-duration) ease,
          box-shadow var(--transition-duration) ease;
      }

      body[data-app="exercise"] .accordion-toggle:hover,
      body[data-app="exercise"] .accordion-toggle:focus-visible {
        color: var(--color-text-strong);
        background: color-mix(in srgb, var(--color-chip-bg) 70%, transparent);
        outline: none;
        box-shadow: 0 0 0 2px color-mix(in srgb, var(--color-focus-ring) 65%, transparent);
      }

      body[data-app="exercise"] .accordion-toggle__icon {
        display: inline-flex;
        font-size: var(--icon-size-sm);
        transition: transform var(--transition-duration) ease;
      }

      body[data-app="exercise"] .accordion-toggle[aria-expanded='false']
        .accordion-toggle__icon {
        transform: rotate(-90deg);
      }

      body[data-app="exercise"] [data-accordion-body][hidden] {
        display: none !important;
      }

      body[data-app="exercise"] .context-pane__section-header,
      body[data-app="exercise"] .question-card__accordion-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: var(--spacing-xs);
        margin-bottom: var(--spacing-xs);
      }

      body[data-app="exercise"] .question-card__accordion-title {
        margin: 0;
        font-size: 0.95rem;
        font-weight: 700;
        color: var(--color-text-strong);
      }

      body[data-app="exercise"] .question-card__input-body {
        display: grid;
        grid-template-columns: minmax(0, 1fr) minmax(260px, 0.5fr);
        gap: var(--spacing-md);
        align-items: start;
      }

      body[data-app="exercise"] .question-card__editor {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-sm);
        min-width: 0;
      }

      body[data-app="exercise"] .question-card__sidebar {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-md);
        position: sticky;
        top: calc(var(--spacing-lg) * 2);
        align-self: start;
        min-width: 0;
      }

      body[data-app="exercise"] .exercise__controls {
        display: grid;
        gap: var(--spacing-md);
        width: var(--content-max-width);
        margin: 0 auto;
      }

      body[data-app="exercise"] .control-card {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-sm);
        padding: var(--spacing-md);
        border-radius: var(--radius-card);
        border: none;
        background-color: var(--color-layer-subtle);
        box-shadow: 0 10px 24px rgba(15, 23, 39, 0.06);
      }

      body[data-app="exercise"] .control-card__header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: var(--spacing-xs);
      }

      body[data-app="exercise"] .control-card__header h3 {
        margin: 0;
        font-size: 1.05rem;
        letter-spacing: 0.01em;
      }

      body[data-app="exercise"] .control-card__toggle {
        padding: 6px 12px;
        font-size: 0.85rem;
        color: var(--color-text-muted);
      }

      body[data-app="exercise"] .collapsible-toggle__icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        transition: transform var(--transition-duration) ease;
      }

      body[data-app="exercise"] .control-card__body {
        display: grid;
        gap: var(--spacing-sm);
      }

      body[data-app="exercise"]
        .control-card--collapsible[data-collapsible-open='false']
        .control-card__body {
        display: none;
      }

      body[data-app="exercise"]
        [data-collapsible-toggle][aria-expanded='true']
        .collapsible-toggle__icon {
        transform: rotate(180deg);
      }

      body[data-app="exercise"]
        .control-card--collapsible[data-collapsible-open='true']
        .control-card__toggle {
        color: var(--color-chip-active);
      }

      body[data-app="exercise"] .search-field {
        position: relative;
        display: flex;
        align-items: center;
      }

      body[data-app="exercise"] .search-field input {
        width: 100%;
        padding: 12px 16px 12px 42px;
        border-radius: 12px;
        border: 1px solid var(--color-border);
        background-color: var(--color-bg);
        font-size: 0.95rem;
      }

      body[data-app="exercise"] .search-field__icon {
        position: absolute;
        left: 14px;
        color: var(--color-text-muted);
      }

      body[data-app="exercise"] .search-field__icon .bx {
        color: var(--color-text-muted);
      }

      body[data-app="exercise"] .filter-chips {
        display: flex;
        flex-wrap: wrap;
        gap: var(--spacing-xs);
      }

      body[data-app="exercise"] .filter-chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 8px 12px;
        border-radius: 999px;
        border: 1px solid var(--color-border);
        background-color: var(--color-chip-bg);
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        transition: border-color var(--transition-duration) ease,
          background-color var(--transition-duration) ease;
      }

      body[data-app="exercise"] .filter-chip .icon {
        color: inherit;
      }

      body[data-app="exercise"] .filter-chip[data-active="true"] {
        background-color: var(--color-chip-active);
        border-color: var(--color-chip-active);
        color: var(--color-chip-active-text);
      }

      body[data-app="exercise"] .has-tooltip {
        position: relative;
      }

      body[data-app="exercise"] .has-tooltip::after {
        content: attr(data-tooltip);
        position: absolute;
        inset-inline-start: 0;
        inset-block-start: calc(100% + 6px);
        padding: 6px 10px;
        border-radius: 8px;
        background: var(--color-text-strong);
        color: var(--color-chip-active-text);
        font-size: 0.78rem;
        line-height: 1.4;
        white-space: nowrap;
        opacity: 0;
        pointer-events: none;
        transform: translateY(-4px);
        transition: opacity var(--transition-duration) ease,
          transform var(--transition-duration) ease;
        z-index: 5;
      }

      body[data-app="exercise"] .has-tooltip::before {
        content: "";
        position: absolute;
        inset-inline-start: 12px;
        inset-block-start: calc(100% + 2px);
        border: 6px solid transparent;
        border-top-color: var(--color-text-strong);
        opacity: 0;
        transform: translateY(-2px);
        transition: opacity var(--transition-duration) ease,
          transform var(--transition-duration) ease;
        z-index: 5;
      }

      body[data-app="exercise"] .has-tooltip:hover::after,
      body[data-app="exercise"] .has-tooltip:hover::before,
      body[data-app="exercise"] .has-tooltip:focus-visible::after,
      body[data-app="exercise"] .has-tooltip:focus-visible::before,
      body[data-app="exercise"] .has-tooltip:focus-within::after,
      body[data-app="exercise"] .has-tooltip:focus-within::before {
        opacity: 1;
        transform: translateY(0);
      }

      body[data-app="exercise"] .sort-control {
        display: grid;
        gap: var(--spacing-xs);
        margin-top: var(--spacing-sm);
      }

      body[data-app="exercise"] .sort-control__label {
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--color-text-muted);
      }

      body[data-app="exercise"] .sort-control__field {
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
        padding: 6px 12px;
        border-radius: 12px;
        border: 1px solid var(--color-border);
        background-color: var(--color-bg);
        transition: border-color var(--transition-duration) ease,
          box-shadow var(--transition-duration) ease;
      }

      body[data-app="exercise"] .sort-control__field:focus-within {
        border-color: var(--color-chip-active);
        box-shadow: 0 0 0 3px var(--color-focus-ring);
      }

      body[data-app="exercise"] .sort-control__select {
        flex: 1;
        border: none;
        background: transparent;
        font-size: 0.92rem;
        color: var(--color-text);
      }

      body[data-app="exercise"] .sort-control__select:focus {
        outline: none;
      }

      body[data-app="exercise"] .sort-control__icon {
        color: var(--color-text-muted);
      }

      body[data-app="exercise"] .question-index {
        display: grid;
        gap: var(--spacing-xs);
        padding-left: 1.25rem;
        margin: 0;
        color: var(--color-text);
      }

      body[data-app="exercise"] .question-index a {
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
        padding: 6px 0;
        color: inherit;
        font-weight: 600;
      }

      body[data-app="exercise"] .reference-card {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-xs);
        padding: var(--spacing-md);
        border-radius: var(--radius-card);
        border: 1px solid var(--color-border);
        background-color: var(--color-bg);
        color: var(--color-text);
      }

      body[data-app="exercise"] .reference-card__body {
        font-size: 0.92rem;
        color: var(--color-text-muted);
      }

      body[data-app="exercise"] .strategy-card-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: var(--spacing-sm);
      }

      body[data-app="exercise"] .strategy-card {
        position: relative;
        border: none;
        border-radius: 12px;
        padding: var(--spacing-sm) var(--spacing-md);
        text-align: left;
        font-weight: 600;
        font-size: 0.95rem;
        background: color-mix(in srgb, var(--color-chip-bg) 80%, transparent);
        color: var(--color-text-strong);
        cursor: pointer;
        transition: transform var(--transition-duration) ease,
          box-shadow var(--transition-duration) ease,
          background-color var(--transition-duration) ease;
      }

      body[data-app="exercise"] .strategy-card:hover,
      body[data-app="exercise"] .strategy-card:focus-visible {
        transform: translateY(-2px);
        box-shadow: 0 12px 20px rgba(27, 35, 55, 0.12);
        background: color-mix(in srgb, var(--color-chip-active) 18%, var(--color-bg));
        color: var(--color-text-strong);
      }

      body[data-app="exercise"] .strategy-card[aria-pressed="true"] {
        background: color-mix(in srgb, var(--color-chip-active) 24%, var(--color-bg));
        color: var(--color-chip-active-text);
        box-shadow: 0 16px 24px rgba(27, 35, 55, 0.18);
      }

      body[data-app="exercise"] .strategy-card:focus-visible {
        outline: none;
        box-shadow: 0 0 0 3px var(--color-focus-ring),
          0 12px 20px rgba(27, 35, 55, 0.12);
      }

      body[data-app="exercise"] .strategy-card[data-tooltip]:hover::after,
      body[data-app="exercise"] .strategy-card[data-tooltip]:focus-visible::after {
        content: attr(data-tooltip);
        position: absolute;
        inset-inline-start: 16px;
        inset-block-end: calc(100% + var(--spacing-xs));
        padding: 6px 10px;
        border-radius: 8px;
        background: var(--color-text-strong);
        color: var(--color-chip-active-text);
        font-size: 0.8rem;
        white-space: nowrap;
        box-shadow: 0 8px 20px rgba(27, 35, 55, 0.16);
        z-index: 3;
      }

      body[data-app="exercise"] .strategy-card__preview {
        margin-top: var(--spacing-xs);
        padding: var(--spacing-xs) var(--spacing-sm);
        border-radius: 10px;
        background: var(--color-layer-subtle);
        color: var(--color-text);
        font-size: 0.85rem;
        line-height: 1.6;
      }

      body[data-app="exercise"] .strategy-card__preview[hidden] {
        display: none;
      }

      body[data-app="exercise"] .exercise__tabs {
        position: sticky;
        top: var(--spacing-lg);
        z-index: 5;
        display: flex;
        gap: var(--spacing-sm);
        padding: var(--spacing-sm) var(--spacing-md);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-card);
        background-color: var(--color-bg);
        background: linear-gradient(
          180deg,
          var(--color-bg) 0%,
          color-mix(in srgb, var(--color-bg) 60%, transparent)
        );
        overflow-x: auto;
        scroll-snap-type: x mandatory;
        scrollbar-width: thin;
        width: var(--content-max-width);
        margin-inline: auto;
      }

      body[data-app="exercise"] .exercise__tabs::-webkit-scrollbar {
        height: 6px;
      }

      body[data-app="exercise"] .exercise__tabs::-webkit-scrollbar-thumb {
        background-color: rgba(27, 35, 55, 0.25);
        border-radius: 999px;
      }

      body[data-app="exercise"] .exercise-tab {
        display: inline-flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 2px;
        min-width: 168px;
        padding: 10px 14px;
        border-radius: 14px;
        border: 1px solid transparent;
        background-color: var(--color-chip-bg);
        color: var(--color-text);
        font-size: 0.95rem;
        font-weight: 600;
        letter-spacing: 0.01em;
        cursor: pointer;
        transition: background-color var(--transition-duration) ease,
          color var(--transition-duration) ease,
          border-color var(--transition-duration) ease,
          box-shadow var(--transition-duration) ease;
        scroll-snap-align: start;
      }

      body[data-app="exercise"] .exercise-tab__label {
        font-family: "Noto Sans Mono", "Noto Sans JP", monospace;
        font-size: 0.78rem;
        text-transform: uppercase;
        color: var(--color-text-muted);
      }

      body[data-app="exercise"] .exercise-tab__title {
        font-family: "M PLUS Rounded 1c", "Noto Sans JP", sans-serif;
        font-weight: 700;
        color: var(--color-text-strong);
      }

      body[data-app="exercise"] .exercise-tab:hover,
      body[data-app="exercise"] .exercise-tab:focus-visible {
        border-color: var(--color-chip-active);
        box-shadow: 0 0 0 3px var(--color-focus-ring);
      }

      body[data-app="exercise"] .exercise-tab[aria-selected="true"] {
        background-color: var(--color-chip-active);
        color: var(--color-chip-active-text);
      }

      body[data-app="exercise"] .exercise-tab[aria-selected="true"] .exercise-tab__label,
      body[data-app="exercise"] .exercise-tab[aria-selected="true"] .exercise-tab__title {
        color: var(--color-chip-active-text);
      }

      body[data-app="exercise"] .exercise__questions {
        display: grid;
        gap: var(--spacing-xl);
        justify-items: center;
        padding-block: var(--spacing-sm) var(--spacing-xl);
      }

      body[data-app="exercise"] .exercise__inline-timer {
        width: var(--content-max-width);
        margin: 0 auto;
        display: flex;
        justify-content: flex-end;
        align-items: center;
        gap: var(--spacing-xs);
        color: var(--color-text-muted);
        font-size: 0.85rem;
      }

      body[data-app="exercise"] .exercise__inline-timer-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        border-radius: 999px;
        background: color-mix(in srgb, var(--color-chip-bg) 70%, var(--color-surface));
        color: var(--color-chip-active);
        font-family: "Noto Sans Mono", "Noto Sans JP", monospace;
        font-weight: 700;
      }

      body[data-app="exercise"] .exercise__inline-timer-badge .icon {
        font-size: var(--icon-size-sm);
      }

      body[data-app="exercise"] .exercise__inline-timer-countdown {
        letter-spacing: 0.06em;
        font-size: 1rem;
      }

      @keyframes exercise-spinner {
        to {
          transform: rotate(360deg);
        }
      }

      body[data-app="exercise"] .question-card {
        position: relative;
        width: var(--content-max-width);
        padding: calc(var(--spacing-lg) + var(--spacing-sm));
        border-radius: var(--radius-card);
        border: 1px solid var(--color-border);
        background-color: var(--color-surface);
        box-shadow: 0 12px 32px rgba(15, 23, 39, 0.08);
        transition: box-shadow var(--transition-duration) ease,
          transform var(--transition-duration) ease;
      }

      body[data-app="exercise"] .question-card:hover,
      body[data-app="exercise"] .question-card:focus-within {
        box-shadow: 0 16px 36px rgba(15, 23, 39, 0.14);
        transform: translateY(-2px);
      }

      body[data-app="exercise"] .question-card__header {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: var(--spacing-sm);
        margin-bottom: var(--spacing-md);
      }

      body[data-app="exercise"] .question-card__badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
        border-radius: 12px;
        background-color: var(--color-chip-active);
        color: var(--color-chip-active-text);
        font-weight: 700;
        font-family: "Noto Sans Mono", "Noto Sans JP", monospace;
      }

      body[data-app="exercise"] .question-card__title {
        font-size: 1.15rem;
        font-weight: 700;
        margin: 0;
        font-family: "M PLUS Rounded 1c", "Noto Sans JP", sans-serif;
        color: var(--color-text-strong);
        letter-spacing: 0.01em;
      }

      body[data-app="exercise"] .question-card__meta {
        margin-left: auto;
        display: flex;
        gap: var(--spacing-sm);
        font-size: 0.9rem;
        color: var(--color-text-muted);
        font-family: "Noto Sans Mono", "Noto Sans JP", monospace;
      }

      body[data-app="exercise"] .question-card__body {
        margin-bottom: var(--spacing-md);
      }

      body[data-app="exercise"] .question-card__input {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-sm);
      }

      body[data-app="exercise"] .question-card__fields {
        display: grid;
        grid-template-columns: minmax(0, 1fr) minmax(220px, 0.45fr);
        gap: var(--spacing-sm);
        align-items: stretch;
      }

      body[data-app="exercise"] .question-card__answer {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-xs);
      }

      body[data-app="exercise"] .question-card__memo {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-xs);
        padding: var(--spacing-sm);
        border-radius: 12px;
        border: 1px solid color-mix(in srgb, var(--color-border) 55%, transparent);
        background: color-mix(in srgb, var(--color-layer-subtle) 65%, transparent);
      }

      body[data-app="exercise"] .question-card__memo-label {
        font-size: 0.92rem;
        font-weight: 600;
        color: var(--color-text-strong);
      }

      body[data-app="exercise"] .question-card__memo textarea {
        min-height: 120px;
        resize: vertical;
        border-radius: 10px;
        border: 1px solid color-mix(in srgb, var(--color-border) 70%, transparent);
        padding: var(--spacing-xs);
        font-size: 0.9rem;
        background: var(--color-surface);
        color: inherit;
      }

      body[data-app="exercise"] .question-card__memo textarea:focus {
        border-color: var(--color-chip-active);
        box-shadow: 0 0 0 2px var(--color-focus-ring);
        outline: none;
      }

      body[data-app="exercise"] .question-card__memo-actions {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: var(--spacing-xs);
        flex-wrap: wrap;
      }

      body[data-app="exercise"] .question-card__memo-hint {
        font-size: 0.78rem;
        color: var(--color-text-muted);
      }

      body[data-app="exercise"] .question-card__memo-button {
        align-self: flex-start;
      }

      body[data-app="exercise"] .question-card__tools {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: var(--spacing-xs);
      }

      body[data-app="exercise"] .question-card__textarea {
        width: 100%;
        min-height: 160px;
        padding: var(--spacing-sm);
        border-radius: 12px;
        border: 1px solid var(--color-border);
        background-color: var(--color-surface);
        color: inherit;
        font-size: 1rem;
        resize: vertical;
        transition: border-color var(--transition-duration) ease,
          box-shadow var(--transition-duration) ease;
      }

      @media (prefers-color-scheme: dark) {
        body[data-app="exercise"] .question-card__textarea {
          background-color: var(--color-surface);
          border-color: var(--color-border);
        }
      }

      body[data-app="exercise"] .question-card__textarea:focus {
        border-color: var(--color-chip-active);
      }

      body[data-app="exercise"] .char-counter {
        align-self: flex-end;
        margin-left: auto;
        font-size: 0.85rem;
        color: var(--color-text-muted);
        font-family: "Noto Sans Mono", "Noto Sans JP", monospace;
      }

      body[data-app="exercise"] .char-counter--limit {
        color: var(--color-warning);
        font-weight: 600;
      }

      body[data-app="exercise"] .composition-guide {
        border-radius: 14px;
        border: 1px solid color-mix(in srgb, var(--color-border) 65%, transparent);
        background: color-mix(in srgb, var(--color-layer-subtle) 60%, transparent);
        padding: var(--spacing-sm) var(--spacing-md);
        display: grid;
        gap: var(--spacing-sm);
      }

      body[data-app="exercise"] .composition-guide[hidden] {
        display: none;
      }

      body[data-app="exercise"] .composition-guide__header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: var(--spacing-sm);
      }

      body[data-app="exercise"] .composition-guide__header-actions {
        display: inline-flex;
        align-items: center;
        gap: var(--spacing-xs);
        margin-inline-start: auto;
      }

      body[data-app="exercise"] .composition-guide__title {
        margin: 0;
        font-size: 0.9rem;
        font-weight: 700;
        color: var(--color-text-strong);
      }

      body[data-app="exercise"] .composition-guide__remaining {
        font-size: 0.78rem;
        color: var(--color-text-muted);
        font-family: "Noto Sans Mono", "Noto Sans JP", monospace;
      }

      body[data-app="exercise"] .composition-guide__remaining[data-warning='true'] {
        color: var(--color-warning);
        font-weight: 600;
      }

      body[data-app="exercise"] .composition-guide__segments {
        display: grid;
        gap: var(--spacing-xs);
      }

      body[data-app="exercise"] .composition-guide__segment {
        display: grid;
        gap: 4px;
      }

      body[data-app="exercise"] .composition-guide__segment-title {
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        gap: var(--spacing-xs);
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--color-text-strong);
      }

      body[data-app="exercise"] .composition-guide__segment-hint {
        font-size: 0.78rem;
        color: var(--color-text-muted);
        font-weight: 500;
      }

      body[data-app="exercise"] .composition-guide__bar {
        position: relative;
        height: 8px;
        border-radius: 999px;
        background: color-mix(in srgb, var(--color-border) 70%, transparent);
        overflow: hidden;
      }

      body[data-app="exercise"] .composition-guide__fill {
        position: absolute;
        inset: 0;
        border-radius: inherit;
        background: linear-gradient(
          90deg,
          color-mix(in srgb, var(--color-chip-active) 60%, #fff 40%) 0%,
          color-mix(in srgb, var(--color-chip-active) 20%, #fff 80%) 100%
        );
        transform: scaleX(0);
        transform-origin: left center;
        transition: transform 160ms ease;
      }

      body[data-app="exercise"] .composition-guide__fill[data-over='true'] {
        background: linear-gradient(
          90deg,
          var(--color-warning) 0%,
          color-mix(in srgb, var(--color-warning) 35%, #fff 65%) 100%
        );
      }

      body[data-app="exercise"] .composition-guide__metrics {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.78rem;
        color: var(--color-text-muted);
        font-family: "Noto Sans Mono", "Noto Sans JP", monospace;
      }

      body[data-app="exercise"] .composition-guide__template-button {
        border: none;
        background: transparent;
        color: var(--color-chip-active);
        font-size: 0.82rem;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 4px;
        cursor: pointer;
      }

      body[data-app="exercise"] .composition-guide__template-button:hover,
      body[data-app="exercise"] .composition-guide__template-button:focus-visible {
        text-decoration: underline;
        outline: none;
      }

      body[data-app="exercise"] .composition-guide__template-preview {
        font-size: 0.8rem;
        color: var(--color-text-muted);
        line-height: 1.6;
        border-radius: 10px;
        border: 1px dashed color-mix(in srgb, var(--color-border) 60%, transparent);
        padding: var(--spacing-xs);
        background: color-mix(
          in srgb,
          var(--color-layer-subtle) 45%,
          transparent
        );
        white-space: pre-wrap;
      }

      body[data-app="exercise"] .question-intent-card {
        border-radius: var(--radius-card);
        background: var(--color-surface);
        border: 1px solid color-mix(in srgb, var(--color-border) 55%, transparent);
        box-shadow: 0 18px 38px rgba(15, 23, 39, 0.1);
        display: flex;
        flex-direction: column;
        min-width: 0;
      }

      body[data-app="exercise"] .question-intent-card__header {
        border: none;
        background: transparent;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: var(--spacing-sm);
        padding: var(--spacing-sm) var(--spacing-md);
        cursor: pointer;
        font-size: 0.95rem;
        font-weight: 700;
        color: var(--color-text-strong);
      }

      body[data-app="exercise"] .question-intent-card__header:hover,
      body[data-app="exercise"] .question-intent-card__header:focus-visible {
        background: color-mix(in srgb, var(--color-chip-bg) 70%, transparent);
        outline: none;
      }

      body[data-app="exercise"] .question-intent-card__meta {
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
        font-size: 0.78rem;
        color: var(--color-text-muted);
      }

      body[data-app="exercise"] .question-intent-card__toggle-icon {
        transition: transform var(--transition-duration) ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }

      body[data-app="exercise"]
        .question-intent-card__header[aria-expanded='true']
        .question-intent-card__toggle-icon {
        transform: rotate(180deg);
      }

      body[data-app="exercise"] .question-intent-card__body {
        display: grid;
        gap: var(--spacing-sm);
        padding: 0 var(--spacing-md) var(--spacing-md);
        border-top: 1px solid color-mix(in srgb, var(--color-border) 55%, transparent);
      }

      body[data-app="exercise"] .question-intent-card__body[hidden] {
        display: none;
      }

      body[data-app="exercise"] .question-intent-card__item {
        display: grid;
        gap: 4px;
      }

      body[data-app="exercise"] .question-intent-card__item dt {
        font-size: 0.82rem;
        font-weight: 700;
        color: var(--color-text-muted);
      }

      body[data-app="exercise"] .question-intent-card__item dd {
        margin: 0;
        font-size: 0.9rem;
        color: var(--color-text);
      }

      body[data-app="exercise"] .question-intent-card__points {
        margin: 0;
        padding-inline-start: 1.2rem;
        display: grid;
        gap: 4px;
        font-size: 0.85rem;
      }

      body[data-app="exercise"] .analysis-card {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-sm);
        padding: var(--spacing-md);
        border-radius: var(--radius-card);
        border: 1px solid color-mix(in srgb, var(--color-border) 55%, transparent);
        background: color-mix(in srgb, var(--color-layer-subtle) 65%, transparent);
        box-shadow: 0 18px 40px rgba(15, 23, 39, 0.1);
      }

      body[data-app="exercise"] .analysis-card__header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: var(--spacing-xs);
      }

      body[data-app="exercise"] .analysis-card__title {
        margin: 0;
        font-size: 0.95rem;
        font-weight: 700;
        color: var(--color-text-strong);
      }

      body[data-app="exercise"] .analysis-card__updated {
        font-size: 0.78rem;
        color: var(--color-text-muted);
      }

      body[data-app="exercise"] .analysis-card__chart {
        display: grid;
        gap: var(--spacing-xs);
      }

      body[data-app="exercise"] .analysis-card__chart-title {
        margin: 0;
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--color-text-muted);
      }

      body[data-app="exercise"] .analysis-card__bars {
        list-style: none;
        margin: 0;
        padding: 0;
        display: grid;
        gap: var(--spacing-xs);
      }

      body[data-app="exercise"] .analysis-card__bar-item {
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
      }

      body[data-app="exercise"] .analysis-card__bar-label {
        min-width: 84px;
        font-size: 0.82rem;
        color: var(--color-text-strong);
      }

      body[data-app="exercise"] .analysis-card__bar-track {
        flex: 1 1 auto;
        height: 8px;
        border-radius: 999px;
        background: color-mix(in srgb, var(--color-border) 65%, transparent);
        position: relative;
        overflow: hidden;
      }

      body[data-app="exercise"] .analysis-card__bar-track span {
        position: absolute;
        inset: 0;
        border-radius: inherit;
        background: linear-gradient(
          90deg,
          var(--color-chip-active) 0%,
          color-mix(in srgb, var(--color-chip-active) 25%, #fff 75%) 100%
        );
        transform-origin: left center;
        transform: scaleX(0);
        transition: transform 200ms ease;
      }

      body[data-app="exercise"] .analysis-card__bar-value {
        font-size: 0.8rem;
        color: var(--color-text-muted);
        font-family: "Noto Sans Mono", "Noto Sans JP", monospace;
      }

      body[data-app="exercise"] .analysis-card__insights {
        display: grid;
        gap: 4px;
        font-size: 0.82rem;
        color: var(--color-text-muted);
      }

      body[data-app="exercise"] .analysis-card__highlight {
        color: var(--color-chip-active);
        font-weight: 600;
      }

      body[data-app="exercise"] .analysis-card__empty {
        font-size: 0.82rem;
        color: var(--color-text-muted);
        line-height: 1.5;
      }

      body[data-app="exercise"] .question-card__guide {
        margin-top: var(--spacing-lg);
        padding: var(--spacing-md);
        border-radius: 16px;
        background: color-mix(in srgb, var(--color-layer-subtle) 55%, transparent);
        border: 1px solid color-mix(in srgb, var(--color-border) 55%, transparent);
        display: flex;
        flex-direction: column;
        gap: var(--spacing-sm);
      }

      body[data-app="exercise"] .question-card__guide-title {
        margin: 0;
        font-size: 1rem;
        font-weight: 700;
        color: var(--color-text-strong);
      }

      body[data-app="exercise"] .question-card__guide-body {
        display: grid;
        gap: var(--spacing-xs);
      }

      body[data-app="exercise"] .question-card__guide-body .support-block {
        border-top: none;
        margin-top: 0;
        padding-top: 0;
      }

      body[data-app="exercise"] .support-block {
        border-top: 1px solid color-mix(
          in srgb,
          var(--color-border) 70%,
          transparent
        );
        padding-top: var(--spacing-sm);
        margin-top: var(--spacing-md);
        font-size: 0.9rem;
      }

      body[data-app="exercise"] .support-block__toggle {
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-color: transparent;
        color: var(--color-text);
        gap: var(--spacing-sm);
      }

      body[data-app="exercise"] .support-block__toggle:hover,
      body[data-app="exercise"] .support-block__toggle:focus-visible {
        color: var(--color-text-strong);
      }

      body[data-app="exercise"] .support-block__toggle[aria-expanded="true"] {
        background-color: color-mix(
          in srgb,
          var(--color-chip-active) 18%,
          var(--color-layer-subtle)
        );
        border-color: transparent;
        color: var(--color-text-strong);
      }

      body[data-app="exercise"] .support-block__content {
        margin-top: var(--spacing-xs);
        padding: var(--spacing-xs) var(--spacing-sm);
        border-radius: 8px;
        background-color: var(--color-layer-subtle);
        color: var(--color-text-muted);
      }

      body[data-app="exercise"] .support-block__content--highlight {
        animation: supportHighlight 1.2s ease;
        background-color: color-mix(
          in srgb,
          var(--color-chip-active) 20%,
          var(--color-layer-subtle)
        );
      }

      body[data-app="exercise"] .support-block__content[hidden] {
        display: none;
      }

      @media (prefers-color-scheme: dark) {
        body[data-app="exercise"] .support-block__content {
          background-color: color-mix(
            in srgb,
            var(--color-chip-bg) 55%,
            transparent
          );
        }
      }

      body[data-app="exercise"] .support-block__label {
        font-weight: 600;
        letter-spacing: 0.01em;
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
      }

      body[data-app="exercise"] .support-block__text {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 2px;
        flex: 1;
      }

      body[data-app="exercise"] .support-block__hint {
        font-size: 0.75rem;
        font-weight: 500;
        color: var(--color-text-muted);
      }

      body[data-app="exercise"] .support-block__toggle:hover .support-block__hint,
      body[data-app="exercise"] .support-block__toggle:focus-visible .support-block__hint,
      body[data-app="exercise"] .support-block__toggle[aria-expanded="true"]
        .support-block__hint {
        color: var(--color-text-strong);
      }

      body[data-app="exercise"] .support-block__chevron {
        flex-shrink: 0;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 999px;
        font-size: var(--icon-size-sm);
        transition: transform var(--transition-duration) ease,
          color var(--transition-duration) ease;
      }

      body[data-app="exercise"]
        .support-block__toggle[aria-expanded="true"]
        .support-block__chevron {
        color: var(--color-chip-active);
        transform: rotate(180deg);
      }

      body[data-app="exercise"] .support-block__icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 28px;
        height: 28px;
        border-radius: 10px;
        background-color: color-mix(
          in srgb,
          var(--color-chip-bg) 55%,
          transparent
        );
        color: var(--color-chip-active);
        font-size: var(--icon-size-sm);
        transition: background-color var(--transition-duration) ease,
          color var(--transition-duration) ease;
      }

      body[data-app="exercise"] .support-block__toggle:hover .support-block__icon,
      body[data-app="exercise"] .support-block__toggle:focus-visible .support-block__icon,
      body[data-app="exercise"] .support-block__toggle[aria-expanded="true"]
        .support-block__icon {
        background-color: var(--color-chip-active);
        color: var(--color-chip-active-text);
      }

      @media (prefers-color-scheme: dark) {
        body[data-app="exercise"] .support-block__icon {
          background-color: rgba(111, 155, 245, 0.28);
          color: var(--color-chip-active-text);
        }
      }

      @keyframes supportHighlight {
        0% {
          box-shadow: 0 0 0 0 rgba(47, 90, 168, 0.3);
        }
        50% {
          box-shadow: 0 0 0 12px rgba(47, 90, 168, 0.16);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(47, 90, 168, 0);
        }
      }

      body[data-app="exercise"] .analysis-info {
        margin-top: var(--spacing-xs);
        padding: var(--spacing-xs) var(--spacing-sm);
        border-radius: 8px;
        background: var(--color-layer-subtle);
        font-size: 0.85rem;
        color: var(--color-text);
      }

      body[data-app="exercise"] .analysis-info[hidden] {
        display: none;
      }

      body[data-app="exercise"] .ui-toast {
        position: fixed;
        top: 24px;
        right: 24px;
        min-width: 220px;
        max-width: 320px;
        padding: 12px 16px;
        border-radius: 14px;
        background-color: var(--color-chip-active);
        color: var(--color-chip-active-text);
        box-shadow: 0 18px 40px rgba(27, 35, 55, 0.2);
        opacity: 0;
        pointer-events: none;
        transform: translateY(-12px);
        transition: opacity var(--transition-duration) ease,
          transform var(--transition-duration) ease;
        font-size: 0.9rem;
        line-height: 1.5;
        z-index: 30;
      }

      body[data-app="exercise"] .ui-toast[data-toast-visible='true'] {
        opacity: 1;
        transform: translateY(0);
      }

      body[data-app="exercise"] .analysis-info__trigger {
        border: none;
        background: transparent;
        color: var(--color-text-muted);
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        transition: background-color var(--transition-duration) ease,
          color var(--transition-duration) ease;
      }

      body[data-app="exercise"] .analysis-info__trigger:hover,
      body[data-app="exercise"] .analysis-info__trigger:focus-visible,
      body[data-app="exercise"] .analysis-info__trigger[aria-expanded="true"] {
        color: var(--color-chip-active);
        background-color: color-mix(
          in srgb,
          var(--color-chip-bg) 60%,
          transparent
        );
      }

      body[data-app="exercise"] .analysis-info__icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: var(--icon-size-md);
        line-height: 1;
      }

      body[data-app="exercise"] .analysis-info__meta {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: var(--spacing-xs);
        margin-top: var(--spacing-xs);
      }

      body[data-app="exercise"] .analysis-info__meta a {
        color: var(--color-chip-active);
        font-weight: 600;
        font-size: 0.82rem;
      }

      body[data-app="exercise"] .analysis-info__meta a:hover,
      body[data-app="exercise"] .analysis-info__meta a:focus-visible {
        text-decoration: underline;
      }

      body[data-app="exercise"] .text-highlight {
        background-color: color-mix(
          in srgb,
          var(--highlight-pattern-border, var(--color-layer-subtle)) 12%,
          var(--color-surface)
        );
        background-image: var(--highlight-pattern-fill, none);
        background-size: var(--highlight-pattern-size) var(--highlight-pattern-size);
        padding-inline: 2px;
        border-radius: 6px;
        border-bottom: 2px solid var(--highlight-pattern-border, transparent);
        box-shadow: inset 0 -2px 0
          color-mix(
            in srgb,
            var(--highlight-pattern-border, var(--color-layer-subtle)) 18%,
            transparent
          );
        cursor: pointer;
        position: relative;
        color: var(--color-text-strong);
      }

      body[data-app="exercise"] .text-highlight::after {
        content: '';
        position: absolute;
        inset: 2px 0;
        pointer-events: none;
        border-radius: 4px;
      }

      body[data-app="exercise"] .highlight-pattern {
        background-image: var(--highlight-pattern-fill, none);
        background-size: var(--highlight-pattern-size) var(--highlight-pattern-size);
        border-radius: 999px;
        border: 2px solid var(--highlight-pattern-border, transparent);
        display: inline-flex;
        width: 20px;
        height: 20px;
        align-items: center;
        justify-content: center;
        position: relative;
        overflow: hidden;
      }

      body[data-app="exercise"] .highlight-pattern::after {
        content: '';
        position: absolute;
        inset: 2px;
        border-radius: inherit;
        box-shadow: inset 0 0 0 1px
          color-mix(
            in srgb,
            var(--highlight-pattern-border, var(--color-border)) 20%,
            transparent
          );
      }

      body[data-app="exercise"] .text-highlight--strength,
      body[data-app="exercise"] .highlight-pattern--strength {
        --highlight-pattern-border: var(--highlight-strength-base);
        --highlight-pattern-fill: repeating-linear-gradient(
          135deg,
          color-mix(in srgb, var(--highlight-strength-contrast) 90%, transparent) 0 10px,
          color-mix(in srgb, var(--highlight-strength-base) 28%, #ffffff 72%) 10px 20px
        );
      }

      body[data-app="exercise"] .text-highlight--weakness,
      body[data-app="exercise"] .highlight-pattern--weakness {
        --highlight-pattern-border: var(--highlight-weakness-base);
        --highlight-pattern-fill: repeating-linear-gradient(
          0deg,
          color-mix(in srgb, var(--highlight-weakness-contrast) 92%, transparent) 0 8px,
          color-mix(in srgb, var(--highlight-weakness-base) 32%, #ffffff 68%) 8px 16px
        );
      }

      body[data-app="exercise"] .text-highlight--challenge,
      body[data-app="exercise"] .highlight-pattern--challenge {
        --highlight-pattern-border: var(--highlight-challenge-base);
        --highlight-pattern-fill: repeating-linear-gradient(
          135deg,
          color-mix(in srgb, var(--highlight-challenge-contrast) 88%, transparent) 0 6px,
          color-mix(in srgb, var(--highlight-challenge-base) 30%, #ffffff 70%) 6px 12px
        );
      }

      body[data-app="exercise"] .text-highlight--opportunity,
      body[data-app="exercise"] .highlight-pattern--opportunity {
        --highlight-pattern-border: var(--highlight-opportunity-base);
        --highlight-pattern-fill: repeating-linear-gradient(
          45deg,
          color-mix(in srgb, var(--highlight-opportunity-contrast) 90%, transparent) 0 12px,
          color-mix(in srgb, var(--highlight-opportunity-base) 26%, #ffffff 74%) 12px 24px
        );
      }

      body[data-app="exercise"] .highlight-toolbar {
        display: grid;
        gap: var(--spacing-sm);
        padding: var(--spacing-sm) var(--spacing-md);
        margin: var(--spacing-sm) 0;
        border-radius: 14px;
        border: 1px solid color-mix(in srgb, var(--color-border) 45%, transparent);
        background: color-mix(in srgb, var(--color-layer-subtle) 55%, transparent);
      }

      body[data-app="exercise"] .highlight-toolbar__title {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: var(--spacing-xs);
      }

      body[data-app="exercise"] .highlight-toolbar__helper {
        font-size: 0.82rem;
        color: var(--color-text-muted);
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
      }

      body[data-app="exercise"] .highlight-toolbar__helper .icon {
        color: var(--color-chip-active);
      }

      body[data-app="exercise"] .highlight-toolbar__palette {
        display: flex;
        gap: var(--spacing-xs);
        flex-wrap: wrap;
      }

      body[data-app="exercise"] .highlight-toolbar__button {
        display: inline-flex;
        align-items: center;
        gap: var(--spacing-xs);
        padding: 6px 14px;
        border-radius: 999px;
        border: 1px solid color-mix(in srgb, var(--color-border) 60%, transparent);
        background: var(--color-surface);
        cursor: pointer;
        font-size: 0.85rem;
        font-weight: 600;
        transition: border-color var(--transition-duration) ease,
          box-shadow var(--transition-duration) ease,
          transform var(--transition-duration) ease,
          background-color var(--transition-duration) ease;
      }

      body[data-app="exercise"] .highlight-toolbar__button[data-active="true"] {
        border-color: var(--color-chip-active);
        box-shadow: 0 0 0 3px color-mix(
          in srgb,
          var(--color-chip-active) 18%,
          transparent
        );
        background: color-mix(
          in srgb,
          var(--color-chip-bg) 45%,
          var(--color-surface)
        );
        transform: translateY(-1px);
      }

      body[data-app="exercise"] .highlight-toolbar__icon {
        font-size: var(--icon-size-sm);
        color: var(--color-chip-active);
      }

      body[data-app="exercise"] .highlight-toolbar__swatch {
        width: 18px;
        height: 18px;
        flex-shrink: 0;
      }

      body[data-app="exercise"] .highlight-toolbar__undo {
        justify-self: start;
      }

      body[data-app="exercise"] .highlight-legend {
        display: grid;
        gap: var(--spacing-sm);
      }

      body[data-app="exercise"] .highlight-legend__item {
        display: grid;
        grid-template-columns: auto 1fr;
        gap: var(--spacing-xs);
        align-items: center;
        padding: 8px;
        border-radius: 14px;
        border: 1px solid color-mix(in srgb, var(--color-border) 60%, transparent);
        background: color-mix(in srgb, var(--color-layer-subtle) 50%, transparent);
      }

      body[data-app="exercise"] .highlight-legend__swatch {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        border-radius: 999px;
        background: none;
        border: none;
      }

      body[data-app="exercise"] .highlight-legend__info {
        display: grid;
        gap: 4px;
      }

      body[data-app="exercise"] .highlight-legend__input {
        border: 1px solid color-mix(in srgb, var(--color-border) 60%, transparent);
        border-radius: 999px;
        padding: 4px 12px;
        font-size: 0.85rem;
        width: 100%;
      }

      body[data-app="exercise"] .highlight-legend__input:focus-visible {
        outline: none;
        box-shadow: 0 0 0 2px var(--color-focus-ring);
      }

      body[data-app="exercise"] .highlight-legend__meaning {
        font-size: 0.78rem;
        color: var(--color-text-muted);
      }

      body[data-app="exercise"] .highlight-inspector {
        margin-top: var(--spacing-sm);
        padding: var(--spacing-md);
        border-radius: 16px;
        background: color-mix(in srgb, var(--color-layer-subtle) 60%, transparent);
        display: grid;
        gap: var(--spacing-sm);
      }

      body[data-app="exercise"] .highlight-inspector[hidden] {
        display: none;
      }

      body[data-app="exercise"] .highlight-inspector__header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: var(--spacing-xs);
      }

      body[data-app="exercise"] .highlight-inspector__preview {
        font-size: 0.9rem;
        line-height: 1.6;
        background: var(--color-surface);
        border-radius: 12px;
        padding: var(--spacing-sm);
        border: 1px solid var(--color-border);
      }

      body[data-app="exercise"] .highlight-inspector__field {
        display: grid;
        gap: 4px;
      }

      body[data-app="exercise"] .highlight-inspector__field label {
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--color-text-muted);
      }

      body[data-app="exercise"] .highlight-inspector__input,
      body[data-app="exercise"] .highlight-inspector__textarea {
        width: 100%;
        border: 1px solid var(--color-border);
        border-radius: 10px;
        padding: 8px 10px;
        font-size: 0.9rem;
        background: var(--color-surface);
      }

      body[data-app="exercise"] .highlight-inspector__textarea {
        min-height: 80px;
        resize: vertical;
      }

      body[data-app="exercise"] .highlight-inspector__actions {
        display: flex;
        flex-wrap: wrap;
        gap: var(--spacing-xs);
      }

      body[data-app="exercise"] .highlight-inspector__hint {
        font-size: 0.85rem;
        color: var(--color-text-muted);
        background: color-mix(in srgb, var(--color-layer-soft) 55%, transparent);
        border-radius: 12px;
        padding: var(--spacing-xs) var(--spacing-sm);
      }

      body[data-app="exercise"] .highlight-practice {
        margin-top: var(--spacing-md);
        display: grid;
        gap: var(--spacing-sm);
        padding: var(--spacing-sm);
        border-radius: 16px;
        background: color-mix(in srgb, var(--color-layer-subtle) 50%, transparent);
      }

      body[data-app="exercise"] .highlight-practice[hidden] {
        display: none;
      }

      body[data-app="exercise"] .highlight-practice__list {
        list-style: none;
        padding: 0;
        margin: 0;
        display: grid;
        gap: var(--spacing-xs);
      }

      body[data-app="exercise"] .highlight-practice__item {
        display: grid;
        gap: 6px;
        padding: var(--spacing-sm);
        border-radius: 12px;
        background: var(--color-surface);
        border: 1px solid var(--color-border);
      }

      body[data-app="exercise"] .highlight-practice__question {
        font-size: 0.9rem;
        line-height: 1.5;
      }

      body[data-app="exercise"] .highlight-practice__meta {
        font-size: 0.8rem;
        color: var(--color-text-muted);
      }

      body[data-app="exercise"] .highlight-practice__actions {
        display: flex;
        flex-wrap: wrap;
        gap: var(--spacing-xs);
      }

      body[data-app="exercise"] .retrieval-card__practice {
        margin-top: var(--spacing-sm);
        display: grid;
        gap: var(--spacing-xs);
      }

      body[data-app="exercise"] .retrieval-card__practice textarea {
        min-height: 72px;
        resize: vertical;
        border-radius: 10px;
        border: 1px solid var(--color-border);
        padding: 8px 10px;
        font-size: 0.9rem;
      }

      body[data-app="exercise"] .retrieval-feedback {
        display: grid;
        gap: 6px;
        border-radius: 12px;
        padding: var(--spacing-xs) var(--spacing-sm);
        background: color-mix(in srgb, var(--color-layer-subtle) 60%, transparent);
      }

      body[data-app="exercise"] .retrieval-feedback[hidden] {
        display: none;
      }

      body[data-app="exercise"] .retrieval-feedback__chips {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
      }

      body[data-app="exercise"] .retrieval-feedback__chip {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 8px;
        border-radius: 999px;
        font-size: 0.8rem;
        font-weight: 600;
        background: var(--color-surface);
        border: 1px solid var(--color-border);
      }

      body[data-app="exercise"] .retrieval-feedback__chip[data-match="true"] {
        border-color: var(--color-chip-active);
        color: var(--color-chip-active);
      }

      body[data-app="exercise"] .retrieval-feedback__chip[data-match="false"] {
        border-style: dashed;
        color: var(--color-text-muted);
      }

      body[data-app="exercise"] .retrieval-feedback__chip[data-extra="true"] {
        border-style: dotted;
        color: var(--color-text-muted);
        background: color-mix(in srgb, var(--color-layer-subtle) 40%, transparent);
      }

      body[data-app="exercise"] .retrieval-feedback__summary {
        font-size: 0.85rem;
        color: var(--color-text-muted);
      }

      body[data-app="exercise"] .retrieval-modal__controls {
        flex-wrap: wrap;
        gap: var(--spacing-sm);
      }

      body[data-app="exercise"] .retrieval-modal__order {
        display: inline-flex;
        flex-direction: column;
        gap: 4px;
        font-size: 0.85rem;
        font-weight: 600;
      }

      body[data-app="exercise"] .retrieval-modal__order select {
        border-radius: 10px;
        border: 1px solid var(--color-border);
        padding: 6px 10px;
        font-size: 0.9rem;
        background: var(--color-surface);
      }

      body[data-app="exercise"] .onboarding-modal {
        position: fixed;
        inset: 0;
        z-index: 120;
        display: grid;
        place-items: center;
        background: rgba(15, 23, 42, 0.55);
        backdrop-filter: blur(4px);
        padding: var(--spacing-md);
      }

      body[data-app="exercise"] .onboarding-modal[hidden] {
        display: none;
      }

      body[data-app="exercise"] .onboarding-modal__dialog {
        background: var(--color-surface);
        border-radius: 20px;
        max-width: 640px;
        width: min(100%, 640px);
        padding: var(--spacing-lg);
        display: grid;
        gap: var(--spacing-md);
        position: relative;
      }

      body[data-app="exercise"] .onboarding-modal__close {
        position: absolute;
        top: 16px;
        right: 16px;
        border: none;
        background: transparent;
        color: var(--color-text-muted);
        cursor: pointer;
        font-size: 1.25rem;
      }

      body[data-app="exercise"] .onboarding-steps {
        display: grid;
        gap: var(--spacing-sm);
      }

      body[data-app="exercise"] .onboarding-step {
        display: grid;
        gap: 4px;
        padding: var(--spacing-sm);
        border-radius: 14px;
        background: color-mix(in srgb, var(--color-layer-subtle) 55%, transparent);
      }

      body[data-app="exercise"] .onboarding-step strong {
        font-size: 0.95rem;
      }

      body[data-app="exercise"] .onboarding-actions {
        display: flex;
        flex-wrap: wrap;
        justify-content: flex-end;
        gap: var(--spacing-xs);
      }

      @media (max-width: 720px) {
        body[data-app="exercise"] .highlight-toolbar {
          padding: var(--spacing-xs);
          margin: var(--spacing-sm) 0;
        }

        body[data-app="exercise"] .highlight-toolbar__button {
          flex: 1 1 calc(50% - var(--spacing-xs));
          justify-content: center;
        }

        body[data-app="exercise"] .highlight-inspector {
          padding: var(--spacing-sm);
        }

        body[data-app="exercise"] .onboarding-modal__dialog {
          padding: var(--spacing-md);
        }
      }

      body[data-app="exercise"] .context-search__hit {
        background: color-mix(
          in srgb,
          var(--color-chip-active) 35%,
          var(--color-layer-subtle)
        );
        padding: 0 2px;
        border-radius: 4px;
      }

      body[data-app="exercise"] .context-search__hit[data-active='true'] {
        outline: 2px solid color-mix(
          in srgb,
          var(--color-chip-active) 60%,
          transparent
        );
      }

      body[data-app="exercise"] .example-expressions {
        margin-top: var(--spacing-sm);
        display: grid;
        gap: var(--spacing-xs);
        background: color-mix(in srgb, var(--color-chip-bg) 35%, transparent);
        border-radius: 14px;
        padding: var(--spacing-sm);
      }

      body[data-app="exercise"] .example-expressions__header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: var(--spacing-xs);
        font-size: 0.88rem;
        color: var(--color-text-muted);
      }

      body[data-app="exercise"] .example-expressions__title {
        font-weight: 700;
        color: var(--color-text-strong);
      }

      body[data-app="exercise"] .example-expressions__list {
        display: flex;
        flex-wrap: wrap;
        gap: var(--spacing-xs);
      }

      body[data-app="exercise"] .example-expression-chip {
        border: none;
        background: var(--color-surface);
        border-radius: 999px;
        padding: 6px 12px;
        font-size: 0.85rem;
        line-height: 1.4;
        color: var(--color-text);
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(15, 23, 39, 0.08);
        transition: transform var(--transition-duration) ease,
          box-shadow var(--transition-duration) ease,
          background-color var(--transition-duration) ease;
      }

      body[data-app="exercise"] .example-expression-chip:focus-visible,
      body[data-app="exercise"] .example-expression-chip:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 18px rgba(15, 23, 39, 0.16);
      }

      body[data-app="exercise"] .example-expression-chip[draggable='true'] {
        user-select: none;
      }

      body[data-app="exercise"] .example-expressions__undo {
        border: none;
        background: transparent;
        color: var(--color-chip-active);
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 4px;
      }

      body[data-app="exercise"] .example-expressions__undo:disabled {
        opacity: 0.4;
        cursor: not-allowed;
      }

      body[data-app="exercise"] .save-status {
        margin-top: var(--spacing-xs);
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 0.82rem;
        color: var(--color-text-muted);
      }

      body[data-app="exercise"] .save-status[data-state='saving'] {
        color: var(--color-chip-active);
      }

      body[data-app="exercise"] .save-status__icon {
        font-size: var(--icon-size-sm);
      }

      body[data-app="exercise"] .shortcut-launcher {
        width: 36px;
        height: 36px;
      }

      body[data-app="exercise"] .shortcut-panel {
        position: fixed;
        inset: 0;
        display: grid;
        place-items: center;
        background: rgba(17, 24, 39, 0.45);
        backdrop-filter: blur(4px);
        z-index: 50;
      }

      body[data-app="exercise"] .shortcut-panel[hidden] {
        display: none;
      }

      body[data-app="exercise"] .shortcut-panel__dialog {
        background: var(--color-surface);
        color: var(--color-text);
        border-radius: 20px;
        padding: var(--spacing-lg);
        width: min(480px, 92vw);
        box-shadow: 0 24px 60px rgba(27, 35, 55, 0.25);
      }

      body[data-app="exercise"] .shortcut-panel__header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: var(--spacing-md);
      }

      body[data-app="exercise"] .shortcut-panel__list {
        display: grid;
        gap: var(--spacing-sm);
        font-size: 0.95rem;
      }

      body[data-app="exercise"] .shortcut-panel__item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: var(--spacing-sm);
        padding: var(--spacing-xs) var(--spacing-sm);
        border-radius: 12px;
        background: color-mix(in srgb, var(--color-chip-bg) 75%, transparent);
      }

      body[data-app="exercise"] .shortcut-panel__keys {
        font-family: "Noto Sans Mono", "Noto Sans JP", monospace;
        font-size: 0.85rem;
        display: inline-flex;
        gap: 6px;
      }

      body[data-app="exercise"] .shortcut-panel__keys span {
        padding: 4px 8px;
        border-radius: 6px;
        background: color-mix(in srgb, var(--color-chip-active) 12%, var(--color-bg));
        border: 1px solid color-mix(in srgb, var(--color-chip-active) 35%, transparent);
      }

      body[data-app="exercise"] .shortcut-panel__close {
        border: none;
        background: transparent;
        color: var(--color-text-muted);
        cursor: pointer;
        font-size: 1.2rem;
        line-height: 1;
        border-radius: 50%;
        width: 32px;
        height: 32px;
      }

      body[data-app="exercise"] .shortcut-panel__close:hover,
      body[data-app="exercise"] .shortcut-panel__close:focus-visible {
        color: var(--color-chip-active);
        background-color: color-mix(
          in srgb,
          var(--color-chip-bg) 50%,
          transparent
        );
      }

      body[data-app="exercise"] .history-modal {
        position: fixed;
        inset: 0;
        display: grid;
        place-items: center;
        background: rgba(15, 23, 42, 0.55);
        backdrop-filter: blur(4px);
        z-index: 70;
        padding: var(--spacing-md);
      }

      body[data-app="exercise"] .history-modal[hidden] {
        display: none;
      }

      body[data-app="exercise"] .history-modal__dialog {
        width: min(920px, 95vw);
        max-height: 85vh;
        display: grid;
        grid-template-rows: auto 1fr;
        gap: var(--spacing-md);
        background: var(--color-surface);
        color: var(--color-text);
        border-radius: 24px;
        box-shadow: 0 32px 80px rgba(15, 23, 39, 0.28);
        padding: var(--spacing-lg);
      }

      body[data-app="exercise"] .history-modal__header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: var(--spacing-sm);
      }

      body[data-app="exercise"] .history-modal__title {
        margin: 0;
        font-size: 1.05rem;
        font-weight: 700;
        color: var(--color-text-strong);
      }

      body[data-app="exercise"] .history-modal__close {
        border: none;
        background: transparent;
        color: var(--color-text-muted);
        font-size: 1.4rem;
        line-height: 1;
        border-radius: 50%;
        width: 36px;
        height: 36px;
        cursor: pointer;
      }

      body[data-app="exercise"] .history-modal__close:hover,
      body[data-app="exercise"] .history-modal__close:focus-visible {
        color: var(--color-chip-active);
        background: color-mix(in srgb, var(--color-chip-bg) 70%, transparent);
        outline: none;
      }

      body[data-app="exercise"] .history-modal__body {
        display: grid;
        grid-template-columns: minmax(0, 260px) minmax(0, 1fr);
        gap: var(--spacing-md);
        min-height: 0;
      }

      body[data-app="exercise"] .history-modal__list {
        list-style: none;
        margin: 0;
        padding: var(--spacing-sm);
        display: flex;
        flex-direction: column;
        gap: var(--spacing-xs);
        overflow-y: auto;
        border-radius: 16px;
        border: 1px solid color-mix(in srgb, var(--color-border) 60%, transparent);
        background: color-mix(in srgb, var(--color-layer-subtle) 60%, transparent);
      }

      body[data-app="exercise"] .history-entry {
        border: 1px solid color-mix(in srgb, var(--color-border) 65%, transparent);
        border-radius: 12px;
        padding: var(--spacing-xs) var(--spacing-sm);
        display: grid;
        gap: 2px;
        cursor: pointer;
        background: var(--color-surface);
        text-align: left;
      }

      body[data-app="exercise"] .history-entry:hover,
      body[data-app="exercise"] .history-entry:focus-visible {
        border-color: var(--color-chip-active);
        outline: none;
      }

      body[data-app="exercise"] .history-entry[aria-selected='true'] {
        border-color: var(--color-chip-active);
        box-shadow: 0 0 0 3px color-mix(in srgb, var(--color-chip-active) 20%, transparent);
      }

      body[data-app="exercise"] .history-entry__time {
        font-size: 0.82rem;
        font-weight: 600;
        color: var(--color-text-strong);
      }

      body[data-app="exercise"] .history-entry__meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: var(--spacing-xs);
        font-size: 0.75rem;
        color: var(--color-text-muted);
        font-family: "Noto Sans Mono", "Noto Sans JP", monospace;
      }

      body[data-app="exercise"] .history-entry__score {
        color: var(--color-chip-active);
        font-weight: 600;
      }

      body[data-app="exercise"] .history-modal__content {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-sm);
        min-height: 0;
      }

      body[data-app="exercise"] .history-modal__summary {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: var(--spacing-sm);
        font-size: 0.82rem;
        color: var(--color-text-muted);
      }

      body[data-app="exercise"] .history-modal__diff {
        flex: 1 1 auto;
        border-radius: 14px;
        border: 1px solid color-mix(in srgb, var(--color-border) 60%, transparent);
        background: color-mix(in srgb, var(--color-layer-subtle) 55%, transparent);
        padding: var(--spacing-sm);
        overflow: auto;
        font-size: 0.9rem;
        line-height: 1.6;
        white-space: pre-wrap;
      }

      body[data-app="exercise"] .history-diff__segment--added {
        background: color-mix(in srgb, var(--color-chip-active) 18%, transparent);
        color: var(--color-chip-active);
      }

      body[data-app="exercise"] .history-diff__segment--removed {
        background: color-mix(in srgb, var(--color-warning) 18%, transparent);
        color: var(--color-warning);
        text-decoration: line-through;
      }

      body[data-app="exercise"] .history-modal__actions {
        display: flex;
        justify-content: flex-end;
        gap: var(--spacing-xs);
      }

      body[data-app="exercise"] .history-modal__empty {
        font-size: 0.82rem;
        color: var(--color-text-muted);
      }

      @media (max-width: 768px) {
        body[data-app="exercise"] .history-modal__body {
          grid-template-columns: minmax(0, 1fr);
        }

        body[data-app="exercise"] .history-modal__list {
          max-height: 240px;
        }
      }

      body[data-app="exercise"] .retrieval-preview {
        margin-top: var(--spacing-lg);
        padding: var(--spacing-md);
        border-radius: var(--radius-card);
        background: var(--color-layer-soft);
        display: grid;
        gap: var(--spacing-sm);
      }

      body[data-app="exercise"] .retrieval-preview__header {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-xs);
      }

      body[data-app="exercise"] .retrieval-modal {
        position: fixed;
        inset: 0;
        display: grid;
        place-items: center;
        z-index: 60;
      }

      body[data-app="exercise"] .retrieval-modal[hidden] {
        display: none;
      }

      body[data-app="exercise"] .retrieval-modal__backdrop {
        position: absolute;
        inset: 0;
        background: rgba(10, 15, 28, 0.58);
        backdrop-filter: blur(4px);
      }

      body[data-app="exercise"] .retrieval-modal__dialog {
        position: relative;
        z-index: 1;
        width: min(560px, 92vw);
        border-radius: 20px;
        background: var(--color-surface);
        color: var(--color-text);
        padding: var(--spacing-lg);
        box-shadow: 0 24px 60px rgba(27, 35, 55, 0.3);
        display: grid;
        gap: var(--spacing-md);
      }

      body[data-app="exercise"] .retrieval-modal__header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: var(--spacing-sm);
        flex-wrap: wrap;
      }

      body[data-app="exercise"] .retrieval-modal__body {
        min-height: 160px;
      }

      body[data-app="exercise"] .retrieval-card {
        display: grid;
        gap: var(--spacing-xs);
        background: var(--color-layer-subtle);
        border-radius: var(--radius-card);
        padding: var(--spacing-md);
        line-height: 1.65;
      }

      body[data-app="exercise"] .retrieval-card[hidden] {
        display: none;
      }

      body[data-app="exercise"] .retrieval-card__tag {
        font-size: 0.82rem;
        font-weight: 600;
        color: var(--color-chip-active);
      }

      body[data-app="exercise"] .retrieval-modal__controls {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: var(--spacing-sm);
      }

      body[data-app="exercise"] .retrieval-progress {
        display: flex;
        flex-direction: column;
        gap: 4px;
        font-size: 0.85rem;
        color: var(--color-text-muted);
        flex: 1;
      }

      body[data-app="exercise"] .retrieval-progress__bar {
        position: relative;
        height: 6px;
        border-radius: 999px;
        background: color-mix(in srgb, var(--color-chip-bg) 50%, transparent);
        overflow: hidden;
      }

      body[data-app="exercise"] .retrieval-progress__bar span {
        position: absolute;
        inset: 0;
        border-radius: inherit;
        background: var(--color-chip-active);
        transform-origin: left center;
        transform: scaleX(0);
        transition: transform var(--transition-duration) ease;
      }

      body[data-app="exercise"] .retrieval-modal__close {
        border: none;
        background: transparent;
        color: var(--color-text-muted);
        cursor: pointer;
        border-radius: 50%;
        width: 32px;
        height: 32px;
      }

      body[data-app="exercise"] .retrieval-modal__close:hover,
      body[data-app="exercise"] .retrieval-modal__close:focus-visible {
        color: var(--color-chip-active);
        background-color: color-mix(
          in srgb,
          var(--color-chip-bg) 50%,
          transparent
        );
      }

      body[data-app="exercise"] .question-card--active::after {
        content: "";
        position: absolute;
        inset: 0;
        border-radius: inherit;
        border: 2px solid var(--color-chip-active);
        pointer-events: none;
        animation: activePulse 2s ease;
      }

      @keyframes activePulse {
        0% {
          opacity: 1;
        }
        100% {
          opacity: 0;
        }
      }

      body[data-app="exercise"] .exercise__footer {
        position: sticky;
        bottom: 0;
        z-index: 10;
        margin-top: auto;
        background-color: var(--color-bg);
        background: linear-gradient(
          180deg,
          color-mix(in srgb, var(--color-bg) 90%, transparent) 0%,
          var(--color-bg) 55%,
          var(--color-bg) 100%
        );
        border-top: 1px solid var(--color-border);
        padding: var(--spacing-md) var(--spacing-lg) calc(var(--spacing-md) + 4px);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: var(--spacing-md);
        flex-wrap: wrap;
      }

      body[data-app="exercise"] .cta-button {
        gap: var(--spacing-xs);
      }

      body[data-app="exercise"] .cta-button__verb {
        font-family: "M PLUS Rounded 1c", "Noto Sans JP", sans-serif;
      }

      body[data-app="exercise"] .exercise__footer-status {
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
        font-size: 0.82rem;
        color: var(--color-text-muted);
      }

      body[data-app="exercise"] .auto-save-indicator {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        font-family: "Noto Sans Mono", "Noto Sans JP", monospace;
        font-size: 0.8rem;
      }

      body[data-app="exercise"] .auto-save-indicator[data-state='warning'] {
        color: var(--color-warning);
        font-weight: 600;
      }

      body[data-app="exercise"] .exercise__footer-actions {
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
        flex-wrap: wrap;
      }

      body[data-app="exercise"] .cta-button__object {
        font-family: "Noto Sans JP", sans-serif;
        font-weight: 600;
      }

      @media (max-width: 1024px) {
        body[data-app="exercise"] .layout {
          --layout-left-width: clamp(280px, 44vw, 480px);
        }

        body[data-app="exercise"] .question-card__input-body {
          grid-template-columns: minmax(0, 1fr);
        }

        body[data-app="exercise"] .question-card__sidebar {
          position: static;
        }
      }

      @media (max-width: 768px) {
        body[data-app="exercise"] .layout {
          flex-direction: column;
          --layout-left-width: 100%;
          gap: var(--spacing-lg);
        }

        body[data-app="exercise"] .layout__pane--left,
        body[data-app="exercise"] .layout__pane--right {
          max-width: 100%;
          width: 100%;
        }

        body[data-app="exercise"] .layout__pane--left {
          order: 2;
        }

        body[data-app="exercise"] .layout__pane--right {
          order: 1;
        }

        body[data-app="exercise"] .layout__resizer {
          display: none;
        }

        body[data-app="exercise"] .context-pane {
          position: relative;
          top: auto;
          max-height: none;
          width: 100%;
          flex: 1 1 auto;
        }

        body[data-app="exercise"] .exercise {
          gap: var(--spacing-lg);
        }

        body[data-app="exercise"] .quick-nav {
          position: relative;
          top: auto;
          max-height: none;
          width: 100%;
          flex: 1 1 auto;
        }

        body[data-app="exercise"] .question-card__input-body {
          grid-template-columns: minmax(0, 1fr);
          gap: var(--spacing-sm);
        }

        body[data-app="exercise"] .question-card__sidebar {
          position: static;
          gap: var(--spacing-sm);
        }

        body[data-app="exercise"] .exercise__tabs {
          position: sticky;
          top: 0;
        }

        body[data-app="exercise"] .app-progress {
          grid-template-columns: 1fr;
          padding: 0 var(--spacing-md) var(--spacing-md);
        }

        body[data-app="exercise"] .progress-card {
          min-height: auto;
        }
      }

      @media (max-width: 960px) {
        body[data-app="exercise"] .app-header {
          flex-wrap: wrap;
          justify-content: center;
          gap: var(--spacing-sm);
        }

        body[data-app="exercise"] .app-header__group:last-of-type {
          order: 2;
        }

        body[data-app="exercise"] .app-header__quicknav {
          order: 3;
          width: 100%;
          justify-content: center;
          flex-wrap: wrap;
          padding-top: var(--spacing-xs);
        }

        body[data-app="exercise"] .app-header__controls {
          width: 100%;
          justify-content: center;
        }
      }

      @media (max-width: 600px) {
        body[data-app="exercise"] .layout {
          padding: var(--spacing-md);
        }

        body[data-app="exercise"] .quick-nav {
          padding: var(--spacing-md);
        }

        body[data-app="exercise"] .context-pane__miniheader {
          position: sticky;
          top: 0;
          z-index: 10;
          display: flex;
          flex-wrap: wrap;
          gap: var(--spacing-xs);
          align-items: center;
          padding: var(--spacing-xs) 0;
          background-color: var(--color-bg);
        }

        body[data-app="exercise"] .context-pane__miniheader a {
          color: var(--color-chip-active);
          font-size: 0.85rem;
          text-decoration: underline;
        }

        body[data-app="exercise"] .app-header__controls {
          flex-direction: column;
          align-items: stretch;
        }

        body[data-app="exercise"] .app-header__control select {
          width: 100%;
        }

        body[data-app="exercise"] .ui-toast {
          top: auto;
          right: var(--spacing-md);
          left: var(--spacing-md);
          bottom: var(--spacing-md);
          transform: translateY(12px);
        }

        body[data-app="exercise"] .ui-toast[data-toast-visible='true'] {
          transform: translateY(0);
        }
      }
    </style>
  </head>
  <body data-app="exercise" data-section-active="answer">
    <div class="app-shell">
      <header class="app-header" role="banner">
        <div class="app-header__group">
          <button
            class="ui-button ui-button--ghost app-header__button"
            type="button"
            aria-label="演習一覧に戻る"
          >
            <span class="icon app-header__icon" aria-hidden="true">
              <i class="bx bx-left-arrow-alt"></i>
            </span>
            戻る
          </button>
          <div class="app-header__title">
            <h1>診断士二次 演習ハブ</h1>
            <span>個別最適化された学習モード</span>
          </div>
          <div class="app-header__selection" aria-live="polite">
            <span class="app-header__selection-item" data-selection-case>
              事例I
            </span>
            <span class="app-header__selection-separator" aria-hidden="true"
              >/</span
            >
            <span class="app-header__selection-item" data-selection-year>
              令和6年
            </span>
            <span class="app-header__selection-separator" aria-hidden="true"
              >/</span
            >
            <span
              class="app-header__selection-item app-header__selection-item--strong"
              data-selection-question
            >
              Q1 経営課題の整理
            </span>
          </div>
          <div class="app-header__controls" role="group" aria-label="演習セットの切り替え">
            <label class="app-header__control">
              <span>事例</span>
              <select class="ui-select" data-case-select aria-label="事例を選択"></select>
            </label>
            <label class="app-header__control">
              <span>年度</span>
              <select class="ui-select" data-year-select aria-label="年度を選択"></select>
            </label>
          </div>
        </div>
        <div class="app-header__group" role="navigation" aria-label="主要操作">
          <button class="ui-button ui-button--ghost app-header__button" type="button">
            <span class="icon app-header__icon" aria-hidden="true">
              <i class="bx bx-search"></i>
            </span>
            検索
          </button>
          <button class="ui-button ui-button--ghost app-header__button" type="button">
            <span class="icon app-header__icon" aria-hidden="true">
              <i class="bx bx-filter"></i>
            </span>
            フィルタ
          </button>
          <button
            class="ui-button ui-button--ghost app-header__button"
            type="button"
            data-onboarding-open
            aria-haspopup="dialog"
          >
            <span class="icon app-header__icon" aria-hidden="true">
              <i class="bx bx-help-circle"></i>
            </span>
            使い方ガイド
          </button>
          <button
            class="ui-button ui-button--icon shortcut-launcher"
            type="button"
            aria-label="キーボードショートカットを表示"
            data-shortcut-open
          >
            <span class="icon" aria-hidden="true">
              <i class="bx bx-keyboard"></i>
            </span>
          </button>
        </div>
        <nav
          class="app-header__quicknav"
          aria-label="セクションへのショートカット"
        >
          <button
            class="ui-button ui-button--ghost app-header__anchor"
            type="button"
            data-target="section-overview"
          >
            設問概要
          </button>
          <button
            class="ui-button ui-button--ghost app-header__anchor"
            type="button"
            data-target="section-scenario"
          >
            与件文
          </button>
          <button
            class="ui-button ui-button--ghost app-header__anchor"
            type="button"
            data-target="section-retrieval"
          >
            リトリーバル
          </button>
          <button
            class="ui-button ui-button--ghost app-header__anchor"
            type="button"
            data-target="section-answer"
          >
            解答
          </button>
        </nav>
      </header>
      <section class="app-progress" aria-label="進捗状況">
        <div class="progress-card" role="status" aria-live="polite">
          <div class="progress-card__header">
            <span class="progress-card__title">解答進捗</span>
            <span class="progress-card__meta" data-progress-questions-summary>
              0 / 4問
            </span>
          </div>
          <div class="progress-card__bar" aria-hidden="true">
            <span data-progress-questions-bar style="width: 0%"></span>
          </div>
        </div>
        <div
          class="progress-card"
          role="status"
          aria-live="polite"
          data-progress-retrieval-card
        >
          <div class="progress-card__header">
            <span class="progress-card__title">リトリーバル</span>
            <span class="progress-card__meta" data-progress-retrieval-summary>
              0枚中0枚完了
            </span>
          </div>
          <div class="progress-card__bar" aria-hidden="true">
            <span data-progress-retrieval-bar style="width: 0%"></span>
          </div>
        </div>
        <div class="progress-card progress-card--timer" role="status">
          <div class="progress-card__header">
            <span class="progress-card__title">残り時間</span>
            <span class="progress-card__meta" data-progress-timer-label>
              45:00
            </span>
          </div>
          <div class="progress-card__bar" aria-hidden="true">
            <span data-progress-timer-bar style="width: 100%"></span>
          </div>
        </div>
      </section>
      <nav class="section-tabs" role="tablist" aria-label="主要セクション">
        <button
          id="section-tab-overview"
          type="button"
          class="section-tab"
          role="tab"
          data-panel-trigger="overview"
          aria-controls="section-overview"
          aria-selected="false"
          tabindex="-1"
        >
          <span class="icon section-tab__icon" aria-hidden="true">
            <i class="bx bx-map"></i>
          </span>
          <span class="section-tab__texts">
            <span class="section-tab__title">出題ナビ</span>
            <span class="section-tab__description">検索とフィルタ</span>
          </span>
        </button>
        <button
          id="section-tab-scenario"
          type="button"
          class="section-tab"
          role="tab"
          data-panel-trigger="scenario"
          aria-controls="section-scenario"
          aria-selected="false"
          tabindex="-1"
        >
          <span class="icon section-tab__icon" aria-hidden="true">
            <i class="bx bx-book-reader"></i>
          </span>
          <span class="section-tab__texts">
            <span class="section-tab__title">与件文</span>
            <span class="section-tab__description">背景を読み込む</span>
          </span>
        </button>
        <button
          id="section-tab-answer"
          type="button"
          class="section-tab"
          role="tab"
          data-panel-trigger="answer"
          aria-controls="section-answer"
          aria-selected="true"
          tabindex="0"
        >
          <span class="icon section-tab__icon" aria-hidden="true">
            <i class="bx bx-edit"></i>
          </span>
          <span class="section-tab__texts">
            <span class="section-tab__title">設問解答・プラクティス</span>
            <span class="section-tab__description">回答・リトリーバル</span>
          </span>
        </button>
      </nav>
      <div class="layout" data-layout>
        <div
          class="layout__pane layout__pane--left"
          data-layout-pane="left"
          id="layout-pane-left"
        >
          <aside
          id="section-scenario"
          class="context-pane"
          role="tabpanel"
          aria-labelledby="section-tab-scenario context-heading"
          data-panel-section="scenario"
          data-panel-collapsed="true"
        >
        <header class="context-pane__header context-pane__card">
          <div class="context-pane__miniheader">
            <strong data-scenario-summary>事例I 令和6年</strong>
            <a class="text-muted" href="#question-1">設問一覧へジャンプ</a>
          </div>
          <h1 id="context-heading" data-scenario-title>B製造業 与件文</h1>
          <dl class="context-pane__meta">
            <dt>業種</dt>
            <dd data-scenario-industry>精密機器製造</dd>
            <dt>従業員</dt>
            <dd data-scenario-employees>220名</dd>
            <dt>売上規模</dt>
            <dd data-scenario-sales>58億円</dd>
            <dt>キーワード</dt>
            <dd data-scenario-keywords>技能伝承 / 開発連携</dd>
          </dl>
        </header>
        <section
          class="context-pane__card context-pane__card--tools"
          aria-label="検索とハイライト"
        >
          <h2 class="context-pane__card-title">検索とマーカー</h2>
          <p class="context-pane__card-intro">
            与件文を検索しながら色分けマーカーで強み・弱みを瞬時に整理できます。
          </p>
          <ul class="context-pane__guide-list">
            <li class="context-pane__guide-item">
              <span class="icon context-pane__guide-icon" aria-hidden="true">
                <i class="bx bx-filter-alt"></i>
              </span>
              青や緑のストライプは活かす資源や機会、オレンジは弱みや注意点を示し、
              パターンの違いで色覚特性があっても識別できます。
            </li>
            <li class="context-pane__guide-item">
              <span class="icon context-pane__guide-icon" aria-hidden="true">
                <i class="bx bx-edit-alt"></i>
              </span>
              サジェスト付き検索と1クリックの色付けで、気づきをメモや回答作成へ
              すぐに連携できます。
            </li>
          </ul>
          <div class="context-pane__search" role="search">
            <label class="sr-only" for="scenario-search">与件文を検索</label>
            <div class="context-pane__search-field">
              <input
                id="scenario-search"
                type="search"
                placeholder="与件文内を検索"
                data-scenario-search
              />
              <span class="icon icon--sm context-pane__search-icon" aria-hidden="true">
                <i class="bx bx-search"></i>
              </span>
            </div>
            <div class="context-pane__search-controls">
              <button
                type="button"
                class="ui-button ui-button--icon ui-button--sm context-pane__search-nav has-tooltip"
                data-scenario-search-prev
                aria-label="前の一致へ"
                data-tooltip="前の一致へ移動"
                disabled
              >
                <span class="icon icon--sm" aria-hidden="true">
                  <i class="bx bx-chevron-up"></i>
                </span>
              </button>
              <button
                type="button"
                class="ui-button ui-button--icon ui-button--sm context-pane__search-nav has-tooltip"
                data-scenario-search-next
                aria-label="次の一致へ"
                data-tooltip="次の一致へ移動"
                disabled
              >
                <span class="icon icon--sm" aria-hidden="true">
                  <i class="bx bx-chevron-down"></i>
                </span>
              </button>
              <span
                class="context-pane__search-count text-muted"
                data-scenario-search-count
                aria-live="polite"
              >
                0 件
              </span>
            </div>
          </div>
          <div class="highlight-toolbar" data-highlight-toolbar>
            <div class="highlight-toolbar__title">
              <strong>マーカーを選択</strong>
              <button
                type="button"
                class="ui-button ui-button--subtle highlight-toolbar__undo has-tooltip"
                data-highlight-undo
                data-tooltip="直前のマーカー操作を元に戻す"
                aria-label="直前のマーカー操作を元に戻す"
              >
                <span class="icon icon--sm" aria-hidden="true">
                  <i class="bx bx-undo"></i>
                </span>
                <span>元に戻す</span>
              </button>
            </div>
            <p class="highlight-toolbar__helper">
              <span class="icon icon--sm" aria-hidden="true">
                <i class="bx bx-highlight"></i>
              </span>
              与件文を選択してマーカーをクリックすると即座に色が付き、ハイライトに
              メモを追加できます。
            </p>
            <div
              class="highlight-toolbar__palette"
              role="radiogroup"
              aria-label="ハイライトカテゴリを選択"
            >
              <button
                type="button"
                class="highlight-toolbar__button has-tooltip"
                data-highlight-category="strength"
                data-active="true"
                data-tooltip="強みとしてマーク"
                aria-label="強みとしてマーク"
              >
                <span
                  class="highlight-toolbar__swatch highlight-pattern highlight-pattern--strength"
                  aria-hidden="true"
                ></span>
                <span class="icon highlight-toolbar__icon" aria-hidden="true">
                  <i class="bx bx-highlight"></i>
                </span>
                <span data-highlight-category-label="strength">強み</span>
              </button>
              <button
                type="button"
                class="highlight-toolbar__button has-tooltip"
                data-highlight-category="weakness"
                data-tooltip="弱みとしてマーク"
                aria-label="弱みとしてマーク"
              >
                <span
                  class="highlight-toolbar__swatch highlight-pattern highlight-pattern--weakness"
                  aria-hidden="true"
                ></span>
                <span class="icon highlight-toolbar__icon" aria-hidden="true">
                  <i class="bx bx-highlight"></i>
                </span>
                <span data-highlight-category-label="weakness">弱み</span>
              </button>
              <button
                type="button"
                class="highlight-toolbar__button has-tooltip"
                data-highlight-category="challenge"
                data-tooltip="課題としてマーク"
                aria-label="課題としてマーク"
              >
                <span
                  class="highlight-toolbar__swatch highlight-pattern highlight-pattern--challenge"
                  aria-hidden="true"
                ></span>
                <span class="icon highlight-toolbar__icon" aria-hidden="true">
                  <i class="bx bx-highlight"></i>
                </span>
                <span data-highlight-category-label="challenge">課題</span>
              </button>
              <button
                type="button"
                class="highlight-toolbar__button has-tooltip"
                data-highlight-category="opportunity"
                data-tooltip="機会としてマーク"
                aria-label="機会としてマーク"
              >
                <span
                  class="highlight-toolbar__swatch highlight-pattern highlight-pattern--opportunity"
                  aria-hidden="true"
                ></span>
                <span class="icon highlight-toolbar__icon" aria-hidden="true">
                  <i class="bx bx-highlight"></i>
                </span>
                <span data-highlight-category-label="opportunity">機会</span>
              </button>
            </div>
            <div class="highlight-legend" data-highlight-legend>
              <div class="highlight-legend__item">
                <span
                  class="highlight-legend__swatch highlight-pattern highlight-pattern--strength"
                  data-highlight-legend-swatch="strength"
                  aria-hidden="true"
                ></span>
                <div class="highlight-legend__info">
                  <input
                    type="text"
                    class="highlight-legend__input"
                    value="強み"
                    data-highlight-label-input="strength"
                    aria-label="強みマーカーの用途を編集"
                  />
                  <small class="highlight-legend__meaning" data-highlight-category-meaning="strength">
                    活かす資源・優位性
                  </small>
                </div>
              </div>
              <div class="highlight-legend__item">
                <span
                  class="highlight-legend__swatch highlight-pattern highlight-pattern--weakness"
                  data-highlight-legend-swatch="weakness"
                  aria-hidden="true"
                ></span>
                <div class="highlight-legend__info">
                  <input
                    type="text"
                    class="highlight-legend__input"
                    value="弱み"
                    data-highlight-label-input="weakness"
                    aria-label="弱みマーカーの用途を編集"
                  />
                  <small class="highlight-legend__meaning" data-highlight-category-meaning="weakness">
                    ボトルネック・改善点
                  </small>
                </div>
              </div>
              <div class="highlight-legend__item">
                <span
                  class="highlight-legend__swatch highlight-pattern highlight-pattern--challenge"
                  data-highlight-legend-swatch="challenge"
                  aria-hidden="true"
                ></span>
                <div class="highlight-legend__info">
                  <input
                    type="text"
                    class="highlight-legend__input"
                    value="課題"
                    data-highlight-label-input="challenge"
                    aria-label="課題マーカーの用途を編集"
                  />
                  <small class="highlight-legend__meaning" data-highlight-category-meaning="challenge">
                    解決すべき課題・リスク
                  </small>
                </div>
              </div>
              <div class="highlight-legend__item">
                <span
                  class="highlight-legend__swatch highlight-pattern highlight-pattern--opportunity"
                  data-highlight-legend-swatch="opportunity"
                  aria-hidden="true"
                ></span>
                <div class="highlight-legend__info">
                  <input
                    type="text"
                    class="highlight-legend__input"
                    value="機会"
                    data-highlight-label-input="opportunity"
                    aria-label="機会マーカーの用途を編集"
                  />
                  <small class="highlight-legend__meaning" data-highlight-category-meaning="opportunity">
                    活用できる外部資源・機会
                  </small>
                </div>
              </div>
            </div>
          </div>
        </section>
        <section
          class="context-pane__card context-pane__card--scenario"
          aria-label="与件文本文"
          data-accordion
          data-accordion-default-open="true"
        >
          <header class="context-pane__section-header">
            <h2 class="context-pane__card-title">与件文本文</h2>
            <button
              type="button"
              class="accordion-toggle"
              data-accordion-toggle
              data-accordion-label-expanded="折りたたむ"
              data-accordion-label-collapsed="展開する"
              aria-expanded="true"
            >
              <span data-accordion-toggle-text>折りたたむ</span>
              <span class="accordion-toggle__icon" aria-hidden="true">
                <i class="bx bx-chevron-up"></i>
              </span>
            </button>
          </header>
          <div data-accordion-body>
            <div class="context-pane__body" data-scenario-body>
          <!-- 与件文を常時参照できるよう縦スクロール可能に配置 -->
          A社は創業40年の精密機器メーカーである。創業者の引退を契機に、
          2代目社長は設計部門のDX化と熟練技術者の技能伝承を最優先テーマ
          と定めた。設計BOMと生産BOMが分断されており、製品立ち上げ時の
          手戻りが多発している。また、顧客ニーズの高度化に伴い、多品種小
          ロットかつ短納期での開発対応が求められている。

          現状、設計段階での顧客折衝は営業部門が単独で担っており、設計の
          観点が十分に反映されていない。生産部門ではベテラン技能者の高齢
          化が進み、暗黙知の形式知化が急務となっている。社長は部門横断で
          の情報共有と意思決定スピードの改善を目指し、試験的にデジタル・
          コラボレーション基盤を導入した。

          今後は、設計段階からの顧客共創、外部パートナーとの連携強化、そ
          れに伴う評価制度の再設計が検討課題である。
        </div>
        <div class="context-pane__actions">
          <button
            type="button"
            class="ui-button ui-button--subtle context-pane__jump"
            data-selection-jump
            hidden
          >
            選択箇所を回答欄へジャンプ
          </button>
          <div class="highlight-inspector" data-highlight-inspector hidden>
            <div class="highlight-inspector__header">
              <h3 class="heading-md">ハイライトメモ</h3>
              <button
                type="button"
                class="analysis-info__trigger has-tooltip"
                aria-label="ハイライトメモを閉じる"
                data-highlight-close
                data-tooltip="ハイライトメモを閉じる"
              >
                <span class="analysis-info__icon" aria-hidden="true">
                  <i class="bx bx-x"></i>
                </span>
              </button>
            </div>
            <div class="highlight-inspector__preview" data-highlight-preview>
              選択したハイライトがここに表示されます。
            </div>
            <div class="highlight-inspector__field">
              <label for="highlight-tags">キーワードタグ</label>
              <input
                id="highlight-tags"
                type="text"
                class="highlight-inspector__input"
                placeholder="例：DX、技能伝承"
                data-highlight-tags
              />
            </div>
            <div class="highlight-inspector__field">
              <label for="highlight-note">メモ</label>
              <textarea
                id="highlight-note"
                class="highlight-inspector__textarea"
                placeholder="関連する知識や次のアクションを記録"
                data-highlight-note
              ></textarea>
            </div>
            <div class="highlight-inspector__actions">
              <button
                type="button"
                class="ui-button ui-button--subtle"
                data-highlight-question
              >
                この部分から問いを作成
              </button>
              <button
                type="button"
                class="ui-button ui-button--primary has-tooltip"
                data-highlight-save
                data-tooltip="ハイライトメモを保存"
              >
                <span class="icon icon--sm" aria-hidden="true">
                  <i class="bx bx-save"></i>
                </span>
                メモを保存
              </button>
            </div>
            <p class="highlight-inspector__hint">
              ハイライト後に問いを作り、リトリーバルカードへ送ると復習の起点
              になります。
            </p>
          </div>
          <section
            class="highlight-practice"
            aria-label="ハイライトから生成した練習問題"
            data-highlight-practice
            hidden
          >
            <h3 class="heading-md">ハイライトからの問い</h3>
            <p class="text-muted">
              作成した問いはリトリーバル練習に追加できます。心理的負荷を抑
              えて、一問ずつ確認しましょう。
            </p>
            <ul class="highlight-practice__list" data-highlight-practice-list></ul>
          </section>
        </div>
      </aside>
          <section
            class="analysis-card"
            aria-labelledby="analysis-card-title"
            data-learning-analysis
          >
            <header class="analysis-card__header">
              <h2 id="analysis-card-title" class="analysis-card__title">
                学習分析
              </h2>
              <span class="analysis-card__updated" data-analysis-updated>
                最終更新 --:--
              </span>
            </header>
            <div class="analysis-card__chart">
              <h3 class="analysis-card__chart-title">
                年度別・設問タイプ別の傾向
              </h3>
              <div class="analysis-card__bars" data-analysis-bars>
                <p class="analysis-card__empty" data-analysis-empty>
                  まだ分析データがありません。解答を保存するとグラフが表示されます。
                </p>
              </div>
            </div>
            <div class="analysis-card__insights" data-analysis-insights>
              <div class="analysis-card__highlight" data-analysis-highlight="weakness">
                <strong>弱点領域</strong>
                <p data-analysis-highlight-text="weakness">
                  履歴が蓄積されると弱点領域が表示されます。
                </p>
              </div>
              <div class="analysis-card__highlight" data-analysis-highlight="trend">
                <strong>文字数トレンド</strong>
                <p data-analysis-highlight-text="trend">
                  年度別の文字数傾向がここに表示されます。
                </p>
              </div>
            </div>
          </section>
          <aside
            class="quick-nav"
            role="complementary"
            aria-label="設問クイックナビゲーション"
            data-panel-section="answer"
            data-panel-collapsed="true"
          >
            <div class="quick-nav__header">
              <h2 class="quick-nav__title">クイックナビ</h2>
              <p class="quick-nav__hint">
                Alt+Shift+N / P / A で設問の移動や回答欄へのフォーカスができます
              </p>
            </div>
            <ol class="quick-nav__list" data-question-quicknav>
              <li class="quick-nav__empty">設問を読み込み中です</li>
            </ol>
          </aside>
        </div>
        <div
          class="layout__resizer"
          role="separator"
          aria-label="表示幅を調整"
          aria-orientation="vertical"
          tabindex="0"
          data-layout-resizer
          aria-controls="layout-pane-left layout-pane-right"
        ></div>
        <div
          class="layout__pane layout__pane--right"
          data-layout-pane="right"
          id="layout-pane-right"
        >

          <main class="exercise" role="main" aria-labelledby="exercise-heading">
        <h2 id="exercise-heading" class="sr-only">演習と設問</h2>
        <section
          id="section-overview"
          class="exercise__controls"
          role="tabpanel"
          aria-label="問題の検索と整理"
          aria-labelledby="section-tab-overview"
          data-panel-section="overview"
          data-panel-collapsed="true"
        >
          <div class="control-card" role="group" aria-labelledby="search-heading">
            <h3 id="search-heading" class="heading-md">問題検索</h3>
            <label class="sr-only" for="problem-search">問題文やキーワードを検索</label>
            <div class="search-field">
              <input
                id="problem-search"
                type="search"
                name="problem-search"
                placeholder="キーワードや設問番号で検索"
                list="problem-search-suggestions"
              />
              <span class="icon icon--sm search-field__icon" aria-hidden="true">
                <i class="bx bx-search"></i>
              </span>
            </div>
            <datalist
              id="problem-search-suggestions"
              data-problem-search-suggestions
            ></datalist>
          </div>
          <div class="control-card" role="group" aria-labelledby="filter-heading">
            <h3 id="filter-heading" class="heading-md">検索フィルタ</h3>
            <div class="filter-chips" role="list">
              <button
                class="filter-chip has-tooltip"
                type="button"
                role="listitem"
                data-active="true"
                data-tooltip="まだ取り組んでいない問題だけを表示します"
                aria-label="未回答（まだ取り組んでいない問題だけを表示します）"
                data-filter="unanswered"
              >
                <span class="icon icon--sm" aria-hidden="true">
                  <i class="bx bx-check"></i>
                </span>
                未回答
              </button>
              <button
                class="filter-chip has-tooltip"
                type="button"
                role="listitem"
                data-tooltip="提出済みの問題に絞り込んで進捗を確認します"
                aria-label="解答済み（提出済みの問題に絞り込みます）"
                data-filter="answered"
              >
                <span class="icon icon--sm" aria-hidden="true">
                  <i class="bx bx-check"></i>
                </span>
                解答済み
              </button>
              <button
                class="filter-chip has-tooltip"
                type="button"
                role="listitem"
                data-tooltip="復習フラグが付いた問題を優先的に表示します"
                aria-label="要復習（復習フラグが付いた問題を優先的に表示します）"
                data-filter="review"
              >
                <span class="icon icon--sm" aria-hidden="true">
                  <i class="bx bx-check"></i>
                </span>
                要復習
              </button>
              <button
                class="filter-chip has-tooltip"
                type="button"
                role="listitem"
                data-tooltip="模範解答や解説が用意された問題だけに限定します"
                aria-label="解説あり（模範解答や解説が用意された問題だけに限定します）"
                data-filter="explanation"
              >
                <span class="icon icon--sm" aria-hidden="true">
                  <i class="bx bx-check"></i>
                </span>
                解説あり
              </button>
            </div>
            <div class="sort-control">
              <label class="sort-control__label" for="problem-sort">並べ替え</label>
              <div
                class="sort-control__field has-tooltip"
                data-tooltip="学習状況に合わせて設問の順序を切り替えます"
              >
                <select
                  id="problem-sort"
                  name="problem-sort"
                  class="sort-control__select ui-select"
                  aria-describedby="problem-sort-hint"
                >
                  <option value="recommended">推奨順</option>
                  <option value="status">ステータス順</option>
                  <option value="recent">最近解いた順</option>
                </select>
                <span class="icon icon--sm sort-control__icon" aria-hidden="true">
                  <i class="bx bx-info-circle"></i>
                </span>
              </div>
              <p id="problem-sort-hint" class="sr-only">
                推奨順、ステータス順、最近解いた順から選択できます。
              </p>
            </div>
          </div>
          <div class="control-card" role="group" aria-labelledby="index-heading">
            <h3 id="index-heading" class="heading-md">問題一覧</h3>
            <ol class="question-index" data-question-index>
              <li><a href="#question-1">Q1 経営課題の整理</a></li>
              <li><a href="#question-2">Q2 顧客共創の提案</a></li>
              <li><a href="#question-3">Q3 技能伝承の仕組み</a></li>
              <li><a href="#question-4">Q4 評価制度の再設計</a></li>
            </ol>
          </div>
          <section
            class="control-card control-card--collapsible reference-card"
            role="complementary"
            aria-labelledby="reference-heading"
            data-collapsible
            data-collapsible-open="false"
          >
            <div class="control-card__header">
              <h3 id="reference-heading" class="heading-md">解説メモ</h3>
              <button
                type="button"
                class="ui-button ui-button--ghost control-card__toggle"
                data-collapsible-toggle
                aria-expanded="false"
                aria-controls="reference-card-body"
                data-label-collapsed="メモを表示"
                data-label-expanded="メモを隠す"
              >
                <span class="collapsible-toggle__icon icon icon--sm" aria-hidden="true">
                  <i class="bx bx-chevron-down"></i>
                </span>
                <span data-collapsible-label>メモを表示</span>
              </button>
            </div>
            <div
              id="reference-card-body"
              class="control-card__body reference-card__body"
              data-collapsible-body
              hidden
            >
              与件文から導かれるポイントをメモとして整理しています。設問に
              迷ったら、キーワードと因果関係の視点を確認しましょう。
        </div>
          </div>
        </section>
          <div
            class="control-card control-card--collapsible"
            role="group"
            aria-labelledby="expression-heading"
            data-collapsible
            data-collapsible-open="false"
          >
            <div class="control-card__header">
              <h3 id="expression-heading" class="heading-md">表現カード</h3>
              <button
                type="button"
                class="ui-button ui-button--ghost control-card__toggle"
                data-collapsible-toggle
                aria-expanded="false"
                aria-controls="expression-card-body"
                data-label-collapsed="一覧を表示"
                data-label-expanded="一覧を隠す"
              >
                <span class="collapsible-toggle__icon icon icon--sm" aria-hidden="true">
                  <i class="bx bx-chevron-down"></i>
                </span>
                <span data-collapsible-label>一覧を表示</span>
              </button>
            </div>
            <div
              id="expression-card-body"
              class="control-card__body"
              data-collapsible-body
              hidden
            >
              <p class="text-muted">
                クリックすると回答作成のヒントが表示されます。キーボードの
                Tabで移動し、Enterで決定できます。
              </p>
              <div class="strategy-card-grid">
              <button
                type="button"
                class="strategy-card"
                data-tooltip="2センテンス構成を意識した短文テンプレート"
                data-strategy="expression"
              >
                30字×2の表現
              </button>
              <button
                type="button"
                class="strategy-card"
                data-tooltip="原因→施策→効果のフレームを提示"
                data-strategy="structure"
              >
                構造の言葉
              </button>
              <button
                type="button"
                class="strategy-card"
                data-tooltip="強み×機会の切り口でアイデアを整理"
                data-strategy="swot"
              >
                強み活用カード
              </button>
              <button
                type="button"
                class="strategy-card"
                data-tooltip="一次知識を再確認して具体例を引き出す"
                data-strategy="knowledge"
              >
                定石・知識集
              </button>
            </div>
            <div class="strategy-card__preview" data-strategy-detail hidden></div>
            <div class="sr-only" aria-live="polite" data-strategy-live></div>
          </div>
        </section>
        <section
          id="section-retrieval"
          class="retrieval-preview"
          aria-labelledby="retrieval-heading"
          data-panel-section="answer"
          data-panel-collapsed="true"
        >
          <div class="retrieval-preview__header">
            <h3 id="retrieval-heading" class="heading-md">リトリーバル</h3>
            <p class="text-muted">
              過去演習で蓄積した知識カードを一枚ずつ確認できます。関連する
              インサイトを復習してから回答を組み立てましょう。
            </p>
          </div>
          <button
            type="button"
            class="ui-button ui-button--primary"
            data-retrieval-open
            aria-haspopup="dialog"
          >
            カードを開く
          </button>
        </section>
        <nav
          class="exercise__tabs"
          role="tablist"
          aria-label="設問タブ"
          data-wheel-scroll="true"
          data-panel-section="answer"
          data-panel-collapsed="true"
        >
          <!-- ホイールでも操作できる設問タブ -->
          <button
            id="tab-question-1"
            class="exercise-tab"
            type="button"
            role="tab"
            aria-selected="true"
            aria-controls="question-1"
            tabindex="0"
            data-target="question-1"
            data-question-tab="q1"
          >
            <span class="exercise-tab__label">Q1</span>
            <span class="exercise-tab__title" data-question-tab-title>経営課題の整理</span>
          </button>
          <button
            id="tab-question-2"
            class="exercise-tab"
            type="button"
            role="tab"
            aria-selected="false"
            aria-controls="question-2"
            tabindex="-1"
            data-target="question-2"
            data-question-tab="q2"
          >
            <span class="exercise-tab__label">Q2</span>
            <span class="exercise-tab__title" data-question-tab-title>顧客共創の提案</span>
          </button>
          <button
            id="tab-question-3"
            class="exercise-tab"
            type="button"
            role="tab"
            aria-selected="false"
            aria-controls="question-3"
            tabindex="-1"
            data-target="question-3"
            data-question-tab="q3"
          >
            <span class="exercise-tab__label">Q3</span>
            <span class="exercise-tab__title" data-question-tab-title>技能伝承の仕組み</span>
          </button>
          <button
            id="tab-question-4"
            class="exercise-tab"
            type="button"
            role="tab"
            aria-selected="false"
            aria-controls="question-4"
            tabindex="-1"
            data-target="question-4"
            data-question-tab="q4"
          >
            <span class="exercise-tab__label">Q4</span>
            <span class="exercise-tab__title" data-question-tab-title>評価制度の再設計</span>
          </button>
        </nav>
        <div class="exercise__inline-timer" role="status" aria-live="polite">
          <span class="exercise__inline-timer-badge">
            <span class="icon" aria-hidden="true">
              <i class="bx bx-time-five"></i>
            </span>
            タイマー
          </span>
          <span class="exercise__inline-timer-countdown" data-inline-timer-label>
            --:--
          </span>
        </div>
        <section
          id="section-answer"
          class="exercise__questions"
          aria-live="polite"
          role="tabpanel"
          aria-labelledby="section-tab-answer"
          data-panel-section="answer"
          data-panel-collapsed="true"
        >
          <article
            id="question-1"
            class="question-card"
            role="region"
            aria-labelledby="question-1-title"
            data-max-length="120"
            data-question-label="Q1 経営課題の整理"
            data-question-key="q1"
          >
            <header class="question-card__header">
              <span class="question-card__badge">1</span>
              <h3
                id="question-1-title"
                class="question-card__title"
                data-question-title
              >
                経営課題の整理
              </h3>
              <div class="question-card__meta">
                <span data-question-score>配点 20点</span>
                <span data-question-limit>120字以内</span>
              </div>
            </header>
            <div class="question-card__body" data-question-prompt>
              A社が直面している主要な経営課題を、設計・生産・人材の観点
              から整理し、優先度の高い順に二点述べよ。
            </div>
            <div
              class="question-card__input"
              data-accordion
              data-accordion-default-open="true"
            >
              <header class="question-card__accordion-header">
                <h4 class="question-card__accordion-title">解答入力欄</h4>
                <button
                  type="button"
                  class="accordion-toggle"
                  data-accordion-toggle
                  data-accordion-label-expanded="折りたたむ"
                  data-accordion-label-collapsed="展開する"
                  aria-expanded="true"
                >
                  <span data-accordion-toggle-text>折りたたむ</span>
                  <span class="accordion-toggle__icon" aria-hidden="true">
                    <i class="bx bx-chevron-up"></i>
                  </span>
                </button>
              </header>
              <div class="question-card__input-body" data-accordion-body>
                <div class="question-card__editor" data-question-editor>
                  <div class="question-card__fields">
                    <div class="question-card__answer">
                      <label class="sr-only" for="answer-1">設問1回答欄</label>
                      <textarea
                        id="answer-1"
                        class="question-card__textarea"
                        maxlength="300"
                        aria-describedby="counter-1"
                        data-max-length="120"
                      ></textarea>
                    </div>
                    <div class="question-card__memo" aria-labelledby="memo-label-1">
                      <label id="memo-label-1" class="question-card__memo-label" for="memo-1">
                        骨子メモ
                      </label>
                      <textarea
                        id="memo-1"
                        data-question-memo
                        data-question-key="q1"
                        placeholder="ハイライトと結び付けたい要点を記入"
                      ></textarea>
                      <div class="question-card__memo-actions">
                        <p class="question-card__memo-hint">
                          メモ内容は選択中のハイライトにコピーできます。
                        </p>
                        <button
                          type="button"
                          class="ui-button ui-button--ghost question-card__memo-button has-tooltip"
                          data-question-memo-attach="q1"
                          data-tooltip="選択中のハイライトにメモをコピー"
                        >
                          <span class="icon icon--sm" aria-hidden="true">
                            <i class="bx bx-export"></i>
                          </span>
                          ハイライトにコピー
                        </button>
                      </div>
                    </div>
                  </div>
                  <div class="question-card__tools">
                    <div id="counter-1" class="char-counter" aria-live="polite">
                      0 / 120 字
                    </div>
                    <button
                      class="analysis-info__trigger has-tooltip"
                      type="button"
                      aria-expanded="false"
                      aria-controls="analysis-info-1"
                      data-info-target="analysis-info-1"
                      data-tooltip="分析ツールの説明を表示"
                    >
                      <span class="analysis-info__icon" aria-hidden="true">
                        <i class="bx bx-info-circle"></i>
                      </span>
                      <span class="sr-only">分析ツールの説明を開く</span>
                    </button>
                  </div>
                  <div class="composition-guide" data-composition-guide hidden>
                    <div class="composition-guide__header">
                      <span class="composition-guide__title">構成ガイド</span>
                      <div class="composition-guide__header-actions">
                        <button
                          type="button"
                          class="composition-guide__template-button has-tooltip"
                          data-composition-template
                          data-tooltip="テンプレートを回答欄へ挿入"
                        >
                          <span class="icon icon--sm" aria-hidden="true">
                            <i class="bx bx-book-open"></i>
                          </span>
                          テンプレート挿入
                        </button>
                        <span
                          class="composition-guide__remaining"
                          data-composition-remaining
                        >
                          残り -- 字
                        </span>
                      </div>
                    </div>
                    <div
                      class="composition-guide__segments"
                      data-composition-segments
                    ></div>
                    <div
                      class="composition-guide__template-preview"
                      data-composition-template-preview
                    ></div>
                  </div>
                  <div id="analysis-info-1" class="analysis-info" hidden>
                    <p>
                      残り字数のカウンターと構造ラベルを合わせて確認し、要素の
                      抜け漏れをチェックしましょう。配点が高い設問では段落構成を
                      メモしてから記入するのがおすすめです。
                    </p>
                    <div class="analysis-info__meta">
                      <span>構造メモ機能の基本操作</span>
                      <a
                        href="https://videos.example.jp/tool-demo"
                        target="_blank"
                        rel="noreferrer"
                      >
                        使い方動画を見る
                      </a>
                    </div>
                  </div>
                  <div
                    class="example-expressions"
                    role="group"
                    aria-label="設問1の例示表現"
                    data-example-for="answer-1"
                  >
                    <div class="example-expressions__header">
                      <span class="example-expressions__title">例示表現</span>
                      <button
                        type="button"
                        class="example-expressions__undo has-tooltip"
                        data-example-undo
                        data-tooltip="直前に挿入した表現を元に戻す"
                        disabled
                      >
                        <span class="icon icon--sm" aria-hidden="true">
                          <i class="bx bx-undo"></i>
                        </span>
                        挿入を取り消す
                      </button>
                    </div>
                    <div
                      class="example-expressions__list"
                      role="list"
                      data-example-list
                    >
                      <button
                        type="button"
                        class="example-expression-chip"
                        role="listitem"
                        draggable="true"
                        data-example-text="設計と生産のBOM分断が手戻りを誘発"
                      >
                        設計と生産のBOM分断が手戻りを誘発
                      </button>
                      <button
                        type="button"
                        class="example-expression-chip"
                        role="listitem"
                        draggable="true"
                        data-example-text="熟練技能の暗黙知が形式知化できていない"
                      >
                        熟練技能の暗黙知が形式知化できていない
                      </button>
                      <button
                        type="button"
                        class="example-expression-chip"
                        role="listitem"
                        draggable="true"
                        data-example-text="顧客ニーズの高度化に開発体制が追随できない"
                      >
                        顧客ニーズの高度化に開発体制が追随できない
                      </button>
                    </div>
                    <div class="sr-only" data-example-live aria-live="polite"></div>
                  </div>
                <div class="save-status" role="status" data-save-status>
                  <span class="icon save-status__icon" aria-hidden="true">
                    <i class="bx bx-save"></i>
                  </span>
                  <span class="save-status__text">保存済み</span>
                </div>
                </div>
              <aside
                class="question-card__sidebar"
                data-question-sidebar
                >
                  <div class="question-intent-card" data-question-intent>
                    <button
                      type="button"
                      class="question-intent-card__header"
                      data-question-intent-toggle
                      aria-expanded="false"
                      aria-controls="question-intent-body-1"
                    >
                      <div>
                        <span>設問趣旨カード</span>
                        <span class="question-intent-card__meta">
                          <span data-question-intent-score>配点 20点</span>
                        </span>
                      </div>
                      <span
                        class="question-intent-card__toggle-icon"
                        aria-hidden="true"
                      >
                        <i class="bx bx-chevron-down"></i>
                      </span>
                    </button>
                    <div
                      id="question-intent-body-1"
                      class="question-intent-card__body"
                      data-question-intent-body
                      hidden
                    >
                      <dl>
                        <div class="question-intent-card__item">
                          <dt>出題意図</dt>
                          <dd data-question-intention></dd>
                        </div>
                        <div class="question-intent-card__item">
                          <dt>評価ポイント</dt>
                          <dd>
                            <ul
                              class="question-intent-card__points"
                              data-question-evaluation-list
                            ></ul>
                          </dd>
                        </div>
                        <div class="question-intent-card__item">
                          <dt>採点のヒント</dt>
                          <dd data-question-scoring></dd>
                        </div>
                      </dl>
                    </div>
                  </div>
                </aside>
              </div>
            </div>
            <section
              class="question-card__guide"
              aria-labelledby="guide-heading-1"
              data-accordion
              data-accordion-default-open="false"
            >
              <header class="question-card__accordion-header">
                <h4 id="guide-heading-1" class="question-card__guide-title">解法ガイド</h4>
                <button
                  type="button"
                  class="accordion-toggle"
                  data-accordion-toggle
                  data-accordion-label-expanded="折りたたむ"
                  data-accordion-label-collapsed="展開する"
                  aria-expanded="false"
                >
                  <span data-accordion-toggle-text>展開する</span>
                  <span class="accordion-toggle__icon" aria-hidden="true">
                    <i class="bx bx-chevron-up"></i>
                  </span>
                </button>
              </header>
              <div class="question-card__guide-body" data-accordion-body hidden>
                <div class="support-block">
                  <button
                    class="support-block__toggle ui-button ui-button--subtle"
                    type="button"
                    aria-expanded="false"
                    aria-controls="support-1"
                    data-support-id="support-1"
                  >
                    <span class="icon icon--sm support-block__icon" aria-hidden="true">
                      <i class="bx bx-bulb"></i>
                    </span>
                    <span class="support-block__text">
                      <span class="support-block__label">活用する 思考補助</span>
                      <span class="support-block__hint">インサイトで骨子を整理</span>
                    </span>
                    <span class="icon icon--sm support-block__chevron" aria-hidden="true">
                      <i class="bx bx-chevron-down"></i>
                    </span>
                  </button>
                  <div
                    id="support-1"
                    class="support-block__content"
                    hidden
                    data-support-content
                  >
                    設計部門のDX化、BOM連携、技能伝承、人材評価の整合性など、
                    与件文から直接引用できる語を起点に因果で整理する。
                  </div>
                </div>
              </div>
            </section>
          </article>

          <article
            id="question-2"
            class="question-card"
            role="region"
            aria-labelledby="question-2-title"
            data-max-length="160"
            data-question-label="Q2 顧客共創の提案"
            data-question-key="q2"
          >
            <header class="question-card__header">
              <span class="question-card__badge">2</span>
              <h3
                id="question-2-title"
                class="question-card__title"
                data-question-title
              >
                顧客共創の提案
              </h3>
              <div class="question-card__meta">
                <span data-question-score>配点 30点</span>
                <span data-question-limit>160字以内</span>
              </div>
            </header>
            <div class="question-card__body" data-question-prompt>
              A社が顧客との共同開発を推進するための施策を、営業・設計・
              生産の連携の仕組みとして提案せよ。
            </div>
            <div
              class="question-card__input"
              data-accordion
              data-accordion-default-open="true"
            >
              <header class="question-card__accordion-header">
                <h4 class="question-card__accordion-title">解答入力欄</h4>
                <button
                  type="button"
                  class="accordion-toggle"
                  data-accordion-toggle
                  data-accordion-label-expanded="折りたたむ"
                  data-accordion-label-collapsed="展開する"
                  aria-expanded="true"
                >
                  <span data-accordion-toggle-text>折りたたむ</span>
                  <span class="accordion-toggle__icon" aria-hidden="true">
                    <i class="bx bx-chevron-up"></i>
                  </span>
                </button>
              </header>
              <div class="question-card__input-body" data-accordion-body>
                <div class="question-card__editor" data-question-editor>
                  <div class="question-card__fields">
                    <div class="question-card__answer">
                      <label class="sr-only" for="answer-2">設問2回答欄</label>
                      <textarea
                        id="answer-2"
                        class="question-card__textarea"
                        maxlength="400"
                        aria-describedby="counter-2"
                        data-max-length="160"
                      ></textarea>
                    </div>
                    <div class="question-card__memo" aria-labelledby="memo-label-2">
                      <label id="memo-label-2" class="question-card__memo-label" for="memo-2">
                        骨子メモ
                      </label>
                      <textarea
                        id="memo-2"
                        data-question-memo
                        data-question-key="q2"
                        placeholder="ポイントや因果をメモ"
                      ></textarea>
                      <div class="question-card__memo-actions">
                        <p class="question-card__memo-hint">
                          メモを選択中のハイライトに反映できます。
                        </p>
                        <button
                          type="button"
                          class="ui-button ui-button--ghost question-card__memo-button has-tooltip"
                          data-question-memo-attach="q2"
                          data-tooltip="選択中のハイライトにメモをコピー"
                        >
                          <span class="icon icon--sm" aria-hidden="true">
                            <i class="bx bx-export"></i>
                          </span>
                          ハイライトにコピー
                        </button>
                      </div>
                    </div>
                  </div>
                  <div class="question-card__tools">
                    <div id="counter-2" class="char-counter" aria-live="polite">
                      0 / 160 字
                    </div>
                    <button
                      class="analysis-info__trigger has-tooltip"
                      type="button"
                      aria-expanded="false"
                      aria-controls="analysis-info-2"
                      data-info-target="analysis-info-2"
                      data-tooltip="分析ツールの説明を表示"
                    >
                      <span class="analysis-info__icon" aria-hidden="true">
                        <i class="bx bx-info-circle"></i>
                      </span>
                      <span class="sr-only">分析ツールの説明を開く</span>
                    </button>
                  </div>
                  <div class="composition-guide" data-composition-guide hidden>
                    <div class="composition-guide__header">
                      <span class="composition-guide__title">構成ガイド</span>
                      <div class="composition-guide__header-actions">
                        <button
                          type="button"
                          class="composition-guide__template-button has-tooltip"
                          data-composition-template
                          data-tooltip="テンプレートを回答欄へ挿入"
                        >
                          <span class="icon icon--sm" aria-hidden="true">
                            <i class="bx bx-book-open"></i>
                          </span>
                          テンプレート挿入
                        </button>
                        <span
                          class="composition-guide__remaining"
                          data-composition-remaining
                        >
                          残り -- 字
                        </span>
                      </div>
                    </div>
                    <div
                      class="composition-guide__segments"
                      data-composition-segments
                    ></div>
                    <div
                      class="composition-guide__template-preview"
                      data-composition-template-preview
                    ></div>
                  </div>
                  <div id="analysis-info-2" class="analysis-info" hidden>
                    <p>
                      共創提案では、顧客の期待価値と自社資源のマトリクスを用い
                      ると構造的に整理できます。フレームを選ぶと、要素の順序を
                      自動で提案します。
                    </p>
                    <div class="analysis-info__meta">
                      <span>提案骨子テンプレート</span>
                      <a
                        href="https://videos.example.jp/template-demo"
                        target="_blank"
                        rel="noreferrer"
                      >
                        使い方動画を見る
                      </a>
                    </div>
                  </div>
                  <div
                    class="example-expressions"
                    role="group"
                    aria-label="設問2の例示表現"
                    data-example-for="answer-2"
                  >
                    <div class="example-expressions__header">
                      <span class="example-expressions__title">例示表現</span>
                      <button
                        type="button"
                        class="example-expressions__undo has-tooltip"
                        data-example-undo
                        data-tooltip="直前に挿入した表現を元に戻す"
                        disabled
                      >
                        <span class="icon icon--sm" aria-hidden="true">
                          <i class="bx bx-undo"></i>
                        </span>
                        挿入を取り消す
                      </button>
                    </div>
                    <div
                      class="example-expressions__list"
                      role="list"
                      data-example-list
                    >
                      <button
                        type="button"
                        class="example-expression-chip"
                        role="listitem"
                        draggable="true"
                        data-example-text="営業・設計・生産で顧客課題を共通理解"
                      >
                        営業・設計・生産で顧客課題を共通理解
                      </button>
                      <button
                        type="button"
                        class="example-expression-chip"
                        role="listitem"
                        draggable="true"
                        data-example-text="共創レビューで要求を段階的に合意形成"
                      >
                        共創レビューで要求を段階的に合意形成
                      </button>
                      <button
                        type="button"
                        class="example-expression-chip"
                        role="listitem"
                        draggable="true"
                        data-example-text="クラウドBOMで設計変更を即時共有"
                      >
                        クラウドBOMで設計変更を即時共有
                      </button>
                    </div>
                    <div class="sr-only" data-example-live aria-live="polite"></div>
                  </div>
                  <div class="save-status" role="status" data-save-status>
                    <span class="icon save-status__icon" aria-hidden="true">
                      <i class="bx bx-save"></i>
                    </span>
                    <span class="save-status__text">保存済み</span>
                  </div>
                </div>
                <aside
                  class="question-card__sidebar"
                  data-question-sidebar
                >
                  <div class="question-intent-card" data-question-intent>
                    <button
                      type="button"
                      class="question-intent-card__header"
                      data-question-intent-toggle
                      aria-expanded="false"
                      aria-controls="question-intent-body-2"
                    >
                      <div>
                        <span>設問趣旨カード</span>
                        <span class="question-intent-card__meta">
                          <span data-question-intent-score>配点 30点</span>
                        </span>
                      </div>
                      <span
                        class="question-intent-card__toggle-icon"
                        aria-hidden="true"
                      >
                        <i class="bx bx-chevron-down"></i>
                      </span>
                    </button>
                    <div
                      id="question-intent-body-2"
                      class="question-intent-card__body"
                      data-question-intent-body
                      hidden
                    >
                      <dl>
                        <div class="question-intent-card__item">
                          <dt>出題意図</dt>
                          <dd data-question-intention></dd>
                        </div>
                        <div class="question-intent-card__item">
                          <dt>評価ポイント</dt>
                          <dd>
                            <ul
                              class="question-intent-card__points"
                              data-question-evaluation-list
                            ></ul>
                          </dd>
                        </div>
                        <div class="question-intent-card__item">
                          <dt>採点のヒント</dt>
                          <dd data-question-scoring></dd>
                        </div>
                      </dl>
                    </div>
                  </div>
                </aside>
              </div>
            </div>
            <section
              class="question-card__guide"
              aria-labelledby="guide-heading-2"
              data-accordion
              data-accordion-default-open="false"
            >
              <header class="question-card__accordion-header">
                <h4 id="guide-heading-2" class="question-card__guide-title">解法ガイド</h4>
                <button
                  type="button"
                  class="accordion-toggle"
                  data-accordion-toggle
                  data-accordion-label-expanded="折りたたむ"
                  data-accordion-label-collapsed="展開する"
                  aria-expanded="false"
                >
                  <span data-accordion-toggle-text>展開する</span>
                  <span class="accordion-toggle__icon" aria-hidden="true">
                    <i class="bx bx-chevron-up"></i>
                  </span>
                </button>
              </header>
              <div class="question-card__guide-body" data-accordion-body hidden>
                <div class="support-block">
                  <button
                    class="support-block__toggle ui-button ui-button--subtle"
                    type="button"
                    aria-expanded="false"
                    aria-controls="support-2"
                    data-support-id="support-2"
                  >
                    <span class="icon icon--sm support-block__icon" aria-hidden="true">
                      <i class="bx bx-bulb"></i>
                    </span>
                    <span class="support-block__text">
                      <span class="support-block__label">確認する 注意事項</span>
                      <span class="support-block__hint">共創で外せない視点を確認</span>
                    </span>
                    <span class="icon icon--sm support-block__chevron" aria-hidden="true">
                      <i class="bx bx-chevron-down"></i>
                    </span>
                  </button>
                  <div
                    id="support-2"
                    class="support-block__content"
                    hidden
                    data-support-content
                  >
                    顧客接点の情報共有タイミング、設計部門の早期参画、試作段
                    階でのフィードバックループを盛り込む。
                  </div>
                </div>
              </div>
            </section>
          </article>

          <article
            id="question-3"
            class="question-card"
            role="region"
            aria-labelledby="question-3-title"
            data-max-length="160"
            data-question-label="Q3 技能伝承の仕組み"
            data-question-key="q3"
          >
            <header class="question-card__header">
              <span class="question-card__badge">3</span>
              <h3
                id="question-3-title"
                class="question-card__title"
                data-question-title
              >
                技能伝承の仕組み
              </h3>
              <div class="question-card__meta">
                <span data-question-score>配点 25点</span>
                <span data-question-limit>160字以内</span>
              </div>
            </header>
            <div class="question-card__body" data-question-prompt>
              熟練技能の形式知化と継承を加速するための施策を、教育体系と
              デジタル活用の両面から述べよ。
            </div>
            <div
              class="question-card__input"
              data-accordion
              data-accordion-default-open="true"
            >
              <header class="question-card__accordion-header">
                <h4 class="question-card__accordion-title">解答入力欄</h4>
                <button
                  type="button"
                  class="accordion-toggle"
                  data-accordion-toggle
                  data-accordion-label-expanded="折りたたむ"
                  data-accordion-label-collapsed="展開する"
                  aria-expanded="true"
                >
                  <span data-accordion-toggle-text>折りたたむ</span>
                  <span class="accordion-toggle__icon" aria-hidden="true">
                    <i class="bx bx-chevron-up"></i>
                  </span>
                </button>
              </header>
              <div class="question-card__input-body" data-accordion-body>
                <div class="question-card__editor" data-question-editor>
                  <div class="question-card__fields">
                    <div class="question-card__answer">
                      <label class="sr-only" for="answer-3">設問3回答欄</label>
                      <textarea
                        id="answer-3"
                        class="question-card__textarea"
                        maxlength="400"
                        aria-describedby="counter-3"
                        data-max-length="160"
                      ></textarea>
                    </div>
                    <div class="question-card__memo" aria-labelledby="memo-label-3">
                      <label id="memo-label-3" class="question-card__memo-label" for="memo-3">
                        骨子メモ
                      </label>
                      <textarea
                        id="memo-3"
                        data-question-memo
                        data-question-key="q3"
                        placeholder="技能伝承で押さえる要素を整理"
                      ></textarea>
                      <div class="question-card__memo-actions">
                        <p class="question-card__memo-hint">
                          メモはハイライトメモとしても保存されます。
                        </p>
                        <button
                          type="button"
                          class="ui-button ui-button--ghost question-card__memo-button has-tooltip"
                          data-question-memo-attach="q3"
                          data-tooltip="選択中のハイライトにメモをコピー"
                        >
                          <span class="icon icon--sm" aria-hidden="true">
                            <i class="bx bx-export"></i>
                          </span>
                          ハイライトにコピー
                        </button>
                      </div>
                    </div>
                  </div>
                  <div class="question-card__tools">
                    <div id="counter-3" class="char-counter" aria-live="polite">
                      0 / 160 字
                    </div>
                    <button
                      class="analysis-info__trigger has-tooltip"
                      type="button"
                      aria-expanded="false"
                      aria-controls="analysis-info-3"
                      data-info-target="analysis-info-3"
                      data-tooltip="分析ツールの説明を表示"
                    >
                      <span class="analysis-info__icon" aria-hidden="true">
                        <i class="bx bx-info-circle"></i>
                      </span>
                      <span class="sr-only">分析ツールの説明を開く</span>
                    </button>
                  </div>
                  <div class="composition-guide" data-composition-guide hidden>
                    <div class="composition-guide__header">
                      <span class="composition-guide__title">構成ガイド</span>
                      <div class="composition-guide__header-actions">
                        <button
                          type="button"
                          class="composition-guide__template-button has-tooltip"
                          data-composition-template
                          data-tooltip="テンプレートを回答欄へ挿入"
                        >
                          <span class="icon icon--sm" aria-hidden="true">
                            <i class="bx bx-book-open"></i>
                          </span>
                          テンプレート挿入
                        </button>
                        <span class="composition-guide__remaining" data-composition-remaining>
                          残り -- 字
                        </span>
                      </div>
                    </div>
                    <div class="composition-guide__segments" data-composition-segments></div>
                    <div
                      class="composition-guide__template-preview"
                      data-composition-template-preview
                    ></div>
                  </div>
                  <div id="analysis-info-3" class="analysis-info" hidden>
                    <p>
                      技能伝承の設問では、プロセス分解チャートを使うとフェーズ
                      ごとの課題と施策を紐づけやすくなります。チャートに入力する
                      と、回答骨子が自動整形されます。
                    </p>
                    <div class="analysis-info__meta">
                      <span>プロセス分解チャート</span>
                      <a
                        href="https://videos.example.jp/chart-demo"
                        target="_blank"
                        rel="noreferrer"
                      >
                        使い方動画を見る
                      </a>
                    </div>
                  </div>
                  <div
                    class="example-expressions"
                    role="group"
                    aria-label="設問3の例示表現"
                    data-example-for="answer-3"
                  >
                    <div class="example-expressions__header">
                      <span class="example-expressions__title">例示表現</span>
                      <button
                        type="button"
                        class="example-expressions__undo has-tooltip"
                        data-example-undo
                        data-tooltip="直前に挿入した表現を元に戻す"
                        disabled
                      >
                        <span class="icon icon--sm" aria-hidden="true">
                          <i class="bx bx-undo"></i>
                        </span>
                        挿入を取り消す
                      </button>
                    </div>
                    <div
                      class="example-expressions__list"
                      role="list"
                      data-example-list
                    >
                      <button
                        type="button"
                        class="example-expression-chip"
                        role="listitem"
                        draggable="true"
                        data-example-text="作業動画と要点字幕で匠のコツを可視化"
                      >
                        作業動画と要点字幕で匠のコツを可視化
                      </button>
                      <button
                        type="button"
                        class="example-expression-chip"
                        role="listitem"
                        draggable="true"
                        data-example-text="技能伝承のペアリングOJTとラーニング記録"
                      >
                        技能伝承のペアリングOJTとラーニング記録
                      </button>
                      <button
                        type="button"
                        class="example-expression-chip"
                        role="listitem"
                        draggable="true"
                        data-example-text="熟練者の暗黙知をワークフローに埋め込む"
                      >
                        熟練者の暗黙知をワークフローに埋め込む
                      </button>
                    </div>
                    <div class="sr-only" data-example-live aria-live="polite"></div>
                  </div>
                  <div class="save-status" role="status" data-save-status>
                    <span class="icon save-status__icon" aria-hidden="true">
                      <i class="bx bx-save"></i>
                    </span>
                    <span class="save-status__text">保存済み</span>
                  </div>
                </div>
                <aside class="question-card__sidebar" data-question-sidebar>
                  <div class="question-intent-card" data-question-intent>
                    <button
                      type="button"
                      class="question-intent-card__header"
                      data-question-intent-toggle
                      aria-expanded="false"
                      aria-controls="question-intent-body-3"
                    >
                      <div>
                        <span>設問趣旨カード</span>
                        <span class="question-intent-card__meta">
                          <span data-question-intent-score>配点 25点</span>
                        </span>
                      </div>
                      <span class="question-intent-card__toggle-icon" aria-hidden="true">
                        <i class="bx bx-chevron-down"></i>
                      </span>
                    </button>
                    <div
                      id="question-intent-body-3"
                      class="question-intent-card__body"
                      data-question-intent-body
                      hidden
                    >
                      <dl>
                        <div class="question-intent-card__item">
                          <dt>出題意図</dt>
                          <dd data-question-intention></dd>
                        </div>
                        <div class="question-intent-card__item">
                          <dt>評価ポイント</dt>
                          <dd>
                            <ul class="question-intent-card__points" data-question-evaluation-list></ul>
                          </dd>
                        </div>
                        <div class="question-intent-card__item">
                          <dt>採点のヒント</dt>
                          <dd data-question-scoring></dd>
                        </div>
                      </dl>
                    </div>
                  </div>
                </aside>
              </div>
            </div>
            <section
              class="question-card__guide"
              aria-labelledby="guide-heading-3"
              data-accordion
              data-accordion-default-open="false"
            >
              <header class="question-card__accordion-header">
                <h4 id="guide-heading-3" class="question-card__guide-title">解法ガイド</h4>
                <button
                  type="button"
                  class="accordion-toggle"
                  data-accordion-toggle
                  data-accordion-label-expanded="折りたたむ"
                  data-accordion-label-collapsed="展開する"
                  aria-expanded="false"
                >
                  <span data-accordion-toggle-text>展開する</span>
                  <span class="accordion-toggle__icon" aria-hidden="true">
                    <i class="bx bx-chevron-up"></i>
                  </span>
                </button>
              </header>
              <div class="question-card__guide-body" data-accordion-body hidden>
                <div class="support-block">
                  <button
                    class="support-block__toggle ui-button ui-button--subtle"
                    type="button"
                    aria-expanded="false"
                    aria-controls="support-3"
                    data-support-id="support-3"
                  >
                    <span class="icon icon--sm support-block__icon" aria-hidden="true">
                      <i class="bx bx-bulb"></i>
                    </span>
                    <span class="support-block__text">
                      <span class="support-block__label">確認する 注意事項</span>
                      <span class="support-block__hint">共創で外せない視点を確認</span>
                    </span>
                    <span class="icon icon--sm support-block__chevron" aria-hidden="true">
                      <i class="bx bx-chevron-down"></i>
                    </span>
                  </button>
                  <div
                    id="support-3"
                    class="support-block__content"
                    hidden
                    data-support-content
                  >
                    顧客接点の情報共有タイミング、設計部門の早期参画、試作段階での
                    フィードバックループを盛り込み、伝承プランに落とし込みます。
                  </div>
                </div>
              </div>
            </section>
          </article>

          <article
            id="question-4"
            class="question-card"
            role="region"
            aria-labelledby="question-4-title"
            data-max-length="200"
            data-question-label="Q4 評価制度の再設計"
            data-question-key="q4"
          >
            <header class="question-card__header">
              <span class="question-card__badge">4</span>
              <h3
                id="question-4-title"
                class="question-card__title"
                data-question-title
              >
                評価制度の再設計
              </h3>
              <div class="question-card__meta">
                <span data-question-score>配点 25点</span>
                <span data-question-limit>200字以内</span>
              </div>
            </header>
            <div class="question-card__body" data-question-prompt>
              DX推進と技能伝承を両立させる評価制度・報酬制度の改善策を、
              期待する行動指標を含めて述べよ。
            </div>
            <div
              class="question-card__input"
              data-accordion
              data-accordion-default-open="true"
            >
              <header class="question-card__accordion-header">
                <h4 class="question-card__accordion-title">解答入力欄</h4>
                <button
                  type="button"
                  class="accordion-toggle"
                  data-accordion-toggle
                  data-accordion-label-expanded="折りたたむ"
                  data-accordion-label-collapsed="展開する"
                  aria-expanded="true"
                >
                  <span data-accordion-toggle-text>折りたたむ</span>
                  <span class="accordion-toggle__icon" aria-hidden="true">
                    <i class="bx bx-chevron-up"></i>
                  </span>
                </button>
              </header>
              <div class="question-card__input-body" data-accordion-body>
                <div class="question-card__editor" data-question-editor>
                  <div class="question-card__fields">
                    <div class="question-card__answer">
                      <label class="sr-only" for="answer-4">設問4回答欄</label>
                      <textarea
                        id="answer-4"
                        class="question-card__textarea"
                        maxlength="500"
                        aria-describedby="counter-4"
                        data-max-length="200"
                      ></textarea>
                    </div>
                    <div class="question-card__memo" aria-labelledby="memo-label-4">
                      <label id="memo-label-4" class="question-card__memo-label" for="memo-4">
                        骨子メモ
                      </label>
                      <textarea
                        id="memo-4"
                        data-question-memo
                        data-question-key="q4"
                        placeholder="評価指標や行動を箇条書きで整理"
                      ></textarea>
                      <div class="question-card__memo-actions">
                        <p class="question-card__memo-hint">
                          メモをハイライトへ送って評価視点を統一できます。
                        </p>
                        <button
                          type="button"
                          class="ui-button ui-button--ghost question-card__memo-button has-tooltip"
                          data-question-memo-attach="q4"
                          data-tooltip="選択中のハイライトにメモをコピー"
                        >
                          <span class="icon icon--sm" aria-hidden="true">
                            <i class="bx bx-export"></i>
                          </span>
                          ハイライトにコピー
                        </button>
                      </div>
                    </div>
                  </div>
                  <div class="question-card__tools">
                    <div id="counter-4" class="char-counter" aria-live="polite">
                      0 / 200 字
                    </div>
                    <button
                      class="analysis-info__trigger has-tooltip"
                      type="button"
                      aria-expanded="false"
                      aria-controls="analysis-info-4"
                      data-info-target="analysis-info-4"
                      data-tooltip="分析ツールの説明を表示"
                    >
                      <span class="analysis-info__icon" aria-hidden="true">
                        <i class="bx bx-info-circle"></i>
                      </span>
                      <span class="sr-only">分析ツールの説明を開く</span>
                    </button>
                  </div>
                  <div class="composition-guide" data-composition-guide hidden>
                    <div class="composition-guide__header">
                      <span class="composition-guide__title">構成ガイド</span>
                      <div class="composition-guide__header-actions">
                        <button
                          type="button"
                          class="composition-guide__template-button has-tooltip"
                          data-composition-template
                          data-tooltip="テンプレートを回答欄へ挿入"
                        >
                          <span class="icon icon--sm" aria-hidden="true">
                            <i class="bx bx-book-open"></i>
                          </span>
                          テンプレート挿入
                        </button>
                        <span class="composition-guide__remaining" data-composition-remaining>
                          残り -- 字
                        </span>
                      </div>
                    </div>
                    <div class="composition-guide__segments" data-composition-segments></div>
                    <div
                      class="composition-guide__template-preview"
                      data-composition-template-preview
                    ></div>
                  </div>
                  <div id="analysis-info-4" class="analysis-info" hidden>
                    <p>
                      評価制度の設問では、成果指標と行動指標を二軸で整理し、重要
                      キーワードをハイライトしておくと記述がぶれません。軸を選ぶと、
                      テンプレートが展開されます。
                    </p>
                    <div class="analysis-info__meta">
                      <span>評価指標デザイン</span>
                      <a
                        href="https://videos.example.jp/eval-demo"
                        target="_blank"
                        rel="noreferrer"
                      >
                        使い方動画を見る
                      </a>
                    </div>
                  </div>
                  <div
                    class="example-expressions"
                    role="group"
                    aria-label="設問4の例示表現"
                    data-example-for="answer-4"
                  >
                    <div class="example-expressions__header">
                      <span class="example-expressions__title">例示表現</span>
                      <button
                        type="button"
                        class="example-expressions__undo has-tooltip"
                        data-example-undo
                        data-tooltip="直前に挿入した表現を元に戻す"
                        disabled
                      >
                        <span class="icon icon--sm" aria-hidden="true">
                          <i class="bx bx-undo"></i>
                        </span>
                        挿入を取り消す
                      </button>
                    </div>
                    <div
                      class="example-expressions__list"
                      role="list"
                      data-example-list
                    >
                      <button
                        type="button"
                        class="example-expression-chip"
                        role="listitem"
                        draggable="true"
                        data-example-text="知識共有と後進育成を評価指標に反映"
                      >
                        知識共有と後進育成を評価指標に反映
                      </button>
                      <button
                        type="button"
                        class="example-expression-chip"
                        role="listitem"
                        draggable="true"
                        data-example-text="DX活用件数を成果評価に連動"
                      >
                        DX活用件数を成果評価に連動
                      </button>
                      <button
                        type="button"
                        class="example-expression-chip"
                        role="listitem"
                        draggable="true"
                        data-example-text="行動指標で共創行動とナレッジ共有を促す"
                      >
                        行動指標で共創行動とナレッジ共有を促す
                      </button>
                    </div>
                    <div class="sr-only" data-example-live aria-live="polite"></div>
                  </div>
                  <div class="save-status" role="status" data-save-status>
                    <span class="icon save-status__icon" aria-hidden="true">
                      <i class="bx bx-save"></i>
                    </span>
                    <span class="save-status__text">保存済み</span>
                  </div>
                </div>
                <aside class="question-card__sidebar" data-question-sidebar>
                  <div class="question-intent-card" data-question-intent>
                    <button
                      type="button"
                      class="question-intent-card__header"
                      data-question-intent-toggle
                      aria-expanded="false"
                      aria-controls="question-intent-body-4"
                    >
                      <div>
                        <span>設問趣旨カード</span>
                        <span class="question-intent-card__meta">
                          <span data-question-intent-score>配点 25点</span>
                        </span>
                      </div>
                      <span class="question-intent-card__toggle-icon" aria-hidden="true">
                        <i class="bx bx-chevron-down"></i>
                      </span>
                    </button>
                    <div
                      id="question-intent-body-4"
                      class="question-intent-card__body"
                      data-question-intent-body
                      hidden
                    >
                      <dl>
                        <div class="question-intent-card__item">
                          <dt>出題意図</dt>
                          <dd data-question-intention></dd>
                        </div>
                        <div class="question-intent-card__item">
                          <dt>評価ポイント</dt>
                          <dd>
                            <ul class="question-intent-card__points" data-question-evaluation-list></ul>
                          </dd>
                        </div>
                        <div class="question-intent-card__item">
                          <dt>採点のヒント</dt>
                          <dd data-question-scoring></dd>
                        </div>
                      </dl>
                    </div>
                  </div>
                </aside>
              </div>
            </div>
            <section
              class="question-card__guide"
              aria-labelledby="guide-heading-4"
              data-accordion
              data-accordion-default-open="false"
            >
              <header class="question-card__accordion-header">
                <h4 id="guide-heading-4" class="question-card__guide-title">解法ガイド</h4>
                <button
                  type="button"
                  class="accordion-toggle"
                  data-accordion-toggle
                  data-accordion-label-expanded="折りたたむ"
                  data-accordion-label-collapsed="展開する"
                  aria-expanded="false"
                >
                  <span data-accordion-toggle-text>展開する</span>
                  <span class="accordion-toggle__icon" aria-hidden="true">
                    <i class="bx bx-chevron-up"></i>
                  </span>
                </button>
              </header>
              <div class="question-card__guide-body" data-accordion-body hidden>
                <div class="support-block">
                  <button
                    class="support-block__toggle ui-button ui-button--subtle"
                    type="button"
                    aria-expanded="false"
                    aria-controls="support-4"
                    data-support-id="support-4"
                  >
                    <span class="icon icon--sm support-block__icon" aria-hidden="true">
                      <i class="bx bx-bulb"></i>
                    </span>
                    <span class="support-block__text">
                      <span class="support-block__label">確認する ゴール像</span>
                      <span class="support-block__hint">模範解答の方向性を把握</span>
                    </span>
                    <span class="icon icon--sm support-block__chevron" aria-hidden="true">
                      <i class="bx bx-chevron-down"></i>
                    </span>
                  </button>
                  <div
                    id="support-4"
                    class="support-block__content"
                    hidden
                    data-support-content
                  >
                    DXで創出した知見の共有や後進育成を評価指標に組み込み、成果と
                    プロセスを両面評価する基準づくりを意識します。
                  </div>
                </div>
              </div>
            </section>
          </article>
        </section>
        <footer
          class="exercise__footer"
          data-panel-section="answer"
          data-panel-collapsed="true"
        >
          <div class="exercise__footer-status">
            <span class="auto-save-indicator" data-auto-save-indicator data-state="idle">
              <span class="icon icon--sm" aria-hidden="true">
                <i class="bx bx-cloud-check"></i>
              </span>
              <span data-auto-save-text>自動保存待機中</span>
            </span>
            <span data-auto-save-timestamp>最終保存 --:--</span>
          </div>
          <div class="exercise__footer-actions">
            <button
              type="button"
              class="ui-button ui-button--ghost has-tooltip"
              data-shortcut-open
              data-tooltip="キーボードショートカット一覧を表示"
            >
              <span class="icon icon--sm" aria-hidden="true">
                <i class="bx bx-keyboard"></i>
              </span>
              ショートカット
            </button>
            <button
              type="button"
              class="ui-button ui-button--subtle has-tooltip"
              data-history-open
              data-tooltip="保存履歴と差分を確認"
            >
              <span class="icon icon--sm" aria-hidden="true">
                <i class="bx bx-history"></i>
              </span>
              履歴比較
            </button>
            <button
              type="button"
              class="cta-button ui-button ui-button--primary ui-button--lg"
              id="next-question-button"
              data-target="question-2"
              aria-label="次の設問へ進む"
            >
              <span class="cta-button__verb">進む</span>
              <span class="cta-button__object">次の設問へ</span>
            </button>
          </div>
        </footer>
          </main>
        </div>
      </div>
    </div>

    <div
      class="history-modal"
      role="dialog"
      aria-modal="true"
      aria-labelledby="history-modal-title"
      hidden
      data-history-modal
    >
      <div class="history-modal__dialog">
        <header class="history-modal__header">
          <h3 id="history-modal-title" class="history-modal__title">履歴と比較</h3>
          <button
            type="button"
            class="history-modal__close"
            aria-label="履歴を閉じる"
            data-history-close
          >
            ✕
          </button>
        </header>
        <div class="history-modal__body">
          <ol
            class="history-modal__list"
            role="listbox"
            aria-label="保存履歴"
            data-history-list
          >
            <li class="history-modal__empty" data-history-empty>
              まだ保存履歴がありません。
            </li>
          </ol>
          <div class="history-modal__content">
            <div class="history-modal__summary">
              <span data-history-selected-timestamp>選択した履歴: --</span>
              <span data-history-selected-meta>文字数 -- / 推定得点 --</span>
            </div>
            <div class="history-modal__diff" data-history-diff>
              ここに差分が表示されます。
            </div>
            <div class="history-modal__actions">
              <button
                type="button"
                class="ui-button ui-button--ghost"
                data-history-copy
                disabled
              >
                <span class="icon icon--sm" aria-hidden="true">
                  <i class="bx bx-copy"></i>
                </span>
                テキストをコピー
              </button>
              <button
                type="button"
                class="ui-button ui-button--primary"
                data-history-restore
                disabled
              >
                <span class="icon icon--sm" aria-hidden="true">
                  <i class="bx bx-undo"></i>
                </span>
                この状態に戻す
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div
      class="retrieval-modal"
      role="dialog"
      aria-modal="true"
      aria-labelledby="retrieval-modal-heading"
      hidden
      data-retrieval-modal
    >
      <div class="retrieval-modal__backdrop" data-retrieval-close></div>
      <div class="retrieval-modal__dialog">
        <header class="retrieval-modal__header">
          <h3 id="retrieval-modal-heading" class="heading-md">リトリーバルカード</h3>
          <label class="retrieval-modal__order">
            <span>カード順序</span>
            <select data-retrieval-order>
              <option value="default">登録順</option>
            </select>
          </label>
          <button
            type="button"
            class="retrieval-modal__close"
            aria-label="リトリーバルを閉じる"
            data-retrieval-close
          >
            ✕
          </button>
        </header>
        <div class="retrieval-modal__body" data-retrieval-container>
          <article
            class="retrieval-card"
            data-retrieval-card
            data-index="0"
            data-category="顧客共創"
            data-expected-keywords="共創,議事録,トレーサビリティ,設計,営業"
          >
            <span class="retrieval-card__tag">顧客共創</span>
            <h4 class="heading-md">共創設計レビュー</h4>
            <p>
              開発初期から設計と営業が参加する共創レビューを設定し、顧客の
              真因をBOMに反映。議事録をクラウド共有してトレーサビリティを
              確保する。
            </p>
            <div class="retrieval-card__practice">
              <label class="text-muted" for="retrieval-response-0">
                思い出したキーワード
              </label>
              <textarea
                id="retrieval-response-0"
                data-retrieval-response
                placeholder="例：共創レビュー／議事録共有 など"
              ></textarea>
              <button
                type="button"
                class="ui-button ui-button--subtle"
                data-retrieval-check
              >
                重なりを確認
              </button>
              <div class="retrieval-feedback" data-retrieval-feedback hidden>
                <div class="retrieval-feedback__chips" data-retrieval-overlap></div>
                <p class="retrieval-feedback__summary" data-retrieval-summary></p>
              </div>
            </div>
          </article>
          <article
            class="retrieval-card"
            data-retrieval-card
            data-index="1"
            data-category="技能伝承"
            data-expected-keywords="動画,字幕,メンター,振り返り,チェックリスト"
            hidden
          >
            <span class="retrieval-card__tag">技能伝承</span>
            <h4 class="heading-md">動画×メンター制度</h4>
            <p>
              熟練者の作業を動画で記録し、技能のツボを字幕で補足。週次でメ
              ンターが振り返り面談を実施し、チェックリストで習熟度を可視化。
            </p>
            <div class="retrieval-card__practice">
              <label class="text-muted" for="retrieval-response-1">
                思い出したキーワード
              </label>
              <textarea
                id="retrieval-response-1"
                data-retrieval-response
                placeholder="例：動画記録／チェックリスト／面談"
              ></textarea>
              <button
                type="button"
                class="ui-button ui-button--subtle"
                data-retrieval-check
              >
                重なりを確認
              </button>
              <div class="retrieval-feedback" data-retrieval-feedback hidden>
                <div class="retrieval-feedback__chips" data-retrieval-overlap></div>
                <p class="retrieval-feedback__summary" data-retrieval-summary></p>
              </div>
            </div>
          </article>
          <article
            class="retrieval-card"
            data-retrieval-card
            data-index="2"
            data-category="評価制度"
            data-expected-keywords="知識共有,評価指標,活用率,ポイント,昇格"
            hidden
          >
            <span class="retrieval-card__tag">評価制度</span>
            <h4 class="heading-md">知識共有インセンティブ</h4>
            <p>
              DX基盤に登録したナレッジ件数と活用率を評価指標に組み込み、共
              有ポイントが昇格面談で参照される仕組みを構築する。
            </p>
            <div class="retrieval-card__practice">
              <label class="text-muted" for="retrieval-response-2">
                思い出したキーワード
              </label>
              <textarea
                id="retrieval-response-2"
                data-retrieval-response
                placeholder="例：知識共有ポイント／評価指標 など"
              ></textarea>
              <button
                type="button"
                class="ui-button ui-button--subtle"
                data-retrieval-check
              >
                重なりを確認
              </button>
              <div class="retrieval-feedback" data-retrieval-feedback hidden>
                <div class="retrieval-feedback__chips" data-retrieval-overlap></div>
                <p class="retrieval-feedback__summary" data-retrieval-summary></p>
              </div>
            </div>
          </article>
          <article
            class="retrieval-card"
            data-retrieval-card
            data-index="3"
            data-category="生産連携"
            data-expected-keywords="段取り替え,シミュレーション,タクトタイム,治具準備"
            hidden
          >
            <span class="retrieval-card__tag">生産連携</span>
            <h4 class="heading-md">段取りシミュレーション</h4>
            <p>
              設計段階で段取り替えシミュレーションを実施し、タクトタイムを
              共有。結果をもとに製造部門が前倒しで治具準備を行う。
            </p>
            <div class="retrieval-card__practice">
              <label class="text-muted" for="retrieval-response-3">
                思い出したキーワード
              </label>
              <textarea
                id="retrieval-response-3"
                data-retrieval-response
                placeholder="例：段取り替え／タクト共有／治具準備"
              ></textarea>
              <button
                type="button"
                class="ui-button ui-button--subtle"
                data-retrieval-check
              >
                重なりを確認
              </button>
              <div class="retrieval-feedback" data-retrieval-feedback hidden>
                <div class="retrieval-feedback__chips" data-retrieval-overlap></div>
                <p class="retrieval-feedback__summary" data-retrieval-summary></p>
              </div>
            </div>
          </article>
          <article
            class="retrieval-card"
            data-retrieval-card
            data-index="4"
            data-category="組織開発"
            data-expected-keywords="アンバサダー,横断,改善アイデア,社内共有,行動指標"
            hidden
          >
            <span class="retrieval-card__tag">組織開発</span>
            <h4 class="heading-md">DXアンバサダー制度</h4>
            <p>
              若手をDXアンバサダーに任命し、部門横断で改善アイデアを月次報
              告。成功事例は社内ラジオで共有し、行動指標に紐づける。
            </p>
            <div class="retrieval-card__practice">
              <label class="text-muted" for="retrieval-response-4">
                思い出したキーワード
              </label>
              <textarea
                id="retrieval-response-4"
                data-retrieval-response
                placeholder="例：DXアンバサダー／横断共有"
              ></textarea>
              <button
                type="button"
                class="ui-button ui-button--subtle"
                data-retrieval-check
              >
                重なりを確認
              </button>
              <div class="retrieval-feedback" data-retrieval-feedback hidden>
                <div class="retrieval-feedback__chips" data-retrieval-overlap></div>
                <p class="retrieval-feedback__summary" data-retrieval-summary></p>
              </div>
            </div>
          </article>
        </div>
        <footer class="retrieval-modal__controls">
          <button
            type="button"
            class="ui-button"
            data-retrieval-prev
            aria-label="前のカードへ"
          >
            前へ
          </button>
          <div class="retrieval-progress">
            <span aria-live="polite" data-retrieval-count>1 / 5</span>
            <div class="retrieval-progress__bar">
              <span data-retrieval-progress></span>
            </div>
          </div>
          <button
            type="button"
            class="ui-button ui-button--primary"
            data-retrieval-next
            aria-label="次のカードへ"
          >
            次へ
          </button>
        </footer>
      </div>
    </div>

    <div
      class="shortcut-panel"
      role="dialog"
      aria-modal="true"
      aria-labelledby="shortcut-panel-heading"
      hidden
      data-shortcut-panel
    >
      <div class="shortcut-panel__dialog">
        <div class="shortcut-panel__header">
          <h3 id="shortcut-panel-heading" class="heading-md">ショートカット一覧</h3>
          <button
            type="button"
            class="shortcut-panel__close"
            aria-label="ショートカット一覧を閉じる"
            data-shortcut-close
          >
            ✕
          </button>
        </div>
        <p class="text-muted">
          キーボード操作でマーカーや支援ツールを呼び出せます。アクセシビ
          リティ向上のため、全ての操作はフォーカス移動と組み合わせて利用
          できます。
        </p>
        <div class="shortcut-panel__list">
          <div class="shortcut-panel__item">
            <span>選択テキストにハイライト</span>
            <span class="shortcut-panel__keys">
              <span>Alt</span><span>Shift</span><span>H</span>
            </span>
          </div>
          <div class="shortcut-panel__item">
            <span>ハイライト色を切り替え</span>
            <span class="shortcut-panel__keys">
              <span>Alt</span><span>Shift</span><span>1〜4</span>
            </span>
          </div>
          <div class="shortcut-panel__item">
            <span>次の設問に移動</span>
            <span class="shortcut-panel__keys">
              <span>Alt</span><span>Shift</span><span>N</span>
            </span>
          </div>
          <div class="shortcut-panel__item">
            <span>前の設問に移動</span>
            <span class="shortcut-panel__keys">
              <span>Alt</span><span>Shift</span><span>P</span>
            </span>
          </div>
          <div class="shortcut-panel__item">
            <span>回答欄へフォーカス</span>
            <span class="shortcut-panel__keys">
              <span>Alt</span><span>Shift</span><span>A</span>
            </span>
          </div>
          <div class="shortcut-panel__item">
            <span>直前のハイライトを元に戻す</span>
            <span class="shortcut-panel__keys">
              <span>Alt</span><span>Shift</span><span>Z</span>
            </span>
          </div>
          <div class="shortcut-panel__item">
            <span>ハイライトを解除</span>
            <span class="shortcut-panel__keys">
              <span>Alt</span><span>Shift</span><span>R</span>
            </span>
          </div>
          <div class="shortcut-panel__item">
            <span>リトリーバルカードを開く</span>
            <span class="shortcut-panel__keys">
              <span>Alt</span><span>Shift</span><span>O</span>
            </span>
          </div>
          <div class="shortcut-panel__item">
            <span>ショートカット一覧を開く</span>
            <span class="shortcut-panel__keys">
              <span>Alt</span><span>Shift</span><span>K</span>
            </span>
          </div>
        </div>
      </div>
    </div>

    <div
      class="onboarding-modal"
      role="dialog"
      aria-modal="true"
      aria-labelledby="onboarding-heading"
      hidden
      data-onboarding-modal
    >
      <div class="onboarding-modal__dialog">
        <button
          type="button"
          class="onboarding-modal__close"
          aria-label="チュートリアルを閉じる"
          data-onboarding-close
        >
          ✕
        </button>
        <h2 id="onboarding-heading" class="heading-lg">
          最初の一歩ガイド
        </h2>
        <p class="text-muted">
          年度と事例の選び方から、ハイライト・リトリーバル・プラクティス
          までを3分で把握しましょう。
        </p>
        <ol class="onboarding-steps">
          <li class="onboarding-step">
            <strong>1. 年度と事例を合わせる</strong>
            <span>
              ヘッダーのセレクタで解きたい<strong>年度・事例</strong>を選択すると、
              与件とカードが自動で切り替わります。迷ったら「学習テーマ」
              から候補を提案します。
            </span>
          </li>
          <li class="onboarding-step">
            <strong>2. ハイライトで構造化</strong>
            <span>
              4色のマーカーに<strong>意味とタグ</strong>をつけて整理しましょう。選択
              後はAlt+Shift+Hで塗り、UndoボタンまたはAlt+Shift+Zで戻せます。
            </span>
          </li>
          <li class="onboarding-step">
            <strong>3. メモから問いを作る</strong>
            <span>
              ハイライトをクリックするとメモ欄が開きます。「この部分から問
              いを作成」を押して、リトリーバル練習に送れます。
            </span>
          </li>
          <li class="onboarding-step">
            <strong>4. リトリーバルで重なりを確認</strong>
            <span>
              キーワードを入力して<strong>重なりを可視化</strong>し、次に意識する観点
              をフィードバックから確認しましょう。順序はモーダル内で切替え
              できます。
            </span>
          </li>
        </ol>
        <div class="onboarding-actions">
          <button
            type="button"
            class="ui-button"
            data-onboarding-close
            data-onboarding-skip
          >
            今は閉じる
          </button>
          <button
            type="button"
            class="ui-button ui-button--primary"
            data-onboarding-complete
          >
            使い方を理解しました
          </button>
        </div>
      </div>
    </div>

    <div
      class="ui-toast"
      role="status"
      aria-live="polite"
      data-toast
      data-toast-visible="false"
    ></div>

    <script>
      (() => {
        const exerciseLibrary = [
          {
            id: 'r06-case1',
            caseId: 'case1',
            caseLabel: '事例I',
            year: '令和6年',
            scenarioTitle: 'B製造業 与件文',
            scenarioSummary: '事例I 令和6年',
            scenarioMeta: {
              industry: '精密機器製造',
              employees: '220名',
              sales: '58億円',
              keywords: '技能伝承 / 開発連携',
            },
            scenarioBody: [
              'A社は創業40年の精密機器メーカーである。創業者の引退を契機に、2代目社長は設計部門のDX化と熟練技術者の技能伝承を最優先テーマと定めた。設計BOMと生産BOMが分断されており、製品立ち上げ時の手戻りが多発している。また、顧客ニーズの高度化に伴い、多品種小ロットかつ短納期での開発対応が求められている。',
              '現状、設計段階での顧客折衝は営業部門が単独で担っており、設計の観点が十分に反映されていない。生産部門ではベテラン技能者の高齢化が進み、暗黙知の形式知化が急務となっている。社長は部門横断での情報共有と意思決定スピードの改善を目指し、試験的にデジタル・コラボレーション基盤を導入した。',
              '今後は、設計段階からの顧客共創、外部パートナーとの連携強化、それに伴う評価制度の再設計が検討課題である。',
            ],
            timeLimitMinutes: 45,
            questions: [
              {
                key: 'q1',
                label: 'Q1',
                tabTitle: '経営課題の整理',
                title: '経営課題の整理',
                prompt:
                  'A社が直面している主要な経営課題を、設計・生産・人材の観点から整理し、優先度の高い順に二点述べよ。',
                score: '配点 20点',
                limit: '120字以内',
                maxLength: 120,
                recommendedRank: 1,
                recentRank: 3,
                status: 'unanswered',
                flags: ['review', 'explanation'],
                keywords: ['経営', 'BOM', '技能伝承'],
                examples: [
                  '設計と生産のBOM分断が手戻りを誘発',
                  '熟練技能の暗黙知が形式知化できていない',
                  '顧客ニーズの高度化に開発体制が追随できない',
                ],
                support:
                  '設計部門のDX化、BOM連携、技能伝承、人材評価の整合性など、与件文から直接引用できる語を起点に因果で整理する。',
              },
              {
                key: 'q2',
                label: 'Q2',
                tabTitle: '顧客共創の提案',
                title: '顧客共創の提案',
                prompt:
                  'A社が顧客との共同開発を推進するための施策を、営業・設計・生産の連携の仕組みとして提案せよ。',
                score: '配点 30点',
                limit: '160字以内',
                maxLength: 160,
                recommendedRank: 2,
                recentRank: 1,
                status: 'answered',
                flags: ['explanation'],
                keywords: ['共創', 'レビュー', 'BOM共有'],
                examples: [
                  '営業・設計・生産で顧客課題を共通理解',
                  '共創レビューで要求を段階的に合意形成',
                  'クラウドBOMで設計変更を即時共有',
                ],
                support:
                  '顧客接点の情報共有タイミング、設計部門の早期参画、試作段階でのフィードバックループを盛り込む。',
              },
              {
                key: 'q3',
                label: 'Q3',
                tabTitle: '技能伝承の仕組み',
                title: '技能伝承の仕組み',
                prompt:
                  '熟練技能の形式知化と継承を加速するための施策を、教育体系とデジタル活用の両面から述べよ。',
                score: '配点 25点',
                limit: '160字以内',
                maxLength: 160,
                recommendedRank: 3,
                recentRank: 4,
                status: 'unanswered',
                flags: ['review'],
                keywords: ['動画', 'メンター', 'チェックリスト'],
                examples: [
                  '作業動画と要点字幕で匠のコツを可視化',
                  '段階別チェックリストで習熟度を測定',
                  'メンター面談で学習計画をリフレクション',
                ],
                support:
                  '指導員制度、ペアワーク、動画記録、工程別のナレッジカードなど複数手段を組み合わせ、習熟度指標を定義する。',
              },
              {
                key: 'q4',
                label: 'Q4',
                tabTitle: '評価制度の再設計',
                title: '評価制度の再設計',
                prompt:
                  'DX推進と技能伝承を両立させる評価制度・報酬制度の改善策を、期待する行動指標を含めて述べよ。',
                score: '配点 25点',
                limit: '200字以内',
                maxLength: 200,
                recommendedRank: 4,
                recentRank: 2,
                status: 'unanswered',
                flags: ['explanation'],
                keywords: ['評価指標', 'DX推進', '後進育成'],
                examples: [
                  '知識共有と後進育成を評価指標に反映',
                  'DX活用件数を成果評価に連動',
                  '行動指標で共創行動とナレッジ共有を促す',
                ],
                support:
                  'DXで創出した知見の共有や後進育成を評価指標に組み込み、成果とプロセスを両面評価する基準づくりを意識する。',
              },
            ],
            retrieval: [
              {
                key: 'r1',
                category: '顧客共創',
                title: '共創設計レビュー',
                body: '開発初期から設計と営業が参加する共創レビューを設定し、顧客の真因をBOMに反映。議事録をクラウド共有してトレーサビリティを確保する。',
                expectedKeywords:
                  '共創,議事録,トレーサビリティ,設計,営業',
              },
              {
                key: 'r2',
                category: '技能伝承',
                title: '動画×メンター制度',
                body: '熟練者の作業を動画で記録し、技能のツボを字幕で補足。週次でメンターが振り返り面談を実施し、チェックリストで習熟度を可視化。',
                expectedKeywords:
                  '動画,字幕,メンター,振り返り,チェックリスト',
              },
            ],
          },
          {
            id: 'r05-case2',
            caseId: 'case2',
            caseLabel: '事例II',
            year: '令和5年',
            scenarioTitle: 'D商店 与件文',
            scenarioSummary: '事例II 令和5年',
            scenarioMeta: {
              industry: '専門小売業',
              employees: '85名',
              sales: '14億円',
              keywords: 'OMO戦略 / 顧客ロイヤルティ',
            },
            scenarioBody: [
              'D商店は地方都市で専門食材の小売と業務用卸を行う老舗である。直営店舗は観光地に位置し、近年はECサイト経由での注文が伸びているが、常連客の来店頻度は減少している。',
              '店舗スタッフは料理教室やライブ配信を通じて顧客との接点を保とうとしているが、イベント情報と在庫データが分断され、プロモーションが一貫しない。ポイントカードは紙ベースで、購買履歴を分析できていない。',
              '社長はOMOを前提とした会員制度の再構築と、スタッフの提案力を高める教育プログラムの整備を検討している。',
            ],
            timeLimitMinutes: 40,
            questions: [
              {
                key: 'q1',
                label: 'Q1',
                tabTitle: '顧客セグメントの整理',
                title: '顧客セグメントの整理',
                prompt:
                  'D商店の主要顧客を来店・EC・業務用の観点で再整理し、それぞれの提供価値強化策を示せ。',
                score: '配点 20点',
                limit: '120字以内',
                maxLength: 120,
                recommendedRank: 1,
                recentRank: 1,
                status: 'answered',
                flags: ['explanation'],
                keywords: ['セグメント', '価値提案', 'OMO'],
                examples: [
                  '旅行者向けに体験型イベントを常設',
                  '業務用顧客へ定期便と仕入れ相談窓口を提供',
                  'EC会員にライブ配信と限定クーポンを提供',
                ],
                support:
                  'セグメントごとに購買動機と接点を整理し、オンラインとオフラインをつなぐ導線を明確化する。',
              },
              {
                key: 'q2',
                label: 'Q2',
                tabTitle: 'OMO会員制度',
                title: 'OMO会員制度の設計',
                prompt:
                  'ポイントカードを起点にOMO型の会員制度を再設計し、来店頻度とEC売上の双方を高める施策を提案せよ。',
                score: '配点 30点',
                limit: '180字以内',
                maxLength: 180,
                recommendedRank: 2,
                recentRank: 3,
                status: 'unanswered',
                flags: ['review', 'explanation'],
                keywords: ['会員制度', 'CRM', 'ポイント'],
                examples: [
                  'アプリでポイント・クーポンを一元管理',
                  '購買履歴からおすすめレシピとセット提案',
                  'イベント参加で来店ポイントを即時付与',
                ],
                support:
                  'ID-POSの分析基盤とアプリ通知を連動させ、オンライン体験が店舗購買につながる循環を設計する。',
              },
              {
                key: 'q3',
                label: 'Q3',
                tabTitle: 'スタッフ育成',
                title: 'スタッフ育成プログラム',
                prompt:
                  '提案力を高めるために、スタッフ教育と評価の仕組みをどのように構築すべきか。OJTと集合研修の役割を整理せよ。',
                score: '配点 25点',
                limit: '160字以内',
                maxLength: 160,
                recommendedRank: 3,
                recentRank: 4,
                status: 'unanswered',
                flags: ['review'],
                keywords: ['研修', 'OJT', '評価'],
                examples: [
                  'ライブ配信の台本づくりをロールプレイで訓練',
                  'OJTで提案ヒアリングの型をチェックリスト化',
                  '提案件数と顧客満足をKPIにコーチング面談',
                ],
                support:
                  'OJT・集合研修・評価の三位一体で学習サイクルを回し、顧客提案の振り返り指標を設定する。',
              },
              {
                key: 'q4',
                label: 'Q4',
                tabTitle: '地域連携と成長戦略',
                title: '地域連携と成長戦略',
                prompt:
                  'D商店が地域資源と連携して新規顧客を獲得するための施策を、オンライン発信と店舗体験の連動で提案せよ。',
                score: '配点 25点',
                limit: '200字以内',
                maxLength: 200,
                recommendedRank: 4,
                recentRank: 2,
                status: 'unanswered',
                flags: ['explanation'],
                keywords: ['地域連携', '体験型', '新規顧客'],
                examples: [
                  '地元飲食店とコラボした季節フェアを配信',
                  '観光客向けテイスティングツアーを予約制で実施',
                  '産地レポートをSNSと店頭POPで同時展開',
                ],
                support:
                  '地域のストーリーをコンテンツ化し、オンライン告知から店舗での体験まで一気通貫の導線を作る。',
              },
            ],
            retrieval: [
              {
                key: 'r1',
                category: 'マーケティング',
                title: 'OMO会員のLTV強化',
                body: 'ECと店舗の購買履歴を統合し、来店回数に応じてライブ配信の招待や限定商品の先行販売を提供する。',
                expectedKeywords:
                  'OMO,ポイント,ライブ配信,限定,来店',
              },
              {
                key: 'r2',
                category: '人材育成',
                title: '提案型スタッフ育成',
                body: '研修でヒアリング→提案→振り返りのスクリプトを習得し、日報アプリで学習ログを共有する。',
                expectedKeywords:
                  'ヒアリング,提案,振り返り,スクリプト,学習ログ',
              },
              {
                key: 'r3',
                category: '地域連携',
                title: '産地コラボ企画',
                body: '地元生産者とのコラボセットを月替わりで販売し、レシピ動画とセット連動クーポンを配布する。',
                expectedKeywords:
                  '地域,コラボ,セット,レシピ動画,クーポン',
              },
            ],
          },
        ];

        const exerciseById = new Map(
          exerciseLibrary.map((exercise) => [exercise.id, exercise])
        );
        const exercisesByCase = exerciseLibrary.reduce((map, exercise) => {
          if (!map.has(exercise.caseId)) {
            map.set(exercise.caseId, []);
          }
          map.get(exercise.caseId).push(exercise);
          return map;
        }, new Map());
        const caseOptions = Array.from(
          exercisesByCase.entries(),
          ([caseId, exercises]) => ({
            caseId,
            label: exercises[0]?.caseLabel || caseId,
            exercises: exercises
              .slice()
              .sort((a, b) => a.year.localeCompare(b.year)),
          })
        );

        const initializeExerciseApp = (appRoot) => {
          if (!appRoot) {
            return;
          }

          const previousController = appRoot.__exerciseCleanupController;
          if (previousController) {
            previousController.abort();
          }

          const cleanupController = new AbortController();
          const { signal } = cleanupController;
          appRoot.__exerciseCleanupController = cleanupController;

          signal.addEventListener(
            'abort',
            () => {
              if (appRoot.__exerciseCleanupController === cleanupController) {
                delete appRoot.__exerciseCleanupController;
              }
            },
            { once: true }
          );

          const escapeSelector = (value) =>
            typeof value === 'string'
              ? value.replace(/([!"#$%&'()*+,./:;<=>?@[\\\]^`{|}~])/g, '\\$1')
              : '';

          const headerAnchors = Array.from(
            appRoot.querySelectorAll('.app-header__anchor')
          );
          const anchorEntries = headerAnchors
            .map((button) => {
              const targetId = button.dataset.target;
              if (!targetId) return null;
              const target = appRoot.querySelector(
                `#${escapeSelector(targetId)}`
              );
              return target ? { button, target, targetId } : null;
            })
            .filter(Boolean);

          const selectionCaseLabel = appRoot.querySelector(
            '[data-selection-case]'
          );
          const selectionYearLabel = appRoot.querySelector(
            '[data-selection-year]'
          );
          const selectionQuestionLabel = appRoot.querySelector(
            '[data-selection-question]'
          );
          const caseSelect = appRoot.querySelector('[data-case-select]');
          const yearSelect = appRoot.querySelector('[data-year-select]');
          const questionIndexList = appRoot.querySelector('[data-question-index]');
          const quickNavList = appRoot.querySelector('[data-question-quicknav]');
          const progressQuestionsSummary = appRoot.querySelector(
            '[data-progress-questions-summary]'
          );
          const progressQuestionsBar = appRoot.querySelector(
            '[data-progress-questions-bar]'
          );
          const progressRetrievalCard = appRoot.querySelector(
            '[data-progress-retrieval-card]'
          );
          const progressRetrievalSummary = appRoot.querySelector(
            '[data-progress-retrieval-summary]'
          );
          const progressRetrievalBar = appRoot.querySelector(
            '[data-progress-retrieval-bar]'
          );
          const progressTimerLabel = appRoot.querySelector(
            '[data-progress-timer-label]'
          );
          const progressTimerBar = appRoot.querySelector(
            '[data-progress-timer-bar]'
          );
          const inlineTimerLabels = Array.from(
            appRoot.querySelectorAll('[data-inline-timer-label]')
          );
          const questionMemoInputs = Array.from(
            appRoot.querySelectorAll('[data-question-memo]')
          );
          const questionMemoAttachButtons = Array.from(
            appRoot.querySelectorAll('[data-question-memo-attach]')
          );
          const problemSearchSuggestionList = appRoot.querySelector(
            '[data-problem-search-suggestions]'
          );

          const toastElement = appRoot.querySelector('[data-toast]');
          let toastTimerId = null;

          const showToast = (message) => {
            if (!toastElement || typeof message !== 'string') {
              return;
            }
            toastElement.textContent = message;
            toastElement.dataset.toastVisible = 'true';
            if (toastTimerId) {
              window.clearTimeout(toastTimerId);
            }
            toastTimerId = window.setTimeout(() => {
              toastElement.dataset.toastVisible = 'false';
              toastElement.textContent = '';
            }, 2600);
          };

          signal.addEventListener('abort', () => {
            if (toastTimerId) {
              window.clearTimeout(toastTimerId);
              toastTimerId = null;
            }
            if (toastElement) {
              toastElement.dataset.toastVisible = 'false';
              toastElement.textContent = '';
            }
          });

          const onboardingModal = appRoot.querySelector('[data-onboarding-modal]');
          const onboardingOpeners = Array.from(
            appRoot.querySelectorAll('[data-onboarding-open]')
          );
          const onboardingCloseButtons = Array.from(
            onboardingModal?.querySelectorAll('[data-onboarding-close]') || []
          );
          const onboardingCompleteButton = onboardingModal?.querySelector(
            '[data-onboarding-complete]'
          );
          const onboardingStorageKey = 'exercise-onboarding-seen-v1';
          let onboardingPreviousFocus = null;

          const markOnboardingSeen = () => {
            try {
              window.localStorage.setItem(onboardingStorageKey, 'seen');
            } catch (error) {
              // ignore storage errors (private mode等)
            }
          };

          const hasSeenOnboarding = () => {
            try {
              return window.localStorage.getItem(onboardingStorageKey) === 'seen';
            } catch (error) {
              return false;
            }
          };

          const openOnboarding = () => {
            if (!onboardingModal || !onboardingModal.hidden) {
              return false;
            }
            onboardingPreviousFocus =
              document.activeElement instanceof HTMLElement
                ? document.activeElement
                : null;
            onboardingModal.hidden = false;
            const focusTarget =
              onboardingCompleteButton ||
              onboardingModal.querySelector('[data-onboarding-close]') ||
              onboardingModal;
            focusTarget?.focus?.();
            return true;
          };

          const closeOnboarding = (persist = false) => {
            if (!onboardingModal || onboardingModal.hidden) {
              return false;
            }
            onboardingModal.hidden = true;
            if (persist) {
              markOnboardingSeen();
            }
            if (onboardingPreviousFocus?.focus) {
              onboardingPreviousFocus.focus();
            }
            return true;
          };

          onboardingOpeners.forEach((button) => {
            button.addEventListener(
              'click',
              () => {
                openOnboarding();
              },
              { signal }
            );
          });

          onboardingCloseButtons.forEach((button) => {
            button.addEventListener(
              'click',
              () => {
                closeOnboarding(true);
              },
              { signal }
            );
          });

          if (onboardingCompleteButton) {
            onboardingCompleteButton.addEventListener(
              'click',
              () => {
                closeOnboarding(true);
                showToast('使い方ガイドはヘッダーから再表示できます');
              },
              { signal }
            );
          }

          if (onboardingModal) {
            onboardingModal.addEventListener(
              'click',
              (event) => {
                if (event.target === onboardingModal) {
                  closeOnboarding(true);
                }
              },
              { signal }
            );
            onboardingModal.addEventListener(
              'keydown',
              (event) => {
                if (event.key === 'Escape' && !onboardingModal.hidden) {
                  closeOnboarding(true);
                }
              },
              { signal }
            );
          }

          if (!hasSeenOnboarding()) {
            openOnboarding();
            markOnboardingSeen();
          }

          const panelButtons = Array.from(
            appRoot.querySelectorAll('[data-panel-trigger]')
          );
          const getPanelSections = (panelId) =>
            Array.from(
              appRoot.querySelectorAll(
                `[data-panel-section="${panelId}"]`
              )
            );
          const panelSections = {
            overview: getPanelSections('overview'),
            scenario: getPanelSections('scenario'),
            answer: getPanelSections('answer'),
          };

          const collapsibleContainers = Array.from(
            appRoot.querySelectorAll('[data-collapsible]')
          );

          const resolveCollapsibleBody = (toggle, container) => {
            const controls = toggle?.getAttribute('aria-controls');
            if (controls) {
              return appRoot.querySelector(`#${escapeSelector(controls)}`);
            }
            return container?.querySelector('[data-collapsible-body]') || null;
          };

          collapsibleContainers.forEach((container) => {
            const toggle = container.querySelector('[data-collapsible-toggle]');
            if (!toggle) {
              return;
            }
            const body = resolveCollapsibleBody(toggle, container);
            if (!body) {
              return;
            }
            const labelElement = toggle.querySelector('[data-collapsible-label]');
            const collapsedLabel =
              toggle.dataset.labelCollapsed?.trim() || '詳細を表示';
            const expandedLabel =
              toggle.dataset.labelExpanded?.trim() || '閉じる';

            const applyState = (expanded) => {
              const isExpanded = Boolean(expanded);
              toggle.setAttribute('aria-expanded', String(isExpanded));
              container.dataset.collapsibleOpen = String(isExpanded);
              body.hidden = !isExpanded;
              if (labelElement) {
                labelElement.textContent = isExpanded
                  ? expandedLabel
                  : collapsedLabel;
              }
            };

            const initialExpanded =
              toggle.getAttribute('aria-expanded') === 'true' ||
              container.dataset.collapsibleOpen === 'true';
            applyState(initialExpanded);

            toggle.addEventListener(
              'click',
              () => {
                const nextState = toggle.getAttribute('aria-expanded') !== 'true';
                applyState(nextState);
              },
              { signal }
            );
          });

          const accordionContainers = Array.from(
            appRoot.querySelectorAll('[data-accordion]')
          );
          let accordionIdCounter = 0;
          accordionContainers.forEach((container) => {
            const toggle = container.querySelector('[data-accordion-toggle]');
            const body = container.querySelector('[data-accordion-body]');
            if (!toggle || !body) {
              return;
            }
            if (!body.id) {
              accordionIdCounter += 1;
              body.id = `accordion-section-${accordionIdCounter}`;
            }
            toggle.setAttribute('aria-controls', body.id);
            const expandedAttr = toggle.getAttribute('aria-expanded');
            const defaultOpen = container.dataset.accordionDefaultOpen !== 'false';
            const initialExpanded =
              expandedAttr === 'true' ||
              (expandedAttr !== 'false' && defaultOpen);
            const applyAccordionState = (expanded) => {
              const isExpanded = Boolean(expanded);
              toggle.setAttribute('aria-expanded', String(isExpanded));
              body.hidden = !isExpanded;
              container.dataset.accordionOpen = String(isExpanded);
              const label = toggle.querySelector('[data-accordion-toggle-text]');
              const expandedLabel =
                toggle.dataset.accordionLabelExpanded?.trim() || '折りたたむ';
              const collapsedLabel =
                toggle.dataset.accordionLabelCollapsed?.trim() || '展開する';
              if (label) {
                label.textContent = isExpanded ? expandedLabel : collapsedLabel;
              }
            };
            applyAccordionState(initialExpanded);
            toggle.addEventListener(
              'click',
              () => {
                const nextState = toggle.getAttribute('aria-expanded') !== 'true';
                applyAccordionState(nextState);
              },
              { signal }
            );
          });

          const panelBySection = new Map([
            ['section-overview', 'overview'],
            ['section-scenario', 'scenario'],
            ['section-retrieval', 'answer'],
            ['section-answer', 'answer'],
          ]);

          const hasPanel = (panelId) =>
            Boolean(
              panelId &&
                panelSections[panelId] &&
                panelSections[panelId].length
            );

          let activePanelId =
            (appRoot.dataset.sectionActive && hasPanel(appRoot.dataset.sectionActive)
              ? appRoot.dataset.sectionActive
              : null) || 'answer';
          let activeQuestionId = null;

          panelButtons.forEach((button) => {
            button.setAttribute('aria-selected', 'false');
            button.setAttribute('tabindex', '-1');
          });

          Object.values(panelSections).forEach((sections) =>
            sections.forEach((section) => {
              section.dataset.panelCollapsed = 'true';
            })
          );

          const setPanelState = (panelId, options = {}) => {
            const resolvedId = hasPanel(panelId) ? panelId : 'answer';
            activePanelId = resolvedId;
            Object.entries(panelSections).forEach(([id, sections]) => {
              const isActive = id === resolvedId;
              sections.forEach((section) => {
                section.dataset.panelCollapsed = String(!isActive);
              });
            });
            panelButtons.forEach((button) => {
              const isActive = button.dataset.panelTrigger === resolvedId;
              button.setAttribute('aria-selected', String(isActive));
              button.setAttribute('tabindex', isActive ? '0' : '-1');
            });
            appRoot.dataset.sectionActive = resolvedId;
            if (options.scrollIntoView) {
              const firstSection = panelSections[resolvedId]?.[0];
              firstSection?.scrollIntoView({
                behavior: 'smooth',
                block: 'start',
              });
            }
          };

          const ensurePanelOpen = (panelId) => {
            if (panelId) {
              setPanelState(panelId);
            }
          };

          panelButtons.forEach((button, index) => {
            button.addEventListener(
              'click',
              () => {
                const panelId = button.dataset.panelTrigger;
                if (!panelId) return;
                setPanelState(panelId, { scrollIntoView: true });
              },
              { signal }
            );

            button.addEventListener(
              'keydown',
              (event) => {
                const { key } = event;
                const total = panelButtons.length;
                if (!total) {
                  return;
                }
                let nextIndex = null;
                if (key === 'ArrowRight' || key === 'ArrowDown') {
                  nextIndex = (index + 1) % total;
                } else if (key === 'ArrowLeft' || key === 'ArrowUp') {
                  nextIndex = (index - 1 + total) % total;
                } else if (key === 'Home') {
                  nextIndex = 0;
                } else if (key === 'End') {
                  nextIndex = total - 1;
                }
                if (nextIndex === null) {
                  return;
                }
                event.preventDefault();
                const nextButton = panelButtons[nextIndex];
                nextButton?.focus();
                const panelId = nextButton?.dataset.panelTrigger;
                if (panelId) {
                  setPanelState(panelId, { scrollIntoView: true });
                }
              },
              { signal }
            );
          });

          setPanelState(activePanelId);

          const setActiveAnchor = (targetId) => {
            headerAnchors.forEach((button) => {
              const isActive = button.dataset.target === targetId;
              button.dataset.active = String(isActive);
            });
          };

          const scrollToSection = (targetId) => {
            const entry = anchorEntries.find(
              (item) => item.targetId === targetId
            );
            if (!entry) return;
            const panelId = panelBySection.get(targetId);
            if (panelId) {
              ensurePanelOpen(panelId);
            }
            entry.target.scrollIntoView({ behavior: 'smooth', block: 'start' });
            setActiveAnchor(targetId);
          };

          headerAnchors.forEach((button) => {
            button.dataset.active = 'false';
            button.addEventListener(
              'click',
              () => {
                if (button.dataset.target) {
                  scrollToSection(button.dataset.target);
                }
              },
              { signal }
            );
          });

          if (anchorEntries.length) {
            setActiveAnchor(anchorEntries[0].targetId);
          }

          if (anchorEntries.length && 'IntersectionObserver' in window) {
            const anchorObserver = new IntersectionObserver(
              (entries) => {
                const visibleEntry = entries
                  .filter((entry) => entry.isIntersecting)
                  .sort((a, b) => b.intersectionRatio - a.intersectionRatio)[0];
                if (!visibleEntry) {
                  return;
                }
                const id = visibleEntry.target.getAttribute('id');
                if (id) {
                  setActiveAnchor(id);
                }
              },
              {
                rootMargin: '-45% 0px -45% 0px',
                threshold: 0.2,
              }
            );

            anchorEntries.forEach((entry) => anchorObserver.observe(entry.target));
            signal.addEventListener(
              'abort',
              () => anchorObserver.disconnect(),
              { once: true }
            );
          }

          const strategyCards = Array.from(
            appRoot.querySelectorAll('.strategy-card')
          );
          const strategyDetail = appRoot.querySelector('[data-strategy-detail]');
          const strategyLiveRegion = appRoot.querySelector('[data-strategy-live]');
          const strategyMessages = {
            expression:
              '導入→結論の2センテンス構成で、課題と対応策を30字ずつ書き出すと要点がぶれません。',
            structure:
              '因果→施策→効果の順で骨子を並べ、接続語を揃えると読みやすさが向上します。',
            swot:
              '強み×機会の掛け合わせでアイデアを発想し、リスクは弱み×脅威として整理しましょう。',
            knowledge:
              '一次知識の定石を再確認し、設問のキーワードと紐づく要素をチェックリスト化します。',
          };

          const showStrategyDetail = (key) => {
            if (!strategyDetail) return;
            const message = key ? strategyMessages[key] : '';
            if (message) {
              strategyDetail.textContent = message;
              strategyDetail.hidden = false;
              if (strategyLiveRegion) {
                strategyLiveRegion.textContent = `${message} を参照できます。`;
              }
            } else {
              strategyDetail.hidden = true;
              if (strategyLiveRegion) {
                strategyLiveRegion.textContent = '';
              }
            }
          };

          if (strategyCards.length) {
            strategyCards.forEach((card) => {
              card.setAttribute('aria-pressed', 'false');
              card.addEventListener(
                'click',
                () => {
                  strategyCards.forEach((other) =>
                    other.setAttribute('aria-pressed', 'false')
                  );
                  card.setAttribute('aria-pressed', 'true');
                  showStrategyDetail(card.dataset.strategy);
                },
                { signal }
              );
            });
          }

          const infoButtons = Array.from(
            appRoot.querySelectorAll('.analysis-info__trigger')
          );
          infoButtons.forEach((button) => {
            const targetId = button.dataset.infoTarget;
            const infoPanel = targetId
              ? appRoot.querySelector(`#${escapeSelector(targetId)}`)
              : null;
            if (!infoPanel) {
              return;
            }
            button.addEventListener(
              'click',
              () => {
                const expanded = button.getAttribute('aria-expanded') === 'true';
                const nextState = !expanded;
                button.setAttribute('aria-expanded', String(nextState));
                infoPanel.hidden = !nextState;
                if (nextState) {
                  infoPanel.scrollIntoView({
                    behavior: 'smooth',
                    block: 'nearest',
                  });
                }
              },
              { signal }
            );
          });

          const retrievalModal = appRoot.querySelector('[data-retrieval-modal]');
          const retrievalOpeners = Array.from(
            appRoot.querySelectorAll('[data-retrieval-open]')
          );
          const retrievalModalBody =
            retrievalModal?.querySelector('.retrieval-modal__body') || null;
          const retrievalCount = retrievalModal?.querySelector(
            '[data-retrieval-count]'
          );
          const retrievalProgress = retrievalModal?.querySelector(
            '[data-retrieval-progress]'
          );
          const retrievalPrev = retrievalModal?.querySelector('[data-retrieval-prev]');
          const retrievalNext = retrievalModal?.querySelector('[data-retrieval-next]');
          const retrievalOrderSelect = retrievalModal?.querySelector(
            '[data-retrieval-order]'
          );
          const retrievalClosers = Array.from(
            retrievalModal?.querySelectorAll('[data-retrieval-close]') || []
          );
          let retrievalCards = [];
          let retrievalIndex = 0;
          let retrievalPreviousFocus = null;
          let retrievalOriginalOrderCounter = 0;
          let retrievalOrderMode = 'default';

          const parseKeywords = (value) =>
            typeof value === 'string'
              ? value
                  .split(/[\s、,，／\/]+/)
                  .map((keyword) => keyword.trim())
                  .filter(Boolean)
              : [];

          const buildFeedbackChip = (keyword, { match = false, extra = false }) => {
            const chip = document.createElement('span');
            chip.className = 'retrieval-feedback__chip';
            if (extra) {
              chip.dataset.extra = 'true';
            } else {
              chip.dataset.match = String(match);
            }
            chip.textContent = keyword;
            return chip;
          };

          const updateRetrievalProgress = () => {
            const total = retrievalCards.length;
            if (progressRetrievalCard) {
              progressRetrievalCard.hidden = total === 0;
            }
            if (!total) {
              if (progressRetrievalSummary) {
                progressRetrievalSummary.textContent = 'カードが登録されていません';
              }
              if (progressRetrievalBar) {
                progressRetrievalBar.style.width = '0%';
              }
              return;
            }
            const completed = Math.max(0, Math.min(retrievalIndex, total));
            const remaining = Math.max(total - completed - 1, 0);
            if (progressRetrievalSummary) {
              progressRetrievalSummary.textContent = `${completed}枚完了 / 残り${remaining}枚`;
            }
            if (progressRetrievalBar) {
              const ratio = total ? completed / total : 0;
              progressRetrievalBar.style.width = `${Math.min(
                100,
                Math.max(0, ratio * 100)
              )}%`;
            }
          };

          const updateRetrievalView = () => {
            if (!retrievalCards.length) {
              if (retrievalCount) {
                retrievalCount.textContent = '0 / 0';
              }
              if (retrievalProgress) {
                retrievalProgress.style.transform = 'scaleX(0)';
              }
              if (retrievalPrev) {
                retrievalPrev.disabled = true;
              }
              if (retrievalNext) {
                retrievalNext.disabled = true;
              }
              return;
            }
            retrievalIndex = Math.min(
              Math.max(retrievalIndex, 0),
              retrievalCards.length - 1
            );
            retrievalCards.forEach((card, index) => {
              card.hidden = index !== retrievalIndex;
            });
            const total = retrievalCards.length;
            if (retrievalCount) {
              retrievalCount.textContent = `${retrievalIndex + 1} / ${total}`;
            }
            if (retrievalProgress) {
              const progressRatio = (retrievalIndex + 1) / total;
              retrievalProgress.style.transform = `scaleX(${progressRatio})`;
            }
            if (retrievalPrev) {
              retrievalPrev.disabled = retrievalIndex === 0;
            }
            if (retrievalNext) {
              retrievalNext.disabled =
                retrievalIndex === Math.max(retrievalCards.length - 1, 0);
            }
            updateRetrievalProgress();
          };

          const updateRetrievalOrderOptions = () => {
            if (!retrievalOrderSelect) {
              return;
            }
            const previousValue = retrievalOrderSelect.value || 'default';
            retrievalOrderSelect.innerHTML = '';
            const makeOption = (value, label) => {
              const option = document.createElement('option');
              option.value = value;
              option.textContent = label;
              return option;
            };
            retrievalOrderSelect.appendChild(makeOption('default', '登録順'));
            const categories = Array.from(
              new Set(
                retrievalCards
                  .map((card) => card.dataset.category)
                  .filter(Boolean)
              )
            );
            categories.forEach((category) => {
              retrievalOrderSelect.appendChild(
                makeOption(`category:${category}`, `カテゴリ順：${category}`)
              );
            });
            if (retrievalCards.some((card) => card.dataset.highlightSource)) {
              retrievalOrderSelect.appendChild(
                makeOption('highlights', 'ハイライト作成カードを先に見る')
              );
            }
            const options = Array.from(retrievalOrderSelect.options || []);
            if (options.some((option) => option.value === previousValue)) {
              retrievalOrderSelect.value = previousValue;
            } else {
              retrievalOrderSelect.value = 'default';
            }
            retrievalOrderMode = retrievalOrderSelect.value;
          };

          const applyRetrievalOrder = (mode) => {
            if (!retrievalModalBody) {
              return;
            }
            retrievalOrderMode = mode;
            const activeCard = retrievalCards[retrievalIndex] || null;
            const cards = Array.from(retrievalCards);
            const byOriginalIndex = (a, b) =>
              Number(a.dataset.originalIndex || 0) -
              Number(b.dataset.originalIndex || 0);
            if (mode === 'default') {
              cards.sort(byOriginalIndex);
            } else if (mode.startsWith('category:')) {
              const [, category] = mode.split(':');
              cards.sort((a, b) => {
                const aMatch = a.dataset.category === category ? 0 : 1;
                const bMatch = b.dataset.category === category ? 0 : 1;
                if (aMatch !== bMatch) {
                  return aMatch - bMatch;
                }
                return byOriginalIndex(a, b);
              });
            } else if (mode === 'highlights') {
              cards.sort((a, b) => {
                const aHighlight = a.dataset.highlightSource ? 0 : 1;
                const bHighlight = b.dataset.highlightSource ? 0 : 1;
                if (aHighlight !== bHighlight) {
                  return aHighlight - bHighlight;
                }
                return byOriginalIndex(a, b);
              });
            }
            cards.forEach((card) => retrievalModalBody.appendChild(card));
            retrievalCards = cards;
            if (activeCard) {
              const newIndex = retrievalCards.indexOf(activeCard);
              retrievalIndex = newIndex === -1 ? 0 : newIndex;
            } else {
              retrievalIndex = Math.min(
                retrievalIndex,
                Math.max(retrievalCards.length - 1, 0)
              );
            }
            updateRetrievalView();
          };

          const refreshRetrievalCards = () => {
            if (!retrievalModalBody) {
              retrievalCards = [];
              updateRetrievalView();
              return;
            }
            retrievalCards = Array.from(
              retrievalModalBody.querySelectorAll('[data-retrieval-card]')
            );
            retrievalCards.forEach((card) => {
              if (!card.dataset.originalIndex) {
                card.dataset.originalIndex = String(retrievalOriginalOrderCounter++);
              }
            });
            updateRetrievalOrderOptions();
            applyRetrievalOrder(retrievalOrderMode);
          };

          const evaluateRetrievalCard = (card) => {
            if (!card) {
              return;
            }
            const textarea = card.querySelector('[data-retrieval-response]');
            const feedback = card.querySelector('[data-retrieval-feedback]');
            const chipsContainer = card.querySelector('[data-retrieval-overlap]');
            const summary = card.querySelector('[data-retrieval-summary]');
            if (!textarea || !feedback || !chipsContainer || !summary) {
              return;
            }
            const userKeywords = parseKeywords(textarea.value);
            const expectedKeywords = parseKeywords(card.dataset.expectedKeywords || '');
            const expectedSet = new Set(expectedKeywords);
            const matched = [];
            const missing = [];
            chipsContainer.innerHTML = '';
            expectedKeywords.forEach((keyword) => {
              const isMatch = userKeywords.includes(keyword);
              if (isMatch) {
                matched.push(keyword);
              } else {
                missing.push(keyword);
              }
              chipsContainer.appendChild(
                buildFeedbackChip(keyword, { match: isMatch })
              );
            });
            const extras = userKeywords.filter((keyword) => !expectedSet.has(keyword));
            extras.forEach((keyword) => {
              chipsContainer.appendChild(
                buildFeedbackChip(`追加: ${keyword}`, {
                  match: false,
                  extra: true,
                })
              );
            });
            const matchRate = expectedKeywords.length
              ? Math.round((matched.length / expectedKeywords.length) * 100)
              : userKeywords.length
              ? 100
              : 0;
            let message = '';
            if (!expectedKeywords.length) {
              message =
                '模範キーワードは未設定です。思い出した内容をメモとして保存しましょう。';
            } else if (!matched.length) {
              message =
                'まずは与件文の表現を短く言い換えてみましょう。最初のキーワードを掴むことが次のカードへの助走になります。';
            } else if (missing.length) {
              message = `重なりは${matchRate}%。次は「${missing[0]}」に注目して、関連する事例を思い出してみましょう。`;
            } else {
              message =
                'すべて想起できています。次のカードでは具体的な事例や成果指標を一つ追加してみましょう。';
            }
            if (extras.length) {
              message += ` 追加キーワードも良い視点です（${extras.join(' / ')}）。`;
            }
            summary.textContent = message;
            feedback.hidden = false;
          };

          const openRetrieval = () => {
            if (!retrievalModal || !retrievalModal.hidden) {
              return false;
            }
            retrievalPreviousFocus =
              document.activeElement instanceof HTMLElement
                ? document.activeElement
                : null;
            refreshRetrievalCards();
            retrievalModal.hidden = false;
            updateRetrievalView();
            const focusTarget =
              retrievalModal.querySelector('[data-retrieval-close]') ||
              retrievalModal;
            focusTarget?.focus?.();
            return true;
          };

          const closeRetrieval = () => {
            if (!retrievalModal || retrievalModal.hidden) {
              return false;
            }
            retrievalModal.hidden = true;
            if (retrievalPreviousFocus?.focus) {
              retrievalPreviousFocus.focus();
            }
            return true;
          };

          if (retrievalOpeners.length) {
            retrievalOpeners.forEach((button) => {
              button.addEventListener('click', openRetrieval, { signal });
            });
          }

          if (retrievalPrev) {
            retrievalPrev.addEventListener(
              'click',
              () => {
                retrievalIndex = Math.max(0, retrievalIndex - 1);
                updateRetrievalView();
              },
              { signal }
            );
          }

          if (retrievalNext) {
            retrievalNext.addEventListener(
              'click',
              () => {
                retrievalIndex = Math.min(
                  retrievalCards.length - 1,
                  retrievalIndex + 1
                );
                updateRetrievalView();
              },
              { signal }
            );
          }

          if (retrievalOrderSelect) {
            retrievalOrderSelect.addEventListener(
              'change',
              () => {
                applyRetrievalOrder(retrievalOrderSelect.value || 'default');
              },
              { signal }
            );
          }

          if (retrievalClosers.length) {
            retrievalClosers.forEach((closer) => {
              closer.addEventListener('click', closeRetrieval, { signal });
            });
          }

          if (retrievalModal) {
            retrievalModal.addEventListener(
              'click',
              (event) => {
                if (event.target === retrievalModal) {
                  closeRetrieval();
                }
              },
              { signal }
            );
          }

          if (retrievalModalBody) {
            retrievalModalBody.addEventListener(
              'click',
              (event) => {
                const button = event.target.closest('[data-retrieval-check]');
                if (!button) {
                  return;
                }
                event.preventDefault();
                const card = button.closest('[data-retrieval-card]');
                evaluateRetrievalCard(card);
                showToast('重なりを確認しました');
              },
              { signal }
            );
          }

          refreshRetrievalCards();

          let updateSelectionJumpVisibility = () => {};

          const unwrapMark = (mark) => {
            if (!mark || !mark.parentNode) return;
            const parent = mark.parentNode;
            while (mark.firstChild) {
              parent.insertBefore(mark.firstChild, mark);
            }
            parent.removeChild(mark);
          };

          const highlightLabelStorageKey = 'exercise-highlight-labels-v1';
          const defaultHighlightLabels = {
            strength: '強み',
            weakness: '弱み',
            challenge: '課題',
            opportunity: '機会',
          };
          const defaultHighlightMeanings = {
            strength: '活かす資源・優位性',
            weakness: 'ボトルネック・改善点',
            challenge: '解決すべき課題・リスク',
            opportunity: '活用できる外部資源・機会',
          };
          const highlightPaletteButtons = Array.from(
            appRoot.querySelectorAll('[data-highlight-category]')
          );
          const highlightCategoryLabelSpans = Array.from(
            appRoot.querySelectorAll('[data-highlight-category-label]')
          );
          const highlightLabelInputs = Array.from(
            appRoot.querySelectorAll('[data-highlight-label-input]')
          );
          const highlightLegendSwatches = Array.from(
            appRoot.querySelectorAll('[data-highlight-legend-swatch]')
          );
          const highlightCategoryMeaningElements = Array.from(
            appRoot.querySelectorAll('[data-highlight-category-meaning]')
          );
          const highlightToolbarUndo = appRoot.querySelector('[data-highlight-undo]');
          const highlightInspector = appRoot.querySelector('[data-highlight-inspector]');
          const highlightInspectorPreview =
            highlightInspector?.querySelector('[data-highlight-preview]') || null;
          const highlightTagsInput =
            highlightInspector?.querySelector('[data-highlight-tags]') || null;
          const highlightNoteInput =
            highlightInspector?.querySelector('[data-highlight-note]') || null;
          const highlightSaveButton =
            highlightInspector?.querySelector('[data-highlight-save]') || null;
          const highlightQuestionButton =
            highlightInspector?.querySelector('[data-highlight-question]') || null;
          const highlightCloseButton =
            highlightInspector?.querySelector('[data-highlight-close]') || null;
          const highlightPracticeSection =
            appRoot.querySelector('[data-highlight-practice]') || null;
          const highlightPracticeList =
            highlightPracticeSection?.querySelector('[data-highlight-practice-list]') || null;
          const highlightPracticeItems = new Map();
          const highlightRetrievalCards = new Map();

          const highlightMetadata = new Map();
          const highlightHistory = [];
          let highlightCounter = 0;
          let activeHighlightCategory = 'strength';
          let activeHighlightId = null;
          let activeHighlightMark = null;

          const highlightCategoriesOrdered = highlightPaletteButtons
            .map((button) => button.dataset.highlightCategory)
            .filter(Boolean);

          const setActiveHighlightCategory = (category, { focus = false } = {}) => {
            if (!category || !highlightCategoriesOrdered.includes(category)) {
              return false;
            }
            activeHighlightCategory = category;
            let focused = false;
            highlightPaletteButtons.forEach((other) => {
              const isActive = other.dataset.highlightCategory === category;
              other.dataset.active = String(isActive);
              other.setAttribute('aria-checked', String(isActive));
              other.setAttribute('tabindex', isActive ? '0' : '-1');
              if (isActive && focus && !focused) {
                focused = true;
                try {
                  other.focus({ preventScroll: true });
                } catch (error) {
                  other.focus();
                }
              }
            });
            return true;
          };

          const highlightCategoryLabels = new Map(
            Object.entries(defaultHighlightLabels)
          );

          const getHighlightLabel = (category) => {
            const label = highlightCategoryLabels.get(category);
            return label && label.trim()
              ? label.trim()
              : defaultHighlightLabels[category] || category;
          };

          const getHighlightMeaning = (category) =>
            defaultHighlightMeanings[category] || '';

          const deriveKeywordsFromSnippet = (snippet) => {
            if (typeof snippet !== 'string') {
              return [];
            }
            return Array.from(
              new Set(
                snippet
                  .replace(/[。．、,]/g, ' ')
                  .split(/\s+/)
                  .map((token) => token.trim())
                  .filter(Boolean)
              )
            ).slice(0, 4);
          };

          const updateHighlightDisplayLabels = () => {
            highlightPaletteButtons.forEach((button) => {
              const category = button.dataset.highlightCategory;
              if (!category) {
                return;
              }
              const label = getHighlightLabel(category);
              const meaning = getHighlightMeaning(category);
              const labelSpan = button.querySelector(
                '[data-highlight-category-label]'
              );
              if (labelSpan) {
                labelSpan.textContent = label;
              }
              const ariaLabel = meaning
                ? `${label}（${meaning}）でハイライト`
                : `${label}でハイライト`;
              button.title = meaning ? `${label}: ${meaning}` : label;
              button.setAttribute('aria-label', ariaLabel);
            });
            highlightLegendSwatches.forEach((swatch) => {
              const category = swatch.dataset.highlightLegendSwatch;
              if (category) {
                swatch.textContent = getHighlightLabel(category);
              }
            });
            highlightCategoryMeaningElements.forEach((element) => {
              const category = element.dataset.highlightCategoryMeaning;
              if (!category) {
                return;
              }
              element.textContent = getHighlightMeaning(category);
            });
          };

          const applyHighlightLabelsToUI = () => {
            updateHighlightDisplayLabels();
            highlightLabelInputs.forEach((input) => {
              const category = input.dataset.highlightLabelInput;
              if (!category) {
                return;
              }
              const label = getHighlightLabel(category);
              input.value = label;
              input.setAttribute(
                'aria-label',
                `${label}マーカーの用途を編集`
              );
            });
          };

          const persistHighlightLabels = () => {
            try {
              const payload = {};
              highlightCategoryLabels.forEach((value, category) => {
                const trimmed = typeof value === 'string' ? value.trim() : '';
                if (trimmed && trimmed !== defaultHighlightLabels[category]) {
                  payload[category] = trimmed;
                }
              });
              if (Object.keys(payload).length) {
                window.localStorage.setItem(
                  highlightLabelStorageKey,
                  JSON.stringify(payload)
                );
              } else {
                window.localStorage.removeItem(highlightLabelStorageKey);
              }
            } catch (error) {
              // ignore storage errors (private mode, etc.)
            }
          };

          const loadHighlightLabels = () => {
            try {
              const raw = window.localStorage.getItem(highlightLabelStorageKey);
              if (!raw) {
                return;
              }
              const stored = JSON.parse(raw);
              if (!stored || typeof stored !== 'object') {
                return;
              }
              Object.entries(stored).forEach(([category, label]) => {
                if (defaultHighlightLabels[category] && typeof label === 'string') {
                  highlightCategoryLabels.set(category, label);
                }
              });
            } catch (error) {
              // ignore parse errors
            }
          };

          loadHighlightLabels();
          applyHighlightLabelsToUI();

          const ensureHighlightPracticeVisibility = () => {
            if (highlightPracticeSection) {
              highlightPracticeSection.hidden = highlightPracticeItems.size === 0;
            }
          };

          const getHighlightSnippet = (mark) =>
            mark?.textContent?.replace(/\s+/g, ' ').trim() || '';

          const cleanupHighlightHistory = (highlightId) => {
            for (let index = highlightHistory.length - 1; index >= 0; index -= 1) {
              if (highlightHistory[index] === highlightId) {
                highlightHistory.splice(index, 1);
              }
            }
          };

          const syncPracticeItem = (highlightId) => {
            const meta = highlightMetadata.get(highlightId);
            if (!meta || !meta.question) {
              const existing = highlightPracticeItems.get(highlightId);
              if (existing) {
                existing.remove();
                highlightPracticeItems.delete(highlightId);
                ensureHighlightPracticeVisibility();
              }
              return;
            }
            if (!highlightPracticeList) {
              return;
            }
            let item = highlightPracticeItems.get(highlightId);
            if (!item) {
              item = document.createElement('li');
              item.className = 'highlight-practice__item';
              item.dataset.highlightPracticeItem = highlightId;
              const questionEl = document.createElement('p');
              questionEl.className = 'highlight-practice__question';
              questionEl.dataset.highlightPracticeQuestion = '';
              const metaEl = document.createElement('span');
              metaEl.className = 'highlight-practice__meta';
              metaEl.dataset.highlightPracticeMeta = '';
              const noteEl = document.createElement('span');
              noteEl.className = 'highlight-practice__meta';
              noteEl.dataset.highlightPracticeNote = '';
              noteEl.hidden = true;
              const actions = document.createElement('div');
              actions.className = 'highlight-practice__actions';
              const openButton = document.createElement('button');
              openButton.type = 'button';
              openButton.className = 'ui-button ui-button--subtle';
              openButton.dataset.highlightOpen = highlightId;
              openButton.textContent = 'ハイライトを表示';
              const toRetrievalButton = document.createElement('button');
              toRetrievalButton.type = 'button';
              toRetrievalButton.className = 'ui-button ui-button--primary';
              toRetrievalButton.dataset.highlightToRetrieval = highlightId;
              toRetrievalButton.textContent = 'カードに追加';
              actions.append(openButton, toRetrievalButton);
              item.append(questionEl, metaEl, noteEl, actions);
              highlightPracticeList.appendChild(item);
              highlightPracticeItems.set(highlightId, item);
            }
            const questionEl = item.querySelector('[data-highlight-practice-question]');
            if (questionEl) {
              questionEl.textContent = meta.question;
            }
            const metaEl = item.querySelector('[data-highlight-practice-meta]');
            if (metaEl) {
              const label = getHighlightLabel(meta.category);
              const tagText =
                meta.tags && meta.tags.length ? `タグ: ${meta.tags.join(' / ')}` : 'タグ未設定';
              metaEl.textContent = `カテゴリ: ${label}　${tagText}`;
            }
            const noteEl = item.querySelector('[data-highlight-practice-note]');
            if (noteEl) {
              if (meta.note) {
                noteEl.hidden = false;
                noteEl.textContent = `メモ: ${meta.note}`;
              } else {
                noteEl.hidden = true;
                noteEl.textContent = '';
              }
            }
            const toRetrievalButton = item.querySelector('[data-highlight-to-retrieval]');
            if (toRetrievalButton) {
              toRetrievalButton.disabled = !!meta.addedToRetrieval;
              toRetrievalButton.textContent = meta.addedToRetrieval
                ? 'カードに追加済み'
                : 'カードに追加';
            }
            ensureHighlightPracticeVisibility();
          };

          const syncHighlightRetrievalCard = (
            highlightId,
            { skipRefresh = false } = {}
          ) => {
            const card = highlightRetrievalCards.get(highlightId);
            if (!card) {
              return;
            }
            const meta = highlightMetadata.get(highlightId);
            if (!meta) {
              card.remove();
              highlightRetrievalCards.delete(highlightId);
              if (!skipRefresh) {
                refreshRetrievalCards();
              }
              return;
            }
            const label = getHighlightLabel(meta.category);
            const tag = card.querySelector('.retrieval-card__tag');
            if (tag) {
              tag.textContent = `ハイライト: ${label}`;
            }
            card.dataset.category = label;
            const heading = card.querySelector('h4');
            if (heading && meta.question) {
              heading.textContent = meta.question;
            }
            const description = card.querySelector('p');
            if (description) {
              description.textContent =
                meta.note || 'ハイライトで整理した観点を30秒で説明できるか確認しましょう。';
            }
            const textarea = card.querySelector('[data-retrieval-response]');
            if (textarea) {
              textarea.placeholder = meta.question
                ? `例：${meta.question.replace(/【.*?】/g, '').slice(0, 20)}`
                : '思い出したキーワードを書き出してください';
            }
            const keywords =
              meta.tags && meta.tags.length
                ? meta.tags
                : deriveKeywordsFromSnippet(meta.snippet || description?.textContent || '');
            card.dataset.expectedKeywords = keywords.join(',');
            if (!skipRefresh) {
              refreshRetrievalCards();
            }
          };

          const updateHighlightLinkedViews = () => {
            highlightMetadata.forEach((_, highlightId) => {
              syncPracticeItem(highlightId);
              syncHighlightRetrievalCard(highlightId, { skipRefresh: true });
            });
            refreshRetrievalCards();
          };

          const copyMemoToActiveHighlight = (questionKey) => {
            if (!questionKey) {
              showToast('ハイライトに関連付ける設問を特定できません');
              return false;
            }
            const memoInput = getMemoInputByQuestionKey(questionKey);
            if (!memoInput) {
              showToast('選択した設問のメモ欄が見つかりません');
              return false;
            }
            if (!activeHighlightId) {
              showToast('先にコピー先のハイライトを選択してください');
              return false;
            }
            const meta = highlightMetadata.get(activeHighlightId);
            if (!meta) {
              showToast('メモを適用するハイライトを選択してください');
              return false;
            }
            const question = getQuestionDataByKey(questionKey);
            const memoValue = memoInput.value.trim();
            const questionLabel = question
              ? `${question.label || ''} ${question.title || ''}`.trim()
              : '';
            if (!meta.question && questionLabel) {
              meta.question = questionLabel;
            }
            meta.note = memoValue;
            highlightMetadata.set(activeHighlightId, meta);
            if (highlightNoteInput && highlightInspector && !highlightInspector.hidden) {
              highlightNoteInput.value = memoValue;
            }
            syncPracticeItem(activeHighlightId);
            syncHighlightRetrievalCard(activeHighlightId);
            showToast(
              memoValue
                ? 'ハイライトにメモをコピーしました'
                : 'ハイライトのメモをクリアしました'
            );
            return true;
          };

          questionMemoAttachButtons.forEach((button) => {
            button.addEventListener(
              'click',
              () => {
                copyMemoToActiveHighlight(button.dataset.questionMemoAttach);
              },
              { signal }
            );
          });

          const cleanupHighlight = (highlightId) => {
            cleanupHighlightHistory(highlightId);
            const meta = highlightMetadata.get(highlightId);
            if (!meta) {
              return;
            }
            highlightMetadata.delete(highlightId);
            const item = highlightPracticeItems.get(highlightId);
            if (item) {
              item.remove();
              highlightPracticeItems.delete(highlightId);
            }
            const retrievalCard = highlightRetrievalCards.get(highlightId);
            if (retrievalCard) {
              retrievalCard.remove();
              highlightRetrievalCards.delete(highlightId);
              refreshRetrievalCards();
            }
            if (activeHighlightId === highlightId) {
              closeHighlightInspector();
            }
            ensureHighlightPracticeVisibility();
          };

          const focusHighlight = (highlightId) => {
            if (!highlightId) {
              return false;
            }
            const mark = appRoot.querySelector(
              `mark.text-highlight[data-highlight-id="${escapeSelector(highlightId)}"]`
            );
            if (!mark) {
              return false;
            }
            ensurePanelOpen('scenario');
            mark.scrollIntoView({ behavior: 'smooth', block: 'center' });
            openHighlightInspector(mark);
            return true;
          };

          const openHighlightInspector = (mark) => {
            const highlightId = mark.dataset.highlightId;
            if (!highlightId) {
              return;
            }
            const category = mark.dataset.highlightCategory || activeHighlightCategory;
            const snippet = getHighlightSnippet(mark);
            const meta = highlightMetadata.get(highlightId) || {
              category,
              tags: [],
              note: '',
              question: '',
              snippet,
              addedToRetrieval: false,
            };
            meta.category = category;
            meta.snippet = snippet;
            highlightMetadata.set(highlightId, meta);
            activeHighlightId = highlightId;
            activeHighlightMark = mark;
            if (highlightInspector) {
              highlightInspector.hidden = false;
              highlightInspector.dataset.highlightCategory = category;
            }
            if (highlightInspectorPreview) {
              highlightInspectorPreview.textContent =
                snippet || '選択したハイライトがここに表示されます。';
            }
            if (highlightTagsInput) {
              highlightTagsInput.value = meta.tags?.join('、') || '';
            }
            if (highlightNoteInput) {
              highlightNoteInput.value = meta.note || '';
            }
            syncPracticeItem(highlightId);
          };

          const closeHighlightInspector = () => {
            if (highlightInspector) {
              highlightInspector.hidden = true;
              delete highlightInspector.dataset.highlightCategory;
            }
            activeHighlightId = null;
            activeHighlightMark = null;
          };

          const saveHighlightMetadata = () => {
            if (!activeHighlightId) {
              return;
            }
            const meta = highlightMetadata.get(activeHighlightId);
            if (!meta) {
              return;
            }
            const tags = highlightTagsInput
              ? highlightTagsInput.value
                  .split(/[、,\s]+/)
                  .map((tag) => tag.trim())
                  .filter(Boolean)
              : [];
            const note = highlightNoteInput ? highlightNoteInput.value.trim() : '';
            meta.tags = tags;
            meta.note = note;
            highlightMetadata.set(activeHighlightId, meta);
            syncPracticeItem(activeHighlightId);
            syncHighlightRetrievalCard(activeHighlightId);
            showToast('ハイライトメモを保存しました');
          };

          const generateHighlightQuestion = (meta) => {
            const label = getHighlightLabel(meta.category);
            const snippet = meta.snippet || '';
            const trimmed = snippet.length > 60 ? `${snippet.slice(0, 57)}…` : snippet;
            return `【${label}】${trimmed}から出題されそうな問いは？`;
          };

          const handleHighlightQuestion = () => {
            if (!activeHighlightId) {
              return;
            }
            const meta = highlightMetadata.get(activeHighlightId);
            if (!meta) {
              return;
            }
            meta.question = generateHighlightQuestion(meta);
            if ((!meta.tags || !meta.tags.length) && meta.snippet) {
              meta.tags = deriveKeywordsFromSnippet(meta.snippet);
              if (highlightTagsInput) {
                highlightTagsInput.value = meta.tags.join('、');
              }
            }
            highlightMetadata.set(activeHighlightId, meta);
            syncPracticeItem(activeHighlightId);
            syncHighlightRetrievalCard(activeHighlightId);
            showToast('問いを追加しました。');
          };

          const createRetrievalCardFromHighlight = (highlightId, meta) => {
            if (!retrievalModalBody) {
              return null;
            }
            const card = document.createElement('article');
            card.className = 'retrieval-card';
            card.dataset.retrievalCard = '';
            card.dataset.highlightSource = highlightId;
            const label = getHighlightLabel(meta.category);
            card.dataset.category = label;
            const tag = document.createElement('span');
            tag.className = 'retrieval-card__tag';
            tag.textContent = `ハイライト: ${label}`;
            const heading = document.createElement('h4');
            heading.className = 'heading-md';
            heading.textContent = meta.question || generateHighlightQuestion(meta);
            const paragraph = document.createElement('p');
            paragraph.textContent =
              meta.note || 'ハイライトで整理した観点を30秒で説明できるか確認しましょう。';
            const practice = document.createElement('div');
            practice.className = 'retrieval-card__practice';
            const labelEl = document.createElement('label');
            labelEl.className = 'text-muted';
            const textareaId = `retrieval-response-${highlightId}`;
            labelEl.setAttribute('for', textareaId);
            labelEl.textContent = '思い出したキーワード';
            const textarea = document.createElement('textarea');
            textarea.id = textareaId;
            textarea.dataset.retrievalResponse = '';
            textarea.placeholder = '思い出したキーワードを書き出してください';
            const checkButton = document.createElement('button');
            checkButton.type = 'button';
            checkButton.className = 'ui-button ui-button--subtle';
            checkButton.dataset.retrievalCheck = '';
            checkButton.textContent = '重なりを確認';
            const feedback = document.createElement('div');
            feedback.className = 'retrieval-feedback';
            feedback.dataset.retrievalFeedback = '';
            feedback.hidden = true;
            const chips = document.createElement('div');
            chips.className = 'retrieval-feedback__chips';
            chips.dataset.retrievalOverlap = '';
            const summary = document.createElement('p');
            summary.className = 'retrieval-feedback__summary';
            summary.dataset.retrievalSummary = '';
            feedback.append(chips, summary);
            practice.append(labelEl, textarea, checkButton, feedback);
            card.append(tag, heading, paragraph, practice);
            const keywords =
              meta.tags && meta.tags.length
                ? meta.tags
                : deriveKeywordsFromSnippet(meta.snippet || heading.textContent || '');
            card.dataset.expectedKeywords = keywords.join(',');
            return card;
          };

          const addHighlightToRetrieval = (highlightId) => {
            if (!highlightId) {
              return;
            }
            const meta = highlightMetadata.get(highlightId);
            if (!meta || !meta.question) {
              showToast('問いを作成してから追加してください');
              return;
            }
            if (meta.addedToRetrieval) {
              showToast('既にカードに追加済みです');
              return;
            }
            const card = createRetrievalCardFromHighlight(highlightId, meta);
            if (!card || !retrievalModalBody) {
              return;
            }
            retrievalModalBody.appendChild(card);
            highlightRetrievalCards.set(highlightId, card);
            meta.addedToRetrieval = true;
            highlightMetadata.set(highlightId, meta);
            syncPracticeItem(highlightId);
            syncHighlightRetrievalCard(highlightId);
            refreshRetrievalCards();
            applyRetrievalOrder(retrievalOrderMode);
            showToast('リトリーバルカードに追加しました');
          };

          const undoHighlight = () => {
            while (highlightHistory.length) {
              const highlightId = highlightHistory.pop();
              const mark = highlightId
                ? appRoot.querySelector(
                    `mark.text-highlight[data-highlight-id="${escapeSelector(highlightId)}"]`
                  )
                : null;
              if (mark) {
                cleanupHighlight(highlightId);
                unwrapMark(mark);
                updateSelectionJumpVisibility();
                showToast('ハイライトを元に戻しました');
                return true;
              }
            }
            return false;
          };

          const highlightSelection = () => {
            const selection = window.getSelection();
            if (!selection || selection.rangeCount === 0) {
              return false;
            }
            const range = selection.getRangeAt(0);
            if (range.collapsed) {
              return false;
            }
            if (!appRoot.contains(range.commonAncestorContainer)) {
              return false;
            }
            const wrapper = document.createElement('mark');
            const category = activeHighlightCategory;
            wrapper.className = `text-highlight text-highlight--${category}`;
            const highlightId = `highlight-${++highlightCounter}`;
            wrapper.dataset.highlightId = highlightId;
            wrapper.dataset.highlightCategory = category;
            try {
              const contents = range.extractContents();
              wrapper.appendChild(contents);
              range.insertNode(wrapper);
              selection.removeAllRanges();
              const newRange = document.createRange();
              newRange.selectNode(wrapper);
              selection.addRange(newRange);
              const snippet = getHighlightSnippet(wrapper);
              highlightMetadata.set(highlightId, {
                category,
                tags: [],
                note: '',
                question: '',
                snippet,
                addedToRetrieval: false,
              });
              highlightHistory.push(highlightId);
              updateSelectionJumpVisibility();
              openHighlightInspector(wrapper);
              return true;
            } catch (error) {
              return false;
            }
          };

          const removeHighlight = () => {
            const selection = window.getSelection();
            if (!selection || selection.rangeCount === 0) {
              return false;
            }
            const range = selection.getRangeAt(0);
            if (!appRoot.contains(range.commonAncestorContainer)) {
              return false;
            }
            let removed = false;
            if (range.collapsed) {
              const node =
                selection.anchorNode instanceof Element
                  ? selection.anchorNode
                  : selection.anchorNode?.parentElement;
              const mark = node?.closest?.('mark.text-highlight');
              if (mark) {
                const highlightId = mark.dataset.highlightId;
                if (highlightId) {
                  cleanupHighlight(highlightId);
                }
                unwrapMark(mark);
                removed = true;
              }
            } else {
              const marks = Array.from(
                appRoot.querySelectorAll('mark.text-highlight')
              );
              marks.forEach((mark) => {
                try {
                  if (range.intersectsNode(mark)) {
                    const highlightId = mark.dataset.highlightId;
                    if (highlightId) {
                      cleanupHighlight(highlightId);
                    }
                    unwrapMark(mark);
                    removed = true;
                  }
                } catch (error) {
                  // ignore intersections that throw for detached nodes
                }
              });
            }
            if (removed) {
              updateSelectionJumpVisibility();
              showToast('ハイライトを解除しました');
            }
            return removed;
          };

          if (highlightToolbarUndo) {
            highlightToolbarUndo.addEventListener(
              'click',
              () => {
                if (!undoHighlight()) {
                  showToast('取り消すハイライトがありません');
                }
              },
              { signal }
            );
          }

          highlightPaletteButtons.forEach((button, index) => {
            const category = button.dataset.highlightCategory;
            if (!category) {
              return;
            }
            button.setAttribute('role', 'radio');
            button.setAttribute('aria-checked', 'false');
            button.setAttribute('tabindex', index === 0 ? '0' : '-1');
            button.addEventListener(
              'click',
              () => {
                const selection = window.getSelection();
                const hasSelection =
                  selection &&
                  selection.rangeCount > 0 &&
                  !selection.getRangeAt(0).collapsed;
                setActiveHighlightCategory(category);
                if (hasSelection) {
                  const success = highlightSelection();
                  if (!success) {
                    showToast('ハイライトする文字列を選択してください');
                  }
                }
                setActiveHighlightCategory(category, { focus: true });
              },
              { signal }
            );
          });
          if (highlightPaletteButtons.length) {
            const initialActive = highlightPaletteButtons.find(
              (button) => button.dataset.active === 'true'
            );
            const initialCategory =
              initialActive?.dataset.highlightCategory ||
              highlightPaletteButtons[0]?.dataset.highlightCategory;
            if (initialCategory) {
              setActiveHighlightCategory(initialCategory);
            }
          }

          highlightLabelInputs.forEach((input) => {
            const category = input.dataset.highlightLabelInput;
            if (!category) {
              return;
            }
            input.addEventListener(
              'input',
              () => {
                highlightCategoryLabels.set(category, input.value);
                updateHighlightDisplayLabels();
              },
              { signal }
            );
            input.addEventListener(
              'blur',
              () => {
                const value = input.value.trim();
                highlightCategoryLabels.set(
                  category,
                  value || defaultHighlightLabels[category] || category
                );
                applyHighlightLabelsToUI();
                persistHighlightLabels();
                updateHighlightLinkedViews();
              },
              { signal }
            );
          });

          if (highlightSaveButton) {
            highlightSaveButton.addEventListener('click', saveHighlightMetadata, {
              signal,
            });
          }

          if (highlightQuestionButton) {
            highlightQuestionButton.addEventListener('click', handleHighlightQuestion, {
              signal,
            });
          }

          if (highlightCloseButton) {
            highlightCloseButton.addEventListener('click', () => {
              closeHighlightInspector();
            }, { signal });
          }

          if (highlightInspector) {
            highlightInspector.addEventListener(
              'keydown',
              (event) => {
                if (event.key === 'Escape') {
                  closeHighlightInspector();
                }
              },
              { signal }
            );
          }

          if (highlightPracticeList) {
            highlightPracticeList.addEventListener(
              'click',
              (event) => {
                const openButton = event.target.closest('[data-highlight-open]');
                if (openButton) {
                  event.preventDefault();
                  const highlightId = openButton.dataset.highlightOpen;
                  if (!focusHighlight(highlightId)) {
                    showToast('対応するハイライトが見つかりませんでした');
                  }
                  return;
                }
                const toRetrievalButton = event.target.closest(
                  '[data-highlight-to-retrieval]'
                );
                if (toRetrievalButton) {
                  event.preventDefault();
                  addHighlightToRetrieval(
                    toRetrievalButton.dataset.highlightToRetrieval
                  );
                }
              },
              { signal }
            );
          }

          ensureHighlightPracticeVisibility();
          const scenarioPane = appRoot.querySelector('#section-scenario');
          const scenarioBody =
            scenarioPane?.querySelector('.context-pane__body') || null;
          const scenarioSummaryLabel = scenarioPane?.querySelector(
            '[data-scenario-summary]'
          );
          const scenarioTitleElement = scenarioPane?.querySelector(
            '[data-scenario-title]'
          );
          const scenarioIndustryLabel = scenarioPane?.querySelector(
            '[data-scenario-industry]'
          );
          const scenarioEmployeesLabel = scenarioPane?.querySelector(
            '[data-scenario-employees]'
          );
          const scenarioSalesLabel = scenarioPane?.querySelector(
            '[data-scenario-sales]'
          );
          const scenarioKeywordsLabel = scenarioPane?.querySelector(
            '[data-scenario-keywords]'
          );
          const scenarioSearchInput = scenarioPane?.querySelector(
            '[data-scenario-search]'
          );
          const scenarioSearchNext = scenarioPane?.querySelector(
            '[data-scenario-search-next]'
          );
          const scenarioSearchPrev = scenarioPane?.querySelector(
            '[data-scenario-search-prev]'
          );
          const scenarioSearchCount = scenarioPane?.querySelector(
            '[data-scenario-search-count]'
          );
          const selectionJumpButton = scenarioPane?.querySelector(
            '[data-selection-jump]'
          );

          if (scenarioBody) {
            scenarioBody.addEventListener(
              'click',
              (event) => {
                const mark = event.target.closest('mark.text-highlight');
                if (mark) {
                  event.preventDefault();
                  openHighlightInspector(mark);
                }
              },
              { signal }
            );
          }

          const scenarioSearchState = {
            matches: [],
            activeIndex: -1,
          };

          const clearScenarioHighlights = () => {
            scenarioSearchState.matches.forEach((mark) => {
              if (
                mark instanceof Element &&
                mark.classList.contains('context-search__hit')
              ) {
                unwrapMark(mark);
              }
            });
            scenarioSearchState.matches = [];
            scenarioSearchState.activeIndex = -1;
          };

          const updateScenarioSearchControls = () => {
            const total = scenarioSearchState.matches.length;
            if (scenarioSearchCount) {
              scenarioSearchCount.textContent = `${total} 件`;
            }
            if (scenarioSearchNext) {
              scenarioSearchNext.disabled = total <= 1;
            }
            if (scenarioSearchPrev) {
              scenarioSearchPrev.disabled = total <= 1;
            }
            scenarioSearchState.matches.forEach((mark, index) => {
              if (mark instanceof Element) {
                mark.dataset.active = String(
                  index === scenarioSearchState.activeIndex
                );
              }
            });
          };

          const focusScenarioHit = (index) => {
            const total = scenarioSearchState.matches.length;
            if (!total) {
              scenarioSearchState.activeIndex = -1;
              updateScenarioSearchControls();
              return;
            }
            const normalized = ((index % total) + total) % total;
            scenarioSearchState.activeIndex = normalized;
            const target = scenarioSearchState.matches[normalized];
            if (target?.scrollIntoView) {
              target.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            updateScenarioSearchControls();
          };

          const applyScenarioSearch = (query) => {
            if (!scenarioBody) {
              return;
            }
            clearScenarioHighlights();
            if (!query) {
              updateScenarioSearchControls();
              return;
            }
            const lowerQuery = query.toLowerCase();
            const walker = document.createTreeWalker(
              scenarioBody,
              NodeFilter.SHOW_TEXT,
              null
            );
            const matches = [];
            let currentNode;
            while ((currentNode = walker.nextNode())) {
              if (!currentNode.nodeValue) {
                continue;
              }
              if (
                currentNode.parentElement?.closest(
                  'mark.text-highlight, mark.context-search__hit'
                )
              ) {
                continue;
              }
              let textNode = currentNode;
              while (textNode && textNode.nodeType === Node.TEXT_NODE) {
                const text = textNode.nodeValue;
                if (!text) {
                  break;
                }
                const lowerText = text.toLowerCase();
                const matchIndex = lowerText.indexOf(lowerQuery);
                if (matchIndex === -1) {
                  break;
                }
                const range = document.createRange();
                range.setStart(textNode, matchIndex);
                range.setEnd(textNode, matchIndex + query.length);
                const mark = document.createElement('mark');
                mark.className = 'context-search__hit';
                range.surroundContents(mark);
                matches.push(mark);
                const nextNode = mark.nextSibling;
                if (!nextNode || nextNode.nodeType !== Node.TEXT_NODE) {
                  break;
                }
                textNode = nextNode;
              }
            }
            scenarioSearchState.matches = matches;
            if (matches.length) {
              focusScenarioHit(0);
            } else {
              scenarioSearchState.activeIndex = -1;
              updateScenarioSearchControls();
            }
          };

          updateSelectionJumpVisibility = () => {
            if (!selectionJumpButton || !scenarioBody) {
              return;
            }
            const selection = window.getSelection();
            const hasSelection =
              selection &&
              !selection.isCollapsed &&
              scenarioBody.contains(selection.anchorNode);
            const hasHighlight =
              scenarioBody.querySelector('mark.text-highlight') !== null;
            selectionJumpButton.hidden = !(hasSelection || hasHighlight);
          };

          if (scenarioSearchInput) {
            scenarioSearchInput.addEventListener(
              'input',
              () => {
                const query = scenarioSearchInput.value.trim();
                if (query) {
                  ensurePanelOpen('scenario');
                }
                applyScenarioSearch(query);
              },
              { signal }
            );
          }

          if (scenarioSearchNext) {
            scenarioSearchNext.addEventListener(
              'click',
              () => {
                focusScenarioHit(scenarioSearchState.activeIndex + 1);
              },
              { signal }
            );
          }

          if (scenarioSearchPrev) {
            scenarioSearchPrev.addEventListener(
              'click',
              () => {
                focusScenarioHit(scenarioSearchState.activeIndex - 1);
              },
              { signal }
            );
          }

          if (selectionJumpButton) {
            selectionJumpButton.addEventListener(
              'click',
              () => {
                ensurePanelOpen('answer');
                if (activeQuestionId) {
                  scrollToQuestion(activeQuestionId);
                }
              },
              { signal }
            );
          }

          document.addEventListener(
            'selectionchange',
            () => updateSelectionJumpVisibility(),
            { signal }
          );

          updateSelectionJumpVisibility();

          document.addEventListener(
            'keydown',
            (event) => {
              if (event.defaultPrevented) {
                return;
              }
              const key = event.key?.toLowerCase?.();
              const isModifierCombo =
                event.altKey && event.shiftKey && !event.ctrlKey && !event.metaKey;

              if (isModifierCombo && key === 'h') {
                if (highlightSelection()) {
                  event.preventDefault();
                }
              } else if (
                isModifierCombo &&
                ['1', '2', '3', '4'].includes(key)
              ) {
                const index = Number(key) - 1;
                const category = highlightCategoriesOrdered[index];
                if (!category) {
                  if (!highlightCategoriesOrdered.length) {
                    showToast('ハイライトカテゴリが設定されていません');
                  }
                } else if (
                  setActiveHighlightCategory(category, { focus: true })
                ) {
                  event.preventDefault();
                }
              } else if (isModifierCombo && key === 'c') {
                if (highlightCategoriesOrdered.length) {
                  const currentIndex = highlightCategoriesOrdered.indexOf(
                    activeHighlightCategory
                  );
                  const nextIndex =
                    (currentIndex + 1) % highlightCategoriesOrdered.length;
                  const nextCategory = highlightCategoriesOrdered[nextIndex];
                  if (setActiveHighlightCategory(nextCategory, { focus: true })) {
                    event.preventDefault();
                  }
                } else {
                  showToast('ハイライトカテゴリが設定されていません');
                }
              } else if (isModifierCombo && key === 'z') {
                if (undoHighlight()) {
                  event.preventDefault();
                }
              } else if (isModifierCombo && key === 'r') {
                if (removeHighlight()) {
                  event.preventDefault();
                }
              } else if (isModifierCombo && key === 'o') {
                if (openRetrieval()) {
                  event.preventDefault();
                }
              } else if (isModifierCombo && key === 'k') {
                if (openShortcutPanel()) {
                  event.preventDefault();
                }
              } else if (isModifierCombo && key === 'n') {
                if (focusNextQuestion()) {
                  event.preventDefault();
                }
              } else if (isModifierCombo && key === 'p') {
                if (focusPreviousQuestion()) {
                  event.preventDefault();
                }
              } else if (isModifierCombo && key === 'a') {
                if (focusAnswerField()) {
                  event.preventDefault();
                }
              } else if (event.key === 'Escape') {
                const closedModal = closeRetrieval();
                const closedShortcuts = closeShortcutPanel();
                if (closedModal || closedShortcuts) {
                  event.preventDefault();
                }
              }
            },
            { signal }
          );

          // 現在の設問位置とタブ／CTAの同期、スムーススクロール、ハイライト
          const tabButtons = Array.from(
            appRoot.querySelectorAll('.exercise-tab')
          );
          const tabList = appRoot.querySelector('.exercise__tabs');
          const problemSearchInput = appRoot.querySelector('#problem-search');
          const filterChips = Array.from(
            appRoot.querySelectorAll('.filter-chip[data-filter]')
          );
          const sortSelect = appRoot.querySelector('#problem-sort');
          const nextButton = appRoot.querySelector('#next-question-button');
          const questionCards = Array.from(
            appRoot.querySelectorAll('.question-card')
          );
          const questionContainer = appRoot.querySelector('.exercise__questions');
          let activeExerciseId = null;
          let currentExercise = null;
          const questionState = new Map();
          let questionSortOrder = [];
          const quickNavStatusLabels = {
            unanswered: '未回答',
            answered: '解答済',
            review: '要復習',
          };
          const getQuickNavStatus = (state, fallback = 'unanswered') => {
            const fallbackStatus = fallback || 'unanswered';
            if (!state) {
              return fallbackStatus;
            }
            const flags =
              state.flags instanceof Set
                ? state.flags
                : Array.isArray(state.flags)
                ? new Set(state.flags)
                : new Set();
            if (flags.has('review')) {
              return 'review';
            }
            return state.status || fallbackStatus;
          };
          const refreshQuickNavStatuses = () => {
            if (!quickNavList) {
              return;
            }
            const buttons = Array.from(
              quickNavList.querySelectorAll('[data-question-jump]')
            );
            buttons.forEach((button) => {
              const key = button.dataset.questionKey;
              const state = key ? questionState.get(key) : null;
              const fallback = button.dataset.defaultStatus || 'unanswered';
              const status = getQuickNavStatus(state, fallback);
              button.dataset.status = status;
              const indicator = button.querySelector('[data-quicknav-indicator]');
              if (indicator) {
                indicator.dataset.status = status;
              }
              const statusText = button.querySelector('[data-quicknav-status]');
              if (statusText) {
                statusText.textContent =
                  quickNavStatusLabels[status] ||
                  quickNavStatusLabels[fallback] ||
                  quickNavStatusLabels.unanswered ||
                  '';
              }
            });
          };
          const updateQuickNavActive = (activeId) => {
            if (!quickNavList) {
              return;
            }
            const buttons = Array.from(
              quickNavList.querySelectorAll('[data-question-jump]')
            );
            buttons.forEach((button) => {
              const isActive = button.dataset.questionJump === activeId;
              button.dataset.active = String(isActive);
              if (isActive) {
                button.setAttribute('aria-current', 'true');
              } else {
                button.removeAttribute('aria-current');
              }
            });
          };
          let currentSearchQuery = '';
          let currentSortMode = sortSelect?.value || 'recommended';
          let exerciseTimerId = null;
          let exerciseTimerEnd = null;
          let suppressSelectEvents = false;
          const activeFilters = new Set(
            filterChips
              .filter((chip) => chip.dataset.active === 'true')
              .map((chip) => chip.dataset.filter)
              .filter(Boolean)
          );
          const getQuestionLabel = (questionId) => {
            const card = questionCards.find((item) => item.id === questionId);
            if (!card) {
              return null;
            }
            if (card.dataset.questionLabel) {
              return card.dataset.questionLabel;
            }
            const headingText = card
              .querySelector('.question-card__title')
              ?.textContent?.trim();
            const tabLabel = tabButtons
              .find((button) => button.dataset.target === questionId)
              ?.querySelector('.exercise-tab__label')
              ?.textContent?.trim();
            if (headingText && tabLabel) {
              return `${tabLabel} ${headingText}`;
            }
            return headingText || null;
          };
          const updateSelectionQuestion = (questionId) => {
            if (!selectionQuestionLabel) {
              return;
            }
            const label = getQuestionLabel(questionId);
            if (label) {
              selectionQuestionLabel.textContent = label;
            }
          };
          const answerTextareas = appRoot.querySelectorAll(
            '.question-card__textarea'
          );
          const insertionHistory = new Map();

          const isCardFilteredOut = (card) =>
            card?.dataset.filteredOut === 'true';

          const getVisibleQuestionCards = () =>
            questionCards.filter((card) => !isCardFilteredOut(card));

          const getQuestionCardByKey = (key) =>
            questionCards.find((card) => card.dataset.questionKey === key);

          const getQuestionDataByKey = (key) => {
            if (!currentExercise || !Array.isArray(currentExercise.questions)) {
              return null;
            }
            return currentExercise.questions.find((question) => question.key === key);
          };

          const getMemoInputByQuestionKey = (key) =>
            questionMemoInputs.find(
              (input) => input.dataset.questionKey === key
            ) || null;

          const collectExerciseSearchSuggestions = (exercise) => {
            const suggestions = new Set();
            const addValue = (value) => {
              if (Array.isArray(value)) {
                value.forEach(addValue);
                return;
              }
              if (typeof value !== 'string') {
                return;
              }
              const trimmed = value.trim();
              if (!trimmed) {
                return;
              }
              suggestions.add(trimmed);
            };
            const addSplitValues = (value) => {
              if (typeof value !== 'string') {
                return;
              }
              value
                .split(/[,，／\/、\s]+/)
                .map((token) => token.trim())
                .filter(Boolean)
                .forEach(addValue);
            };
            if (!exercise) {
              return [];
            }
            addValue(exercise.caseLabel);
            addValue(exercise.scenarioTitle);
            addValue(exercise.scenarioSummary);
            if (exercise.scenarioMeta) {
              Object.values(exercise.scenarioMeta).forEach((metaValue) => {
                addSplitValues(metaValue);
              });
            }
            if (Array.isArray(exercise.questions)) {
              exercise.questions.forEach((question) => {
                addValue(question.title);
                addValue(question.tabTitle);
                addValue(`${question.label || ''} ${question.title || ''}`.trim());
                addValue(question.label);
                if (Array.isArray(question.keywords)) {
                  question.keywords.forEach((keyword) => {
                    addSplitValues(keyword);
                  });
                }
              });
            }
            return Array.from(suggestions).sort((a, b) =>
              a.localeCompare(b, 'ja')
            );
          };

          const updateProblemSearchSuggestions = (exercise) => {
            if (!problemSearchSuggestionList) {
              return;
            }
            problemSearchSuggestionList.innerHTML = '';
            const values = collectExerciseSearchSuggestions(exercise);
            if (!values.length) {
              return;
            }
            const fragment = document.createDocumentFragment();
            values.forEach((value) => {
              const option = document.createElement('option');
              option.value = value;
              fragment.appendChild(option);
            });
            problemSearchSuggestionList.appendChild(fragment);
          };

          const populateCaseSelectOptions = () => {
            if (!caseSelect) {
              return;
            }
            const previousValue = caseSelect.value;
            caseSelect.innerHTML = '';
            const fragment = document.createDocumentFragment();
            caseOptions.forEach(({ caseId, label }) => {
              const option = document.createElement('option');
              option.value = caseId;
              option.textContent = label;
              fragment.appendChild(option);
            });
            caseSelect.appendChild(fragment);
            if (
              previousValue &&
              caseOptions.some((option) => option.caseId === previousValue)
            ) {
              caseSelect.value = previousValue;
            }
          };

          const populateYearSelectOptions = (caseId, selectedExerciseId) => {
            if (!yearSelect) {
              return;
            }
            const exercises = exercisesByCase.get(caseId) || [];
            const previousValue = selectedExerciseId || yearSelect.value;
            yearSelect.innerHTML = '';
            const fragment = document.createDocumentFragment();
            exercises
              .slice()
              .sort((a, b) => a.year.localeCompare(b.year))
              .forEach((exercise) => {
                const option = document.createElement('option');
                option.value = exercise.id;
                option.textContent = exercise.year;
                fragment.appendChild(option);
              });
            yearSelect.appendChild(fragment);
            if (
              previousValue &&
              exercises.some((exercise) => exercise.id === previousValue)
            ) {
              yearSelect.value = previousValue;
            } else if (yearSelect.options.length) {
              yearSelect.selectedIndex = 0;
            }
          };

          const renderScenarioBody = (paragraphs) => {
            if (!scenarioBody) {
              return;
            }
            scenarioBody.innerHTML = '';
            if (!Array.isArray(paragraphs) || !paragraphs.length) {
              return;
            }
            const fragment = document.createDocumentFragment();
            paragraphs.forEach((text) => {
              const trimmed = typeof text === 'string' ? text.trim() : '';
              if (!trimmed) {
                return;
              }
              const paragraph = document.createElement('p');
              paragraph.textContent = trimmed;
              fragment.appendChild(paragraph);
            });
            scenarioBody.appendChild(fragment);
          };

          const updateScenarioView = (exercise) => {
            if (!exercise) {
              return;
            }
            if (selectionCaseLabel) {
              selectionCaseLabel.textContent = exercise.caseLabel;
            }
            if (selectionYearLabel) {
              selectionYearLabel.textContent = exercise.year;
            }
            if (scenarioSummaryLabel) {
              scenarioSummaryLabel.textContent = exercise.scenarioSummary;
            }
            if (scenarioTitleElement) {
              scenarioTitleElement.textContent = exercise.scenarioTitle;
            }
            if (scenarioIndustryLabel) {
              scenarioIndustryLabel.textContent =
                exercise.scenarioMeta?.industry || '';
            }
            if (scenarioEmployeesLabel) {
              scenarioEmployeesLabel.textContent =
                exercise.scenarioMeta?.employees || '';
            }
            if (scenarioSalesLabel) {
              scenarioSalesLabel.textContent =
                exercise.scenarioMeta?.sales || '';
            }
            if (scenarioKeywordsLabel) {
              scenarioKeywordsLabel.textContent =
                exercise.scenarioMeta?.keywords || '';
            }
            renderScenarioBody(exercise.scenarioBody);
          };

          const ensureQuestionState = (question) => {
            if (!question || !question.key) {
              return null;
            }
            const existing = questionState.get(question.key) || {};
            const merged = {
              status: question.status || existing.status || 'unanswered',
              flags: new Set(
                Array.isArray(question.flags)
                  ? question.flags
                  : existing.flags || []
              ),
              keywords: Array.isArray(question.keywords)
                ? question.keywords
                : existing.keywords || [],
              recommendedRank:
                question.recommendedRank ?? existing.recommendedRank ?? 0,
              recentRank: question.recentRank ?? existing.recentRank ?? 0,
              memoDraft:
                typeof existing.memoDraft === 'string'
                  ? existing.memoDraft
                  : '',
            };
            questionState.set(question.key, merged);
            return merged;
          };

          const updateQuestionIndexNavigation = (orderedQuestions) => {
            if (questionIndexList) {
              questionIndexList.innerHTML = '';
              const fragment = document.createDocumentFragment();
              orderedQuestions.forEach((question) => {
                const card = questionCards.find(
                  (item) => item.dataset.questionKey === question.key
                );
                if (!card) {
                  return;
                }
                const item = document.createElement('li');
                const anchor = document.createElement('a');
                anchor.href = `#${card.id}`;
                anchor.textContent = `${question.label} ${
                  question.tabTitle || question.title
                }`;
                anchor.dataset.questionKey = question.key;
                item.appendChild(anchor);
                fragment.appendChild(item);
              });
              questionIndexList.appendChild(fragment);
            }
            if (quickNavList) {
              quickNavList.innerHTML = '';
              if (!orderedQuestions.length) {
                const emptyItem = document.createElement('li');
                emptyItem.className = 'quick-nav__empty';
                emptyItem.textContent = '該当する設問がありません';
                quickNavList.appendChild(emptyItem);
                return;
              }
              const fragment = document.createDocumentFragment();
              orderedQuestions.forEach((question) => {
                const card = questionCards.find(
                  (item) => item.dataset.questionKey === question.key
                );
                if (!card) {
                  return;
                }
                const item = document.createElement('li');
                item.className = 'quick-nav__item';
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'quick-nav__link';
                button.dataset.questionJump = card.id;
                button.dataset.questionKey = question.key;
                const state = questionState.get(question.key);
                const defaultStatus = question.status || 'unanswered';
                const resolvedStatus = getQuickNavStatus(state, defaultStatus);
                button.dataset.defaultStatus = defaultStatus;
                button.dataset.status = resolvedStatus;

                const number = document.createElement('span');
                number.className = 'quick-nav__number';
                number.textContent = question.label || '';

                const texts = document.createElement('span');
                texts.className = 'quick-nav__texts';

                const label = document.createElement('span');
                label.className = 'quick-nav__label';
                label.textContent = question.tabTitle || question.title || '';

                const status = document.createElement('span');
                status.className = 'quick-nav__status';
                status.dataset.quicknavStatus = '';
                status.textContent =
                  quickNavStatusLabels[resolvedStatus] ||
                  quickNavStatusLabels[defaultStatus] ||
                  quickNavStatusLabels.unanswered ||
                  '';

                texts.append(label, status);

                const indicator = document.createElement('span');
                indicator.className = 'quick-nav__indicator';
                indicator.dataset.quicknavIndicator = '';
                indicator.dataset.status = resolvedStatus;

                button.append(number, texts, indicator);
                item.appendChild(button);
                fragment.appendChild(item);
              });
              quickNavList.appendChild(fragment);
              refreshQuickNavStatuses();
              updateQuickNavActive(activeQuestionId);
            }
          };

          const updateQuestionCard = (question, card, index) => {
            if (!question || !card) {
              return;
            }
            ensureQuestionState(question);
            card.dataset.questionKey = question.key;
            card.dataset.questionLabel = `${question.label} ${question.title}`;
            if (card.dataset.maxLength) {
              card.dataset.maxLength = String(question.maxLength || '');
            }
            const titleElement = card.querySelector('[data-question-title]');
            if (titleElement) {
              titleElement.textContent = question.title;
            }
            const scoreElement = card.querySelector('[data-question-score]');
            if (scoreElement) {
              scoreElement.textContent = question.score || '';
            }
            const limitElement = card.querySelector('[data-question-limit]');
            if (limitElement) {
              limitElement.textContent = question.limit || '';
            }
            const promptElement = card.querySelector('[data-question-prompt]');
            if (promptElement) {
              promptElement.textContent = question.prompt || '';
            }
            const textarea = card.querySelector('.question-card__textarea');
            if (textarea) {
              textarea.dataset.questionKey = question.key;
              textarea.dataset.maxLength = String(question.maxLength || '');
              const maxAttr = question.maxLength
                ? Math.max(question.maxLength * 2, question.maxLength + 80)
                : textarea.getAttribute('maxlength');
              if (maxAttr) {
                textarea.setAttribute('maxlength', String(maxAttr));
              }
            }
            const memoInput = card.querySelector('[data-question-memo]');
            if (memoInput) {
              memoInput.dataset.questionKey = question.key;
              const state = questionState.get(question.key);
              const memoValue =
                typeof state?.memoDraft === 'string' ? state.memoDraft : '';
              if (memoInput.value !== memoValue) {
                memoInput.value = memoValue;
              }
            }
            const memoAttachButton = card.querySelector(
              '[data-question-memo-attach]'
            );
            if (memoAttachButton) {
              memoAttachButton.dataset.questionMemoAttach = question.key;
            }
            const counterId = textarea?.getAttribute('aria-describedby');
            if (counterId) {
              const counterElement = appRoot.querySelector(
                `#${escapeSelector(counterId)}`
              );
              if (counterElement && question.maxLength) {
                counterElement.textContent = `0 / ${question.maxLength} 字`;
              }
            }
            const exampleButtons = Array.from(
              card.querySelectorAll('[data-example-text]')
            );
            exampleButtons.forEach((button, exampleIndex) => {
              const value = question.examples?.[exampleIndex] || '';
              if (value) {
                button.hidden = false;
                button.dataset.exampleText = value;
                button.textContent = value;
              } else {
                button.hidden = true;
                button.dataset.exampleText = '';
                button.textContent = '';
              }
            });
            const supportContent = card.querySelector('[data-support-content]');
            if (supportContent) {
              supportContent.textContent = question.support || '';
            }
            const tabButton = tabButtons[index];
            if (tabButton) {
              tabButton.dataset.target = card.id;
              tabButton.dataset.questionTab = question.key;
              const labelSpan = tabButton.querySelector('.exercise-tab__label');
              if (labelSpan) {
                labelSpan.textContent = question.label;
              }
              const titleSpan = tabButton.querySelector(
                '[data-question-tab-title]'
              );
              if (titleSpan) {
                titleSpan.textContent = question.tabTitle || question.title;
              }
            }
          };

          const buildRetrievalCardElement = (cardData, index) => {
            const article = document.createElement('article');
            article.className = 'retrieval-card';
            article.dataset.retrievalCard = '';
            article.dataset.index = String(index);
            if (cardData.category) {
              article.dataset.category = cardData.category;
            }
            if (cardData.expectedKeywords) {
              article.dataset.expectedKeywords = cardData.expectedKeywords;
            }

            const tag = document.createElement('span');
            tag.className = 'retrieval-card__tag';
            tag.textContent = cardData.category || '';
            article.appendChild(tag);

            const heading = document.createElement('h4');
            heading.className = 'heading-md';
            heading.textContent = cardData.title || '';
            article.appendChild(heading);

            const body = document.createElement('p');
            body.textContent = cardData.body || '';
            article.appendChild(body);

            const practice = document.createElement('div');
            practice.className = 'retrieval-card__practice';
            const label = document.createElement('label');
            label.className = 'text-muted';
            const textareaId = `retrieval-response-${index}`;
            label.setAttribute('for', textareaId);
            label.textContent = '思い出したキーワード';
            practice.appendChild(label);

            const textarea = document.createElement('textarea');
            textarea.id = textareaId;
            textarea.dataset.retrievalResponse = '';
            textarea.placeholder = '例：キーワードをメモ';
            practice.appendChild(textarea);

            const button = document.createElement('button');
            button.type = 'button';
            button.className = 'ui-button ui-button--subtle';
            button.dataset.retrievalCheck = '';
            button.textContent = '重なりを確認';
            practice.appendChild(button);

            const feedback = document.createElement('div');
            feedback.className = 'retrieval-feedback';
            feedback.dataset.retrievalFeedback = '';
            feedback.hidden = true;

            const overlap = document.createElement('div');
            overlap.className = 'retrieval-feedback__chips';
            overlap.dataset.retrievalOverlap = '';
            feedback.appendChild(overlap);

            const summary = document.createElement('p');
            summary.className = 'retrieval-feedback__summary';
            summary.dataset.retrievalSummary = '';
            feedback.appendChild(summary);

            practice.appendChild(feedback);
            article.appendChild(practice);

            return article;
          };

          const renderRetrievalCardsForExercise = (exercise) => {
            if (!retrievalModalBody) {
              retrievalCards = [];
              updateRetrievalProgress();
              return;
            }
            retrievalModalBody.innerHTML = '';
            const cards = Array.isArray(exercise?.retrieval)
              ? exercise.retrieval
              : [];
            retrievalIndex = 0;
            retrievalOriginalOrderCounter = 0;
            retrievalOrderMode = 'default';
            if (retrievalOrderSelect) {
              retrievalOrderSelect.value = 'default';
            }
            cards.forEach((cardData, index) => {
              const element = buildRetrievalCardElement(cardData, index);
              if (!element) {
                return;
              }
              if (index !== 0) {
                element.hidden = true;
              }
              retrievalModalBody.appendChild(element);
            });
            refreshRetrievalCards();
            updateRetrievalProgress();
          };

          const updateQuestionProgress = () => {
            const total = questionCards.length;
            const answered = Array.from(answerTextareas).filter((textarea) =>
              Boolean(textarea?.value?.trim())
            ).length;
            if (progressQuestionsSummary) {
              progressQuestionsSummary.textContent = `${answered} / ${total}問`;
            }
            if (progressQuestionsBar) {
              const ratio = total ? answered / total : 0;
              progressQuestionsBar.style.width = `${Math.min(
                100,
                Math.max(0, ratio * 100)
              )}%`;
            }
            refreshQuickNavStatuses();
          };

          const stopExerciseTimer = () => {
            if (exerciseTimerId !== null) {
              window.clearInterval(exerciseTimerId);
              exerciseTimerId = null;
            }
            exerciseTimerEnd = null;
          };

          const updateTimerDisplay = () => {
            if (!currentExercise) {
              return;
            }
            const durationMinutes = Number(currentExercise.timeLimitMinutes) || 45;
            const totalSeconds = Math.max(durationMinutes * 60, 1);
            const remainingSeconds = Math.max(
              0,
              Math.round((exerciseTimerEnd || Date.now()) - Date.now()) / 1000
            );
            const rounded = Math.floor(remainingSeconds);
            const minutes = String(Math.floor(rounded / 60)).padStart(2, '0');
            const seconds = String(rounded % 60).padStart(2, '0');
            const formatted = `${minutes}:${seconds}`;
            if (progressTimerLabel) {
              progressTimerLabel.textContent = formatted;
            }
            inlineTimerLabels.forEach((label) => {
              label.textContent = formatted;
            });
            if (progressTimerBar) {
              const ratio = Math.min(1, Math.max(0, rounded / totalSeconds));
              progressTimerBar.style.width = `${ratio * 100}%`;
            }
          };

          const startExerciseTimer = (exercise) => {
            stopExerciseTimer();
            const durationMinutes = Number(exercise?.timeLimitMinutes) || 45;
            exerciseTimerEnd = Date.now() + durationMinutes * 60 * 1000;
            updateTimerDisplay();
            exerciseTimerId = window.setInterval(() => {
              updateTimerDisplay();
              if ((exerciseTimerEnd || 0) <= Date.now()) {
                stopExerciseTimer();
                updateTimerDisplay();
              }
            }, 1000);
          };

          signal.addEventListener(
            'abort',
            () => {
              stopExerciseTimer();
              updateTimerDisplay();
            },
            { once: true }
          );

          const compareTuples = (a, b) => {
            const length = Math.max(a.length, b.length);
            for (let index = 0; index < length; index += 1) {
              const diff = (a[index] ?? 0) - (b[index] ?? 0);
              if (diff !== 0) {
                return diff;
              }
            }
            return 0;
          };

          const applyQuestionFilters = () => {
            if (!currentExercise) {
              return;
            }
            const normalizedQuery = currentSearchQuery.trim().toLowerCase();
            const filters = Array.from(activeFilters);
            const filterIsInactive = filters.length === 0;
            const questionMatches = currentExercise.questions.map(
              (question, index) => {
                const card = questionCards[index];
                const tab = tabButtons[index];
                const state = ensureQuestionState(question) || {};
                const textarea = card?.querySelector('.question-card__textarea');
                const answerValue = textarea?.value?.trim() || '';
                const answered = Boolean(answerValue) || state.status === 'answered';
                if (answered) {
                  state.status = 'answered';
                }
                const hasReviewFlag = state.flags instanceof Set
                  ? state.flags.has('review')
                  : Array.isArray(state.flags) && state.flags.includes('review');
                const hasExplanationFlag = state.flags instanceof Set
                  ? state.flags.has('explanation')
                  : Array.isArray(state.flags) &&
                    state.flags.includes('explanation');
                const searchPool = [
                  question.title,
                  question.prompt,
                  question.tabTitle,
                  ...(state.keywords || []),
                ]
                  .filter(Boolean)
                  .join(' ')
                  .toLowerCase();
                const matchesSearch =
                  !normalizedQuery || searchPool.includes(normalizedQuery);
                const matchesFilter =
                  filterIsInactive ||
                  filters.some((filter) => {
                    if (filter === 'unanswered') {
                      return !answered;
                    }
                    if (filter === 'answered') {
                      return answered;
                    }
                    if (filter === 'review') {
                      return hasReviewFlag;
                    }
                    if (filter === 'explanation') {
                      return hasExplanationFlag;
                    }
                    return true;
                  });
                const sortTuple = (() => {
                  if (currentSortMode === 'status') {
                    return [
                      answered ? 1 : 0,
                      hasReviewFlag ? 0 : 1,
                      state.recommendedRank ?? question.recommendedRank ?? index,
                    ];
                  }
                  if (currentSortMode === 'recent') {
                    return [
                      state.recentRank ?? question.recentRank ?? index,
                      state.recommendedRank ?? question.recommendedRank ?? index,
                    ];
                  }
                  return [state.recommendedRank ?? question.recommendedRank ?? index];
                })();
                return {
                  question,
                  card,
                  tab,
                  matches: matchesSearch && matchesFilter,
                  answered,
                  sortTuple,
                };
              }
            );

            const visible = questionMatches.filter((item) => item.matches);
            const hidden = questionMatches.filter((item) => !item.matches);

            visible.sort((a, b) => {
              const diff = compareTuples(a.sortTuple, b.sortTuple);
              if (diff !== 0) {
                return diff;
              }
              return (a.question.label || '').localeCompare(
                b.question.label || ''
              );
            });

            const orderMap = new Map();
            visible.forEach((item, order) => {
              orderMap.set(item.card, order);
            });
            hidden.forEach((item, order) => {
              orderMap.set(item.card, visible.length + order);
            });

            questionCards.sort(
              (a, b) => (orderMap.get(a) ?? 0) - (orderMap.get(b) ?? 0)
            );
            questionCards.forEach((card) => {
              if (questionContainer) {
                questionContainer.appendChild(card);
              }
            });

            tabButtons.sort((a, b) => {
              const aCard = getQuestionCardByKey(a.dataset.questionTab);
              const bCard = getQuestionCardByKey(b.dataset.questionTab);
              return (orderMap.get(aCard) ?? 0) - (orderMap.get(bCard) ?? 0);
            });
            tabButtons.forEach((tab) => {
              tabList?.appendChild(tab);
            });

            visible.forEach((item) => {
              item.card.dataset.filteredOut = 'false';
              item.card.hidden = false;
              item.card.removeAttribute('aria-hidden');
              if (item.tab) {
                item.tab.hidden = false;
                item.tab.removeAttribute('aria-hidden');
              }
            });
            hidden.forEach((item) => {
              item.card.dataset.filteredOut = 'true';
              item.card.hidden = true;
              item.card.setAttribute('aria-hidden', 'true');
              if (item.tab) {
                item.tab.hidden = true;
                item.tab.setAttribute('aria-hidden', 'true');
              }
            });

            updateQuestionIndexNavigation(visible.map((item) => item.question));
            questionSortOrder = visible.map((item) => item.question.key);

            if (!visible.length) {
              if (selectionQuestionLabel) {
                selectionQuestionLabel.textContent = '該当する設問がありません';
              }
              if (nextButton) {
                nextButton.disabled = true;
              }
              return;
            }

            if (nextButton) {
              nextButton.disabled = false;
            }

            const currentCard = activeQuestionId
              ? appRoot.querySelector(`#${escapeSelector(activeQuestionId)}`)
              : null;
            if (!currentCard || currentCard.dataset.filteredOut === 'true') {
              const firstId = visible[0].card.id;
              scrollToQuestion(firstId);
            } else {
              updateFooterCta(currentCard.id);
              updateSelectionQuestion(currentCard.id);
            }
          };

          const applyExercise = (exercise, { preserveScroll = false } = {}) => {
            if (!exercise) {
              return;
            }
            const previousExerciseId = activeExerciseId;
            answerTextareas.forEach((textarea) => {
              if (typeof textarea.__saveDraftForExercise === 'function') {
                textarea.__saveDraftForExercise(previousExerciseId);
              }
              if (typeof textarea.__cancelDraftSchedule === 'function') {
                textarea.__cancelDraftSchedule();
              }
            });
            questionMemoInputs.forEach((memoInput) => {
              if (typeof memoInput.__saveMemoForExercise === 'function') {
                memoInput.__saveMemoForExercise(previousExerciseId);
              }
              if (typeof memoInput.__cancelMemoSchedule === 'function') {
                memoInput.__cancelMemoSchedule();
              }
            });
            currentExercise = exercise;
            activeExerciseId = exercise.id;
            questionState.clear();
            suppressSelectEvents = true;
            populateCaseSelectOptions();
            if (caseSelect) {
              caseSelect.value = exercise.caseId;
            }
            populateYearSelectOptions(exercise.caseId, exercise.id);
            if (yearSelect) {
              yearSelect.value = exercise.id;
            }
            suppressSelectEvents = false;

            updateScenarioView(exercise);

            exercise.questions.forEach((question, index) => {
              const card = questionCards[index];
              updateQuestionCard(question, card, index);
              const textarea = card?.querySelector('.question-card__textarea');
              if (textarea && typeof textarea.__loadDraftForExercise === 'function') {
                textarea.__loadDraftForExercise(exercise.id);
              }
              const memoInput = card?.querySelector('[data-question-memo]');
              if (
                memoInput &&
                typeof memoInput.__loadMemoForExercise === 'function'
              ) {
                memoInput.__loadMemoForExercise(exercise.id);
              }
            });

            updateQuestionIndexNavigation(exercise.questions);
            renderRetrievalCardsForExercise(exercise);

            if (problemSearchInput) {
              problemSearchInput.value = '';
            }
            updateProblemSearchSuggestions(exercise);
            currentSearchQuery = '';
            currentSortMode = sortSelect?.value || 'recommended';

            tabButtons.forEach((tab) => {
              tab.hidden = false;
              tab.removeAttribute('aria-hidden');
            });
            questionCards.forEach((card) => {
              card.dataset.filteredOut = 'false';
              card.hidden = false;
              card.removeAttribute('aria-hidden');
            });

            updateQuestionProgress();
            updateRetrievalProgress();
            startExerciseTimer(exercise);

            applyQuestionFilters();

            const visibleCards = getVisibleQuestionCards();
            if (visibleCards.length) {
              const firstId = visibleCards[0].id;
              if (!preserveScroll) {
                const firstElement = appRoot.querySelector(
                  `#${escapeSelector(firstId)}`
                );
                firstElement?.scrollIntoView({ behavior: 'auto', block: 'start' });
              }
              updateTabs(firstId);
              updateFooterCta(firstId);
              updateSelectionQuestion(firstId);
              activeQuestionId = firstId;
              updateQuickNavActive(firstId);
            }
          };

          const focusAnswerField = () => {
            if (!activeQuestionId) {
              return false;
            }
            const card = appRoot.querySelector(
              `#${escapeSelector(activeQuestionId)}`
            );
            const textarea = card?.querySelector('.question-card__textarea');
            if (!textarea) {
              return false;
            }
            try {
              textarea.focus({ preventScroll: false });
            } catch (error) {
              textarea.focus();
            }
            return true;
          };

          const focusQuestionByOffset = (offset) => {
            const visibleCards = getVisibleQuestionCards();
            if (!visibleCards.length) {
              return false;
            }
            let currentIndex = visibleCards.findIndex(
              (card) => card.id === activeQuestionId
            );
            if (currentIndex === -1) {
              currentIndex = 0;
            }
            const nextIndex =
              (currentIndex + offset + visibleCards.length) % visibleCards.length;
            const targetId = visibleCards[nextIndex].id;
            scrollToQuestion(targetId);
            return true;
          };

          const focusNextQuestion = () => focusQuestionByOffset(1);
          const focusPreviousQuestion = () => focusQuestionByOffset(-1);

          populateCaseSelectOptions();
          if (caseSelect) {
            caseSelect.addEventListener(
              'change',
              () => {
                if (suppressSelectEvents) {
                  return;
                }
                const selectedCaseId = caseSelect.value;
                const exercises = exercisesByCase.get(selectedCaseId) || [];
                const nextExercise =
                  exercises.find((exercise) => exercise.id === yearSelect?.value) ||
                  exercises[0];
                suppressSelectEvents = true;
                populateYearSelectOptions(selectedCaseId, nextExercise?.id);
                if (yearSelect && nextExercise) {
                  yearSelect.value = nextExercise.id;
                }
                suppressSelectEvents = false;
                if (nextExercise) {
                  applyExercise(nextExercise);
                }
              },
              { signal }
            );
          }

          if (yearSelect) {
            yearSelect.addEventListener(
              'change',
              () => {
                if (suppressSelectEvents) {
                  return;
                }
                const selectedExercise = exerciseById.get(yearSelect.value);
                if (selectedExercise) {
                  applyExercise(selectedExercise);
                }
              },
              { signal }
            );
          }

          if (problemSearchInput) {
            problemSearchInput.addEventListener(
              'input',
              () => {
                currentSearchQuery = problemSearchInput.value || '';
                applyQuestionFilters();
              },
              { signal }
            );
          }

          filterChips.forEach((chip) => {
            const isActive = chip.dataset.active === 'true';
            chip.setAttribute('aria-pressed', String(isActive));
            chip.addEventListener(
              'click',
              () => {
                const filter = chip.dataset.filter;
                if (!filter) {
                  return;
                }
                const currentlyActive = chip.dataset.active === 'true';
                const nextState = !currentlyActive;
                chip.dataset.active = String(nextState);
                chip.setAttribute('aria-pressed', String(nextState));
                if (nextState) {
                  activeFilters.add(filter);
                } else {
                  activeFilters.delete(filter);
                }
                applyQuestionFilters();
              },
              { signal }
            );
          });

          if (sortSelect) {
            sortSelect.addEventListener(
              'change',
              () => {
                currentSortMode = sortSelect.value || 'recommended';
                applyQuestionFilters();
              },
              { signal }
            );
          }

          const activateCard = (card) => {
            questionCards.forEach((c) =>
              c.classList.remove('question-card--active')
            );
            if (!card) return;
            card.classList.add('question-card--active');
            if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
              card.classList.remove('question-card--active');
            } else {
              setTimeout(() => {
                card.classList.remove('question-card--active');
              }, 2000);
            }
          };

          const updateTabs = (activeId) => {
            tabButtons.forEach((button) => {
              const isActive = button.dataset.target === activeId;
              button.setAttribute('aria-selected', String(isActive));
              button.setAttribute('tabindex', isActive ? '0' : '-1');
            });
          };

          const updateFooterCta = (activeId) => {
            if (!nextButton) return;
            const visibleCards = getVisibleQuestionCards();
            if (!visibleCards.length) {
              nextButton.disabled = true;
              return;
            }
            nextButton.disabled = false;
            const currentIndex = visibleCards.findIndex(
              (card) => card.id === activeId
            );
            if (currentIndex === -1) {
              nextButton.dataset.target = visibleCards[0].id;
              return;
            }

            const verb = nextButton.querySelector('.cta-button__verb');
            const object = nextButton.querySelector('.cta-button__object');
            const isLast = currentIndex === visibleCards.length - 1;
            const nextIndex = isLast ? 0 : currentIndex + 1;
            nextButton.dataset.target = visibleCards[nextIndex].id;
            if (verb && object) {
              if (isLast) {
                verb.textContent = '見直す';
                object.textContent = '1問目へ';
                nextButton.setAttribute('aria-label', '1問目へ戻る');
              } else {
                verb.textContent = '進む';
                object.textContent = '次の設問へ';
                nextButton.setAttribute('aria-label', '次の設問へ進む');
              }
            }
          };

          const scrollToQuestion = (targetId) => {
            const target = targetId
              ? appRoot.querySelector(`#${escapeSelector(targetId)}`)
              : null;
            if (!target) return;
            if (target.dataset.filteredOut === 'true') {
              showToast('現在のフィルタではこの設問を表示できません');
              return;
            }
            ensurePanelOpen('answer');
            target.scrollIntoView({ behavior: 'smooth', block: 'start' });
            if (target.focus) {
              try {
                target.focus({ preventScroll: true });
              } catch (error) {
                target.focus();
              }
            }
            activateCard(target);
            updateTabs(targetId);
            updateFooterCta(targetId);
            updateSelectionQuestion(targetId);
            activeQuestionId = targetId;
            updateQuickNavActive(targetId);
            setActiveAnchor('section-answer');
          };

          if (quickNavList) {
            quickNavList.addEventListener(
              'click',
              (event) => {
                const trigger = event.target.closest('[data-question-jump]');
                if (!trigger) {
                  return;
                }
                event.preventDefault();
                const targetId = trigger.dataset.questionJump;
                if (targetId) {
                  scrollToQuestion(targetId);
                }
              },
              { signal }
            );
          }

          tabButtons.forEach((button, index) => {
            button.addEventListener(
              'click',
              () => {
                scrollToQuestion(button.dataset.target);
              },
              { signal }
            );

            button.addEventListener(
              'keydown',
              (event) => {
                const { key } = event;
                const visibleTabs = tabButtons.filter((tab) => !tab.hidden);
                const currentIndex = visibleTabs.indexOf(button);
                if (currentIndex === -1) {
                  return;
                }
                let nextIndex = currentIndex;
                if (key === 'ArrowRight' || key === 'ArrowDown') {
                  nextIndex = (currentIndex + 1) % visibleTabs.length;
                } else if (key === 'ArrowLeft' || key === 'ArrowUp') {
                  nextIndex =
                    (currentIndex - 1 + visibleTabs.length) % visibleTabs.length;
                } else if (key === 'Home') {
                  nextIndex = 0;
                } else if (key === 'End') {
                  nextIndex = visibleTabs.length - 1;
                } else {
                  return;
                }
                event.preventDefault();
                const nextButtonEl = visibleTabs[nextIndex];
                nextButtonEl.focus();
                scrollToQuestion(nextButtonEl.dataset.target);
              },
              { signal }
            );
          });

          if (tabList?.dataset.wheelScroll === 'true') {
            tabList.addEventListener(
              'wheel',
              (event) => {
                if (Math.abs(event.deltaY) <= Math.abs(event.deltaX)) {
                  return;
                }
                event.preventDefault();
                tabList.scrollBy({
                  left: event.deltaY,
                  behavior: 'smooth',
                });
              },
              { passive: false, signal }
            );
          }

          if (nextButton) {
            nextButton.addEventListener(
              'click',
              () => {
                const targetId = nextButton.dataset.target;
                if (targetId) {
                  scrollToQuestion(targetId);
                }
              },
              { signal }
            );
          }

          if (questionCards.length) {
            updateFooterCta(questionCards[0].id);
            updateSelectionQuestion(questionCards[0].id);
            activeQuestionId = questionCards[0].id;
            updateQuickNavActive(activeQuestionId);
          }

          const observer = new IntersectionObserver(
            (entries) => {
              entries.forEach((entry) => {
                if (entry.isIntersecting) {
                  const id = entry.target.getAttribute('id');
                  updateTabs(id);
                  updateFooterCta(id);
                  activateCard(entry.target);
                  updateSelectionQuestion(id);
                  activeQuestionId = id;
                  updateQuickNavActive(id);
                  setActiveAnchor('section-answer');
                }
              });
            },
            {
              rootMargin: '-40% 0px -45% 0px',
              threshold: 0.1,
            }
          );

          signal.addEventListener(
            'abort',
            () => {
              observer.disconnect();
            },
            { once: true }
          );

          questionCards.forEach((card) => {
            card.setAttribute('tabindex', '-1');
            observer.observe(card);
          });

          // 字数カウンタ：上限超過時は警告色を適用
          const updateCounter = (textarea, counter) => {
            const max = Number(textarea.dataset.maxLength);
            const length = textarea.value.length;
            const remaining = `${length} / ${max} 字`;
            counter.textContent = remaining;
            counter.classList.toggle('char-counter--limit', length > max);
          };

          const answerStorageKey = 'exercise-answer-drafts-v1';
          let answerDrafts = {};

          try {
            answerDrafts = JSON.parse(
              localStorage.getItem(answerStorageKey) || '{}'
            );
          } catch (error) {
            answerDrafts = {};
          }

          const persistDrafts = () => {
            try {
              const hasDrafts = Object.keys(answerDrafts).length > 0;
              if (hasDrafts) {
                localStorage.setItem(
                  answerStorageKey,
                  JSON.stringify(answerDrafts)
                );
              } else {
                localStorage.removeItem(answerStorageKey);
              }
            } catch (error) {
              // ストレージ未対応環境では静かにフォールバック
            }
          };

          const makeDraftKey = (exerciseId, questionKey) =>
            exerciseId && questionKey ? `${exerciseId}::${questionKey}` : null;

          const memoStorageKey = 'exercise-memo-drafts-v1';
          let memoDrafts = {};
          try {
            memoDrafts = JSON.parse(localStorage.getItem(memoStorageKey) || '{}');
          } catch (error) {
            memoDrafts = {};
          }

          const persistMemoDrafts = () => {
            try {
              const hasDrafts = Object.keys(memoDrafts).length > 0;
              if (hasDrafts) {
                localStorage.setItem(memoStorageKey, JSON.stringify(memoDrafts));
              } else {
                localStorage.removeItem(memoStorageKey);
              }
            } catch (error) {
              // ignore storage errors
            }
          };

          const getMostRecentDraftExerciseId = () => {
            let latestId = null;
            let latestTimestamp = -Infinity;
            Object.entries(answerDrafts || {}).forEach(([key, draft]) => {
              if (typeof key !== 'string' || !key.includes('::')) {
                return;
              }
              const [exerciseId] = key.split('::');
              if (!exerciseId) {
                return;
              }
              const timestamp = Date.parse(draft?.savedAt || '');
              if (Number.isFinite(timestamp)) {
                if (timestamp > latestTimestamp) {
                  latestTimestamp = timestamp;
                  latestId = exerciseId;
                }
              } else if (latestId === null) {
                latestId = exerciseId;
              }
            });
            return latestId;
          };

          answerTextareas.forEach((textarea) => {
            const describedBy = textarea.getAttribute('aria-describedby');
            const counter = describedBy
              ? appRoot.querySelector(`#${escapeSelector(describedBy)}`)
              : null;
            const inputContainer = textarea.closest('.question-card__input');
            const saveStatus = inputContainer?.querySelector('[data-save-status]');
            const saveStatusText = saveStatus?.querySelector(
              '.save-status__text'
            );
            const exampleContainer = textarea.id
              ? appRoot.querySelector(
                  `[data-example-for="${escapeSelector(textarea.id)}"]`
                )
              : null;
            const exampleChips = exampleContainer
              ? Array.from(
                  exampleContainer.querySelectorAll('[data-example-text]')
                )
              : [];
            const undoButton = exampleContainer?.querySelector(
              '[data-example-undo]'
            );
            const exampleLiveRegion = exampleContainer?.querySelector(
              '[data-example-live]'
            );

            const announceExample = (message) => {
              if (exampleLiveRegion) {
                exampleLiveRegion.textContent = message;
              }
            };

            const setUndoAvailability = (available) => {
              if (undoButton) {
                undoButton.disabled = !available;
              }
            };

            const setSaveStatus = (state) => {
              if (!saveStatus || !saveStatusText) {
                return;
              }
              saveStatus.dataset.state = state;
              if (state === 'saving') {
                saveStatusText.textContent = '保存中';
              } else {
                saveStatusText.textContent = '保存済み';
              }
            };

            textarea.dataset.exampleInsertion = 'false';
            setUndoAvailability(false);
            setSaveStatus('saved');

            let saveTimer = null;

            const getDraftKey = (exerciseId = activeExerciseId) =>
              makeDraftKey(exerciseId, textarea.dataset.questionKey);

            const loadDraft = (exerciseId = activeExerciseId) => {
              const key = getDraftKey(exerciseId);
              let savedDraft = key ? answerDrafts[key] : null;
              const legacyKey = textarea.id && answerDrafts[textarea.id];
              if (!savedDraft && legacyKey) {
                if (key) {
                  answerDrafts[key] = legacyKey;
                  delete answerDrafts[textarea.id];
                  persistDrafts();
                }
                savedDraft = legacyKey;
              }
              textarea.value =
                typeof savedDraft?.value === 'string' ? savedDraft.value : '';
              textarea.dataset.exampleInsertion = 'false';
              insertionHistory.delete(textarea);
              setUndoAvailability(false);
              setSaveStatus('saved');
              if (counter) {
                updateCounter(textarea, counter);
              }
              updateQuestionProgress();
            };

            const cancelScheduledSave = () => {
              if (saveTimer !== null) {
                clearTimeout(saveTimer);
                saveTimer = null;
              }
            };

            const resolveExerciseId = (value) =>
              typeof value === 'string' && value ? value : activeExerciseId;

            const saveDraft = (value) => {
              const exerciseId = resolveExerciseId(value);
              const key = getDraftKey(exerciseId);
              cancelScheduledSave();
              if (!exerciseId || !key) {
                return;
              }
              if (textarea.value === '') {
                delete answerDrafts[key];
              } else {
                answerDrafts[key] = {
                  value: textarea.value,
                  savedAt: new Date().toISOString(),
                };
              }
              if (textarea.id && textarea.id !== key) {
                delete answerDrafts[textarea.id];
              }
              persistDrafts();
              setSaveStatus('saved');
              updateQuestionProgress();
            };

            const scheduleSave = () => {
              const key = getDraftKey();
              if (!key) {
                return;
              }
              cancelScheduledSave();
              setSaveStatus('saving');
              saveTimer = window.setTimeout(() => saveDraft(), 300);
            };

            const insertExampleText = (text) => {
              if (!text) {
                return;
              }
              const start =
                typeof textarea.selectionStart === 'number'
                  ? textarea.selectionStart
                  : textarea.value.length;
              const end =
                typeof textarea.selectionEnd === 'number'
                  ? textarea.selectionEnd
                  : start;
              textarea.setRangeText(text, start, end, 'end');
              textarea.dataset.exampleInsertion = 'true';
              insertionHistory.set(textarea, {
                text,
                start,
                end: start + text.length,
              });
              setUndoAvailability(true);
              announceExample(`${text} を挿入しました。`);
              textarea.dispatchEvent(new Event('input', { bubbles: true }));
              try {
                textarea.focus({ preventScroll: true });
              } catch (error) {
                textarea.focus();
              }
            };

            exampleChips.forEach((chip) => {
              chip.addEventListener(
                'click',
                () => {
                  insertExampleText(chip.dataset.exampleText || '');
                },
                { signal }
              );

              chip.addEventListener(
                'dragstart',
                (event) => {
                  const text = chip.dataset.exampleText || '';
                  event.dataTransfer?.setData('text/plain', text);
                  event.dataTransfer?.setDragImage?.(chip, 10, 10);
                  event.dataTransfer?.setData('text/uri-list', '');
                  event.dataTransfer.effectAllowed = 'copy';
                },
                { signal }
              );
            });

            if (undoButton) {
              undoButton.addEventListener(
                'click',
                () => {
                  const history = insertionHistory.get(textarea);
                  if (!history) {
                    return;
                  }
                  const { text, start, end } = history;
                  const currentSlice = textarea.value.slice(start, end);
                  if (currentSlice === text) {
                    textarea.setSelectionRange(start, end);
                    textarea.dataset.exampleInsertion = 'true';
                    textarea.setRangeText('', start, end, 'start');
                    textarea.dispatchEvent(
                      new Event('input', { bubbles: true })
                    );
                    announceExample(`${text} を削除しました。`);
                  }
                  insertionHistory.delete(textarea);
                  setUndoAvailability(false);
                  try {
                    textarea.focus({ preventScroll: true });
                  } catch (error) {
                    textarea.focus();
                  }
                },
                { signal }
              );
            }

            textarea.addEventListener(
              'input',
              () => {
                if (counter) {
                  updateCounter(textarea, counter);
                }
                if (textarea.dataset.exampleInsertion === 'true') {
                  textarea.dataset.exampleInsertion = 'false';
                } else {
                  insertionHistory.delete(textarea);
                  setUndoAvailability(false);
                }
                scheduleSave();
                const questionKey = textarea.dataset.questionKey;
                const state = questionKey ? questionState.get(questionKey) : null;
                if (state) {
                  const trimmed = textarea.value.trim();
                  const nextStatus = trimmed ? 'answered' : 'unanswered';
                  const previousStatus = state.status;
                  state.status = nextStatus;
                  if (previousStatus !== nextStatus) {
                    applyQuestionFilters();
                  }
                }
                updateQuestionProgress();
              },
              { signal }
            );

            textarea.addEventListener(
              'dragover',
              (event) => {
                if (event.dataTransfer) {
                  event.preventDefault();
                  event.dataTransfer.dropEffect = 'copy';
                }
              },
              { signal }
            );

            textarea.addEventListener(
              'drop',
              (event) => {
                const text = event.dataTransfer?.getData('text/plain');
                if (!text) {
                  return;
                }
                event.preventDefault();
                const start =
                  typeof textarea.selectionStart === 'number'
                    ? textarea.selectionStart
                    : textarea.value.length;
                const end =
                  typeof textarea.selectionEnd === 'number'
                    ? textarea.selectionEnd
                    : start;
                textarea.setSelectionRange(start, end);
                insertExampleText(text);
              },
              { signal }
            );

            textarea.addEventListener('blur', saveDraft, { signal });
            window.addEventListener('beforeunload', saveDraft, { signal });

            textarea.__loadDraftForExercise = loadDraft;
            textarea.__saveDraftForExercise = saveDraft;
            textarea.__cancelDraftSchedule = cancelScheduledSave;

            signal.addEventListener(
              'abort',
              () => {
                cancelScheduledSave();
              },
              { once: true }
            );
          });

          questionMemoInputs.forEach((memoInput) => {
            const questionKey = memoInput.dataset.questionKey;
            if (!questionKey) {
              return;
            }
            let saveTimer = null;

            const cancelScheduledSave = () => {
              if (saveTimer !== null) {
                clearTimeout(saveTimer);
                saveTimer = null;
              }
            };

            const resolveExerciseId = (value) =>
              typeof value === 'string' && value ? value : activeExerciseId;

            const loadMemo = (value) => {
              const exerciseId = resolveExerciseId(value);
              const key = makeDraftKey(exerciseId, questionKey);
              const record = key ? memoDrafts[key] : null;
              const nextValue =
                typeof record?.value === 'string' ? record.value : '';
              memoInput.value = nextValue;
              const state = questionState.get(questionKey);
              if (state) {
                state.memoDraft = nextValue;
              }
            };

            const saveMemo = (value) => {
              const exerciseId = resolveExerciseId(value);
              const key = makeDraftKey(exerciseId, questionKey);
              cancelScheduledSave();
              if (!exerciseId || !key) {
                return;
              }
              const currentValue = memoInput.value;
              if (currentValue.trim()) {
                memoDrafts[key] = {
                  value: currentValue,
                  savedAt: new Date().toISOString(),
                };
              } else {
                delete memoDrafts[key];
              }
              persistMemoDrafts();
              const state = questionState.get(questionKey);
              if (state) {
                state.memoDraft = currentValue;
              }
            };

            const scheduleSave = () => {
              const exerciseId = resolveExerciseId();
              const key = makeDraftKey(exerciseId, questionKey);
              if (!exerciseId || !key) {
                return;
              }
              cancelScheduledSave();
              saveTimer = window.setTimeout(() => saveMemo(), 250);
            };

            memoInput.addEventListener(
              'input',
              () => {
                const state = questionState.get(questionKey);
                if (state) {
                  state.memoDraft = memoInput.value;
                }
                scheduleSave();
              },
              { signal }
            );

            memoInput.addEventListener(
              'blur',
              () => {
                saveMemo();
              },
              { signal }
            );

            window.addEventListener(
              'beforeunload',
              () => {
                saveMemo();
              },
              { signal }
            );

            memoInput.__loadMemoForExercise = loadMemo;
            memoInput.__saveMemoForExercise = saveMemo;
            memoInput.__cancelMemoSchedule = cancelScheduledSave;

            signal.addEventListener(
              'abort',
              () => {
                cancelScheduledSave();
              },
              { once: true }
            );
          });

          const fallbackExercise =
            caseOptions[0]?.exercises?.[0] || exerciseLibrary[0] || null;
          const initialExerciseId =
            appRoot.dataset.initialExercise ||
            getMostRecentDraftExerciseId() ||
            fallbackExercise?.id ||
            null;
          const initialExercise =
            (initialExerciseId && exerciseById.get(initialExerciseId)) ||
            fallbackExercise;
          if (initialExercise) {
            applyExercise(initialExercise, { preserveScroll: true });
          }

          // 折りたたみ補助情報：ローカルストレージで既読状態を保持
          const supportToggles = appRoot.querySelectorAll(
            '.support-block__toggle'
          );
          const storageKey = 'exercise-support-state-v1';
          let storedState = {};

          try {
            storedState = JSON.parse(localStorage.getItem(storageKey) || '{}');
          } catch (error) {
            storedState = {};
          }

          supportToggles.forEach((toggle) => {
            const supportId = toggle.dataset.supportId;
            const content = supportId
              ? appRoot.querySelector(`#${escapeSelector(supportId)}`)
              : null;
            if (!content) {
              return;
            }
            const isOpen = storedState[supportId];

            if (isOpen) {
              toggle.setAttribute('aria-expanded', 'true');
              content.hidden = false;
            }

            toggle.addEventListener(
              'click',
              () => {
                const expanded = toggle.getAttribute('aria-expanded') === 'true';
                const nextState = !expanded;
                toggle.setAttribute('aria-expanded', String(nextState));
                content.hidden = !nextState;
                storedState[supportId] = nextState;
                try {
                  localStorage.setItem(storageKey, JSON.stringify(storedState));
                } catch (error) {
                  // ストレージ未対応環境では静かにフォールバック
                }
                const labelText =
                  toggle
                    .querySelector('.support-block__label')
                    ?.textContent?.replace(/\s+/g, ' ')
                    ?.trim() || 'サポート情報';
                if (nextState) {
                  content.classList.remove('support-block__content--highlight');
                  void content.offsetWidth;
                  content.classList.add('support-block__content--highlight');
                  window.setTimeout(() => {
                    content.classList.remove('support-block__content--highlight');
                  }, 1200);
                  showToast(`${labelText}を表示しました`);
                } else {
                  showToast(`${labelText}を閉じました`);
                }
              },
              { signal }
            );
          });
        };

        const initializeAllRoots = () => {
          document
            .querySelectorAll('[data-app="exercise"]')
            .forEach((root) => initializeExerciseApp(root));
        };

        const scheduleInitialization = (() => {
          let rafId = null;
          return () => {
            if (typeof window === 'undefined') {
              initializeAllRoots();
              return;
            }

            if (rafId !== null) {
              window.cancelAnimationFrame(rafId);
            }

            rafId = window.requestAnimationFrame(() => {
              rafId = null;
              initializeAllRoots();
            });
          };
        })();

        if (document.readyState === 'loading') {
          document.addEventListener(
            'DOMContentLoaded',
            () => {
              scheduleInitialization();
            },
            { once: true }
          );
        } else {
          scheduleInitialization();
        }

        const registerSpaHooks = () => {
          const listeners = [
            [window, 'pageshow'],
            [window, 'popstate'],
            [window, 'hashchange'],
            [document, 'turbo:load'],
            [document, 'turbo:frame-load'],
            [document, 'astro:page-load'],
            [document, 'astro:after-swap'],
            [document, 'htmx:afterSettle'],
          ];

          listeners.forEach(([target, event]) => {
            if (target && target.addEventListener) {
              target.addEventListener(event, scheduleInitialization);
            }
          });

          if (
            window.navigation &&
            typeof window.navigation.addEventListener === 'function'
          ) {
            window.navigation.addEventListener('navigate', scheduleInitialization);
          }

          if (
            typeof history !== 'undefined' &&
            !history.__exerciseAppPatched
          ) {
            history.__exerciseAppPatched = true;
            ['pushState', 'replaceState'].forEach((method) => {
              const original = history[method];
              if (typeof original === 'function') {
                history[method] = function (...args) {
                  const result = original.apply(this, args);
                  scheduleInitialization();
                  return result;
                };
              }
            });
          }
        };

        registerSpaHooks();

        const observer = new MutationObserver((mutations) => {
          mutations.forEach((mutation) => {
            mutation.addedNodes.forEach((node) => {
              const targets = [];
              if (node instanceof Element && node.matches('[data-app="exercise"]')) {
                targets.push(node);
              }
              if (node instanceof Element || node instanceof DocumentFragment) {
                node.querySelectorAll?.('[data-app="exercise"]').forEach((element) => {
                  targets.push(element);
                });
              }
              targets.forEach((root) => initializeExerciseApp(root));
            });
          });
        });

        const observeTarget = document.body || document.documentElement;
        if (observeTarget) {
          observer.observe(observeTarget, { childList: true, subtree: true });
        }

        window.initializeExerciseApp = initializeExerciseApp;
        window.initializeAllExerciseApps = initializeAllRoots;
        window.refreshExerciseApp = scheduleInitialization;
      })();
    </script>
  </body>
</html>
